

<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../../../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../../../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../../../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../../../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../../../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>statsmodels.genmod.generalized_estimating_equations &#8212; statsmodels</title>
  <link rel="icon" type="image/png" sizes="32x32" href="../../../_static/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../../../_static/icons/favicon-16x16.png">
  <link rel="manifest" href="../../../_static/icons/site.webmanifest">
  <link rel="mask-icon" href="../../../_static/icons/safari-pinned-tab.svg" color="#919191">
  <meta name="msapplication-TileColor" content="#2b5797">
  <meta name="msapplication-config" content="../../../_static/icons/browserconfig.xml">
  <link rel="stylesheet" href="../../../_static/stylesheets/examples.css">
  <link rel="stylesheet" href="../../../_static/stylesheets/deprecation.css">
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/material.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=indigo data-md-color-accent=blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#_modules/statsmodels/genmod/generalized_estimating_equations" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../../index.html" title="statsmodels"
           class="md-header-nav__button md-logo">
          
              <img src="../../../_static/statsmodels-logo-v2-bw.svg" height="26"
                   alt="statsmodels logo">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">statsmodels 0.13.5</span>
          <span class="md-header-nav__topic"> statsmodels.genmod.generalized_estimating_equations </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../../../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/statsmodels/statsmodels" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    statsmodels
  </div>
</a>
          </div>
        </div>
      
      
  
  <script src="../../../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../../../../versions-v2.json",
        target_loc = "../../../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="../../index.html" class="md-tabs__link">Module code</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../../index.html" title="statsmodels" class="md-nav__button md-logo">
      
        <img src="../../../_static/statsmodels-logo-v2-bw.svg" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../../../index.html"
       title="statsmodels">statsmodels 0.13.5</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/statsmodels/statsmodels" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    statsmodels
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
    
      <a href="../../../install.html" class="md-nav__link">Installing statsmodels</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../gettingstarted.html" class="md-nav__link">Getting started</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../user-guide.html" class="md-nav__link">User Guide</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../examples/index.html" class="md-nav__link">Examples</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../api.html" class="md-nav__link">API Reference</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../about.html" class="md-nav__link">About statsmodels</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../dev/index.html" class="md-nav__link">Developer Page</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../release/index.html" class="md-nav__link">Release Notes</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
  <ul class="md-nav__list" data-md-scrollfix="">
    

<li id="searchbox" class="md-nav__item"></li>

  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <h1 id="modules-statsmodels-genmod-generalized-estimating-equations--page-root">Source code for statsmodels.genmod.generalized_estimating_equations</h1><div class="highlight"><pre>
<span></span><span class="sd">"""</span>
<span class="sd">Procedures for fitting marginal regression models to dependent data</span>
<span class="sd">using Generalized Estimating Equations.</span>

<span class="sd">References</span>
<span class="sd">----------</span>
<span class="sd">KY Liang and S Zeger. "Longitudinal data analysis using</span>
<span class="sd">generalized linear models". Biometrika (1986) 73 (1): 13-22.</span>

<span class="sd">S Zeger and KY Liang. "Longitudinal Data Analysis for Discrete and</span>
<span class="sd">Continuous Outcomes". Biometrics Vol. 42, No. 1 (Mar., 1986),</span>
<span class="sd">pp. 121-130</span>

<span class="sd">A Rotnitzky and NP Jewell (1990). "Hypothesis testing of regression</span>
<span class="sd">parameters in semiparametric generalized linear models for cluster</span>
<span class="sd">correlated data", Biometrika, 77, 485-497.</span>

<span class="sd">Xu Guo and Wei Pan (2002). "Small sample performance of the score</span>
<span class="sd">test in GEE".</span>
<span class="sd">http://www.sph.umn.edu/faculty1/wp-content/uploads/2012/11/rr2002-013.pdf</span>

<span class="sd">LA Mancl LA, TA DeRouen (2001). A covariance estimator for GEE with</span>
<span class="sd">improved small-sample properties.  Biometrics. 2001 Mar;57(1):126-34.</span>
<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">statsmodels.compat.python</span> <span class="kn">import</span> <span class="n">lzip</span>
<span class="kn">from</span> <span class="nn">statsmodels.compat.pandas</span> <span class="kn">import</span> <span class="n">Appender</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">patsy</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">statsmodels.tools.decorators</span> <span class="kn">import</span> <span class="n">cache_readonly</span>
<span class="kn">import</span> <span class="nn">statsmodels.base.model</span> <span class="k">as</span> <span class="nn">base</span>
<span class="c1"># used for wrapper:</span>
<span class="kn">import</span> <span class="nn">statsmodels.regression.linear_model</span> <span class="k">as</span> <span class="nn">lm</span>
<span class="kn">import</span> <span class="nn">statsmodels.base.wrapper</span> <span class="k">as</span> <span class="nn">wrap</span>

<span class="kn">from</span> <span class="nn">statsmodels.genmod</span> <span class="kn">import</span> <span class="n">families</span>
<span class="kn">from</span> <span class="nn">statsmodels.genmod.generalized_linear_model</span> <span class="kn">import</span> <span class="n">GLM</span><span class="p">,</span> <span class="n">GLMResults</span>
<span class="kn">from</span> <span class="nn">statsmodels.genmod</span> <span class="kn">import</span> <span class="n">cov_struct</span> <span class="k">as</span> <span class="n">cov_structs</span>

<span class="kn">import</span> <span class="nn">statsmodels.genmod.families.varfuncs</span> <span class="k">as</span> <span class="nn">varfuncs</span>
<span class="kn">from</span> <span class="nn">statsmodels.genmod.families.links</span> <span class="kn">import</span> <span class="n">Link</span>

<span class="kn">from</span> <span class="nn">statsmodels.tools.sm_exceptions</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ConvergenceWarning</span><span class="p">,</span>
                                             <span class="n">DomainWarning</span><span class="p">,</span>
                                             <span class="n">IterationLimitWarning</span><span class="p">,</span>
                                             <span class="n">ValueWarning</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">statsmodels.graphics._regressionplots_doc</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_plot_added_variable_doc</span><span class="p">,</span>
    <span class="n">_plot_partial_residuals_doc</span><span class="p">,</span>
    <span class="n">_plot_ceres_residuals_doc</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">statsmodels.discrete.discrete_margins</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">_get_margeff_exog</span><span class="p">,</span> <span class="n">_check_margeff_args</span><span class="p">,</span> <span class="n">_effects_at</span><span class="p">,</span> <span class="n">margeff_cov_with_se</span><span class="p">,</span>
    <span class="n">_check_at_is_all</span><span class="p">,</span> <span class="n">_transform_names</span><span class="p">,</span> <span class="n">_check_discrete_args</span><span class="p">,</span>
    <span class="n">_get_dummy_index</span><span class="p">,</span> <span class="n">_get_count_index</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ParameterConstraint</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    A class for managing linear equality constraints for a parameter</span>
<span class="sd">    vector.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">exog</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lhs : ndarray</span>
<span class="sd">           A q x p matrix which is the left hand side of the</span>
<span class="sd">           constraint lhs * param = rhs.  The number of constraints is</span>
<span class="sd">           q &gt;= 1 and p is the dimension of the parameter vector.</span>
<span class="sd">        rhs : ndarray</span>
<span class="sd">          A 1-dimensional vector of length q which is the right hand</span>
<span class="sd">          side of the constraint equation.</span>
<span class="sd">        exog : ndarray</span>
<span class="sd">          The n x p exognenous data for the full model.</span>
<span class="sd">        """</span>

        <span class="c1"># In case a row or column vector is passed (patsy linear</span>
        <span class="c1"># constraints passes a column vector).</span>
        <span class="n">rhs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">rhs</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">rhs</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"The right hand side of the constraint "</span>
                             <span class="s2">"must be a vector."</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span> <span class="o">!=</span> <span class="n">lhs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"The number of rows of the left hand "</span>
                             <span class="s2">"side constraint matrix L must equal "</span>
                             <span class="s2">"the length of the right hand side "</span>
                             <span class="s2">"constraint vector R."</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lhs</span> <span class="o">=</span> <span class="n">lhs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span> <span class="o">=</span> <span class="n">rhs</span>

        <span class="c1"># The columns of lhs0 are an orthogonal basis for the</span>
        <span class="c1"># orthogonal complement to row(lhs), the columns of lhs1 are</span>
        <span class="c1"># an orthogonal basis for row(lhs).  The columns of lhsf =</span>
        <span class="c1"># [lhs0, lhs1] are mutually orthogonal.</span>
        <span class="n">lhs_u</span><span class="p">,</span> <span class="n">lhs_s</span><span class="p">,</span> <span class="n">lhs_vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">lhs</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs0</span> <span class="o">=</span> <span class="n">lhs_u</span><span class="p">[:,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lhs_s</span><span class="p">):]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhs1</span> <span class="o">=</span> <span class="n">lhs_u</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">lhs_s</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lhsf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs1</span><span class="p">))</span>

        <span class="c1"># param0 is one solution to the underdetermined system</span>
        <span class="c1"># L * param = R.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">lhs_vt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs</span><span class="p">)</span> <span class="o">/</span>
                             <span class="n">lhs_s</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_offset_increment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">param0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">orig_exog</span> <span class="o">=</span> <span class="n">exog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exog_fulltrans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhsf</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">offset_increment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns a vector that should be added to the offset vector to</span>
<span class="sd">        accommodate the constraint.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exog : array_like</span>
<span class="sd">           The exogeneous data for the model.</span>
<span class="sd">        """</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_increment</span>

    <span class="k">def</span> <span class="nf">reduced_exog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns a linearly transformed exog matrix whose columns span</span>
<span class="sd">        the constrained model space.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exog : array_like</span>
<span class="sd">           The exogeneous data for the model.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_fulltrans</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs0</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="k">def</span> <span class="nf">restore_exog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns the full exog matrix before it was reduced to</span>
<span class="sd">        satisfy the constraint.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_exog</span>

    <span class="k">def</span> <span class="nf">unpack_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Converts the parameter vector `params` from reduced to full</span>
<span class="sd">        coordinates.</span>
<span class="sd">        """</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">param0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs0</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">unpack_cov</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bcov</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Converts the covariance matrix `bcov` from reduced to full</span>
<span class="sd">        coordinates.</span>
<span class="sd">        """</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lhs0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bcov</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lhs0</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>


<span class="n">_gee_init_doc</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">    Marginal regression model fit using Generalized Estimating Equations.</span>

<span class="s2">    GEE can be used to fit Generalized Linear Models (GLMs) when the</span>
<span class="s2">    data have a grouped structure, and the observations are possibly</span>
<span class="s2">    correlated within groups but not between groups.</span>

<span class="s2">    Parameters</span>
<span class="s2">    ----------</span>
<span class="s2">    endog : array_like</span>
<span class="s2">        1d array of endogenous values (i.e. responses, outcomes,</span>
<span class="s2">        dependent variables, or 'Y' values).</span>
<span class="s2">    exog : array_like</span>
<span class="s2">        2d array of exogeneous values (i.e. covariates, predictors,</span>
<span class="s2">        independent variables, regressors, or 'X' values). A `nobs x</span>
<span class="s2">        k` array where `nobs` is the number of observations and `k` is</span>
<span class="s2">        the number of regressors. An intercept is not included by</span>
<span class="s2">        default and should be added by the user. See</span>
<span class="s2">        `statsmodels.tools.add_constant`.</span>
<span class="s2">    groups : array_like</span>
<span class="s2">        A 1d array of length `nobs` containing the group labels.</span>
<span class="s2">    time : array_like</span>
<span class="s2">        A 2d array of time (or other index) values, used by some</span>
<span class="s2">        dependence structures to define similarity relationships among</span>
<span class="s2">        observations within a cluster.</span>
<span class="s2">    family : family class instance</span>
<span class="si">%(family_doc)s</span><span class="s2"></span>
<span class="s2">    cov_struct : CovStruct class instance</span>
<span class="s2">        The default is Independence.  To specify an exchangeable</span>
<span class="s2">        structure use cov_struct = Exchangeable().  See</span>
<span class="s2">        statsmodels.genmod.cov_struct.CovStruct for more</span>
<span class="s2">        information.</span>
<span class="s2">    offset : array_like</span>
<span class="s2">        An offset to be included in the fit.  If provided, must be</span>
<span class="s2">        an array whose length is the number of rows in exog.</span>
<span class="s2">    dep_data : array_like</span>
<span class="s2">        Additional data passed to the dependence structure.</span>
<span class="s2">    constraint : (ndarray, ndarray)</span>
<span class="s2">        If provided, the constraint is a tuple (L, R) such that the</span>
<span class="s2">        model parameters are estimated under the constraint L *</span>
<span class="s2">        param = R, where L is a q x p matrix and R is a</span>
<span class="s2">        q-dimensional vector.  If constraint is provided, a score</span>
<span class="s2">        test is performed to compare the constrained model to the</span>
<span class="s2">        unconstrained model.</span>
<span class="s2">    update_dep : bool</span>
<span class="s2">        If true, the dependence parameters are optimized, otherwise</span>
<span class="s2">        they are held fixed at their starting values.</span>
<span class="s2">    weights : array_like</span>
<span class="s2">        An array of case weights to use in the analysis.</span>
<span class="s2">    </span><span class="si">%(extra_params)s</span><span class="s2"></span>

<span class="s2">    See Also</span>
<span class="s2">    --------</span>
<span class="s2">    statsmodels.genmod.families.family</span>
<span class="s2">    :ref:`families`</span>
<span class="s2">    :ref:`links`</span>

<span class="s2">    Notes</span>
<span class="s2">    -----</span>
<span class="s2">    Only the following combinations make sense for family and link ::</span>

<span class="s2">                   + ident log logit probit cloglog pow opow nbinom loglog logc</span>
<span class="s2">      Gaussian     |   x    x                        x</span>
<span class="s2">      inv Gaussian |   x    x                        x</span>
<span class="s2">      binomial     |   x    x    x     x       x     x    x           x      x</span>
<span class="s2">      Poisson      |   x    x                        x</span>
<span class="s2">      neg binomial |   x    x                        x          x</span>
<span class="s2">      gamma        |   x    x                        x</span>

<span class="s2">    Not all of these link functions are currently available.</span>

<span class="s2">    Endog and exog are references so that if the data they refer</span>
<span class="s2">    to are already arrays and these arrays are changed, endog and</span>
<span class="s2">    exog will change.</span>

<span class="s2">    The "robust" covariance type is the standard "sandwich estimator"</span>
<span class="s2">    (e.g. Liang and Zeger (1986)).  It is the default here and in most</span>
<span class="s2">    other packages.  The "naive" estimator gives smaller standard</span>
<span class="s2">    errors, but is only correct if the working correlation structure</span>
<span class="s2">    is correctly specified.  The "bias reduced" estimator of Mancl and</span>
<span class="s2">    DeRouen (Biometrics, 2001) reduces the downward bias of the robust</span>
<span class="s2">    estimator.</span>

<span class="s2">    The robust covariance provided here follows Liang and Zeger (1986)</span>
<span class="s2">    and agrees with R's gee implementation.  To obtain the robust</span>
<span class="s2">    standard errors reported in Stata, multiply by sqrt(N / (N - g)),</span>
<span class="s2">    where N is the total sample size, and g is the average group size.</span>
<span class="s2">    </span><span class="si">%(notes)s</span><span class="s2"></span>
<span class="s2">    Examples</span>
<span class="s2">    --------</span>
<span class="s2">    </span><span class="si">%(example)s</span><span class="s2"></span>
<span class="s2">"""</span>

<span class="n">_gee_nointercept</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">    The nominal and ordinal GEE models should not have an intercept</span>
<span class="s2">    (either implicit or explicit).  Use "0 + " in a formula to</span>
<span class="s2">    suppress the intercept.</span>
<span class="s2">"""</span>

<span class="n">_gee_family_doc</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">        The default is Gaussian.  To specify the binomial</span>
<span class="s2">        distribution use `family=sm.families.Binomial()`. Each family</span>
<span class="s2">        can take a link instance as an argument.  See</span>
<span class="s2">        statsmodels.genmod.families.family for more information."""</span>

<span class="n">_gee_ordinal_family_doc</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">        The only family supported is `Binomial`.  The default `Logit`</span>
<span class="s2">        link may be replaced with `probit` if desired."""</span>

<span class="n">_gee_nominal_family_doc</span> <span class="o">=</span> <span class="s2">"""</span><span class="se">\</span>
<span class="s2">        The default value `None` uses a multinomial logit family</span>
<span class="s2">        specifically designed for use with GEE.  Setting this</span>
<span class="s2">        argument to a non-default value is not currently supported."""</span>

<span class="n">_gee_fit_doc</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">    Fits a marginal regression model using generalized estimating</span>
<span class="s2">    equations (GEE).</span>

<span class="s2">    Parameters</span>
<span class="s2">    ----------</span>
<span class="s2">    maxiter : int</span>
<span class="s2">        The maximum number of iterations</span>
<span class="s2">    ctol : float</span>
<span class="s2">        The convergence criterion for stopping the Gauss-Seidel</span>
<span class="s2">        iterations</span>
<span class="s2">    start_params : array_like</span>
<span class="s2">        A vector of starting values for the regression</span>
<span class="s2">        coefficients.  If None, a default is chosen.</span>
<span class="s2">    params_niter : int</span>
<span class="s2">        The number of Gauss-Seidel updates of the mean structure</span>
<span class="s2">        parameters that take place prior to each update of the</span>
<span class="s2">        dependence structure.</span>
<span class="s2">    first_dep_update : int</span>
<span class="s2">        No dependence structure updates occur before this</span>
<span class="s2">        iteration number.</span>
<span class="s2">    cov_type : str</span>
<span class="s2">        One of "robust", "naive", or "bias_reduced".</span>
<span class="s2">    ddof_scale : scalar or None</span>
<span class="s2">        The scale parameter is estimated as the sum of squared</span>
<span class="s2">        Pearson residuals divided by `N - ddof_scale`, where N</span>
<span class="s2">        is the total sample size.  If `ddof_scale` is None, the</span>
<span class="s2">        number of covariates (including an intercept if present)</span>
<span class="s2">        is used.</span>
<span class="s2">    scaling_factor : scalar</span>
<span class="s2">        The estimated covariance of the parameter estimates is</span>
<span class="s2">        scaled by this value.  Default is 1, Stata uses N / (N - g),</span>
<span class="s2">        where N is the total sample size and g is the average group</span>
<span class="s2">        size.</span>
<span class="s2">    scale : str or float, optional</span>
<span class="s2">        `scale` can be None, 'X2', or a float</span>
<span class="s2">        If a float, its value is used as the scale parameter.</span>
<span class="s2">        The default value is None, which uses `X2` (Pearson's</span>
<span class="s2">        chi-square) for Gamma, Gaussian, and Inverse Gaussian.</span>
<span class="s2">        The default is 1 for the Binomial and Poisson families.</span>

<span class="s2">    Returns</span>
<span class="s2">    -------</span>
<span class="s2">    An instance of the GEEResults class or subclass</span>

<span class="s2">    Notes</span>
<span class="s2">    -----</span>
<span class="s2">    If convergence difficulties occur, increase the values of</span>
<span class="s2">    `first_dep_update` and/or `params_niter`.  Setting</span>
<span class="s2">    `first_dep_update` to a greater value (e.g. ~10-20) causes the</span>
<span class="s2">    algorithm to move close to the GLM solution before attempting</span>
<span class="s2">    to identify the dependence structure.</span>

<span class="s2">    For the Gaussian family, there is no benefit to setting</span>
<span class="s2">    `params_niter` to a value greater than 1, since the mean</span>
<span class="s2">    structure parameters converge in one step.</span>
<span class="s2">"""</span>

<span class="n">_gee_results_doc</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">    Attributes</span>
<span class="s2">    ----------</span>

<span class="s2">    cov_params_default : ndarray</span>
<span class="s2">        default covariance of the parameter estimates. Is chosen among one</span>
<span class="s2">        of the following three based on `cov_type`</span>
<span class="s2">    cov_robust : ndarray</span>
<span class="s2">        covariance of the parameter estimates that is robust</span>
<span class="s2">    cov_naive : ndarray</span>
<span class="s2">        covariance of the parameter estimates that is not robust to</span>
<span class="s2">        correlation or variance misspecification</span>
<span class="s2">    cov_robust_bc : ndarray</span>
<span class="s2">        covariance of the parameter estimates that is robust and bias</span>
<span class="s2">        reduced</span>
<span class="s2">    converged : bool</span>
<span class="s2">        indicator for convergence of the optimization.</span>
<span class="s2">        True if the norm of the score is smaller than a threshold</span>
<span class="s2">    cov_type : str</span>
<span class="s2">        string indicating whether a "robust", "naive" or "bias_reduced"</span>
<span class="s2">        covariance is used as default</span>
<span class="s2">    fit_history : dict</span>
<span class="s2">        Contains information about the iterations.</span>
<span class="s2">    fittedvalues : ndarray</span>
<span class="s2">        Linear predicted values for the fitted model.</span>
<span class="s2">        dot(exog, params)</span>
<span class="s2">    model : class instance</span>
<span class="s2">        Pointer to GEE model instance that called `fit`.</span>
<span class="s2">    normalized_cov_params : ndarray</span>
<span class="s2">        See GEE docstring</span>
<span class="s2">    params : ndarray</span>
<span class="s2">        The coefficients of the fitted model.  Note that</span>
<span class="s2">        interpretation of the coefficients often depends on the</span>
<span class="s2">        distribution family and the data.</span>
<span class="s2">    scale : float</span>
<span class="s2">        The estimate of the scale / dispersion for the model fit.</span>
<span class="s2">        See GEE.fit for more information.</span>
<span class="s2">    score_norm : float</span>
<span class="s2">        norm of the score at the end of the iterative estimation.</span>
<span class="s2">    bse : ndarray</span>
<span class="s2">        The standard errors of the fitted GEE parameters.</span>
<span class="s2">"""</span>

<span class="n">_gee_example</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">    Logistic regression with autoregressive working dependence:</span>

<span class="s2">    &gt;&gt;&gt; import statsmodels.api as sm</span>
<span class="s2">    &gt;&gt;&gt; family = sm.families.Binomial()</span>
<span class="s2">    &gt;&gt;&gt; va = sm.cov_struct.Autoregressive()</span>
<span class="s2">    &gt;&gt;&gt; model = sm.GEE(endog, exog, group, family=family, cov_struct=va)</span>
<span class="s2">    &gt;&gt;&gt; result = model.fit()</span>
<span class="s2">    &gt;&gt;&gt; print(result.summary())</span>

<span class="s2">    Use formulas to fit a Poisson GLM with independent working</span>
<span class="s2">    dependence:</span>

<span class="s2">    &gt;&gt;&gt; import statsmodels.api as sm</span>
<span class="s2">    &gt;&gt;&gt; fam = sm.families.Poisson()</span>
<span class="s2">    &gt;&gt;&gt; ind = sm.cov_struct.Independence()</span>
<span class="s2">    &gt;&gt;&gt; model = sm.GEE.from_formula("y ~ age + trt + base", "subject",</span>
<span class="s2">                                 data, cov_struct=ind, family=fam)</span>
<span class="s2">    &gt;&gt;&gt; result = model.fit()</span>
<span class="s2">    &gt;&gt;&gt; print(result.summary())</span>

<span class="s2">    Equivalent, using the formula API:</span>

<span class="s2">    &gt;&gt;&gt; import statsmodels.api as sm</span>
<span class="s2">    &gt;&gt;&gt; import statsmodels.formula.api as smf</span>
<span class="s2">    &gt;&gt;&gt; fam = sm.families.Poisson()</span>
<span class="s2">    &gt;&gt;&gt; ind = sm.cov_struct.Independence()</span>
<span class="s2">    &gt;&gt;&gt; model = smf.gee("y ~ age + trt + base", "subject",</span>
<span class="s2">                    data, cov_struct=ind, family=fam)</span>
<span class="s2">    &gt;&gt;&gt; result = model.fit()</span>
<span class="s2">    &gt;&gt;&gt; print(result.summary())</span>
<span class="s2">"""</span>

<span class="n">_gee_ordinal_example</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">    Fit an ordinal regression model using GEE, with "global</span>
<span class="s2">    odds ratio" dependence:</span>

<span class="s2">    &gt;&gt;&gt; import statsmodels.api as sm</span>
<span class="s2">    &gt;&gt;&gt; gor = sm.cov_struct.GlobalOddsRatio("ordinal")</span>
<span class="s2">    &gt;&gt;&gt; model = sm.OrdinalGEE(endog, exog, groups, cov_struct=gor)</span>
<span class="s2">    &gt;&gt;&gt; result = model.fit()</span>
<span class="s2">    &gt;&gt;&gt; print(result.summary())</span>

<span class="s2">    Using formulas:</span>

<span class="s2">    &gt;&gt;&gt; import statsmodels.formula.api as smf</span>
<span class="s2">    &gt;&gt;&gt; model = smf.ordinal_gee("y ~ 0 + x1 + x2", groups, data,</span>
<span class="s2">                                    cov_struct=gor)</span>
<span class="s2">    &gt;&gt;&gt; result = model.fit()</span>
<span class="s2">    &gt;&gt;&gt; print(result.summary())</span>
<span class="s2">"""</span>

<span class="n">_gee_nominal_example</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">    Fit a nominal regression model using GEE:</span>

<span class="s2">    &gt;&gt;&gt; import statsmodels.api as sm</span>
<span class="s2">    &gt;&gt;&gt; import statsmodels.formula.api as smf</span>
<span class="s2">    &gt;&gt;&gt; gor = sm.cov_struct.GlobalOddsRatio("nominal")</span>
<span class="s2">    &gt;&gt;&gt; model = sm.NominalGEE(endog, exog, groups, cov_struct=gor)</span>
<span class="s2">    &gt;&gt;&gt; result = model.fit()</span>
<span class="s2">    &gt;&gt;&gt; print(result.summary())</span>

<span class="s2">    Using formulas:</span>

<span class="s2">    &gt;&gt;&gt; import statsmodels.api as sm</span>
<span class="s2">    &gt;&gt;&gt; model = sm.NominalGEE.from_formula("y ~ 0 + x1 + x2", groups,</span>
<span class="s2">                     data, cov_struct=gor)</span>
<span class="s2">    &gt;&gt;&gt; result = model.fit()</span>
<span class="s2">    &gt;&gt;&gt; print(result.summary())</span>

<span class="s2">    Using the formula API:</span>

<span class="s2">    &gt;&gt;&gt; import statsmodels.formula.api as smf</span>
<span class="s2">    &gt;&gt;&gt; model = smf.nominal_gee("y ~ 0 + x1 + x2", groups, data,</span>
<span class="s2">                                cov_struct=gor)</span>
<span class="s2">    &gt;&gt;&gt; result = model.fit()</span>
<span class="s2">    &gt;&gt;&gt; print(result.summary())</span>
<span class="s2">"""</span>


<span class="k">def</span> <span class="nf">_check_args</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">exposure</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">endog</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"Leading dimension of 'exog' should match "</span>
                         <span class="s2">"length of 'endog'"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">groups</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">endog</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"'groups' and 'endog' should have the same size"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">endog</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"'time' and 'endog' should have the same size"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">offset</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">endog</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"'offset and 'endog' should have the same size"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">exposure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">exposure</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="n">endog</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"'exposure' and 'endog' should have the same size"</span><span class="p">)</span>


<div class="viewcode-block" id="GEE"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEE.html#statsmodels.genmod.generalized_estimating_equations.GEE">[docs]</a><span class="k">class</span> <span class="nc">GEE</span><span class="p">(</span><span class="n">GLM</span><span class="p">):</span>

    <span class="vm">__doc__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"    Marginal Regression Model using Generalized Estimating "</span>
        <span class="s2">"Equations.</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">_gee_init_doc</span> <span class="o">%</span>
        <span class="p">{</span><span class="s1">'extra_params'</span><span class="p">:</span> <span class="n">base</span><span class="o">.</span><span class="n">_missing_param_doc</span><span class="p">,</span>
         <span class="s1">'family_doc'</span><span class="p">:</span> <span class="n">_gee_family_doc</span><span class="p">,</span>
         <span class="s1">'example'</span><span class="p">:</span> <span class="n">_gee_example</span><span class="p">,</span>
         <span class="s1">'notes'</span><span class="p">:</span> <span class="s2">""</span><span class="p">})</span>

    <span class="n">cached_means</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cov_struct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">exposure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dep_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">update_dep</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="ow">is</span> <span class="n">GEE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">family</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">family</span><span class="o">.</span><span class="n">link</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">family</span><span class="o">.</span><span class="n">safe_links</span><span class="p">)):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"The </span><span class="si">{0}</span><span class="s2"> link function does not respect the "</span>
                       <span class="s2">"domain of the </span><span class="si">{1}</span><span class="s2"> family."</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">family</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                                         <span class="n">family</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">),</span>
                              <span class="n">DomainWarning</span><span class="p">)</span>

        <span class="n">groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>  <span class="c1"># in case groups is pandas</span>

        <span class="k">if</span> <span class="s2">"missing_idx"</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">"missing_idx"</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If here, we are entering from super.from_formula; missing</span>
            <span class="c1"># has already been dropped from endog and exog, but not from</span>
            <span class="c1"># the other variables.</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="o">~</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">"missing_idx"</span><span class="p">]</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">exposure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">exposure</span> <span class="o">=</span> <span class="n">exposure</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">"missing_idx"</span><span class="p">]</span>

        <span class="n">_check_args</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">exposure</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">missing</span> <span class="o">=</span> <span class="n">missing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dep_data</span> <span class="o">=</span> <span class="n">dep_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span> <span class="o">=</span> <span class="n">constraint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_dep</span> <span class="o">=</span> <span class="n">update_dep</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_history</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="c1"># Pass groups, time, offset, and dep_data so they are</span>
        <span class="c1"># processed for missing data along with endog and exog.</span>
        <span class="c1"># Calling super creates self.exog, self.endog, etc. as</span>
        <span class="c1"># ndarrays and the original exog, endog, etc. are</span>
        <span class="c1"># self.data.endog, etc.</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GEE</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span>
                                  <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span>
                                  <span class="n">exposure</span><span class="o">=</span><span class="n">exposure</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
                                  <span class="n">dep_data</span><span class="o">=</span><span class="n">dep_data</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="n">missing</span><span class="p">,</span>
                                  <span class="n">family</span><span class="o">=</span><span class="n">family</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_keys</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">"update_dep"</span><span class="p">,</span> <span class="s2">"constraint"</span><span class="p">,</span> <span class="s2">"family"</span><span class="p">,</span>
                                <span class="s2">"cov_struct"</span><span class="p">])</span>
        <span class="c1"># remove keys added by super that are not supported</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">"freq_weights"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_init_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">"var_weights"</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Handle the family argument</span>
        <span class="k">if</span> <span class="n">family</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">family</span> <span class="o">=</span> <span class="n">families</span><span class="o">.</span><span class="n">Gaussian</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">family</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">families</span><span class="o">.</span><span class="n">Family</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"GEE: `family` must be a genmod "</span>
                                 <span class="s2">"family instance"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">family</span>

        <span class="c1"># Handle the cov_struct argument</span>
        <span class="k">if</span> <span class="n">cov_struct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cov_struct</span> <span class="o">=</span> <span class="n">cov_structs</span><span class="o">.</span><span class="n">Independence</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cov_struct</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">cov_structs</span><span class="o">.</span><span class="n">CovStruct</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"GEE: `cov_struct` must be a genmod "</span>
                                 <span class="s2">"cov_struct instance"</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cov_struct</span> <span class="o">=</span> <span class="n">cov_struct</span>

        <span class="c1"># Handle the constraint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">constraint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">constraint</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"GEE: `constraint` must be a 2-tuple."</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"GEE: the left hand side of the constraint must have "</span>
                    <span class="s2">"the same number of columns as the exog matrix."</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span> <span class="o">=</span> <span class="n">ParameterConstraint</span><span class="p">(</span><span class="n">constraint</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                  <span class="n">constraint</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_exposure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_offset_exposure</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">offset_increment</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_offset_exposure</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">offset_increment</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">reduced_exog</span><span class="p">()</span>

        <span class="c1"># Create list of row indices for each group</span>
        <span class="n">group_labels</span><span class="p">,</span> <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">se</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ix</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">"int"</span><span class="p">)</span>
        <span class="n">gb</span> <span class="o">=</span> <span class="n">se</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span>
        <span class="n">dk</span> <span class="o">=</span> <span class="p">[(</span><span class="n">lb</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gb</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">lb</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_labels</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_indices</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">dk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span> <span class="o">=</span> <span class="n">group_labels</span>

        <span class="c1"># Convert the data to the internal representation, which is a</span>
        <span class="c1"># list of arrays, corresponding to the groups.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endog</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weights_li</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_group</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span><span class="p">)</span>

        <span class="c1"># Time defaults to a 1d grid with equal spacing</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_li</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_li</span> <span class="o">=</span> \
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
                 <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">time_li</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset_exposure</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset_exposure</span><span class="p">)</span> <span class="ow">and</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_offset_exposure</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset_li</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset_li</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset_exposure</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">constraint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">exog_fulltrans_li</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">cluster_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">exog_fulltrans</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">family</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cov_struct</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Total sample size</span>
        <span class="n">group_ns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">group_ns</span><span class="p">)</span>
        <span class="c1"># The following are column based, not on rank see #1928</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># assumes constant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Skip the covariance updates if all groups have a single</span>
        <span class="c1"># observation (reduces to fitting a GLM).</span>
        <span class="n">maxgroup</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">maxgroup</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_dep</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Override to allow groups and time to be passed as variable</span>
    <span class="c1"># names.</span>
<div class="viewcode-block" id="GEE.from_formula"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEE.from_formula.html#statsmodels.genmod.generalized_estimating_equations.GEE.from_formula">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_formula</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exposure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Create a GEE model instance from a formula and dataframe.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        formula : str or generic Formula object</span>
<span class="sd">            The formula specifying the model</span>
<span class="sd">        groups : array_like or string</span>
<span class="sd">            Array of grouping labels.  If a string, this is the name</span>
<span class="sd">            of a variable in `data` that contains the grouping labels.</span>
<span class="sd">        data : array_like</span>
<span class="sd">            The data for the model.</span>
<span class="sd">        subset : array_like</span>
<span class="sd">            An array-like object of booleans, integers, or index</span>
<span class="sd">            values that indicate the subset of the data to used when</span>
<span class="sd">            fitting the model.</span>
<span class="sd">        time : array_like or string</span>
<span class="sd">            The time values, used for dependence structures involving</span>
<span class="sd">            distances between observations.  If a string, this is the</span>
<span class="sd">            name of a variable in `data` that contains the time</span>
<span class="sd">            values.</span>
<span class="sd">        offset : array_like or string</span>
<span class="sd">            The offset values, added to the linear predictor.  If a</span>
<span class="sd">            string, this is the name of a variable in `data` that</span>
<span class="sd">            contains the offset values.</span>
<span class="sd">        exposure : array_like or string</span>
<span class="sd">            The exposure values, only used if the link function is the</span>
<span class="sd">            logarithm function, in which case the log of `exposure`</span>
<span class="sd">            is added to the offset (if any).  If a string, this is the</span>
<span class="sd">            name of a variable in `data` that contains the offset</span>
<span class="sd">            values.</span>
<span class="sd">        %(missing_param_doc)s</span>
<span class="sd">        args : extra arguments</span>
<span class="sd">            These are passed to the model</span>
<span class="sd">        kwargs : extra keyword arguments</span>
<span class="sd">            These are passed to the model with two exceptions. `dep_data`</span>
<span class="sd">            is processed as described below.  The ``eval_env`` keyword is</span>
<span class="sd">            passed to patsy. It can be either a</span>
<span class="sd">            :class:`patsy:patsy.EvalEnvironment` object or an integer</span>
<span class="sd">            indicating the depth of the namespace to use. For example, the</span>
<span class="sd">            default ``eval_env=0`` uses the calling namespace.</span>
<span class="sd">            If you wish to use a "clean" environment set ``eval_env=-1``.</span>

<span class="sd">        Optional arguments</span>
<span class="sd">        ------------------</span>
<span class="sd">        dep_data : str or array_like</span>
<span class="sd">            Data used for estimating the dependence structure.  See</span>
<span class="sd">            specific dependence structure classes (e.g. Nested) for</span>
<span class="sd">            details.  If `dep_data` is a string, it is interpreted as</span>
<span class="sd">            a formula that is applied to `data`. If it is an array, it</span>
<span class="sd">            must be an array of strings corresponding to column names in</span>
<span class="sd">            `data`.  Otherwise it must be an array-like with the same</span>
<span class="sd">            number of rows as data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        model : GEE model instance</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        `data` must define __getitem__ with the keys in the formula</span>
<span class="sd">        terms args and kwargs are passed on to the model</span>
<span class="sd">        instantiation. E.g., a numpy structured or rec array, a</span>
<span class="sd">        dictionary, or a pandas DataFrame.</span>
<span class="sd">        """</span> <span class="o">%</span> <span class="p">{</span><span class="s1">'missing_param_doc'</span><span class="p">:</span> <span class="n">base</span><span class="o">.</span><span class="n">_missing_param_doc</span><span class="p">}</span>

        <span class="n">groups_name</span> <span class="o">=</span> <span class="s2">"Groups"</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">groups_name</span> <span class="o">=</span> <span class="n">groups</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">groups</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">time</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exposure</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">exposure</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">exposure</span><span class="p">]</span>

        <span class="n">dep_data</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"dep_data"</span><span class="p">)</span>
        <span class="n">dep_data_names</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">dep_data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dep_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">dep_data</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrix</span><span class="p">(</span><span class="n">dep_data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
                                         <span class="n">return_type</span><span class="o">=</span><span class="s1">'dataframe'</span><span class="p">)</span>
                <span class="n">dep_data_names</span> <span class="o">=</span> <span class="n">dep_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dep_data_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dep_data</span><span class="p">)</span>
                <span class="n">dep_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">dep_data</span><span class="p">]</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">"dep_data"</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dep_data</span><span class="p">)</span>

        <span class="n">family</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">"family"</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">family</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">"family"</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">"family"</span><span class="p">]</span>

        <span class="n">model</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">GEE</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">,</span>
                                             <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
                                             <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span>
                                             <span class="n">exposure</span><span class="o">=</span><span class="n">exposure</span><span class="p">,</span>
                                             <span class="n">family</span><span class="o">=</span><span class="n">family</span><span class="p">,</span>
                                             <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dep_data_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">_dep_data_names</span> <span class="o">=</span> <span class="n">dep_data_names</span>
        <span class="n">model</span><span class="o">.</span><span class="n">_groups_name</span> <span class="o">=</span> <span class="n">groups_name</span>

        <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="GEE.cluster_list"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEE.cluster_list.html#statsmodels.genmod.generalized_estimating_equations.GEE.cluster_list">[docs]</a>    <span class="k">def</span> <span class="nf">cluster_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns `array` split into subarrays corresponding to the</span>
<span class="sd">        cluster structure.</span>
<span class="sd">        """</span>

        <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group_indices</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="p">:])</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">]</span></div>

<div class="viewcode-block" id="GEE.compare_score_test"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEE.compare_score_test.html#statsmodels.genmod.generalized_estimating_equations.GEE.compare_score_test">[docs]</a>    <span class="k">def</span> <span class="nf">compare_score_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submodel</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Perform a score test for the given submodel against this model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        submodel : GEEResults instance</span>
<span class="sd">            A fitted GEE model that is a submodel of this model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A dictionary with keys "statistic", "p-value", and "df",</span>
<span class="sd">        containing the score test statistic, its chi^2 p-value,</span>
<span class="sd">        and the degrees of freedom used to compute the p-value.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The score test can be performed without calling 'fit' on the</span>
<span class="sd">        larger model.  The provided submodel must be obtained from a</span>
<span class="sd">        fitted GEE.</span>

<span class="sd">        This method performs the same score test as can be obtained by</span>
<span class="sd">        fitting the GEE with a linear constraint and calling `score_test`</span>
<span class="sd">        on the results.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        Xu Guo and Wei Pan (2002). "Small sample performance of the score</span>
<span class="sd">        test in GEE".</span>
<span class="sd">        http://www.sph.umn.edu/faculty1/wp-content/uploads/2012/11/rr2002-013.pdf</span>
<span class="sd">        """</span>

        <span class="c1"># Since the model has not been fit, its scaletype has not been</span>
        <span class="c1"># set.  So give it the scaletype of the submodel.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaletype</span> <span class="o">=</span> <span class="n">submodel</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">scaletype</span>

        <span class="c1"># Check consistency between model and submodel (not a comprehensive</span>
        <span class="c1"># check)</span>
        <span class="n">submod</span> <span class="o">=</span> <span class="n">submodel</span><span class="o">.</span><span class="n">model</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">submod</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Model and submodel have different numbers of cases."</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">submod</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Model and submodel have the same number of variables"</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">submod</span><span class="o">.</span><span class="n">family</span><span class="p">)):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Model and submodel have different GLM families."</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_struct</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">submod</span><span class="o">.</span><span class="n">cov_struct</span><span class="p">)):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"Model and submodel have different GEE covariance "</span>
                          <span class="s2">"structures."</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">submod</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Model and submodel should have the same weights."</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Get the positions of the submodel variables in the</span>
        <span class="c1"># parent model</span>
        <span class="n">qm</span><span class="p">,</span> <span class="n">qc</span> <span class="o">=</span> <span class="n">_score_test_submodel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submodel</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">qm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"The provided model is not a submodel."</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Embed the submodel params into a params vector for the</span>
        <span class="c1"># parent model</span>
        <span class="n">params_ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">qm</span><span class="p">,</span> <span class="n">submodel</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>

        <span class="c1"># Attempt to preserve the state of the parent model</span>
        <span class="n">cov_struct_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_struct</span>
        <span class="kn">import</span> <span class="nn">copy</span>
        <span class="n">cached_means_save</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cached_means</span><span class="p">)</span>

        <span class="c1"># Get the score vector of the submodel params in</span>
        <span class="c1"># the parent model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_struct</span> <span class="o">=</span> <span class="n">submodel</span><span class="o">.</span><span class="n">cov_struct</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_cached_means</span><span class="p">(</span><span class="n">params_ex</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_mean_params</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Singular matrix encountered in GEE score test"</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ConvergenceWarning</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"ddof_scale"</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ddof_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"scaling_factor"</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaling_factor</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">ncov1</span><span class="p">,</span> <span class="n">cmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_covmat</span><span class="p">()</span>
        <span class="n">score2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">qc</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">amat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">ncov1</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">amat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">ncov1</span><span class="p">)</span>

        <span class="n">bmat_11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">qm</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cmat</span><span class="p">,</span> <span class="n">qm</span><span class="p">))</span>
        <span class="n">bmat_22</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">qc</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cmat</span><span class="p">,</span> <span class="n">qc</span><span class="p">))</span>
        <span class="n">bmat_12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">qm</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cmat</span><span class="p">,</span> <span class="n">qc</span><span class="p">))</span>

        <span class="n">amat_11</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">qm</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">amat</span><span class="p">,</span> <span class="n">qm</span><span class="p">))</span>
        <span class="n">amat_12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">qm</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">amat</span><span class="p">,</span> <span class="n">qc</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">amat_11</span><span class="p">,</span> <span class="n">bmat_12</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">amat_11</span><span class="p">),</span> <span class="n">bmat_12</span><span class="p">)</span>

        <span class="n">score_cov</span> <span class="o">=</span> <span class="n">bmat_22</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">amat_12</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ab</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">amat_11</span><span class="p">,</span> <span class="n">amat_12</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">amat_11</span><span class="p">),</span> <span class="n">amat_12</span><span class="p">)</span>

        <span class="n">score_cov</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bmat_12</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">aa</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">amat_11</span><span class="p">,</span> <span class="n">bmat_11</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">amat_11</span><span class="p">),</span> <span class="n">bmat_11</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">amat_11</span><span class="p">,</span> <span class="n">amat_12</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">amat_11</span><span class="p">),</span> <span class="n">amat_12</span><span class="p">)</span>

        <span class="n">score_cov</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">amat_12</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">aa</span><span class="p">))</span>

        <span class="c1"># Attempt to restore state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_struct</span> <span class="o">=</span> <span class="n">cov_struct_save</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cached_means</span> <span class="o">=</span> <span class="n">cached_means_save</span>

        <span class="kn">from</span> <span class="nn">scipy.stats.distributions</span> <span class="kn">import</span> <span class="n">chi2</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sc2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">score_cov</span><span class="p">,</span> <span class="n">score2</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">sc2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">score_cov</span><span class="p">),</span> <span class="n">score2</span><span class="p">)</span>
        <span class="n">score_statistic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">score2</span><span class="p">,</span> <span class="n">sc2</span><span class="p">)</span>
        <span class="n">score_df</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">score2</span><span class="p">)</span>
        <span class="n">score_pvalue</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">chi2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">score_statistic</span><span class="p">,</span> <span class="n">score_df</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">"statistic"</span><span class="p">:</span> <span class="n">score_statistic</span><span class="p">,</span>
                <span class="s2">"df"</span><span class="p">:</span> <span class="n">score_df</span><span class="p">,</span>
                <span class="s2">"p-value"</span><span class="p">:</span> <span class="n">score_pvalue</span><span class="p">}</span></div>

<div class="viewcode-block" id="GEE.estimate_scale"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEE.estimate_scale.html#statsmodels.genmod.generalized_estimating_equations.GEE.estimate_scale">[docs]</a>    <span class="k">def</span> <span class="nf">estimate_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Estimate the dispersion/scale.</span>
<span class="sd">        """</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaletype</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="p">,</span> <span class="p">(</span><span class="n">families</span><span class="o">.</span><span class="n">Binomial</span><span class="p">,</span> <span class="n">families</span><span class="o">.</span><span class="n">Poisson</span><span class="p">,</span>
                                        <span class="n">families</span><span class="o">.</span><span class="n">NegativeBinomial</span><span class="p">,</span>
                                        <span class="n">_Multinomial</span><span class="p">)):</span>
                <span class="k">return</span> <span class="mf">1.</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaletype</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaletype</span><span class="p">)</span>

        <span class="n">endog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span>
        <span class="n">cached_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_means</span>
        <span class="n">nobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span>
        <span class="n">varfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">variance</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">fsum</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_group</span><span class="p">):</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">endog</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">expval</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">cached_means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">varfunc</span><span class="p">(</span><span class="n">expval</span><span class="p">))</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="p">(</span><span class="n">endog</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">expval</span><span class="p">)</span> <span class="o">/</span> <span class="n">sdev</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights_li</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">scale</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="p">(</span><span class="n">resid</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">fsum</span> <span class="o">+=</span> <span class="n">f</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scale</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">resid</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">fsum</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>

        <span class="n">scale</span> <span class="o">/=</span> <span class="p">(</span><span class="n">fsum</span> <span class="o">*</span> <span class="p">(</span><span class="n">nobs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddof_scale</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">nobs</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">scale</span></div>

<div class="viewcode-block" id="GEE.mean_deriv"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEE.mean_deriv.html#statsmodels.genmod.generalized_estimating_equations.GEE.mean_deriv">[docs]</a>    <span class="k">def</span> <span class="nf">mean_deriv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">lin_pred</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Derivative of the expected endog with respect to the parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exog : array_like</span>
<span class="sd">           The exogeneous data at which the derivative is computed.</span>
<span class="sd">        lin_pred : array_like</span>
<span class="sd">           The values of the linear predictor.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        The value of the derivative of the expected endog with respect</span>
<span class="sd">        to the parameter vector.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If there is an offset or exposure, it should be added to</span>
<span class="sd">        `lin_pred` prior to calling this function.</span>
<span class="sd">        """</span>

        <span class="n">idl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">inverse_deriv</span><span class="p">(</span><span class="n">lin_pred</span><span class="p">)</span>
        <span class="n">dmat</span> <span class="o">=</span> <span class="n">exog</span> <span class="o">*</span> <span class="n">idl</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dmat</span></div>

<div class="viewcode-block" id="GEE.mean_deriv_exog"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEE.mean_deriv_exog.html#statsmodels.genmod.generalized_estimating_equations.GEE.mean_deriv_exog">[docs]</a>    <span class="k">def</span> <span class="nf">mean_deriv_exog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">offset_exposure</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Derivative of the expected endog with respect to exog.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exog : array_like</span>
<span class="sd">            Values of the independent variables at which the derivative</span>
<span class="sd">            is calculated.</span>
<span class="sd">        params : array_like</span>
<span class="sd">            Parameter values at which the derivative is calculated.</span>
<span class="sd">        offset_exposure : array_like, optional</span>
<span class="sd">            Combined offset and exposure.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        The derivative of the expected endog with respect to exog.</span>
<span class="sd">        """</span>

        <span class="n">lin_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">offset_exposure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lin_pred</span> <span class="o">+=</span> <span class="n">offset_exposure</span>

        <span class="n">idl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">inverse_deriv</span><span class="p">(</span><span class="n">lin_pred</span><span class="p">)</span>
        <span class="n">dmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">idl</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dmat</span></div>

    <span class="k">def</span> <span class="nf">_update_mean_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        update : array_like</span>
<span class="sd">            The update vector such that params + update is the next</span>
<span class="sd">            iterate when solving the score equations.</span>
<span class="sd">        score : array_like</span>
<span class="sd">            The current value of the score equations, not</span>
<span class="sd">            incorporating the scale parameter.  If desired,</span>
<span class="sd">            multiply this vector by the scale parameter to</span>
<span class="sd">            incorporate the scale.</span>
<span class="sd">        """</span>

        <span class="n">endog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span>
        <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"weights_li"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">cached_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_means</span>

        <span class="n">varfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">variance</span>

        <span class="n">bmat</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_group</span><span class="p">):</span>

            <span class="n">expval</span><span class="p">,</span> <span class="n">lpr</span> <span class="o">=</span> <span class="n">cached_means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="n">endog</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">expval</span>
            <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_deriv</span><span class="p">(</span><span class="n">exog</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lpr</span><span class="p">)</span>
            <span class="n">sdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">varfunc</span><span class="p">(</span><span class="n">expval</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">wresid</span> <span class="o">=</span> <span class="n">resid</span> <span class="o">*</span> <span class="n">w</span>
                <span class="n">wdmat</span> <span class="o">=</span> <span class="n">dmat</span> <span class="o">*</span> <span class="n">w</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wresid</span> <span class="o">=</span> <span class="n">resid</span>
                <span class="n">wdmat</span> <span class="o">=</span> <span class="n">dmat</span>

            <span class="n">rslt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_struct</span><span class="o">.</span><span class="n">covariance_matrix_solve</span><span class="p">(</span>
                    <span class="n">expval</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="p">(</span><span class="n">wdmat</span><span class="p">,</span> <span class="n">wresid</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">rslt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">vinv_d</span><span class="p">,</span> <span class="n">vinv_resid</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rslt</span><span class="p">)</span>

            <span class="n">bmat</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dmat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">vinv_d</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dmat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">vinv_resid</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">bmat</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">bmat</span><span class="p">),</span> <span class="n">score</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_history</span><span class="p">[</span><span class="s2">"cov_adjust"</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cov_struct</span><span class="o">.</span><span class="n">cov_adjust</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">update</span><span class="p">,</span> <span class="n">score</span>

<div class="viewcode-block" id="GEE.update_cached_means"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEE.update_cached_means.html#statsmodels.genmod.generalized_estimating_equations.GEE.update_cached_means">[docs]</a>    <span class="k">def</span> <span class="nf">update_cached_means</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean_params</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        cached_means should always contain the most recent calculation</span>
<span class="sd">        of the group-wise mean vectors.  This function should be</span>
<span class="sd">        called every time the regression parameters are changed, to</span>
<span class="sd">        keep the cached means up to date.</span>
<span class="sd">        """</span>

        <span class="n">endog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span>
        <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_li</span>

        <span class="n">linkinv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">inverse</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cached_means</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_group</span><span class="p">):</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">endog</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">lpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mean_params</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lpr</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">expval</span> <span class="o">=</span> <span class="n">linkinv</span><span class="p">(</span><span class="n">lpr</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cached_means</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">expval</span><span class="p">,</span> <span class="n">lpr</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">_covmat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns the sampling covariance matrix of the regression</span>
<span class="sd">        parameters and related quantities.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cov_robust : array_like</span>
<span class="sd">           The robust, or sandwich estimate of the covariance, which</span>
<span class="sd">           is meaningful even if the working covariance structure is</span>
<span class="sd">           incorrectly specified.</span>
<span class="sd">        cov_naive : array_like</span>
<span class="sd">           The model-based estimate of the covariance, which is</span>
<span class="sd">           meaningful if the covariance structure is correctly</span>
<span class="sd">           specified.</span>
<span class="sd">        cmat : array_like</span>
<span class="sd">           The center matrix of the sandwich expression, used in</span>
<span class="sd">           obtaining score test results.</span>
<span class="sd">        """</span>

        <span class="n">endog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span>
        <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"weights_li"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">varfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">variance</span>
        <span class="n">cached_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_means</span>

        <span class="c1"># Calculate the naive (model-based) and robust (sandwich)</span>
        <span class="c1"># covariances.</span>
        <span class="n">bmat</span><span class="p">,</span> <span class="n">cmat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_group</span><span class="p">):</span>

            <span class="n">expval</span><span class="p">,</span> <span class="n">lpr</span> <span class="o">=</span> <span class="n">cached_means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="n">endog</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">expval</span>
            <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_deriv</span><span class="p">(</span><span class="n">exog</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lpr</span><span class="p">)</span>
            <span class="n">sdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">varfunc</span><span class="p">(</span><span class="n">expval</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">wresid</span> <span class="o">=</span> <span class="n">resid</span> <span class="o">*</span> <span class="n">w</span>
                <span class="n">wdmat</span> <span class="o">=</span> <span class="n">dmat</span> <span class="o">*</span> <span class="n">w</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">wresid</span> <span class="o">=</span> <span class="n">resid</span>
                <span class="n">wdmat</span> <span class="o">=</span> <span class="n">dmat</span>

            <span class="n">rslt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_struct</span><span class="o">.</span><span class="n">covariance_matrix_solve</span><span class="p">(</span>
                <span class="n">expval</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="p">(</span><span class="n">wdmat</span><span class="p">,</span> <span class="n">wresid</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">rslt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">vinv_d</span><span class="p">,</span> <span class="n">vinv_resid</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rslt</span><span class="p">)</span>

            <span class="n">bmat</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dmat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">vinv_d</span><span class="p">)</span>
            <span class="n">dvinv_resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dmat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">vinv_resid</span><span class="p">)</span>
            <span class="n">cmat</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">dvinv_resid</span><span class="p">,</span> <span class="n">dvinv_resid</span><span class="p">)</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_scale</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">bmati</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">bmat</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">bmati</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">bmat</span><span class="p">)</span>

        <span class="n">cov_naive</span> <span class="o">=</span> <span class="n">bmati</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="n">cov_robust</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bmati</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cmat</span><span class="p">,</span> <span class="n">bmati</span><span class="p">))</span>

        <span class="n">cov_naive</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling_factor</span>
        <span class="n">cov_robust</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling_factor</span>
        <span class="k">return</span> <span class="n">cov_robust</span><span class="p">,</span> <span class="n">cov_naive</span><span class="p">,</span> <span class="n">cmat</span>

    <span class="c1"># Calculate the bias-corrected sandwich estimate of Mancl and</span>
    <span class="c1"># DeRouen.</span>
    <span class="k">def</span> <span class="nf">_bc_covmat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cov_naive</span><span class="p">):</span>

        <span class="n">cov_naive</span> <span class="o">=</span> <span class="n">cov_naive</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling_factor</span>
        <span class="n">endog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span>
        <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span>
        <span class="n">varfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">variance</span>
        <span class="n">cached_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_means</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_scale</span><span class="p">()</span>

        <span class="n">bcm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_group</span><span class="p">):</span>

            <span class="n">expval</span><span class="p">,</span> <span class="n">lpr</span> <span class="o">=</span> <span class="n">cached_means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="n">endog</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">expval</span>
            <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_deriv</span><span class="p">(</span><span class="n">exog</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lpr</span><span class="p">)</span>
            <span class="n">sdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">varfunc</span><span class="p">(</span><span class="n">expval</span><span class="p">))</span>

            <span class="n">rslt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_struct</span><span class="o">.</span><span class="n">covariance_matrix_solve</span><span class="p">(</span>
                <span class="n">expval</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="p">(</span><span class="n">dmat</span><span class="p">,))</span>
            <span class="k">if</span> <span class="n">rslt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">vinv_d</span> <span class="o">=</span> <span class="n">rslt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">vinv_d</span> <span class="o">/=</span> <span class="n">scale</span>

            <span class="n">hmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vinv_d</span><span class="p">,</span> <span class="n">cov_naive</span><span class="p">)</span>
            <span class="n">hmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">hmat</span><span class="p">,</span> <span class="n">dmat</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

            <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights_li</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mf">1.</span>

            <span class="n">aresid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resid</span><span class="p">))</span> <span class="o">-</span> <span class="n">hmat</span><span class="p">,</span> <span class="n">resid</span><span class="p">)</span>
            <span class="n">rslt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_struct</span><span class="o">.</span><span class="n">covariance_matrix_solve</span><span class="p">(</span>
                <span class="n">expval</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="p">(</span><span class="n">aresid</span><span class="p">,))</span>
            <span class="k">if</span> <span class="n">rslt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">srt</span> <span class="o">=</span> <span class="n">rslt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">srt</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dmat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">srt</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span>
            <span class="n">bcm</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">srt</span><span class="p">,</span> <span class="n">srt</span><span class="p">)</span>

        <span class="n">cov_robust_bc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_naive</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bcm</span><span class="p">,</span> <span class="n">cov_naive</span><span class="p">))</span>
        <span class="n">cov_robust_bc</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling_factor</span>

        <span class="k">return</span> <span class="n">cov_robust_bc</span>

    <span class="k">def</span> <span class="nf">_starting_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_offset_exposure</span><span class="p">):</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_exposure</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">GLM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="p">,</span>
                    <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span> <span class="n">freq_weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span>

<div class="viewcode-block" id="GEE.fit"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEE.fit.html#statsmodels.genmod.generalized_estimating_equations.GEE.fit">[docs]</a>    <span class="nd">@Appender</span><span class="p">(</span><span class="n">_gee_fit_doc</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">ctol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">start_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">params_niter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">first_dep_update</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">cov_type</span><span class="o">=</span><span class="s1">'robust'</span><span class="p">,</span> <span class="n">ddof_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scaling_factor</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scaletype</span> <span class="o">=</span> <span class="n">scale</span>

        <span class="c1"># Subtract this number from the total sample size when</span>
        <span class="c1"># normalizing the scale parameter estimate.</span>
        <span class="k">if</span> <span class="n">ddof_scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ddof_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ddof_scale</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"ddof_scale must be a non-negative number or None"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ddof_scale</span> <span class="o">=</span> <span class="n">ddof_scale</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">scaling_factor</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_fit_history</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cov_type</span> <span class="o">==</span> <span class="s1">'naive'</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"when using weights, cov_type may not be naive"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">start_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mean_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_starting_params</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">start_params</span><span class="p">)</span>
            <span class="n">mean_params</span> <span class="o">=</span> <span class="n">start_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_cached_means</span><span class="p">(</span><span class="n">mean_params</span><span class="p">)</span>

        <span class="n">del_params</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
        <span class="n">num_assoc_updates</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">itr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>

            <span class="n">update</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_mean_params</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">update</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"Singular matrix encountered in GEE update"</span><span class="p">,</span>
                              <span class="n">ConvergenceWarning</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="n">mean_params</span> <span class="o">+=</span> <span class="n">update</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_cached_means</span><span class="p">(</span><span class="n">mean_params</span><span class="p">)</span>

            <span class="c1"># L2 norm of the change in mean structure parameters at</span>
            <span class="c1"># this iteration.</span>
            <span class="n">del_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">score</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_history</span><span class="p">[</span><span class="s1">'params'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_params</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_history</span><span class="p">[</span><span class="s1">'score'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">score</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fit_history</span><span class="p">[</span><span class="s1">'dep_params'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cov_struct</span><span class="o">.</span><span class="n">dep_params</span><span class="p">)</span>

            <span class="c1"># Do not exit until the association parameters have been</span>
            <span class="c1"># updated at least once.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">del_params</span> <span class="o">&lt;</span> <span class="n">ctol</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">num_assoc_updates</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_dep</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)):</span>
                <span class="k">break</span>

            <span class="c1"># Update the dependence structure</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_dep</span> <span class="ow">and</span> <span class="p">(</span><span class="n">itr</span> <span class="o">%</span> <span class="n">params_niter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">itr</span> <span class="o">&gt;=</span> <span class="n">first_dep_update</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_assoc</span><span class="p">(</span><span class="n">mean_params</span><span class="p">)</span>
                <span class="n">num_assoc_updates</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">del_params</span> <span class="o">&gt;=</span> <span class="n">ctol</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"Iteration limit reached prior to convergence"</span><span class="p">,</span>
                          <span class="n">IterationLimitWarning</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mean_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"Unable to estimate GEE parameters."</span><span class="p">,</span>
                          <span class="n">ConvergenceWarning</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">bcov</span><span class="p">,</span> <span class="n">ncov</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_covmat</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">bcov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"Estimated covariance structure for GEE "</span>
                          <span class="s2">"estimates is singular"</span><span class="p">,</span> <span class="n">ConvergenceWarning</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">bc_cov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">cov_type</span> <span class="o">==</span> <span class="s2">"bias_reduced"</span><span class="p">:</span>
            <span class="n">bc_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bc_covmat</span><span class="p">(</span><span class="n">ncov</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">mean_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">mean_params</span><span class="p">,</span> <span class="n">bcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_constraint</span><span class="p">(</span><span class="n">mean_params</span><span class="p">,</span> <span class="n">bcov</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mean_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"Unable to estimate constrained GEE "</span>
                              <span class="s2">"parameters."</span><span class="p">,</span> <span class="n">ConvergenceWarning</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">y</span><span class="p">,</span> <span class="n">ncov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_constraint</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ncov</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"Unable to estimate constrained GEE "</span>
                              <span class="s2">"parameters."</span><span class="p">,</span> <span class="n">ConvergenceWarning</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">bc_cov</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">y</span><span class="p">,</span> <span class="n">bc_cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_constraint</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bc_cov</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"Unable to estimate constrained GEE "</span>
                                  <span class="s2">"parameters."</span><span class="p">,</span> <span class="n">ConvergenceWarning</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_scale</span><span class="p">()</span>

        <span class="c1"># kwargs to add to results instance, need to be available in __init__</span>
        <span class="n">res_kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="n">cov_type</span><span class="p">,</span>
                        <span class="n">cov_robust</span><span class="o">=</span><span class="n">bcov</span><span class="p">,</span>
                        <span class="n">cov_naive</span><span class="o">=</span><span class="n">ncov</span><span class="p">,</span>
                        <span class="n">cov_robust_bc</span><span class="o">=</span><span class="n">bc_cov</span><span class="p">)</span>

        <span class="c1"># The superclass constructor will multiply the covariance</span>
        <span class="c1"># matrix argument bcov by scale, which we do not want, so we</span>
        <span class="c1"># divide bcov by the scale parameter here</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">GEEResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean_params</span><span class="p">,</span> <span class="n">bcov</span> <span class="o">/</span> <span class="n">scale</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span>
                             <span class="n">cov_type</span><span class="o">=</span><span class="n">cov_type</span><span class="p">,</span> <span class="n">use_t</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">attr_kwds</span><span class="o">=</span><span class="n">res_kwds</span><span class="p">)</span>

        <span class="c1"># attributes not needed during results__init__</span>
        <span class="n">results</span><span class="o">.</span><span class="n">fit_history</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_history</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_history</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">score_norm</span> <span class="o">=</span> <span class="n">del_params</span>
        <span class="n">results</span><span class="o">.</span><span class="n">converged</span> <span class="o">=</span> <span class="p">(</span><span class="n">del_params</span> <span class="o">&lt;</span> <span class="n">ctol</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">cov_struct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_struct</span>
        <span class="n">results</span><span class="o">.</span><span class="n">params_niter</span> <span class="o">=</span> <span class="n">params_niter</span>
        <span class="n">results</span><span class="o">.</span><span class="n">first_dep_update</span> <span class="o">=</span> <span class="n">first_dep_update</span>
        <span class="n">results</span><span class="o">.</span><span class="n">ctol</span> <span class="o">=</span> <span class="n">ctol</span>
        <span class="n">results</span><span class="o">.</span><span class="n">maxiter</span> <span class="o">=</span> <span class="n">maxiter</span>

        <span class="c1"># These will be copied over to subclasses when upgrading.</span>
        <span class="n">results</span><span class="o">.</span><span class="n">_props</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"cov_type"</span><span class="p">,</span> <span class="s2">"use_t"</span><span class="p">,</span>
                          <span class="s2">"cov_params_default"</span><span class="p">,</span> <span class="s2">"cov_robust"</span><span class="p">,</span>
                          <span class="s2">"cov_naive"</span><span class="p">,</span> <span class="s2">"cov_robust_bc"</span><span class="p">,</span>
                          <span class="s2">"fit_history"</span><span class="p">,</span>
                          <span class="s2">"score_norm"</span><span class="p">,</span> <span class="s2">"converged"</span><span class="p">,</span> <span class="s2">"cov_struct"</span><span class="p">,</span>
                          <span class="s2">"params_niter"</span><span class="p">,</span> <span class="s2">"first_dep_update"</span><span class="p">,</span> <span class="s2">"ctol"</span><span class="p">,</span>
                          <span class="s2">"maxiter"</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">GEEResultsWrapper</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_update_regularized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pen_wt</span><span class="p">,</span> <span class="n">scad_param</span><span class="p">,</span> <span class="n">eps</span><span class="p">):</span>

        <span class="n">sn</span><span class="p">,</span> <span class="n">hm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_group</span><span class="p">):</span>

            <span class="n">expval</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">expval</span>
            <span class="n">sdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">variance</span><span class="p">(</span><span class="n">expval</span><span class="p">))</span>

            <span class="n">ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">sdev</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">rslt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_struct</span><span class="o">.</span><span class="n">covariance_matrix_solve</span><span class="p">(</span>
                           <span class="n">expval</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>
            <span class="n">sn0</span> <span class="o">=</span> <span class="n">rslt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">sn</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">sn0</span><span class="p">)</span>
            <span class="n">hm0</span> <span class="o">=</span> <span class="n">rslt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">hm</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">hm0</span><span class="p">)</span>

        <span class="c1"># Wang et al. divide sn here by num_group, but that</span>
        <span class="c1"># seems to be incorrect</span>

        <span class="n">ap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">clipped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">scad_param</span> <span class="o">*</span> <span class="n">pen_wt</span> <span class="o">-</span> <span class="n">ap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">en</span> <span class="o">=</span> <span class="n">pen_wt</span> <span class="o">*</span> <span class="n">clipped</span> <span class="o">*</span> <span class="p">(</span><span class="n">ap</span> <span class="o">&gt;</span> <span class="n">pen_wt</span><span class="p">)</span>
        <span class="n">en</span> <span class="o">/=</span> <span class="p">(</span><span class="n">scad_param</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">pen_wt</span>
        <span class="n">en</span> <span class="o">+=</span> <span class="n">pen_wt</span> <span class="o">*</span> <span class="p">(</span><span class="n">ap</span> <span class="o">&lt;=</span> <span class="n">pen_wt</span><span class="p">)</span>
        <span class="n">en</span> <span class="o">/=</span> <span class="n">eps</span> <span class="o">+</span> <span class="n">ap</span>

        <span class="n">hm</span><span class="o">.</span><span class="n">flat</span><span class="p">[::</span><span class="n">hm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_group</span> <span class="o">*</span> <span class="n">en</span>
        <span class="n">sn</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_group</span> <span class="o">*</span> <span class="n">en</span> <span class="o">*</span> <span class="n">params</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">hm</span><span class="p">,</span> <span class="n">sn</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">hm</span><span class="p">),</span> <span class="n">sn</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Encountered singularity in regularized GEE update"</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">hm</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_scale</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">update</span><span class="p">,</span> <span class="n">hm</span>

    <span class="k">def</span> <span class="nf">_regularized_covmat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean_params</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_cached_means</span><span class="p">(</span><span class="n">mean_params</span><span class="p">)</span>

        <span class="n">ma</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_group</span><span class="p">):</span>

            <span class="n">expval</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">expval</span>
            <span class="n">sdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">variance</span><span class="p">(</span><span class="n">expval</span><span class="p">))</span>

            <span class="n">ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">sdev</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">rslt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_struct</span><span class="o">.</span><span class="n">covariance_matrix_solve</span><span class="p">(</span>
                           <span class="n">expval</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">sdev</span><span class="p">,</span> <span class="p">(</span><span class="n">resid</span><span class="p">,))</span>
            <span class="n">ma0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">rslt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ma</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">ma0</span><span class="p">,</span> <span class="n">ma0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ma</span>

<div class="viewcode-block" id="GEE.fit_regularized"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEE.fit_regularized.html#statsmodels.genmod.generalized_estimating_equations.GEE.fit_regularized">[docs]</a>    <span class="k">def</span> <span class="nf">fit_regularized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pen_wt</span><span class="p">,</span> <span class="n">scad_param</span><span class="o">=</span><span class="mf">3.7</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                        <span class="n">ddof_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_assoc</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">ctol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">ztol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Regularized estimation for GEE.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pen_wt : float</span>
<span class="sd">            The penalty weight (a non-negative scalar).</span>
<span class="sd">        scad_param : float</span>
<span class="sd">            Non-negative scalar determining the shape of the Scad</span>
<span class="sd">            penalty.</span>
<span class="sd">        maxiter : int</span>
<span class="sd">            The maximum number of iterations.</span>
<span class="sd">        ddof_scale : int</span>
<span class="sd">            Value to subtract from `nobs` when calculating the</span>
<span class="sd">            denominator degrees of freedom for t-statistics, defaults</span>
<span class="sd">            to the number of columns in `exog`.</span>
<span class="sd">        update_assoc : int</span>
<span class="sd">            The dependence parameters are updated every `update_assoc`</span>
<span class="sd">            iterations of the mean structure parameter updates.</span>
<span class="sd">        ctol : float</span>
<span class="sd">            Convergence criterion, default is one order of magnitude</span>
<span class="sd">            smaller than proposed in section 3.1 of Wang et al.</span>
<span class="sd">        ztol : float</span>
<span class="sd">            Coefficients smaller than this value are treated as</span>
<span class="sd">            being zero, default is based on section 5 of Wang et al.</span>
<span class="sd">        eps : non-negative scalar</span>
<span class="sd">            Numerical constant, see section 3.2 of Wang et al.</span>
<span class="sd">        scale : float or string</span>
<span class="sd">            If a float, this value is used as the scale parameter.</span>
<span class="sd">            If "X2", the scale parameter is always estimated using</span>
<span class="sd">            Pearson's chi-square method (e.g. as in a quasi-Poisson</span>
<span class="sd">            analysis).  If None, the default approach for the family</span>
<span class="sd">            is used to estimate the scale parameter.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        GEEResults instance.  Note that not all methods of the results</span>
<span class="sd">        class make sense when the model has been fit with regularization.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This implementation assumes that the link is canonical.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        Wang L, Zhou J, Qu A. (2012). Penalized generalized estimating</span>
<span class="sd">        equations for high-dimensional longitudinal data analysis.</span>
<span class="sd">        Biometrics. 2012 Jun;68(2):353-60.</span>
<span class="sd">        doi: 10.1111/j.1541-0420.2011.01678.x.</span>
<span class="sd">        https://www.ncbi.nlm.nih.gov/pubmed/21955051</span>
<span class="sd">        http://users.stat.umn.edu/~wangx346/research/GEE_selection.pdf</span>
<span class="sd">        """</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scaletype</span> <span class="o">=</span> <span class="n">scale</span>

        <span class="n">mean_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_cached_means</span><span class="p">(</span><span class="n">mean_params</span><span class="p">)</span>
        <span class="n">converged</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fit_history</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="c1"># Subtract this number from the total sample size when</span>
        <span class="c1"># normalizing the scale parameter estimate.</span>
        <span class="k">if</span> <span class="n">ddof_scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ddof_scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ddof_scale</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"ddof_scale must be a non-negative number or None"</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ddof_scale</span> <span class="o">=</span> <span class="n">ddof_scale</span>

        <span class="c1"># Keep this private for now.  In some cases the early steps are</span>
        <span class="c1"># very small so it seems necessary to ensure a certain minimum</span>
        <span class="c1"># number of iterations before testing for convergence.</span>
        <span class="n">miniter</span> <span class="o">=</span> <span class="mi">20</span>

        <span class="k">for</span> <span class="n">itr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>

            <span class="n">update</span><span class="p">,</span> <span class="n">hm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_regularized</span><span class="p">(</span>
                              <span class="n">mean_params</span><span class="p">,</span> <span class="n">pen_wt</span><span class="p">,</span> <span class="n">scad_param</span><span class="p">,</span> <span class="n">eps</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">update</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">"Singular matrix encountered in regularized GEE update"</span><span class="p">,</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ConvergenceWarning</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">itr</span> <span class="o">&gt;</span> <span class="n">miniter</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">update</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">ctol</span><span class="p">:</span>
                <span class="n">converged</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="n">mean_params</span> <span class="o">+=</span> <span class="n">update</span>
            <span class="n">fit_history</span><span class="p">[</span><span class="s1">'params'</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_params</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_cached_means</span><span class="p">(</span><span class="n">mean_params</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">itr</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">itr</span> <span class="o">%</span> <span class="n">update_assoc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_assoc</span><span class="p">(</span><span class="n">mean_params</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">converged</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"GEE.fit_regularized did not converge"</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">mean_params</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mean_params</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ztol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_assoc</span><span class="p">(</span><span class="n">mean_params</span><span class="p">)</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_regularized_covmat</span><span class="p">(</span><span class="n">mean_params</span><span class="p">)</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">hm</span><span class="p">,</span> <span class="n">ma</span><span class="p">)</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">hm</span><span class="p">,</span> <span class="n">cov</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># kwargs to add to results instance, need to be available in __init__</span>
        <span class="n">res_kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="s2">"robust"</span><span class="p">,</span> <span class="n">cov_robust</span><span class="o">=</span><span class="n">cov</span><span class="p">)</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_scale</span><span class="p">()</span>
        <span class="n">rslt</span> <span class="o">=</span> <span class="n">GEEResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean_params</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span>
                          <span class="n">regularized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">attr_kwds</span><span class="o">=</span><span class="n">res_kwds</span><span class="p">)</span>
        <span class="n">rslt</span><span class="o">.</span><span class="n">fit_history</span> <span class="o">=</span> <span class="n">fit_history</span>

        <span class="k">return</span> <span class="n">GEEResultsWrapper</span><span class="p">(</span><span class="n">rslt</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_handle_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mean_params</span><span class="p">,</span> <span class="n">bcov</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Expand the parameter estimate `mean_params` and covariance matrix</span>
<span class="sd">        `bcov` to the coordinate system of the unconstrained model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mean_params : array_like</span>
<span class="sd">            A parameter vector estimate for the reduced model.</span>
<span class="sd">        bcov : array_like</span>
<span class="sd">            The covariance matrix of mean_params.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        mean_params : array_like</span>
<span class="sd">            The input parameter vector mean_params, expanded to the</span>
<span class="sd">            coordinate system of the full model</span>
<span class="sd">        bcov : array_like</span>
<span class="sd">            The input covariance matrix bcov, expanded to the</span>
<span class="sd">            coordinate system of the full model</span>
<span class="sd">        """</span>

        <span class="c1"># The number of variables in the full model</span>
        <span class="n">red_p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean_params</span><span class="p">)</span>
        <span class="n">full_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">lhs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mean_params0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">mean_params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">full_p</span> <span class="o">-</span> <span class="n">red_p</span><span class="p">)]</span>

        <span class="c1"># Get the score vector under the full model.</span>
        <span class="n">save_exog_li</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">exog_fulltrans_li</span>
        <span class="kn">import</span> <span class="nn">copy</span>
        <span class="n">save_cached_means</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cached_means</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_cached_means</span><span class="p">(</span><span class="n">mean_params0</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_mean_params</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">score</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"Singular matrix encountered in GEE score test"</span><span class="p">,</span>
                          <span class="n">ConvergenceWarning</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">ncov1</span><span class="p">,</span> <span class="n">cmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_covmat</span><span class="p">()</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimate_scale</span><span class="p">()</span>
        <span class="n">cmat</span> <span class="o">=</span> <span class="n">cmat</span> <span class="o">/</span> <span class="n">scale</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">score2</span> <span class="o">=</span> <span class="n">score</span><span class="p">[</span><span class="n">red_p</span><span class="p">:]</span> <span class="o">/</span> <span class="n">scale</span>
        <span class="n">amat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">ncov1</span><span class="p">)</span>

        <span class="n">bmat_11</span> <span class="o">=</span> <span class="n">cmat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">red_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">red_p</span><span class="p">]</span>
        <span class="n">bmat_22</span> <span class="o">=</span> <span class="n">cmat</span><span class="p">[</span><span class="n">red_p</span><span class="p">:,</span> <span class="n">red_p</span><span class="p">:]</span>
        <span class="n">bmat_12</span> <span class="o">=</span> <span class="n">cmat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">red_p</span><span class="p">,</span> <span class="n">red_p</span><span class="p">:]</span>
        <span class="n">amat_11</span> <span class="o">=</span> <span class="n">amat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">red_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">red_p</span><span class="p">]</span>
        <span class="n">amat_12</span> <span class="o">=</span> <span class="n">amat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">red_p</span><span class="p">,</span> <span class="n">red_p</span><span class="p">:]</span>

        <span class="n">score_cov</span> <span class="o">=</span> <span class="n">bmat_22</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">amat_12</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                     <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">amat_11</span><span class="p">,</span> <span class="n">bmat_12</span><span class="p">))</span>
        <span class="n">score_cov</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">bmat_12</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">amat_11</span><span class="p">,</span> <span class="n">amat_12</span><span class="p">))</span>
        <span class="n">score_cov</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">amat_12</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">amat_11</span><span class="p">,</span> <span class="n">bmat_11</span><span class="p">),</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">amat_11</span><span class="p">,</span> <span class="n">amat_12</span><span class="p">)))</span>

        <span class="kn">from</span> <span class="nn">scipy.stats.distributions</span> <span class="kn">import</span> <span class="n">chi2</span>
        <span class="n">score_statistic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">score2</span><span class="p">,</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">score_cov</span><span class="p">,</span> <span class="n">score2</span><span class="p">))</span>
        <span class="n">score_df</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">score2</span><span class="p">)</span>
        <span class="n">score_pvalue</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">chi2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">score_statistic</span><span class="p">,</span> <span class="n">score_df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score_test_results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"statistic"</span><span class="p">:</span> <span class="n">score_statistic</span><span class="p">,</span>
                                   <span class="s2">"df"</span><span class="p">:</span> <span class="n">score_df</span><span class="p">,</span>
                                   <span class="s2">"p-value"</span><span class="p">:</span> <span class="n">score_pvalue</span><span class="p">}</span>

        <span class="n">mean_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">unpack_param</span><span class="p">(</span><span class="n">mean_params</span><span class="p">)</span>
        <span class="n">bcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">unpack_cov</span><span class="p">(</span><span class="n">bcov</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span> <span class="o">=</span> <span class="n">save_exog_li</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cached_means</span> <span class="o">=</span> <span class="n">save_cached_means</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">restore_exog</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">mean_params</span><span class="p">,</span> <span class="n">bcov</span>

    <span class="k">def</span> <span class="nf">_update_assoc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Update the association parameters</span>
<span class="sd">        """</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cov_struct</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_derivative_exog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="s1">'dydx'</span><span class="p">,</span>
                         <span class="n">dummy_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">count_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        For computing marginal effects, returns dF(XB) / dX where F(.)</span>
<span class="sd">        is the fitted mean.</span>

<span class="sd">        transform can be 'dydx', 'dyex', 'eydx', or 'eyex'.</span>

<span class="sd">        Not all of these make sense in the presence of discrete regressors,</span>
<span class="sd">        but checks are done in the results in get_margeff.</span>
<span class="sd">        """</span>
        <span class="c1"># This form should be appropriate for group 1 probit, logit,</span>
        <span class="c1"># logistic, cloglog, heckprob, xtprobit.</span>
        <span class="n">offset_exposure</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">exog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span>
            <span class="n">offset_exposure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_offset_exposure</span>

        <span class="n">margeff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_deriv_exog</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">offset_exposure</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">'ex'</span> <span class="ow">in</span> <span class="n">transform</span><span class="p">:</span>
            <span class="n">margeff</span> <span class="o">*=</span> <span class="n">exog</span>
        <span class="k">if</span> <span class="s1">'ey'</span> <span class="ow">in</span> <span class="n">transform</span><span class="p">:</span>
            <span class="n">margeff</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">exog</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">count_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">statsmodels.discrete.discrete_margins</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">_get_count_effects</span><span class="p">)</span>
            <span class="n">margeff</span> <span class="o">=</span> <span class="n">_get_count_effects</span><span class="p">(</span><span class="n">margeff</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">count_idx</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dummy_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">statsmodels.discrete.discrete_margins</span> <span class="kn">import</span> <span class="p">(</span>
                <span class="n">_get_dummy_effects</span><span class="p">)</span>
            <span class="n">margeff</span> <span class="o">=</span> <span class="n">_get_dummy_effects</span><span class="p">(</span><span class="n">margeff</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">dummy_idx</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">margeff</span>

<div class="viewcode-block" id="GEE.qic"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEE.qic.html#statsmodels.genmod.generalized_estimating_equations.GEE.qic">[docs]</a>    <span class="k">def</span> <span class="nf">qic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">cov_params</span><span class="p">,</span> <span class="n">n_step</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns quasi-information criteria and quasi-likelihood values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : array_like</span>
<span class="sd">            The GEE estimates of the regression parameters.</span>
<span class="sd">        scale : scalar</span>
<span class="sd">            Estimated scale parameter</span>
<span class="sd">        cov_params : array_like</span>
<span class="sd">            An estimate of the covariance matrix for the</span>
<span class="sd">            model parameters.  Conventionally this is the robust</span>
<span class="sd">            covariance matrix.</span>
<span class="sd">        n_step : integer</span>
<span class="sd">            The number of points in the trapezoidal approximation</span>
<span class="sd">            to the quasi-likelihood function.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ql : scalar</span>
<span class="sd">            The quasi-likelihood value</span>
<span class="sd">        qic : scalar</span>
<span class="sd">            A QIC that can be used to compare the mean and covariance</span>
<span class="sd">            structures of the model.</span>
<span class="sd">        qicu : scalar</span>
<span class="sd">            A simplified QIC that can be used to compare mean structures</span>
<span class="sd">            but not covariance structures</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The quasi-likelihood used here is obtained by numerically evaluating</span>
<span class="sd">        Wedderburn's integral representation of the quasi-likelihood function.</span>
<span class="sd">        This approach is valid for all families and  links.  Many other</span>
<span class="sd">        packages use analytical expressions for quasi-likelihoods that are</span>
<span class="sd">        valid in special cases where the link function is canonical.  These</span>
<span class="sd">        analytical expressions may omit additive constants that only depend</span>
<span class="sd">        on the data.  Therefore, the numerical values of our QL and QIC values</span>
<span class="sd">        will differ from the values reported by other packages.  However only</span>
<span class="sd">        the differences between two QIC values calculated for different models</span>
<span class="sd">        using the same data are meaningful.  Our QIC should produce the same</span>
<span class="sd">        QIC differences as other software.</span>

<span class="sd">        When using the QIC for models with unknown scale parameter, use a</span>
<span class="sd">        common estimate of the scale parameter for all models being compared.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [*] W. Pan (2001).  Akaike's information criterion in generalized</span>
<span class="sd">               estimating equations.  Biometrics (57) 1.</span>
<span class="sd">        """</span>

        <span class="n">varfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">variance</span>

        <span class="n">means</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">omega</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># omega^-1 is the model-based covariance assuming independence</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_group</span><span class="p">):</span>
            <span class="n">expval</span><span class="p">,</span> <span class="n">lpr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expval</span><span class="p">)</span>
            <span class="n">dmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_deriv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lpr</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dmat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dmat</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale</span>

        <span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">means</span><span class="p">)</span>

        <span class="c1"># The quasi-likelihood, use change of variables so the integration is</span>
        <span class="c1"># from -1 to 1.</span>
        <span class="n">endog_li</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span><span class="p">)</span>
        <span class="n">du</span> <span class="o">=</span> <span class="n">means</span> <span class="o">-</span> <span class="n">endog_li</span>
        <span class="n">qv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n_step</span><span class="p">)</span>
        <span class="n">xv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.99999</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_step</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xv</span><span class="p">):</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">endog_li</span> <span class="o">+</span> <span class="p">(</span><span class="n">g</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">du</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">vu</span> <span class="o">=</span> <span class="n">varfunc</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
            <span class="n">qv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">du</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">g</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">vu</span><span class="p">)</span>
        <span class="n">qv</span> <span class="o">/=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">trapz</span>
        <span class="n">ql</span> <span class="o">=</span> <span class="n">trapz</span><span class="p">(</span><span class="n">qv</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="n">xv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">xv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">qicu</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ql</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">qic</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ql</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="n">cov_params</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ql</span><span class="p">,</span> <span class="n">qic</span><span class="p">,</span> <span class="n">qicu</span></div></div>


<div class="viewcode-block" id="GEEResults"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEEResults.html#statsmodels.genmod.generalized_estimating_equations.GEEResults">[docs]</a><span class="k">class</span> <span class="nc">GEEResults</span><span class="p">(</span><span class="n">GLMResults</span><span class="p">):</span>

    <span class="vm">__doc__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"This class summarizes the fit of a marginal regression model "</span>
        <span class="s2">"using GEE.</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span> <span class="n">_gee_results_doc</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">cov_params</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span>
                 <span class="n">cov_type</span><span class="o">=</span><span class="s1">'robust'</span><span class="p">,</span> <span class="n">use_t</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">regularized</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">GEEResults</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">normalized_cov_params</span><span class="o">=</span><span class="n">cov_params</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">)</span>

        <span class="c1"># not added by super</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_resid</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">df_resid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">df_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">family</span>

        <span class="n">attr_kwds</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'attr_kwds'</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attr_kwds</span><span class="p">)</span>

        <span class="c1"># we do not do this if the cov_type has already been set</span>
        <span class="c1"># subclasses can set it through attr_kwds</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">'cov_type'</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">'cov_params_default'</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">=</span> <span class="n">cov_type</span>  <span class="c1"># keep alias</span>
            <span class="n">covariance_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">allowed_covariances</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"robust"</span><span class="p">,</span> <span class="s2">"naive"</span><span class="p">,</span> <span class="s2">"bias_reduced"</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">covariance_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_covariances</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"GEE: `cov_type` must be one of "</span> <span class="o">+</span>
                       <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allowed_covariances</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cov_type</span> <span class="o">==</span> <span class="s2">"robust"</span><span class="p">:</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_robust</span>
            <span class="k">elif</span> <span class="n">cov_type</span> <span class="o">==</span> <span class="s2">"naive"</span><span class="p">:</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_naive</span>
            <span class="k">elif</span> <span class="n">cov_type</span> <span class="o">==</span> <span class="s2">"bias_reduced"</span><span class="p">:</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_robust_bc</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cov_params_default</span> <span class="o">=</span> <span class="n">cov</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_type</span> <span class="o">!=</span> <span class="n">cov_type</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'cov_type in argument is different from '</span>
                                 <span class="s1">'already attached cov_type'</span><span class="p">)</span>

    <span class="nd">@cache_readonly</span>
    <span class="k">def</span> <span class="nf">resid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        The response residuals.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">resid_response</span>

<div class="viewcode-block" id="GEEResults.standard_errors"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEEResults.standard_errors.html#statsmodels.genmod.generalized_estimating_equations.GEEResults.standard_errors">[docs]</a>    <span class="k">def</span> <span class="nf">standard_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cov_type</span><span class="o">=</span><span class="s2">"robust"</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        This is a convenience function that returns the standard</span>
<span class="sd">        errors for any covariance type.  The value of `bse` is the</span>
<span class="sd">        standard errors for whichever covariance type is specified as</span>
<span class="sd">        an argument to `fit` (defaults to "robust").</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cov_type : str</span>
<span class="sd">            One of "robust", "naive", or "bias_reduced".  Determines</span>
<span class="sd">            the covariance used to compute standard errors.  Defaults</span>
<span class="sd">            to "robust".</span>
<span class="sd">        """</span>

        <span class="c1"># Check covariance_type</span>
        <span class="n">covariance_type</span> <span class="o">=</span> <span class="n">cov_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">allowed_covariances</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"robust"</span><span class="p">,</span> <span class="s2">"naive"</span><span class="p">,</span> <span class="s2">"bias_reduced"</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">covariance_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_covariances</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"GEE: `covariance_type` must be one of "</span> <span class="o">+</span>
                   <span class="s2">", "</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">allowed_covariances</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">covariance_type</span> <span class="o">==</span> <span class="s2">"robust"</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_robust</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">covariance_type</span> <span class="o">==</span> <span class="s2">"naive"</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_naive</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">covariance_type</span> <span class="o">==</span> <span class="s2">"bias_reduced"</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_robust_bc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">"GEE: `bias_reduced` covariance not available"</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_robust_bc</span><span class="p">))</span></div>

    <span class="c1"># Need to override to allow for different covariance types.</span>
    <span class="nd">@cache_readonly</span>
    <span class="k">def</span> <span class="nf">bse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard_errors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_type</span><span class="p">)</span>

<div class="viewcode-block" id="GEEResults.score_test"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEEResults.score_test.html#statsmodels.genmod.generalized_estimating_equations.GEEResults.score_test">[docs]</a>    <span class="k">def</span> <span class="nf">score_test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Return the results of a score test for a linear constraint.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Adictionary containing the p-value, the test statistic,</span>
<span class="sd">        and the degrees of freedom for the score test.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        See also GEE.compare_score_test for an alternative way to perform</span>
<span class="sd">        a score test.  GEEResults.score_test is more general, in that it</span>
<span class="sd">        supports testing arbitrary linear equality constraints.   However</span>
<span class="sd">        GEE.compare_score_test might be easier to use when comparing</span>
<span class="sd">        two explicit models.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        Xu Guo and Wei Pan (2002). "Small sample performance of the score</span>
<span class="sd">        test in GEE".</span>
<span class="sd">        http://www.sph.umn.edu/faculty1/wp-content/uploads/2012/11/rr2002-013.pdf</span>
<span class="sd">        """</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s2">"score_test_results"</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">"score_test on results instance only available when "</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="s2">" model was fit with constraints"</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">score_test_results</span></div>

    <span class="nd">@cache_readonly</span>
    <span class="k">def</span> <span class="nf">resid_split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns the residuals, the endogeneous data minus the fitted</span>
<span class="sd">        values from the model.  The residuals are returned as a list</span>
<span class="sd">        of arrays containing the residuals for each cluster.</span>
<span class="sd">        """</span>
        <span class="n">sresid</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">group_labels</span><span class="p">:</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">group_indices</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="n">sresid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resid</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">sresid</span>

    <span class="nd">@cache_readonly</span>
    <span class="k">def</span> <span class="nf">resid_centered</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns the residuals centered within each group.</span>
<span class="sd">        """</span>
        <span class="n">cresid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">group_labels</span><span class="p">:</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">group_indices</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="n">cresid</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="n">cresid</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">cresid</span>

    <span class="nd">@cache_readonly</span>
    <span class="k">def</span> <span class="nf">resid_centered_split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns the residuals centered within each group.  The</span>
<span class="sd">        residuals are returned as a list of arrays containing the</span>
<span class="sd">        centered residuals for each cluster.</span>
<span class="sd">        """</span>
        <span class="n">sresid</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">group_labels</span><span class="p">:</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">group_indices</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
            <span class="n">sresid</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centered_resid</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">sresid</span>

<div class="viewcode-block" id="GEEResults.qic"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEEResults.qic.html#statsmodels.genmod.generalized_estimating_equations.GEEResults.qic">[docs]</a>    <span class="k">def</span> <span class="nf">qic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_step</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns the QIC and QICu information criteria.</span>

<span class="sd">        See GEE.qic for documentation.</span>
<span class="sd">        """</span>

        <span class="c1"># It is easy to forget to set the scale parameter.  Sometimes</span>
        <span class="c1"># this is intentional, so we warn.</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"QIC values obtained using scale=None are not "</span>
                          <span class="s2">"appropriate for comparing models"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scale</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">qic</span><span class="p">,</span> <span class="n">qicu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">qic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">cov_params</span><span class="p">(),</span>
                                      <span class="n">n_step</span><span class="o">=</span><span class="n">n_step</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">qic</span><span class="p">,</span> <span class="n">qicu</span></div>

    <span class="c1"># FIXME: alias to be removed, temporary backwards compatibility</span>
    <span class="n">split_resid</span> <span class="o">=</span> <span class="n">resid_split</span>
    <span class="n">centered_resid</span> <span class="o">=</span> <span class="n">resid_centered</span>
    <span class="n">split_centered_resid</span> <span class="o">=</span> <span class="n">resid_centered_split</span>

<div class="viewcode-block" id="GEEResults.plot_added_variable"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEEResults.plot_added_variable.html#statsmodels.genmod.generalized_estimating_equations.GEEResults.plot_added_variable">[docs]</a>    <span class="nd">@Appender</span><span class="p">(</span><span class="n">_plot_added_variable_doc</span> <span class="o">%</span> <span class="p">{</span><span class="s1">'extra_params_doc'</span><span class="p">:</span> <span class="s1">''</span><span class="p">})</span>
    <span class="k">def</span> <span class="nf">plot_added_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">focus_exog</span><span class="p">,</span> <span class="n">resid_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">use_glm_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fit_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">statsmodels.graphics.regressionplots</span> <span class="kn">import</span> <span class="n">plot_added_variable</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_added_variable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">focus_exog</span><span class="p">,</span>
                                  <span class="n">resid_type</span><span class="o">=</span><span class="n">resid_type</span><span class="p">,</span>
                                  <span class="n">use_glm_weights</span><span class="o">=</span><span class="n">use_glm_weights</span><span class="p">,</span>
                                  <span class="n">fit_kwargs</span><span class="o">=</span><span class="n">fit_kwargs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="GEEResults.plot_partial_residuals"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEEResults.plot_partial_residuals.html#statsmodels.genmod.generalized_estimating_equations.GEEResults.plot_partial_residuals">[docs]</a>    <span class="nd">@Appender</span><span class="p">(</span><span class="n">_plot_partial_residuals_doc</span> <span class="o">%</span> <span class="p">{</span><span class="s1">'extra_params_doc'</span><span class="p">:</span> <span class="s1">''</span><span class="p">})</span>
    <span class="k">def</span> <span class="nf">plot_partial_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">focus_exog</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">statsmodels.graphics.regressionplots</span> <span class="kn">import</span> <span class="n">plot_partial_residuals</span>

        <span class="k">return</span> <span class="n">plot_partial_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">focus_exog</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span></div>

<div class="viewcode-block" id="GEEResults.plot_ceres_residuals"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEEResults.plot_ceres_residuals.html#statsmodels.genmod.generalized_estimating_equations.GEEResults.plot_ceres_residuals">[docs]</a>    <span class="nd">@Appender</span><span class="p">(</span><span class="n">_plot_ceres_residuals_doc</span> <span class="o">%</span> <span class="p">{</span><span class="s1">'extra_params_doc'</span><span class="p">:</span> <span class="s1">''</span><span class="p">})</span>
    <span class="k">def</span> <span class="nf">plot_ceres_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">focus_exog</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.66</span><span class="p">,</span> <span class="n">cond_means</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="kn">from</span> <span class="nn">statsmodels.graphics.regressionplots</span> <span class="kn">import</span> <span class="n">plot_ceres_residuals</span>

        <span class="k">return</span> <span class="n">plot_ceres_residuals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">focus_exog</span><span class="p">,</span> <span class="n">frac</span><span class="p">,</span>
                                    <span class="n">cond_means</span><span class="o">=</span><span class="n">cond_means</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span></div>

<div class="viewcode-block" id="GEEResults.conf_int"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEEResults.conf_int.html#statsmodels.genmod.generalized_estimating_equations.GEEResults.conf_int">[docs]</a>    <span class="k">def</span> <span class="nf">conf_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.05</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cov_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns confidence intervals for the fitted parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alpha : float, optional</span>
<span class="sd">             The `alpha` level for the confidence interval.  i.e., The</span>
<span class="sd">             default `alpha` = .05 returns a 95% confidence interval.</span>
<span class="sd">        cols : array_like, optional</span>
<span class="sd">             `cols` specifies which confidence intervals to return</span>
<span class="sd">        cov_type : str</span>
<span class="sd">             The covariance type used for computing standard errors;</span>
<span class="sd">             must be one of 'robust', 'naive', and 'bias reduced'.</span>
<span class="sd">             See `GEE` for details.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The confidence interval is based on the Gaussian distribution.</span>
<span class="sd">        """</span>
        <span class="c1"># super does not allow to specify cov_type and method is not</span>
        <span class="c1"># implemented,</span>
        <span class="c1"># FIXME: remove this method here</span>
        <span class="k">if</span> <span class="n">cov_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bse</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard_errors</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="n">cov_type</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">bse</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">+</span> <span class="n">q</span> <span class="o">*</span> <span class="n">bse</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">bse</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">+</span> <span class="n">q</span> <span class="o">*</span> <span class="n">bse</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lzip</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">))</span></div>

<div class="viewcode-block" id="GEEResults.summary"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEEResults.summary.html#statsmodels.genmod.generalized_estimating_equations.GEEResults.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.05</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Summarize the GEE regression results</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        yname : str, optional</span>
<span class="sd">            Default is `y`</span>
<span class="sd">        xname : list[str], optional</span>
<span class="sd">            Names for the exogenous variables, default is `var_#` for ## in</span>
<span class="sd">            the number of regressors. Must match the number of parameters in</span>
<span class="sd">            the model</span>
<span class="sd">        title : str, optional</span>
<span class="sd">            Title for the top table. If not None, then this replaces</span>
<span class="sd">            the default title</span>
<span class="sd">        alpha : float</span>
<span class="sd">            significance level for the confidence intervals</span>
<span class="sd">        cov_type : str</span>
<span class="sd">            The covariance type used to compute the standard errors;</span>
<span class="sd">            one of 'robust' (the usual robust sandwich-type covariance</span>
<span class="sd">            estimate), 'naive' (ignores dependence), and 'bias</span>
<span class="sd">            reduced' (the Mancl/DeRouen estimate).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        smry : Summary instance</span>
<span class="sd">            this holds the summary tables and text, which can be</span>
<span class="sd">            printed or converted to various output formats.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        statsmodels.iolib.summary.Summary : class to hold summary results</span>
<span class="sd">        """</span>

        <span class="n">top_left</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">'Dep. Variable:'</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">'Model:'</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">'Method:'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'Generalized'</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="p">[</span><span class="s1">'Estimating Equations'</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s1">'Family:'</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s1">'Dependence structure:'</span><span class="p">,</span>
                     <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cov_struct</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s1">'Date:'</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">'Covariance type: '</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_type</span><span class="p">,</span> <span class="p">])</span>
                    <span class="p">]</span>

        <span class="n">NY</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog_li</span><span class="p">]</span>

        <span class="n">top_right</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">'No. Observations:'</span><span class="p">,</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">NY</span><span class="p">)]),</span>
                     <span class="p">(</span><span class="s1">'No. clusters:'</span><span class="p">,</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog_li</span><span class="p">)]),</span>
                     <span class="p">(</span><span class="s1">'Min. cluster size:'</span><span class="p">,</span> <span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">NY</span><span class="p">)]),</span>
                     <span class="p">(</span><span class="s1">'Max. cluster size:'</span><span class="p">,</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">NY</span><span class="p">)]),</span>
                     <span class="p">(</span><span class="s1">'Mean cluster size:'</span><span class="p">,</span> <span class="p">[</span><span class="s2">"</span><span class="si">%.1f</span><span class="s2">"</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">NY</span><span class="p">)]),</span>
                     <span class="p">(</span><span class="s1">'Num. iterations:'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'</span><span class="si">%d</span><span class="s1">'</span> <span class="o">%</span>
                                           <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_history</span><span class="p">[</span><span class="s1">'params'</span><span class="p">])]),</span>
                     <span class="p">(</span><span class="s1">'Scale:'</span><span class="p">,</span> <span class="p">[</span><span class="s2">"</span><span class="si">%.3f</span><span class="s2">"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">]),</span>
                     <span class="p">(</span><span class="s1">'Time:'</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                     <span class="p">]</span>

        <span class="c1"># The skew of the residuals</span>
        <span class="n">skew1</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span>
        <span class="n">kurt1</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span>
        <span class="n">skew2</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centered_resid</span><span class="p">)</span>
        <span class="n">kurt2</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centered_resid</span><span class="p">)</span>

        <span class="n">diagn_left</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">'Skew:'</span><span class="p">,</span> <span class="p">[</span><span class="s2">"</span><span class="si">%12.4f</span><span class="s2">"</span> <span class="o">%</span> <span class="n">skew1</span><span class="p">]),</span>
                      <span class="p">(</span><span class="s1">'Centered skew:'</span><span class="p">,</span> <span class="p">[</span><span class="s2">"</span><span class="si">%12.4f</span><span class="s2">"</span> <span class="o">%</span> <span class="n">skew2</span><span class="p">])]</span>

        <span class="n">diagn_right</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">'Kurtosis:'</span><span class="p">,</span> <span class="p">[</span><span class="s2">"</span><span class="si">%12.4f</span><span class="s2">"</span> <span class="o">%</span> <span class="n">kurt1</span><span class="p">]),</span>
                       <span class="p">(</span><span class="s1">'Centered kurtosis:'</span><span class="p">,</span> <span class="p">[</span><span class="s2">"</span><span class="si">%12.4f</span><span class="s2">"</span> <span class="o">%</span> <span class="n">kurt2</span><span class="p">])</span>
                       <span class="p">]</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">' '</span> <span class="o">+</span>\
                <span class="s2">"Regression Results"</span>

        <span class="c1"># Override the exog variable names if xname is provided as an</span>
        <span class="c1"># argument.</span>
        <span class="k">if</span> <span class="n">xname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_names</span>

        <span class="k">if</span> <span class="n">yname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog_names</span>

        <span class="c1"># Create summary table instance</span>
        <span class="kn">from</span> <span class="nn">statsmodels.iolib.summary</span> <span class="kn">import</span> <span class="n">Summary</span>
        <span class="n">smry</span> <span class="o">=</span> <span class="n">Summary</span><span class="p">()</span>
        <span class="n">smry</span><span class="o">.</span><span class="n">add_table_2cols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gleft</span><span class="o">=</span><span class="n">top_left</span><span class="p">,</span> <span class="n">gright</span><span class="o">=</span><span class="n">top_right</span><span class="p">,</span>
                             <span class="n">yname</span><span class="o">=</span><span class="n">yname</span><span class="p">,</span> <span class="n">xname</span><span class="o">=</span><span class="n">xname</span><span class="p">,</span>
                             <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="n">smry</span><span class="o">.</span><span class="n">add_table_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yname</span><span class="o">=</span><span class="n">yname</span><span class="p">,</span> <span class="n">xname</span><span class="o">=</span><span class="n">xname</span><span class="p">,</span>
                              <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">use_t</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">smry</span><span class="o">.</span><span class="n">add_table_2cols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gleft</span><span class="o">=</span><span class="n">diagn_left</span><span class="p">,</span>
                             <span class="n">gright</span><span class="o">=</span><span class="n">diagn_right</span><span class="p">,</span> <span class="n">yname</span><span class="o">=</span><span class="n">yname</span><span class="p">,</span>
                             <span class="n">xname</span><span class="o">=</span><span class="n">xname</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">smry</span></div>

<div class="viewcode-block" id="GEEResults.get_margeff"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEEResults.get_margeff.html#statsmodels.genmod.generalized_estimating_equations.GEEResults.get_margeff">[docs]</a>    <span class="k">def</span> <span class="nf">get_margeff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="s1">'overall'</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">'dydx'</span><span class="p">,</span> <span class="n">atexog</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">dummy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">"""Get marginal effects of the fitted model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        at : str, optional</span>
<span class="sd">            Options are:</span>

<span class="sd">            - 'overall', The average of the marginal effects at each</span>
<span class="sd">              observation.</span>
<span class="sd">            - 'mean', The marginal effects at the mean of each regressor.</span>
<span class="sd">            - 'median', The marginal effects at the median of each regressor.</span>
<span class="sd">            - 'zero', The marginal effects at zero for each regressor.</span>
<span class="sd">            - 'all', The marginal effects at each observation. If `at` is 'all'</span>
<span class="sd">              only margeff will be available.</span>

<span class="sd">            Note that if `exog` is specified, then marginal effects for all</span>
<span class="sd">            variables not specified by `exog` are calculated using the `at`</span>
<span class="sd">            option.</span>
<span class="sd">        method : str, optional</span>
<span class="sd">            Options are:</span>

<span class="sd">            - 'dydx' - dy/dx - No transformation is made and marginal effects</span>
<span class="sd">              are returned.  This is the default.</span>
<span class="sd">            - 'eyex' - estimate elasticities of variables in `exog` --</span>
<span class="sd">              d(lny)/d(lnx)</span>
<span class="sd">            - 'dyex' - estimate semi-elasticity -- dy/d(lnx)</span>
<span class="sd">            - 'eydx' - estimate semi-elasticity -- d(lny)/dx</span>

<span class="sd">            Note that tranformations are done after each observation is</span>
<span class="sd">            calculated.  Semi-elasticities for binary variables are computed</span>
<span class="sd">            using the midpoint method. 'dyex' and 'eyex' do not make sense</span>
<span class="sd">            for discrete variables.</span>
<span class="sd">        atexog : array_like, optional</span>
<span class="sd">            Optionally, you can provide the exogenous variables over which to</span>
<span class="sd">            get the marginal effects.  This should be a dictionary with the key</span>
<span class="sd">            as the zero-indexed column number and the value of the dictionary.</span>
<span class="sd">            Default is None for all independent variables less the constant.</span>
<span class="sd">        dummy : bool, optional</span>
<span class="sd">            If False, treats binary variables (if present) as continuous.  This</span>
<span class="sd">            is the default.  Else if True, treats binary variables as</span>
<span class="sd">            changing from 0 to 1.  Note that any variable that is either 0 or 1</span>
<span class="sd">            is treated as binary.  Each binary variable is treated separately</span>
<span class="sd">            for now.</span>
<span class="sd">        count : bool, optional</span>
<span class="sd">            If False, treats count variables (if present) as continuous.  This</span>
<span class="sd">            is the default.  Else if True, the marginal effect is the</span>
<span class="sd">            change in probabilities when each observation is increased by one.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        effects : ndarray</span>
<span class="sd">            the marginal effect corresponding to the input options</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        When using after Poisson, returns the expected number of events</span>
<span class="sd">        per period, assuming that the model is loglinear.</span>
<span class="sd">        """</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">constraint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"marginal effects ignore constraints"</span><span class="p">,</span>
                          <span class="n">ValueWarning</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">GEEMargins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">atexog</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span></div>

<div class="viewcode-block" id="GEEResults.plot_isotropic_dependence"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEEResults.plot_isotropic_dependence.html#statsmodels.genmod.generalized_estimating_equations.GEEResults.plot_isotropic_dependence">[docs]</a>    <span class="k">def</span> <span class="nf">plot_isotropic_dependence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xpoints</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                  <span class="n">min_n</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Create a plot of the pairwise products of within-group</span>
<span class="sd">        residuals against the corresponding time differences.  This</span>
<span class="sd">        plot can be used to assess the possible form of an isotropic</span>
<span class="sd">        covariance structure.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax : AxesSubplot</span>
<span class="sd">            An axes on which to draw the graph.  If None, new</span>
<span class="sd">            figure and axes objects are created</span>
<span class="sd">        xpoints : scalar or array_like</span>
<span class="sd">            If scalar, the number of points equally spaced points on</span>
<span class="sd">            the time difference axis used to define bins for</span>
<span class="sd">            calculating local means.  If an array, the specific points</span>
<span class="sd">            that define the bins.</span>
<span class="sd">        min_n : int</span>
<span class="sd">            The minimum sample size in a bin for the mean residual</span>
<span class="sd">            product to be included on the plot.</span>
<span class="sd">        """</span>

        <span class="kn">from</span> <span class="nn">statsmodels.graphics</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">gutils</span>

        <span class="n">resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cluster_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cluster_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>

        <span class="c1"># All within-group pairwise time distances (xdt) and the</span>
        <span class="c1"># corresponding products of scaled residuals (xre).</span>
        <span class="n">xre</span><span class="p">,</span> <span class="n">xdt</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">re</span><span class="p">,</span> <span class="n">ti</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">re</span> <span class="o">=</span> <span class="n">re</span><span class="p">[</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">*</span> <span class="n">re</span><span class="p">[</span><span class="n">ix</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="n">xre</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="p">)</span>
            <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">ti</span><span class="p">[</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">ti</span><span class="p">[</span><span class="n">ix</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">xdt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>

        <span class="n">xre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">xre</span><span class="p">)</span>
        <span class="n">xdt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">xdt</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">gutils</span><span class="o">.</span><span class="n">create_mpl_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>

        <span class="c1"># Convert to a correlation</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">xdt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xre</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>
        <span class="n">xre</span> <span class="o">/=</span> <span class="n">v0</span>

        <span class="c1"># Use the simple average to smooth, since fancier smoothers</span>
        <span class="c1"># that trim and downweight outliers give biased results (we</span>
        <span class="c1"># need the actual mean of a skewed distribution).</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">xpoints</span><span class="p">):</span>
            <span class="n">xpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">xdt</span><span class="p">),</span> <span class="n">xpoints</span><span class="p">)</span>
        <span class="n">dg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">xdt</span><span class="p">,</span> <span class="n">xpoints</span><span class="p">)</span>
        <span class="n">dgu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dg</span><span class="p">)</span>
        <span class="n">hist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dg</span> <span class="o">==</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dgu</span><span class="p">])</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">hist</span> <span class="o">&gt;=</span> <span class="n">min_n</span><span class="p">)</span>
        <span class="n">dgu</span> <span class="o">=</span> <span class="n">dgu</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
        <span class="n">dgy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xre</span><span class="p">[</span><span class="n">dg</span> <span class="o">==</span> <span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dgu</span><span class="p">])</span>
        <span class="n">dgx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">xdt</span><span class="p">[</span><span class="n">dg</span> <span class="o">==</span> <span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">dgu</span><span class="p">])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dgx</span><span class="p">,</span> <span class="n">dgy</span><span class="p">,</span> <span class="s1">'-'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'orange'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Time difference"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Product of scaled residuals"</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="GEEResults.sensitivity_params"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEEResults.sensitivity_params.html#statsmodels.genmod.generalized_estimating_equations.GEEResults.sensitivity_params">[docs]</a>    <span class="k">def</span> <span class="nf">sensitivity_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dep_params_first</span><span class="p">,</span>
                           <span class="n">dep_params_last</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Refits the GEE model using a sequence of values for the</span>
<span class="sd">        dependence parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dep_params_first : array_like</span>
<span class="sd">            The first dep_params in the sequence</span>
<span class="sd">        dep_params_last : array_like</span>
<span class="sd">            The last dep_params in the sequence</span>
<span class="sd">        num_steps : int</span>
<span class="sd">            The number of dep_params in the sequence</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        results : array_like</span>
<span class="sd">            The GEEResults objects resulting from the fits.</span>
<span class="sd">        """</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

        <span class="kn">import</span> <span class="nn">copy</span>
        <span class="n">cov_struct</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cov_struct</span><span class="p">)</span>

        <span class="c1"># We are fixing the dependence structure in each run.</span>
        <span class="n">update_dep</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">update_dep</span>
        <span class="n">model</span><span class="o">.</span><span class="n">update_dep</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">dep_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">):</span>

            <span class="n">dp</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">dep_params_last</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">dep_params_first</span>
            <span class="n">dep_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span>

            <span class="n">model</span><span class="o">.</span><span class="n">cov_struct</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">cov_struct</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">cov_struct</span><span class="o">.</span><span class="n">dep_params</span> <span class="o">=</span> <span class="n">dp</span>
            <span class="n">rslt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">start_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                             <span class="n">ctol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ctol</span><span class="p">,</span>
                             <span class="n">params_niter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_niter</span><span class="p">,</span>
                             <span class="n">first_dep_update</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">first_dep_update</span><span class="p">,</span>
                             <span class="n">cov_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_type</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rslt</span><span class="p">)</span>

        <span class="n">model</span><span class="o">.</span><span class="n">update_dep</span> <span class="o">=</span> <span class="n">update_dep</span>

        <span class="k">return</span> <span class="n">results</span></div>

    <span class="c1"># FIXME: alias to be removed, temporary backwards compatibility</span>
    <span class="n">params_sensitivity</span> <span class="o">=</span> <span class="n">sensitivity_params</span></div>


<span class="k">class</span> <span class="nc">GEEResultsWrapper</span><span class="p">(</span><span class="n">lm</span><span class="o">.</span><span class="n">RegressionResultsWrapper</span><span class="p">):</span>
    <span class="n">_attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'centered_resid'</span><span class="p">:</span> <span class="s1">'rows'</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">_wrap_attrs</span> <span class="o">=</span> <span class="n">wrap</span><span class="o">.</span><span class="n">union_dicts</span><span class="p">(</span><span class="n">lm</span><span class="o">.</span><span class="n">RegressionResultsWrapper</span><span class="o">.</span><span class="n">_wrap_attrs</span><span class="p">,</span>
                                   <span class="n">_attrs</span><span class="p">)</span>
<span class="n">wrap</span><span class="o">.</span><span class="n">populate_wrapper</span><span class="p">(</span><span class="n">GEEResultsWrapper</span><span class="p">,</span> <span class="n">GEEResults</span><span class="p">)</span>  <span class="c1"># noqa:E305</span>


<div class="viewcode-block" id="OrdinalGEE"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.OrdinalGEE.html#statsmodels.genmod.generalized_estimating_equations.OrdinalGEE">[docs]</a><span class="k">class</span> <span class="nc">OrdinalGEE</span><span class="p">(</span><span class="n">GEE</span><span class="p">):</span>

    <span class="vm">__doc__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"    Ordinal Response Marginal Regression Model using GEE</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span>
        <span class="n">_gee_init_doc</span> <span class="o">%</span> <span class="p">{</span><span class="s1">'extra_params'</span><span class="p">:</span> <span class="n">base</span><span class="o">.</span><span class="n">_missing_param_doc</span><span class="p">,</span>
                         <span class="s1">'family_doc'</span><span class="p">:</span> <span class="n">_gee_ordinal_family_doc</span><span class="p">,</span>
                         <span class="s1">'example'</span><span class="p">:</span> <span class="n">_gee_ordinal_example</span><span class="p">,</span>
                         <span class="s1">'notes'</span><span class="p">:</span> <span class="n">_gee_nointercept</span><span class="p">})</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cov_struct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dep_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">family</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">family</span> <span class="o">=</span> <span class="n">families</span><span class="o">.</span><span class="n">Binomial</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">families</span><span class="o">.</span><span class="n">Binomial</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"ordinal GEE must use a Binomial family"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cov_struct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cov_struct</span> <span class="o">=</span> <span class="n">cov_structs</span><span class="o">.</span><span class="n">OrdinalIndependence</span><span class="p">()</span>

        <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_ordinal</span><span class="p">(</span>
            <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">OrdinalGEE</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span>
                                         <span class="n">family</span><span class="p">,</span> <span class="n">cov_struct</span><span class="p">,</span> <span class="n">missing</span><span class="p">,</span>
                                         <span class="n">offset</span><span class="p">,</span> <span class="n">dep_data</span><span class="p">,</span> <span class="n">constraint</span><span class="p">)</span>

<div class="viewcode-block" id="OrdinalGEE.setup_ordinal"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.OrdinalGEE.setup_ordinal.html#statsmodels.genmod.generalized_estimating_equations.OrdinalGEE.setup_ordinal">[docs]</a>    <span class="k">def</span> <span class="nf">setup_ordinal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Restructure ordinal data as binary indicators so that they can</span>
<span class="sd">        be analyzed using Generalized Estimating Equations.</span>
<span class="sd">        """</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">endog_orig</span> <span class="o">=</span> <span class="n">endog</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exog_orig</span> <span class="o">=</span> <span class="n">exog</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups_orig</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset_orig</span> <span class="o">=</span> <span class="n">offset</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset_orig</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">endog</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_orig</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_orig</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">endog</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">exog</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">exog</span><span class="p">)</span>
        <span class="n">endog</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">endog</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

        <span class="c1"># The unique outcomes, except the greatest one.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endog_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">endog</span><span class="p">)</span>
        <span class="n">endog_cuts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_values</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ncut</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">endog_cuts</span><span class="p">)</span>

        <span class="n">nrows</span> <span class="o">=</span> <span class="n">ncut</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">endog</span><span class="p">)</span>
        <span class="n">exog_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nrows</span><span class="p">,</span> <span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">endog_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">intercepts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncut</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">groups_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">groups</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">time_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nrows</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">offset_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="n">jrow</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">zipper</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">endog</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">exog_row</span><span class="p">,</span> <span class="n">endog_value</span><span class="p">,</span> <span class="n">group_value</span><span class="p">,</span> <span class="n">time_value</span><span class="p">,</span>
             <span class="n">offset_value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">zipper</span><span class="p">:</span>

            <span class="c1"># Loop over thresholds for the indicators</span>
            <span class="k">for</span> <span class="n">thresh_ix</span><span class="p">,</span> <span class="n">thresh</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">endog_cuts</span><span class="p">):</span>

                <span class="n">exog_out</span><span class="p">[</span><span class="n">jrow</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">exog_row</span>
                <span class="n">endog_out</span><span class="p">[</span><span class="n">jrow</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">endog_value</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">))</span>
                <span class="n">intercepts</span><span class="p">[</span><span class="n">jrow</span><span class="p">,</span> <span class="n">thresh_ix</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">groups_out</span><span class="p">[</span><span class="n">jrow</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_value</span>
                <span class="n">time_out</span><span class="p">[</span><span class="n">jrow</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_value</span>
                <span class="n">offset_out</span><span class="p">[</span><span class="n">jrow</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset_value</span>
                <span class="n">jrow</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">exog_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">intercepts</span><span class="p">,</span> <span class="n">exog_out</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># exog column names, including intercepts</span>
        <span class="n">xnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"I(y&gt;</span><span class="si">%.1f</span><span class="s2">)"</span> <span class="o">%</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">endog_cuts</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_orig</span><span class="p">)</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
            <span class="n">xnames</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_orig</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xnames</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">"x</span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
        <span class="n">exog_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">exog_out</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">xnames</span><span class="p">)</span>

        <span class="c1"># Preserve the endog name if there is one</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endog_orig</span><span class="p">)</span> <span class="o">==</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
            <span class="n">endog_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">endog_out</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">endog_orig</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">endog_out</span><span class="p">,</span> <span class="n">exog_out</span><span class="p">,</span> <span class="n">groups_out</span><span class="p">,</span> <span class="n">time_out</span><span class="p">,</span> <span class="n">offset_out</span></div>

    <span class="k">def</span> <span class="nf">_starting_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">exposure</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"exposure"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">GEE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span>
                    <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">families</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(),</span>
                    <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">exposure</span><span class="o">=</span><span class="n">exposure</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span>

<div class="viewcode-block" id="OrdinalGEE.fit"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.OrdinalGEE.fit.html#statsmodels.genmod.generalized_estimating_equations.OrdinalGEE.fit">[docs]</a>    <span class="nd">@Appender</span><span class="p">(</span><span class="n">_gee_fit_doc</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">ctol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">start_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">params_niter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">first_dep_update</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">cov_type</span><span class="o">=</span><span class="s1">'robust'</span><span class="p">):</span>

        <span class="n">rslt</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">OrdinalGEE</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">maxiter</span><span class="p">,</span> <span class="n">ctol</span><span class="p">,</span> <span class="n">start_params</span><span class="p">,</span>
                                           <span class="n">params_niter</span><span class="p">,</span> <span class="n">first_dep_update</span><span class="p">,</span>
                                           <span class="n">cov_type</span><span class="o">=</span><span class="n">cov_type</span><span class="p">)</span>

        <span class="n">rslt</span> <span class="o">=</span> <span class="n">rslt</span><span class="o">.</span><span class="n">_results</span>   <span class="c1"># use unwrapped instance</span>
        <span class="n">res_kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">k</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rslt</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">rslt</span><span class="o">.</span><span class="n">_props</span><span class="p">))</span>
        <span class="c1"># Convert the GEEResults to an OrdinalGEEResults</span>
        <span class="n">ord_rslt</span> <span class="o">=</span> <span class="n">OrdinalGEEResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rslt</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                                     <span class="n">rslt</span><span class="o">.</span><span class="n">cov_params</span><span class="p">()</span> <span class="o">/</span> <span class="n">rslt</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                                     <span class="n">rslt</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                                     <span class="n">cov_type</span><span class="o">=</span><span class="n">cov_type</span><span class="p">,</span>
                                     <span class="n">attr_kwds</span><span class="o">=</span><span class="n">res_kwds</span><span class="p">)</span>
        <span class="c1"># for k in rslt._props:</span>
        <span class="c1">#    setattr(ord_rslt, k, getattr(rslt, k))</span>
        <span class="c1"># TODO: document or delete</span>

        <span class="k">return</span> <span class="n">OrdinalGEEResultsWrapper</span><span class="p">(</span><span class="n">ord_rslt</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">OrdinalGEEResults</span><span class="p">(</span><span class="n">GEEResults</span><span class="p">):</span>

    <span class="vm">__doc__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"This class summarizes the fit of a marginal regression model"</span>
        <span class="s2">"for an ordinal response using GEE.</span><span class="se">\n</span><span class="s2">"</span>
        <span class="o">+</span> <span class="n">_gee_results_doc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exog_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Plot the fitted probabilities of endog in an ordinal model,</span>
<span class="sd">        for specified values of the predictors.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax : AxesSubplot</span>
<span class="sd">            An axes on which to draw the graph.  If None, new</span>
<span class="sd">            figure and axes objects are created</span>
<span class="sd">        exog_values : array_like</span>
<span class="sd">            A list of dictionaries, with each dictionary mapping</span>
<span class="sd">            variable names to values at which the variable is held</span>
<span class="sd">            fixed.  The values P(endog=y | exog) are plotted for all</span>
<span class="sd">            possible values of y, at the given exog value.  Variables</span>
<span class="sd">            not included in a dictionary are held fixed at the mean</span>
<span class="sd">            value.</span>

<span class="sd">        Example:</span>
<span class="sd">        --------</span>
<span class="sd">        We have a model with covariates 'age' and 'sex', and wish to</span>
<span class="sd">        plot the probabilities P(endog=y | exog) for males (sex=0) and</span>
<span class="sd">        for females (sex=1), as separate paths on the plot.  Since</span>
<span class="sd">        'age' is not included below in the map, it is held fixed at</span>
<span class="sd">        its mean value.</span>

<span class="sd">        &gt;&gt;&gt; ev = [{"sex": 1}, {"sex": 0}]</span>
<span class="sd">        &gt;&gt;&gt; rslt.distribution_plot(exog_values=ev)</span>
<span class="sd">        """</span>

        <span class="kn">from</span> <span class="nn">statsmodels.graphics</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">gutils</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">gutils</span><span class="o">.</span><span class="n">create_mpl_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>

        <span class="c1"># If no covariate patterns are specified, create one with all</span>
        <span class="c1"># variables set to their mean values.</span>
        <span class="k">if</span> <span class="n">exog_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exog_values</span> <span class="o">=</span> <span class="p">[{},</span> <span class="p">]</span>

        <span class="n">exog_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ix_icept</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_names</span><span class="p">)</span> <span class="k">if</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"I("</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">exog_values</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_names</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> is not a variable in the model"</span>
                                     <span class="o">%</span> <span class="n">k</span><span class="p">)</span>

            <span class="c1"># Get the fitted probability for each level, at the given</span>
            <span class="c1"># covariate values.</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ix_icept</span><span class="p">:</span>

                <span class="n">xp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
                <span class="n">xp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">vn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_names</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ix_icept</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="c1"># User-specified value</span>
                    <span class="k">if</span> <span class="n">vn</span> <span class="ow">in</span> <span class="n">ev</span><span class="p">:</span>
                        <span class="n">xp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ev</span><span class="p">[</span><span class="n">vn</span><span class="p">]</span>
                    <span class="c1"># Mean value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">xp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">exog_means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

                <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)))</span>
                <span class="n">pr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

            <span class="n">pr</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">pr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>
            <span class="n">prd</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">pr</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog_values</span><span class="p">,</span> <span class="n">prd</span><span class="p">,</span> <span class="s1">'o-'</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Response value"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Probability"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>


<span class="k">def</span> <span class="nf">_score_test_submodel</span><span class="p">(</span><span class="n">par</span><span class="p">,</span> <span class="n">sub</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Return transformation matrices for design matrices.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    par : instance</span>
<span class="sd">        The parent model</span>
<span class="sd">    sub : instance</span>
<span class="sd">        The sub-model</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    qm : array_like</span>
<span class="sd">        Matrix mapping the design matrix of the parent to the design matrix</span>
<span class="sd">        for the sub-model.</span>
<span class="sd">    qc : array_like</span>
<span class="sd">        Matrix mapping the design matrix of the parent to the orthogonal</span>
<span class="sd">        complement of the columnspace of the submodel in the columnspace</span>
<span class="sd">        of the parent.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Returns None, None if the provided submodel is not actually a submodel.</span>
<span class="sd">    """</span>

    <span class="n">x1</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">exog</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">exog</span>

    <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">vt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">vt</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Get the orthogonal complement of col(x2) in col(x1).</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">qr</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">u</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">u</span><span class="p">))</span>
    <span class="n">x2c</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">x2c</span> <span class="o">=</span> <span class="n">x2c</span><span class="p">[:,</span> <span class="n">sb</span> <span class="o">&gt;</span> <span class="mf">1e-12</span><span class="p">]</span>

    <span class="c1"># x1 * qm = x2</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-12</span><span class="p">)</span>
    <span class="n">qm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span> <span class="o">/</span> <span class="n">s</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>

    <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">qm</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">e</span> <span class="o">&gt;</span> <span class="mf">1e-8</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># x1 * qc = x2c</span>
    <span class="n">qc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">x2c</span><span class="p">)</span> <span class="o">/</span> <span class="n">s</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">qm</span><span class="p">,</span> <span class="n">qc</span>


<span class="k">class</span> <span class="nc">OrdinalGEEResultsWrapper</span><span class="p">(</span><span class="n">GEEResultsWrapper</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="n">wrap</span><span class="o">.</span><span class="n">populate_wrapper</span><span class="p">(</span><span class="n">OrdinalGEEResultsWrapper</span><span class="p">,</span> <span class="n">OrdinalGEEResults</span><span class="p">)</span>  <span class="c1"># noqa:E305</span>


<div class="viewcode-block" id="NominalGEE"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.NominalGEE.html#statsmodels.genmod.generalized_estimating_equations.NominalGEE">[docs]</a><span class="k">class</span> <span class="nc">NominalGEE</span><span class="p">(</span><span class="n">GEE</span><span class="p">):</span>

    <span class="vm">__doc__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"    Nominal Response Marginal Regression Model using GEE.</span><span class="se">\n</span><span class="s2">"</span> <span class="o">+</span>
        <span class="n">_gee_init_doc</span> <span class="o">%</span> <span class="p">{</span><span class="s1">'extra_params'</span><span class="p">:</span> <span class="n">base</span><span class="o">.</span><span class="n">_missing_param_doc</span><span class="p">,</span>
                         <span class="s1">'family_doc'</span><span class="p">:</span> <span class="n">_gee_nominal_family_doc</span><span class="p">,</span>
                         <span class="s1">'example'</span><span class="p">:</span> <span class="n">_gee_nominal_example</span><span class="p">,</span>
                         <span class="s1">'notes'</span><span class="p">:</span> <span class="n">_gee_nointercept</span><span class="p">})</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cov_struct</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dep_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">constraint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_nominal</span><span class="p">(</span>
            <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">family</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">family</span> <span class="o">=</span> <span class="n">_Multinomial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncut</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cov_struct</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cov_struct</span> <span class="o">=</span> <span class="n">cov_structs</span><span class="o">.</span><span class="n">NominalIndependence</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">NominalGEE</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">family</span><span class="p">,</span> <span class="n">cov_struct</span><span class="p">,</span> <span class="n">missing</span><span class="p">,</span>
            <span class="n">offset</span><span class="p">,</span> <span class="n">dep_data</span><span class="p">,</span> <span class="n">constraint</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_starting_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">exposure</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">"exposure"</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">GEE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span>
                    <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">families</span><span class="o">.</span><span class="n">Binomial</span><span class="p">(),</span>
                    <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">exposure</span><span class="o">=</span><span class="n">exposure</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">params</span>

<div class="viewcode-block" id="NominalGEE.setup_nominal"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.NominalGEE.setup_nominal.html#statsmodels.genmod.generalized_estimating_equations.NominalGEE.setup_nominal">[docs]</a>    <span class="k">def</span> <span class="nf">setup_nominal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Restructure nominal data as binary indicators so that they can</span>
<span class="sd">        be analyzed using Generalized Estimating Equations.</span>
<span class="sd">        """</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">endog_orig</span> <span class="o">=</span> <span class="n">endog</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exog_orig</span> <span class="o">=</span> <span class="n">exog</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups_orig</span> <span class="o">=</span> <span class="n">groups</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset_orig</span> <span class="o">=</span> <span class="n">offset</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">offset_orig</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">endog</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_orig</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_orig</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">endog</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">exog</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">exog</span><span class="p">)</span>
        <span class="n">endog</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">endog</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

        <span class="c1"># The unique outcomes, except the greatest one.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endog_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">endog</span><span class="p">)</span>
        <span class="n">endog_cuts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_values</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ncut</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">endog_cuts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncut</span> <span class="o">=</span> <span class="n">ncut</span>

        <span class="n">nrows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">endog_cuts</span><span class="p">)</span> <span class="o">*</span> <span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">endog_cuts</span><span class="p">)</span> <span class="o">*</span> <span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">exog_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">endog_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">groups_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">time_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nrows</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">offset_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nrows</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="n">jrow</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">zipper</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">endog</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">exog_row</span><span class="p">,</span> <span class="n">endog_value</span><span class="p">,</span> <span class="n">group_value</span><span class="p">,</span> <span class="n">time_value</span><span class="p">,</span>
             <span class="n">offset_value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">zipper</span><span class="p">:</span>

            <span class="c1"># Loop over thresholds for the indicators</span>
            <span class="k">for</span> <span class="n">thresh_ix</span><span class="p">,</span> <span class="n">thresh</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">endog_cuts</span><span class="p">):</span>

                <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">endog_cuts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
                <span class="n">u</span><span class="p">[</span><span class="n">thresh_ix</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">exog_out</span><span class="p">[</span><span class="n">jrow</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">exog_row</span><span class="p">)</span>
                <span class="n">endog_out</span><span class="p">[</span><span class="n">jrow</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">endog_value</span> <span class="o">==</span> <span class="n">thresh</span><span class="p">))</span>
                <span class="n">groups_out</span><span class="p">[</span><span class="n">jrow</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_value</span>
                <span class="n">time_out</span><span class="p">[</span><span class="n">jrow</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_value</span>
                <span class="n">offset_out</span><span class="p">[</span><span class="n">jrow</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset_value</span>
                <span class="n">jrow</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># exog names</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_orig</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">xnames_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_orig</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xnames_in</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"x</span><span class="si">%d</span><span class="s2">"</span> <span class="o">%</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">xnames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">endog_cuts</span><span class="p">:</span>
            <span class="n">xnames</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">"</span><span class="si">%s</span><span class="s2">[</span><span class="si">%.1f</span><span class="s2">]"</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">xnames_in</span><span class="p">])</span>
        <span class="n">exog_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">exog_out</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">xnames</span><span class="p">)</span>
        <span class="n">exog_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">exog_out</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">xnames</span><span class="p">)</span>

        <span class="c1"># Preserve endog name if there is one</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endog_orig</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">endog_out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">endog_out</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">endog_orig</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">endog_out</span><span class="p">,</span> <span class="n">exog_out</span><span class="p">,</span> <span class="n">groups_out</span><span class="p">,</span> <span class="n">time_out</span><span class="p">,</span> <span class="n">offset_out</span></div>

<div class="viewcode-block" id="NominalGEE.mean_deriv"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.NominalGEE.mean_deriv.html#statsmodels.genmod.generalized_estimating_equations.NominalGEE.mean_deriv">[docs]</a>    <span class="k">def</span> <span class="nf">mean_deriv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">lin_pred</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Derivative of the expected endog with respect to the parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exog : array_like</span>
<span class="sd">           The exogeneous data at which the derivative is computed,</span>
<span class="sd">           number of rows must be a multiple of `ncut`.</span>
<span class="sd">        lin_pred : array_like</span>
<span class="sd">           The values of the linear predictor, length must be multiple</span>
<span class="sd">           of `ncut`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        The derivative of the expected endog with respect to the</span>
<span class="sd">        parameters.</span>
<span class="sd">        """</span>

        <span class="n">expval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lin_pred</span><span class="p">)</span>

        <span class="c1"># Reshape so that each row contains all the indicators</span>
        <span class="c1"># corresponding to one multinomial observation.</span>
        <span class="n">expval_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">expval</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expval</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncut</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">ncut</span><span class="p">))</span>

        <span class="c1"># The normalizing constant for the multinomial probabilities.</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">expval_m</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">denom</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncut</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>

        <span class="c1"># The multinomial probabilities</span>
        <span class="n">mprob</span> <span class="o">=</span> <span class="n">expval</span> <span class="o">/</span> <span class="n">denom</span>

        <span class="c1"># First term of the derivative: denom * expval' / denom^2 =</span>
        <span class="c1"># expval' / denom.</span>
        <span class="n">dmat</span> <span class="o">=</span> <span class="n">mprob</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">exog</span>

        <span class="c1"># Second term of the derivative: -expval * denom' / denom^2</span>
        <span class="n">ddenom</span> <span class="o">=</span> <span class="n">expval</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">exog</span>
        <span class="n">dmat</span> <span class="o">-=</span> <span class="n">mprob</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">ddenom</span> <span class="o">/</span> <span class="n">denom</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">dmat</span></div>

<div class="viewcode-block" id="NominalGEE.mean_deriv_exog"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.NominalGEE.mean_deriv_exog.html#statsmodels.genmod.generalized_estimating_equations.NominalGEE.mean_deriv_exog">[docs]</a>    <span class="k">def</span> <span class="nf">mean_deriv_exog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">offset_exposure</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Derivative of the expected endog with respect to exog for the</span>
<span class="sd">        multinomial model, used in analyzing marginal effects.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exog : array_like</span>
<span class="sd">           The exogeneous data at which the derivative is computed,</span>
<span class="sd">           number of rows must be a multiple of `ncut`.</span>
<span class="sd">        lpr : array_like</span>
<span class="sd">           The linear predictor values, length must be multiple of</span>
<span class="sd">           `ncut`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        The value of the derivative of the expected endog with respect</span>
<span class="sd">        to exog.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        offset_exposure must be set at None for the multinomial family.</span>
<span class="sd">        """</span>

        <span class="k">if</span> <span class="n">offset_exposure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"Offset/exposure ignored for the multinomial family"</span><span class="p">,</span>
                          <span class="n">ValueWarning</span><span class="p">)</span>

        <span class="n">lpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="n">expval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lpr</span><span class="p">)</span>

        <span class="n">expval_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">expval</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expval</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncut</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">ncut</span><span class="p">))</span>

        <span class="n">denom</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">expval_m</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">denom</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncut</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>

        <span class="n">bmat0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">params</span><span class="p">)</span>

        <span class="c1"># Masking matrix</span>
        <span class="n">qmat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncut</span><span class="p">):</span>
            <span class="n">ee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncut</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="n">ee</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">qmat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncut</span><span class="p">)))</span>
        <span class="n">qmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">qmat</span><span class="p">)</span>
        <span class="n">qmat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncut</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">qmat</span><span class="p">)</span>
        <span class="n">bmat</span> <span class="o">=</span> <span class="n">bmat0</span> <span class="o">*</span> <span class="n">qmat</span>

        <span class="n">dmat</span> <span class="o">=</span> <span class="n">expval</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">bmat</span> <span class="o">/</span> <span class="n">denom</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="n">expval_mb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">expval_m</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ncut</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">expval_mb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">expval_mb</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncut</span><span class="p">)))</span>

        <span class="n">dmat</span> <span class="o">-=</span> <span class="n">expval</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">bmat</span> <span class="o">*</span> <span class="n">expval_mb</span><span class="p">)</span> <span class="o">/</span> <span class="n">denom</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="n">dmat</span></div>

<div class="viewcode-block" id="NominalGEE.fit"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.NominalGEE.fit.html#statsmodels.genmod.generalized_estimating_equations.NominalGEE.fit">[docs]</a>    <span class="nd">@Appender</span><span class="p">(</span><span class="n">_gee_fit_doc</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">ctol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">start_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">params_niter</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">first_dep_update</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">cov_type</span><span class="o">=</span><span class="s1">'robust'</span><span class="p">):</span>

        <span class="n">rslt</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">NominalGEE</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">maxiter</span><span class="p">,</span> <span class="n">ctol</span><span class="p">,</span> <span class="n">start_params</span><span class="p">,</span>
                                           <span class="n">params_niter</span><span class="p">,</span> <span class="n">first_dep_update</span><span class="p">,</span>
                                           <span class="n">cov_type</span><span class="o">=</span><span class="n">cov_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rslt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">"GEE updates did not converge"</span><span class="p">,</span>
                          <span class="n">ConvergenceWarning</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">rslt</span> <span class="o">=</span> <span class="n">rslt</span><span class="o">.</span><span class="n">_results</span>   <span class="c1"># use unwrapped instance</span>
        <span class="n">res_kwds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(((</span><span class="n">k</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">rslt</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">rslt</span><span class="o">.</span><span class="n">_props</span><span class="p">))</span>
        <span class="c1"># Convert the GEEResults to a NominalGEEResults</span>
        <span class="n">nom_rslt</span> <span class="o">=</span> <span class="n">NominalGEEResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rslt</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                                     <span class="n">rslt</span><span class="o">.</span><span class="n">cov_params</span><span class="p">()</span> <span class="o">/</span> <span class="n">rslt</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                                     <span class="n">rslt</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                                     <span class="n">cov_type</span><span class="o">=</span><span class="n">cov_type</span><span class="p">,</span>
                                     <span class="n">attr_kwds</span><span class="o">=</span><span class="n">res_kwds</span><span class="p">)</span>
        <span class="c1"># TODO: document or delete</span>
        <span class="c1"># for k in rslt._props:</span>
        <span class="c1">#    setattr(nom_rslt, k, getattr(rslt, k))</span>

        <span class="k">return</span> <span class="n">NominalGEEResultsWrapper</span><span class="p">(</span><span class="n">nom_rslt</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">NominalGEEResults</span><span class="p">(</span><span class="n">GEEResults</span><span class="p">):</span>

    <span class="vm">__doc__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">"This class summarizes the fit of a marginal regression model"</span>
        <span class="s2">"for a nominal response using GEE.</span><span class="se">\n</span><span class="s2">"</span>
        <span class="o">+</span> <span class="n">_gee_results_doc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exog_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Plot the fitted probabilities of endog in an nominal model,</span>
<span class="sd">        for specified values of the predictors.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ax : AxesSubplot</span>
<span class="sd">            An axes on which to draw the graph.  If None, new</span>
<span class="sd">            figure and axes objects are created</span>
<span class="sd">        exog_values : array_like</span>
<span class="sd">            A list of dictionaries, with each dictionary mapping</span>
<span class="sd">            variable names to values at which the variable is held</span>
<span class="sd">            fixed.  The values P(endog=y | exog) are plotted for all</span>
<span class="sd">            possible values of y, at the given exog value.  Variables</span>
<span class="sd">            not included in a dictionary are held fixed at the mean</span>
<span class="sd">            value.</span>

<span class="sd">        Example:</span>
<span class="sd">        --------</span>
<span class="sd">        We have a model with covariates 'age' and 'sex', and wish to</span>
<span class="sd">        plot the probabilities P(endog=y | exog) for males (sex=0) and</span>
<span class="sd">        for females (sex=1), as separate paths on the plot.  Since</span>
<span class="sd">        'age' is not included below in the map, it is held fixed at</span>
<span class="sd">        its mean value.</span>

<span class="sd">        &gt;&gt;&gt; ex = [{"sex": 1}, {"sex": 0}]</span>
<span class="sd">        &gt;&gt;&gt; rslt.distribution_plot(exog_values=ex)</span>
<span class="sd">        """</span>

        <span class="kn">from</span> <span class="nn">statsmodels.graphics</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">gutils</span>

        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">gutils</span><span class="o">.</span><span class="n">create_mpl_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span>

        <span class="c1"># If no covariate patterns are specified, create one with all</span>
        <span class="c1"># variables set to their mean values.</span>
        <span class="k">if</span> <span class="n">exog_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exog_values</span> <span class="o">=</span> <span class="p">[{},</span> <span class="p">]</span>

        <span class="n">link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">link</span><span class="o">.</span><span class="n">inverse</span>
        <span class="n">ncut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">family</span><span class="o">.</span><span class="n">ncut</span>

        <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">ncut</span><span class="p">)</span>
        <span class="n">exog_means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">k</span><span class="p">]</span>
        <span class="n">exog_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_names</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k</span><span class="p">]</span>
        <span class="n">exog_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"["</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exog_names</span><span class="p">]</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">ncut</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span> <span class="o">//</span> <span class="n">ncut</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">exog_values</span><span class="p">:</span>

            <span class="n">exog</span> <span class="o">=</span> <span class="n">exog_means</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ev</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exog_names</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> is not a variable in the model"</span>
                                     <span class="o">%</span> <span class="n">k</span><span class="p">)</span>

                <span class="n">ii</span> <span class="o">=</span> <span class="n">exog_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">exog</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">ev</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="n">lpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">exog</span><span class="p">)</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">link</span><span class="p">(</span><span class="n">lpr</span><span class="p">)</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">pr</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">pr</span><span class="o">.</span><span class="n">sum</span><span class="p">()]</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog_values</span><span class="p">,</span> <span class="n">pr</span><span class="p">,</span> <span class="s1">'o-'</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Response value"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Probability"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog_values</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog_values</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>


<span class="k">class</span> <span class="nc">NominalGEEResultsWrapper</span><span class="p">(</span><span class="n">GEEResultsWrapper</span><span class="p">):</span>
    <span class="k">pass</span>
<span class="n">wrap</span><span class="o">.</span><span class="n">populate_wrapper</span><span class="p">(</span><span class="n">NominalGEEResultsWrapper</span><span class="p">,</span> <span class="n">NominalGEEResults</span><span class="p">)</span>  <span class="c1"># noqa:E305</span>


<span class="k">class</span> <span class="nc">_MultinomialLogit</span><span class="p">(</span><span class="n">Link</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    The multinomial logit transform, only for use with GEE.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The data are assumed coded as binary indicators, where each</span>
<span class="sd">    observed multinomial value y is coded as I(y == S[0]), ..., I(y ==</span>
<span class="sd">    S[-1]), where S is the set of possible response labels, excluding</span>
<span class="sd">    the largest one.  Thererefore functions in this class should only</span>
<span class="sd">    be called using vector argument whose length is a multiple of |S|</span>
<span class="sd">    = ncut, which is an argument to be provided when initializing the</span>
<span class="sd">    class.</span>

<span class="sd">    call and derivative use a private method _clean to trim p by 1e-10</span>
<span class="sd">    so that p is in (0, 1)</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncut</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncut</span> <span class="o">=</span> <span class="n">ncut</span>

    <span class="k">def</span> <span class="nf">inverse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lpr</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Inverse of the multinomial logit transform, which gives the</span>
<span class="sd">        expected values of the data as a function of the linear</span>
<span class="sd">        predictors.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lpr : array_like (length must be divisible by `ncut`)</span>
<span class="sd">            The linear predictors</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        prob : ndarray</span>
<span class="sd">            Probabilities, or expected values</span>
<span class="sd">        """</span>

        <span class="n">expval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lpr</span><span class="p">)</span>

        <span class="n">denom</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">expval</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">expval</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncut</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">ncut</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">kron</span><span class="p">(</span><span class="n">denom</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncut</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>

        <span class="n">prob</span> <span class="o">=</span> <span class="n">expval</span> <span class="o">/</span> <span class="n">denom</span>

        <span class="k">return</span> <span class="n">prob</span>


<span class="k">class</span> <span class="nc">_Multinomial</span><span class="p">(</span><span class="n">families</span><span class="o">.</span><span class="n">Family</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Pseudo-link function for fitting nominal multinomial models with</span>
<span class="sd">    GEE.  Not for use outside the GEE class.</span>
<span class="sd">    """</span>

    <span class="n">links</span> <span class="o">=</span> <span class="p">[</span><span class="n">_MultinomialLogit</span><span class="p">,</span> <span class="p">]</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">varfuncs</span><span class="o">.</span><span class="n">binary</span>
    <span class="n">safe_links</span> <span class="o">=</span> <span class="p">[</span><span class="n">_MultinomialLogit</span><span class="p">,</span> <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nlevels</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nlevels : int</span>
<span class="sd">            The number of distinct categories for the multinomial</span>
<span class="sd">            distribution.</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">nlevels</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nlevels</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncut</span> <span class="o">=</span> <span class="n">nlevels</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">_MultinomialLogit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncut</span><span class="p">)</span>


<div class="viewcode-block" id="GEEMargins"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEEMargins.html#statsmodels.genmod.generalized_estimating_equations.GEEMargins">[docs]</a><span class="k">class</span> <span class="nc">GEEMargins</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Estimated marginal effects for a regression model fit with GEE.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    results : GEEResults instance</span>
<span class="sd">        The results instance of a fitted discrete choice model</span>
<span class="sd">    args : tuple</span>
<span class="sd">        Args are passed to `get_margeff`. This is the same as</span>
<span class="sd">        results.get_margeff. See there for more information.</span>
<span class="sd">    kwargs : dict</span>
<span class="sd">        Keyword args are passed to `get_margeff`. This is the same as</span>
<span class="sd">        results.get_margeff. See there for more information.</span>
<span class="sd">    """</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_margeff</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@cache_readonly</span>
    <span class="k">def</span> <span class="nf">tvalues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_check_at_is_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margeff_options</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">margeff</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">margeff_se</span>

<div class="viewcode-block" id="GEEMargins.summary_frame"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEEMargins.summary_frame.html#statsmodels.genmod.generalized_estimating_equations.GEEMargins.summary_frame">[docs]</a>    <span class="k">def</span> <span class="nf">summary_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.05</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns a DataFrame summarizing the marginal effects.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alpha : float</span>
<span class="sd">            Number between 0 and 1. The confidence intervals have the</span>
<span class="sd">            probability 1-alpha.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        frame : DataFrames</span>
<span class="sd">            A DataFrame summarizing the marginal effects.</span>
<span class="sd">        """</span>
        <span class="n">_check_at_is_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margeff_options</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">DataFrame</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">_transform_names</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">margeff_options</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]],</span>
                 <span class="s1">'Std. Err.'</span><span class="p">,</span> <span class="s1">'z'</span><span class="p">,</span> <span class="s1">'Pr(&gt;|z|)'</span><span class="p">,</span>
                 <span class="s1">'Conf. Int. Low'</span><span class="p">,</span> <span class="s1">'Cont. Int. Hi.'</span><span class="p">]</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>  <span class="c1"># True if not a constant</span>
        <span class="n">exog_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_names</span>
        <span class="n">var_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">exog_names</span><span class="p">)</span> <span class="k">if</span> <span class="n">ind</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">margeff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">margeff_se</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvalues</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">pvalues</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf_int</span><span class="p">(</span><span class="n">alpha</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">names</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">var_names</span><span class="p">)</span></div>

    <span class="nd">@cache_readonly</span>
    <span class="k">def</span> <span class="nf">pvalues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_check_at_is_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margeff_options</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tvalues</span><span class="p">))</span> <span class="o">*</span> <span class="mi">2</span>

<div class="viewcode-block" id="GEEMargins.conf_int"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEEMargins.conf_int.html#statsmodels.genmod.generalized_estimating_equations.GEEMargins.conf_int">[docs]</a>    <span class="k">def</span> <span class="nf">conf_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.05</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns the confidence intervals of the marginal effects</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alpha : float</span>
<span class="sd">            Number between 0 and 1. The confidence intervals have the</span>
<span class="sd">            probability 1-alpha.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        conf_int : ndarray</span>
<span class="sd">            An array with lower, upper confidence intervals for the marginal</span>
<span class="sd">            effects.</span>
<span class="sd">        """</span>
        <span class="n">_check_at_is_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margeff_options</span><span class="p">)</span>
        <span class="n">me_se</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margeff_se</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margeff</span> <span class="o">-</span> <span class="n">q</span> <span class="o">*</span> <span class="n">me_se</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margeff</span> <span class="o">+</span> <span class="n">q</span> <span class="o">*</span> <span class="n">me_se</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lzip</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">))</span></div>

<div class="viewcode-block" id="GEEMargins.summary"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEEMargins.summary.html#statsmodels.genmod.generalized_estimating_equations.GEEMargins.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.05</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns a summary table for marginal effects</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alpha : float</span>
<span class="sd">            Number between 0 and 1. The confidence intervals have the</span>
<span class="sd">            probability 1-alpha.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Summary : SummaryTable</span>
<span class="sd">            A SummaryTable instance</span>
<span class="sd">        """</span>
        <span class="n">_check_at_is_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">margeff_options</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">model</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s2">" Marginal Effects"</span>
        <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margeff_options</span><span class="p">[</span><span class="s1">'method'</span><span class="p">]</span>
        <span class="n">top_left</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">'Dep. Variable:'</span><span class="p">,</span> <span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">endog_names</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s1">'Method:'</span><span class="p">,</span> <span class="p">[</span><span class="n">method</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s1">'At:'</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">margeff_options</span><span class="p">[</span><span class="s1">'at'</span><span class="p">]]),</span> <span class="p">]</span>

        <span class="kn">from</span> <span class="nn">statsmodels.iolib.summary</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Summary</span><span class="p">,</span> <span class="n">summary_params</span><span class="p">,</span>
                                               <span class="n">table_extend</span><span class="p">)</span>
        <span class="n">exog_names</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">exog_names</span><span class="p">[:]</span>  <span class="c1"># copy</span>
        <span class="n">smry</span> <span class="o">=</span> <span class="n">Summary</span><span class="p">()</span>

        <span class="n">const_idx</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">const_idx</span>
        <span class="k">if</span> <span class="n">const_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exog_names</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">const_idx</span><span class="p">)</span>

        <span class="n">J</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">"J"</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">J</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">yname</span><span class="p">,</span> <span class="n">yname_list</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">_get_endog_name</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">endog_names</span><span class="p">,</span>
                                                        <span class="kc">None</span><span class="p">,</span> <span class="nb">all</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yname</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">endog_names</span>
            <span class="n">yname_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">yname</span><span class="p">]</span>

        <span class="n">smry</span><span class="o">.</span><span class="n">add_table_2cols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gleft</span><span class="o">=</span><span class="n">top_left</span><span class="p">,</span> <span class="n">gright</span><span class="o">=</span><span class="p">[],</span>
                             <span class="n">yname</span><span class="o">=</span><span class="n">yname</span><span class="p">,</span> <span class="n">xname</span><span class="o">=</span><span class="n">exog_names</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

        <span class="c1"># NOTE: add_table_params is not general enough yet for margeff</span>
        <span class="c1"># could use a refactor with getattr instead of hard-coded params</span>
        <span class="c1"># tvalues etc.</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">conf_int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conf_int</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">margeff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margeff</span>
        <span class="n">margeff_se</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">margeff_se</span>
        <span class="n">tvalues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tvalues</span>
        <span class="n">pvalues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalues</span>
        <span class="k">if</span> <span class="n">J</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">eq</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">J</span><span class="p">):</span>
                <span class="n">restup</span> <span class="o">=</span> <span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">margeff</span><span class="p">[:,</span> <span class="n">eq</span><span class="p">],</span> <span class="n">margeff_se</span><span class="p">[:,</span> <span class="n">eq</span><span class="p">],</span>
                          <span class="n">tvalues</span><span class="p">[:,</span> <span class="n">eq</span><span class="p">],</span> <span class="n">pvalues</span><span class="p">[:,</span> <span class="n">eq</span><span class="p">],</span> <span class="n">conf_int</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">eq</span><span class="p">])</span>
                <span class="n">tble</span> <span class="o">=</span> <span class="n">summary_params</span><span class="p">(</span><span class="n">restup</span><span class="p">,</span> <span class="n">yname</span><span class="o">=</span><span class="n">yname_list</span><span class="p">[</span><span class="n">eq</span><span class="p">],</span>
                                      <span class="n">xname</span><span class="o">=</span><span class="n">exog_names</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                                      <span class="n">use_t</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">skip_header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">tble</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">yname_list</span><span class="p">[</span><span class="n">eq</span><span class="p">]</span>
                <span class="c1"># overwrite coef with method name</span>
                <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">''</span><span class="p">,</span> <span class="n">_transform_names</span><span class="p">[</span><span class="n">method</span><span class="p">],</span> <span class="s1">'std err'</span><span class="p">,</span> <span class="s1">'z'</span><span class="p">,</span>
                          <span class="s1">'P&gt;|z|'</span><span class="p">,</span>
                          <span class="s1">'[</span><span class="si">%3.1f%%</span><span class="s1"> Conf. Int.]'</span> <span class="o">%</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)]</span>
                <span class="n">tble</span><span class="o">.</span><span class="n">insert_header_row</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
                <span class="c1"># from IPython.core.debugger import Pdb; Pdb().set_trace()</span>
                <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tble</span><span class="p">)</span>

            <span class="n">table</span> <span class="o">=</span> <span class="n">table_extend</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">keep_headers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">restup</span> <span class="o">=</span> <span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">margeff</span><span class="p">,</span> <span class="n">margeff_se</span><span class="p">,</span> <span class="n">tvalues</span><span class="p">,</span> <span class="n">pvalues</span><span class="p">,</span> <span class="n">conf_int</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">summary_params</span><span class="p">(</span><span class="n">restup</span><span class="p">,</span> <span class="n">yname</span><span class="o">=</span><span class="n">yname</span><span class="p">,</span> <span class="n">xname</span><span class="o">=</span><span class="n">exog_names</span><span class="p">,</span>
                                   <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">use_t</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">[</span><span class="s1">''</span><span class="p">,</span> <span class="n">_transform_names</span><span class="p">[</span><span class="n">method</span><span class="p">],</span> <span class="s1">'std err'</span><span class="p">,</span> <span class="s1">'z'</span><span class="p">,</span>
                      <span class="s1">'P&gt;|z|'</span><span class="p">,</span> <span class="s1">'[</span><span class="si">%3.1f%%</span><span class="s1"> Conf. Int.]'</span> <span class="o">%</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)]</span>
            <span class="n">table</span><span class="o">.</span><span class="n">insert_header_row</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>

        <span class="n">smry</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">smry</span></div>

<div class="viewcode-block" id="GEEMargins.get_margeff"><a class="viewcode-back" href="../../../generated/statsmodels.genmod.generalized_estimating_equations.GEEMargins.get_margeff.html#statsmodels.genmod.generalized_estimating_equations.GEEMargins.get_margeff">[docs]</a>    <span class="k">def</span> <span class="nf">get_margeff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="s1">'overall'</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">'dydx'</span><span class="p">,</span> <span class="n">atexog</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">dummy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>  <span class="c1"># always reset the cache when this is called</span>
        <span class="c1"># TODO: if at is not all or overall, we can also put atexog values</span>
        <span class="c1"># in summary table head</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">at</span> <span class="o">=</span> <span class="n">at</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">_check_margeff_args</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margeff_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">at</span><span class="o">=</span><span class="n">at</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">model</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">params</span>
        <span class="n">exog</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># copy because values are changed</span>
        <span class="n">effects_idx</span> <span class="o">=</span> <span class="n">exog</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="n">const_idx</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">const_idx</span>

        <span class="k">if</span> <span class="n">dummy</span><span class="p">:</span>
            <span class="n">_check_discrete_args</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
            <span class="n">dummy_idx</span><span class="p">,</span> <span class="n">dummy</span> <span class="o">=</span> <span class="n">_get_dummy_index</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">const_idx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dummy_idx</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">count</span><span class="p">:</span>
            <span class="n">_check_discrete_args</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
            <span class="n">count_idx</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">_get_count_index</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">const_idx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">count_idx</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># get the exogenous variables</span>
        <span class="n">exog</span> <span class="o">=</span> <span class="n">_get_margeff_exog</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">at</span><span class="p">,</span> <span class="n">atexog</span><span class="p">,</span> <span class="n">effects_idx</span><span class="p">)</span>

        <span class="c1"># get base marginal effects, handled by sub-classes</span>
        <span class="n">effects</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_derivative_exog</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span>
                                         <span class="n">dummy_idx</span><span class="p">,</span> <span class="n">count_idx</span><span class="p">)</span>
        <span class="n">effects</span> <span class="o">=</span> <span class="n">_effects_at</span><span class="p">(</span><span class="n">effects</span><span class="p">,</span> <span class="n">at</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">at</span> <span class="o">==</span> <span class="s1">'all'</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">margeff</span> <span class="o">=</span> <span class="n">effects</span><span class="p">[:,</span> <span class="n">effects_idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Set standard error of the marginal effects by Delta method.</span>
            <span class="n">margeff_cov</span><span class="p">,</span> <span class="n">margeff_se</span> <span class="o">=</span> <span class="n">margeff_cov_with_se</span><span class="p">(</span>
                <span class="n">model</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">cov_params</span><span class="p">(),</span> <span class="n">at</span><span class="p">,</span>
                <span class="n">model</span><span class="o">.</span><span class="n">_derivative_exog</span><span class="p">,</span> <span class="n">dummy_idx</span><span class="p">,</span> <span class="n">count_idx</span><span class="p">,</span>
                <span class="n">method</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># do not care about at constant</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">margeff_cov</span> <span class="o">=</span> <span class="n">margeff_cov</span><span class="p">[</span><span class="n">effects_idx</span><span class="p">][:,</span> <span class="n">effects_idx</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">margeff_se</span> <span class="o">=</span> <span class="n">margeff_se</span><span class="p">[</span><span class="n">effects_idx</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">margeff</span> <span class="o">=</span> <span class="n">effects</span><span class="p">[</span><span class="n">effects_idx</span><span class="p">]</span></div></div>
</pre></div>

          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2009-2019, Josef Perktold, Skipper Seabold, Jonathan Taylor, statsmodels-developers.
              
          </div>
            Last updated on
              Nov 02, 2022.
            <br/>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../../../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>