

<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../../../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../../../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../../../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../../../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../../../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>statsmodels.nonparametric._kernel_base &#8212; statsmodels</title>
  <link rel="icon" type="image/png" sizes="32x32" href="../../../_static/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../../../_static/icons/favicon-16x16.png">
  <link rel="manifest" href="../../../_static/icons/site.webmanifest">
  <link rel="mask-icon" href="../../../_static/icons/safari-pinned-tab.svg" color="#919191">
  <meta name="msapplication-TileColor" content="#2b5797">
  <meta name="msapplication-config" content="../../../_static/icons/browserconfig.xml">
  <link rel="stylesheet" href="../../../_static/stylesheets/examples.css">
  <link rel="stylesheet" href="../../../_static/stylesheets/deprecation.css">
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/material.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=indigo data-md-color-accent=blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#_modules/statsmodels/nonparametric/_kernel_base" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../../index.html" title="statsmodels"
           class="md-header-nav__button md-logo">
          
              <img src="../../../_static/statsmodels-logo-v2-bw.svg" height="26"
                   alt="statsmodels logo">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">statsmodels 0.13.5</span>
          <span class="md-header-nav__topic"> statsmodels.nonparametric._kernel_base </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../../../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/statsmodels/statsmodels" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    statsmodels
  </div>
</a>
          </div>
        </div>
      
      
  
  <script src="../../../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../../../../versions-v2.json",
        target_loc = "../../../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="../../index.html" class="md-tabs__link">Module code</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../../index.html" title="statsmodels" class="md-nav__button md-logo">
      
        <img src="../../../_static/statsmodels-logo-v2-bw.svg" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../../../index.html"
       title="statsmodels">statsmodels 0.13.5</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/statsmodels/statsmodels" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    statsmodels
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
    
      <a href="../../../install.html" class="md-nav__link">Installing statsmodels</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../gettingstarted.html" class="md-nav__link">Getting started</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../user-guide.html" class="md-nav__link">User Guide</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../examples/index.html" class="md-nav__link">Examples</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../api.html" class="md-nav__link">API Reference</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../about.html" class="md-nav__link">About statsmodels</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../dev/index.html" class="md-nav__link">Developer Page</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../../../release/index.html" class="md-nav__link">Release Notes</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
  <ul class="md-nav__list" data-md-scrollfix="">
    

<li id="searchbox" class="md-nav__item"></li>

  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <h1 id="modules-statsmodels-nonparametric-kernel-base--page-root">Source code for statsmodels.nonparametric._kernel_base</h1><div class="highlight"><pre>
<span></span><span class="sd">"""</span>
<span class="sd">Module containing the base object for multivariate kernel density and</span>
<span class="sd">regression, plus some utilities.</span>
<span class="sd">"""</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">scipy.stats.mstats</span> <span class="kn">import</span> <span class="n">mquantiles</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">joblib</span>
    <span class="n">has_joblib</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">has_joblib</span> <span class="o">=</span> <span class="kc">False</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">kernels</span>


<span class="n">kernel_func</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">wangryzin</span><span class="o">=</span><span class="n">kernels</span><span class="o">.</span><span class="n">wang_ryzin</span><span class="p">,</span>
                   <span class="n">aitchisonaitken</span><span class="o">=</span><span class="n">kernels</span><span class="o">.</span><span class="n">aitchison_aitken</span><span class="p">,</span>
                   <span class="n">gaussian</span><span class="o">=</span><span class="n">kernels</span><span class="o">.</span><span class="n">gaussian</span><span class="p">,</span>
                   <span class="n">aitchison_aitken_reg</span> <span class="o">=</span> <span class="n">kernels</span><span class="o">.</span><span class="n">aitchison_aitken_reg</span><span class="p">,</span>
                   <span class="n">wangryzin_reg</span> <span class="o">=</span> <span class="n">kernels</span><span class="o">.</span><span class="n">wang_ryzin_reg</span><span class="p">,</span>
                   <span class="n">gauss_convolution</span><span class="o">=</span><span class="n">kernels</span><span class="o">.</span><span class="n">gaussian_convolution</span><span class="p">,</span>
                   <span class="n">wangryzin_convolution</span><span class="o">=</span><span class="n">kernels</span><span class="o">.</span><span class="n">wang_ryzin_convolution</span><span class="p">,</span>
                   <span class="n">aitchisonaitken_convolution</span><span class="o">=</span><span class="n">kernels</span><span class="o">.</span><span class="n">aitchison_aitken_convolution</span><span class="p">,</span>
                   <span class="n">gaussian_cdf</span><span class="o">=</span><span class="n">kernels</span><span class="o">.</span><span class="n">gaussian_cdf</span><span class="p">,</span>
                   <span class="n">aitchisonaitken_cdf</span><span class="o">=</span><span class="n">kernels</span><span class="o">.</span><span class="n">aitchison_aitken_cdf</span><span class="p">,</span>
                   <span class="n">wangryzin_cdf</span><span class="o">=</span><span class="n">kernels</span><span class="o">.</span><span class="n">wang_ryzin_cdf</span><span class="p">,</span>
                   <span class="n">d_gaussian</span><span class="o">=</span><span class="n">kernels</span><span class="o">.</span><span class="n">d_gaussian</span><span class="p">,</span>
                   <span class="n">tricube</span><span class="o">=</span><span class="n">kernels</span><span class="o">.</span><span class="n">tricube</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_compute_min_std_IQR</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">"""Compute minimum of std and IQR for each variable."""</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">q75</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">q25</span> <span class="o">=</span> <span class="n">mquantiles</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="p">(</span><span class="n">q75</span> <span class="o">-</span> <span class="n">q25</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.349</span>  <span class="c1"># IQR</span>
    <span class="n">dispersion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dispersion</span>


<span class="k">def</span> <span class="nf">_compute_subset</span><span class="p">(</span><span class="n">class_type</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">do</span><span class="p">,</span> <span class="n">n_cvars</span><span class="p">,</span> <span class="n">ix_ord</span><span class="p">,</span>
                    <span class="n">ix_unord</span><span class="p">,</span> <span class="n">n_sub</span><span class="p">,</span> <span class="n">class_vars</span><span class="p">,</span> <span class="n">randomize</span><span class="p">,</span> <span class="n">bound</span><span class="p">):</span>
    <span class="sd">""""Compute bw on subset of data.</span>

<span class="sd">    Called from ``GenericKDE._compute_efficient_*``.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Needs to be outside the class in order for joblib to be able to pickle it.</span>
<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">randomize</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">sub_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">n_sub</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sub_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">bound</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">bound</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span>

    <span class="k">if</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s1">'KDEMultivariate'</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.kernel_density</span> <span class="kn">import</span> <span class="n">KDEMultivariate</span>
        <span class="n">var_type</span> <span class="o">=</span> <span class="n">class_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sub_model</span> <span class="o">=</span> <span class="n">KDEMultivariate</span><span class="p">(</span><span class="n">sub_data</span><span class="p">,</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">bw</span><span class="o">=</span><span class="n">bw</span><span class="p">,</span>
                        <span class="n">defaults</span><span class="o">=</span><span class="n">EstimatorSettings</span><span class="p">(</span><span class="n">efficient</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s1">'KDEMultivariateConditional'</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.kernel_density</span> <span class="kn">import</span> <span class="n">KDEMultivariateConditional</span>
        <span class="n">k_dep</span><span class="p">,</span> <span class="n">dep_type</span><span class="p">,</span> <span class="n">indep_type</span> <span class="o">=</span> <span class="n">class_vars</span>
        <span class="n">endog</span> <span class="o">=</span> <span class="n">sub_data</span><span class="p">[:,</span> <span class="p">:</span><span class="n">k_dep</span><span class="p">]</span>
        <span class="n">exog</span> <span class="o">=</span> <span class="n">sub_data</span><span class="p">[:,</span> <span class="n">k_dep</span><span class="p">:]</span>
        <span class="n">sub_model</span> <span class="o">=</span> <span class="n">KDEMultivariateConditional</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">dep_type</span><span class="p">,</span>
            <span class="n">indep_type</span><span class="p">,</span> <span class="n">bw</span><span class="o">=</span><span class="n">bw</span><span class="p">,</span> <span class="n">defaults</span><span class="o">=</span><span class="n">EstimatorSettings</span><span class="p">(</span><span class="n">efficient</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s1">'KernelReg'</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">.kernel_regression</span> <span class="kn">import</span> <span class="n">KernelReg</span>
        <span class="n">var_type</span><span class="p">,</span> <span class="n">k_vars</span><span class="p">,</span> <span class="n">reg_type</span> <span class="o">=</span> <span class="n">class_vars</span>
        <span class="n">endog</span> <span class="o">=</span> <span class="n">_adjust_shape</span><span class="p">(</span><span class="n">sub_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">exog</span> <span class="o">=</span> <span class="n">_adjust_shape</span><span class="p">(</span><span class="n">sub_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">k_vars</span><span class="p">)</span>
        <span class="n">sub_model</span> <span class="o">=</span> <span class="n">KernelReg</span><span class="p">(</span><span class="n">endog</span><span class="o">=</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="n">exog</span><span class="p">,</span> <span class="n">reg_type</span><span class="o">=</span><span class="n">reg_type</span><span class="p">,</span>
                              <span class="n">var_type</span><span class="o">=</span><span class="n">var_type</span><span class="p">,</span> <span class="n">bw</span><span class="o">=</span><span class="n">bw</span><span class="p">,</span>
                              <span class="n">defaults</span><span class="o">=</span><span class="n">EstimatorSettings</span><span class="p">(</span><span class="n">efficient</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"class_type not recognized, should be one of "</span> \
                 <span class="s2">"{KDEMultivariate, KDEMultivariateConditional, KernelReg}"</span><span class="p">)</span>

    <span class="c1"># Compute dispersion in next 4 lines</span>
    <span class="k">if</span> <span class="n">class_type</span> <span class="o">==</span> <span class="s1">'KernelReg'</span><span class="p">:</span>
        <span class="n">sub_data</span> <span class="o">=</span> <span class="n">sub_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>

    <span class="n">dispersion</span> <span class="o">=</span> <span class="n">_compute_min_std_IQR</span><span class="p">(</span><span class="n">sub_data</span><span class="p">)</span>

    <span class="n">fct</span> <span class="o">=</span> <span class="n">dispersion</span> <span class="o">*</span> <span class="n">n_sub</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_cvars</span> <span class="o">+</span> <span class="n">co</span><span class="p">))</span>
    <span class="n">fct</span><span class="p">[</span><span class="n">ix_unord</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_sub</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_cvars</span> <span class="o">+</span> <span class="n">do</span><span class="p">))</span>
    <span class="n">fct</span><span class="p">[</span><span class="n">ix_ord</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_sub</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_cvars</span> <span class="o">+</span> <span class="n">do</span><span class="p">))</span>
    <span class="n">sample_scale_sub</span> <span class="o">=</span> <span class="n">sub_model</span><span class="o">.</span><span class="n">bw</span> <span class="o">/</span> <span class="n">fct</span>  <span class="c1">#TODO: check if correct</span>
    <span class="n">bw_sub</span> <span class="o">=</span> <span class="n">sub_model</span><span class="o">.</span><span class="n">bw</span>
    <span class="k">return</span> <span class="n">sample_scale_sub</span><span class="p">,</span> <span class="n">bw_sub</span>


<span class="k">class</span> <span class="nc">GenericKDE</span> <span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Base class for density estimation and regression KDE classes.</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="nf">_compute_bw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bw</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Computes the bandwidth of the data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bw : {array_like, str}</span>
<span class="sd">            If array_like: user-specified bandwidth.</span>
<span class="sd">            If a string, should be one of:</span>

<span class="sd">                - cv_ml: cross validation maximum likelihood</span>
<span class="sd">                - normal_reference: normal reference rule of thumb</span>
<span class="sd">                - cv_ls: cross validation least squares</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The default values for bw is 'normal_reference'.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">bw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bw</span> <span class="o">=</span> <span class="s1">'normal_reference'</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bw</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bw_method</span> <span class="o">=</span> <span class="s2">"user-specified"</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The user specified a bandwidth selection method</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bw_method</span> <span class="o">=</span> <span class="n">bw</span>
            <span class="c1"># Workaround to avoid instance methods in __dict__</span>
            <span class="k">if</span> <span class="n">bw</span> <span class="o">==</span> <span class="s1">'normal_reference'</span><span class="p">:</span>
                <span class="n">bwfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normal_reference</span>
            <span class="k">elif</span> <span class="n">bw</span> <span class="o">==</span> <span class="s1">'cv_ml'</span><span class="p">:</span>
                <span class="n">bwfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv_ml</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># bw == 'cv_ls'</span>
                <span class="n">bwfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cv_ls</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">bwfunc</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">_compute_dispersion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Computes the measure of dispersion.</span>

<span class="sd">        The minimum of the standard deviation and interquartile range / 1.349</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Reimplemented in `KernelReg`, because the first column of `data` has to</span>
<span class="sd">        be removed.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        See the user guide for the np package in R.</span>
<span class="sd">        In the notes on bwscaling option in npreg, npudens, npcdens there is</span>
<span class="sd">        a discussion on the measure of dispersion</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="n">_compute_min_std_IQR</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_class_vars_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Helper method to be able to pass needed vars to _compute_subset.</span>

<span class="sd">        Needs to be implemented by subclasses."""</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_compute_efficient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bw</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Computes the bandwidth by estimating the scaling factor (c)</span>
<span class="sd">        in n_res resamples of size ``n_sub`` (in `randomize` case), or by</span>
<span class="sd">        dividing ``nobs`` into as many ``n_sub`` blocks as needed (if</span>
<span class="sd">        `randomize` is False).</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        See p.9 in socserv.mcmaster.ca/racine/np_faq.pdf</span>
<span class="sd">        """</span>

        <span class="k">if</span> <span class="n">bw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bw_method</span> <span class="o">=</span> <span class="s1">'normal_reference'</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bw</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bw_method</span> <span class="o">=</span> <span class="n">bw</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bw_method</span> <span class="o">=</span> <span class="s2">"user-specified"</span>
            <span class="k">return</span> <span class="n">bw</span>

        <span class="n">nobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span>
        <span class="n">n_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sub</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">n_cvars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">'c'</span><span class="p">)</span>
        <span class="n">co</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># 2*order of continuous kernel</span>
        <span class="n">do</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># 2*order of discrete kernel</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ix_ord</span><span class="p">,</span> <span class="n">ix_unord</span> <span class="o">=</span> <span class="n">_get_type_pos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="p">)</span>

        <span class="c1"># Define bounds for slicing the data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomize</span><span class="p">:</span>
            <span class="c1"># randomize chooses blocks of size n_sub, independent of nobs</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span> <span class="o">*</span> <span class="n">n_sub</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_sub</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nobs</span> <span class="o">//</span> <span class="n">n_sub</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">nobs</span> <span class="o">%</span> <span class="n">n_sub</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bounds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nobs</span> <span class="o">-</span> <span class="n">nobs</span> <span class="o">%</span> <span class="n">n_sub</span><span class="p">,</span> <span class="n">nobs</span><span class="p">))</span>

        <span class="n">n_blocks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_res</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomize</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">bounds</span><span class="p">)</span>
        <span class="n">sample_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_blocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vars</span><span class="p">))</span>
        <span class="n">only_bw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n_blocks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vars</span><span class="p">))</span>

        <span class="n">class_type</span><span class="p">,</span> <span class="n">class_vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_class_vars_type</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">has_joblib</span><span class="p">:</span>
            <span class="c1"># `res` is a list of tuples (sample_scale_sub, bw_sub)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span><span class="p">)(</span>
                <span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="n">_compute_subset</span><span class="p">)(</span>
                    <span class="n">class_type</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">do</span><span class="p">,</span> <span class="n">n_cvars</span><span class="p">,</span> <span class="n">ix_ord</span><span class="p">,</span> <span class="n">ix_unord</span><span class="p">,</span> \
                    <span class="n">n_sub</span><span class="p">,</span> <span class="n">class_vars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomize</span><span class="p">,</span> <span class="n">bounds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> \
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_blocks</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_blocks</span><span class="p">):</span>
                <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_compute_subset</span><span class="p">(</span><span class="n">class_type</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">do</span><span class="p">,</span>
                                           <span class="n">n_cvars</span><span class="p">,</span> <span class="n">ix_ord</span><span class="p">,</span> <span class="n">ix_unord</span><span class="p">,</span> <span class="n">n_sub</span><span class="p">,</span>
                                           <span class="n">class_vars</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">randomize</span><span class="p">,</span>
                                           <span class="n">bounds</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_blocks</span><span class="p">):</span>
            <span class="n">sample_scale</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">only_bw</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_dispersion</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">order_func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_median</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span>
        <span class="n">m_scale</span> <span class="o">=</span> <span class="n">order_func</span><span class="p">(</span><span class="n">sample_scale</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># TODO: Check if 1/5 is correct in line below!</span>
        <span class="n">bw</span> <span class="o">=</span> <span class="n">m_scale</span> <span class="o">*</span> <span class="n">s</span> <span class="o">*</span> <span class="n">nobs</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_cvars</span> <span class="o">+</span> <span class="n">co</span><span class="p">))</span>
        <span class="n">bw</span><span class="p">[</span><span class="n">ix_ord</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_scale</span><span class="p">[</span><span class="n">ix_ord</span><span class="p">]</span> <span class="o">*</span> <span class="n">nobs</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="o">/</span> <span class="p">(</span><span class="n">n_cvars</span> <span class="o">+</span> <span class="n">do</span><span class="p">))</span>
        <span class="n">bw</span><span class="p">[</span><span class="n">ix_unord</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_scale</span><span class="p">[</span><span class="n">ix_unord</span><span class="p">]</span> <span class="o">*</span> <span class="n">nobs</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">2.</span><span class="o">/</span> <span class="p">(</span><span class="n">n_cvars</span> <span class="o">+</span> <span class="n">do</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_only_bw</span><span class="p">:</span>
            <span class="n">bw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">only_bw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bw</span>

    <span class="k">def</span> <span class="nf">_set_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defaults</span><span class="p">):</span>
        <span class="sd">"""Sets the default values for the efficient estimation"""</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_res</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">n_res</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_sub</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">n_sub</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">randomize</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">randomize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_median</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">return_median</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">efficient</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">efficient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_only_bw</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">return_only_bw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span> <span class="o">=</span> <span class="n">defaults</span><span class="o">.</span><span class="n">n_jobs</span>

    <span class="k">def</span> <span class="nf">_normal_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Returns Scott's normal reference rule of thumb bandwidth parameter.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        See p.13 in [2] for an example and discussion.  The formula for the</span>
<span class="sd">        bandwidth is</span>

<span class="sd">        .. math:: h = 1.06n^{-1/(4+q)}</span>

<span class="sd">        where ``n`` is the number of observations and ``q`` is the number of</span>
<span class="sd">        variables.</span>
<span class="sd">        """</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">1.06</span> <span class="o">*</span> <span class="n">X</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">_set_bw_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bw</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Sets bandwidth lower bound to effectively zero )1e-10), and for</span>
<span class="sd">        discrete values upper bound to 1.</span>
<span class="sd">        """</span>
        <span class="n">bw</span><span class="p">[</span><span class="n">bw</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-10</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ix_ord</span><span class="p">,</span> <span class="n">ix_unord</span> <span class="o">=</span> <span class="n">_get_type_pos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="p">)</span>
        <span class="n">bw</span><span class="p">[</span><span class="n">ix_ord</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">bw</span><span class="p">[</span><span class="n">ix_ord</span><span class="p">],</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="n">bw</span><span class="p">[</span><span class="n">ix_unord</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">bw</span><span class="p">[</span><span class="n">ix_unord</span><span class="p">],</span> <span class="mf">1.</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bw</span>

    <span class="k">def</span> <span class="nf">_cv_ml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""</span>
<span class="sd">        Returns the cross validation maximum likelihood bandwidth parameter.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        For more details see p.16, 18, 27 in Ref. [1] (see module docstring).</span>

<span class="sd">        Returns the bandwidth estimate that maximizes the leave-out-out</span>
<span class="sd">        likelihood.  The leave-one-out log likelihood function is:</span>

<span class="sd">        .. math:: \ln L=\sum_{i=1}^{n}\ln f_{-i}(X_{i})</span>

<span class="sd">        The leave-one-out kernel estimator of :math:`f_{-i}` is:</span>

<span class="sd">        .. math:: f_{-i}(X_{i})=\frac{1}{(n-1)h}</span>
<span class="sd">                        \sum_{j=1,j\neq i}K_{h}(X_{i},X_{j})</span>

<span class="sd">        where :math:`K_{h}` represents the Generalized product kernel</span>
<span class="sd">        estimator:</span>

<span class="sd">        .. math:: K_{h}(X_{i},X_{j})=\prod_{s=1}^</span>
<span class="sd">                        {q}h_{s}^{-1}k\left(\frac{X_{is}-X_{js}}{h_{s}}\right)</span>
<span class="sd">        """</span>
        <span class="c1"># the initial value for the optimization is the normal_reference</span>
        <span class="n">h0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normal_reference</span><span class="p">()</span>
        <span class="n">bw</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loo_likelihood</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">h0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">,</span> <span class="p">),</span>
                           <span class="n">maxiter</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">maxfun</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">bw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_bw_bounds</span><span class="p">(</span><span class="n">bw</span><span class="p">)</span>  <span class="c1"># bound bw if necessary</span>
        <span class="k">return</span> <span class="n">bw</span>

    <span class="k">def</span> <span class="nf">_cv_ls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">"""</span>
<span class="sd">        Returns the cross-validation least squares bandwidth parameter(s).</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        For more details see pp. 16, 27 in Ref. [1] (see module docstring).</span>

<span class="sd">        Returns the value of the bandwidth that maximizes the integrated mean</span>
<span class="sd">        square error between the estimated and actual distribution.  The</span>
<span class="sd">        integrated mean square error (IMSE) is given by:</span>

<span class="sd">        .. math:: \int\left[\hat{f}(x)-f(x)\right]^{2}dx</span>

<span class="sd">        This is the general formula for the IMSE.  The IMSE differs for</span>
<span class="sd">        conditional (``KDEMultivariateConditional``) and unconditional</span>
<span class="sd">        (``KDEMultivariate``) kernel density estimation.</span>
<span class="sd">        """</span>
        <span class="n">h0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normal_reference</span><span class="p">()</span>
        <span class="n">bw</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imse</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">h0</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">maxfun</span><span class="o">=</span><span class="mf">1e3</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">xtol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">bw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_bw_bounds</span><span class="p">(</span><span class="n">bw</span><span class="p">)</span>  <span class="c1"># bound bw if necessary</span>
        <span class="k">return</span> <span class="n">bw</span>

    <span class="k">def</span> <span class="nf">loo_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>


<div class="viewcode-block" id="EstimatorSettings"><a class="viewcode-back" href="../../../generated/statsmodels.nonparametric.kernel_density.EstimatorSettings.html#statsmodels.nonparametric.kernel_density.EstimatorSettings">[docs]</a><span class="k">class</span> <span class="nc">EstimatorSettings</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Object to specify settings for density estimation or regression.</span>

<span class="sd">    `EstimatorSettings` has several properties related to how bandwidth</span>
<span class="sd">    estimation for the `KDEMultivariate`, `KDEMultivariateConditional`,</span>
<span class="sd">    `KernelReg` and `CensoredKernelReg` classes behaves.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    efficient : bool, optional</span>
<span class="sd">        If True, the bandwidth estimation is to be performed</span>
<span class="sd">        efficiently -- by taking smaller sub-samples and estimating</span>
<span class="sd">        the scaling factor of each subsample.  This is useful for large</span>
<span class="sd">        samples (nobs &gt;&gt; 300) and/or multiple variables (k_vars &gt; 3).</span>
<span class="sd">        If False (default), all data is used at the same time.</span>
<span class="sd">    randomize : bool, optional</span>
<span class="sd">        If True, the bandwidth estimation is to be performed by</span>
<span class="sd">        taking `n_res` random resamples (with replacement) of size `n_sub` from</span>
<span class="sd">        the full sample.  If set to False (default), the estimation is</span>
<span class="sd">        performed by slicing the full sample in sub-samples of size `n_sub` so</span>
<span class="sd">        that all samples are used once.</span>
<span class="sd">    n_sub : int, optional</span>
<span class="sd">        Size of the sub-samples.  Default is 50.</span>
<span class="sd">    n_res : int, optional</span>
<span class="sd">        The number of random re-samples used to estimate the bandwidth.</span>
<span class="sd">        Only has an effect if ``randomize == True``.  Default value is 25.</span>
<span class="sd">    return_median : bool, optional</span>
<span class="sd">        If True (default), the estimator uses the median of all scaling factors</span>
<span class="sd">        for each sub-sample to estimate the bandwidth of the full sample.</span>
<span class="sd">        If False, the estimator uses the mean.</span>
<span class="sd">    return_only_bw : bool, optional</span>
<span class="sd">        If True, the estimator is to use the bandwidth and not the</span>
<span class="sd">        scaling factor.  This is *not* theoretically justified.</span>
<span class="sd">        Should be used only for experimenting.</span>
<span class="sd">    n_jobs : int, optional</span>
<span class="sd">        The number of jobs to use for parallel estimation with</span>
<span class="sd">        ``joblib.Parallel``.  Default is -1, meaning ``n_cores - 1``, with</span>
<span class="sd">        ``n_cores`` the number of available CPU cores.</span>
<span class="sd">        See the `joblib documentation</span>
<span class="sd">        &lt;https://joblib.readthedocs.io/en/latest/generated/joblib.Parallel.html&gt;`_ for more details.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; settings = EstimatorSettings(randomize=True, n_jobs=3)</span>
<span class="sd">    &gt;&gt;&gt; k_dens = KDEMultivariate(data, var_type, defaults=settings)</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">efficient</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">randomize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_res</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">n_sub</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                 <span class="n">return_median</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_only_bw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">efficient</span> <span class="o">=</span> <span class="n">efficient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">randomize</span> <span class="o">=</span> <span class="n">randomize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_res</span> <span class="o">=</span> <span class="n">n_res</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_sub</span> <span class="o">=</span> <span class="n">n_sub</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_median</span> <span class="o">=</span> <span class="n">return_median</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">return_only_bw</span> <span class="o">=</span> <span class="n">return_only_bw</span>  <span class="c1"># TODO: remove this?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_jobs</span> <span class="o">=</span> <span class="n">n_jobs</span></div>


<span class="k">class</span> <span class="nc">LeaveOneOut</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Generator to give leave-one-out views on X.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : array_like</span>
<span class="sd">        2-D array.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; X = np.random.normal(0, 1, [10,2])</span>
<span class="sd">    &gt;&gt;&gt; loo = LeaveOneOut(X)</span>
<span class="sd">    &gt;&gt;&gt; for x in loo:</span>
<span class="sd">    ...    print x</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    A little lighter weight than sklearn LOO. We do not need test index.</span>
<span class="sd">    Also passes views on X, not the index.</span>
<span class="sd">    """</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X</span>
        <span class="n">nobs</span><span class="p">,</span> <span class="n">k_vars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nobs</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nobs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">yield</span> <span class="n">X</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:]</span>


<span class="k">def</span> <span class="nf">_get_type_pos</span><span class="p">(</span><span class="n">var_type</span><span class="p">):</span>
    <span class="n">ix_cont</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span> <span class="o">==</span> <span class="s1">'c'</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">var_type</span><span class="p">])</span>
    <span class="n">ix_ord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span> <span class="o">==</span> <span class="s1">'o'</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">var_type</span><span class="p">])</span>
    <span class="n">ix_unord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span> <span class="o">==</span> <span class="s1">'u'</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">var_type</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ix_cont</span><span class="p">,</span> <span class="n">ix_ord</span><span class="p">,</span> <span class="n">ix_unord</span>


<span class="k">def</span> <span class="nf">_adjust_shape</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">k_vars</span><span class="p">):</span>
    <span class="sd">""" Returns an array of shape (nobs, k_vars) for use with `gpke`."""</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dat</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dat</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">k_vars</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># one obs many vars</span>
        <span class="n">nobs</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">dat</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">k_vars</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># one obs one var</span>
        <span class="n">nobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dat</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">k_vars</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dat</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">k_vars</span><span class="p">:</span>
            <span class="n">dat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">T</span>

        <span class="n">nobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">dat</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># ndim &gt;1 so many obs many vars</span>

    <span class="n">dat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="p">(</span><span class="n">nobs</span><span class="p">,</span> <span class="n">k_vars</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dat</span>


<span class="k">def</span> <span class="nf">gpke</span><span class="p">(</span><span class="n">bw</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_predict</span><span class="p">,</span> <span class="n">var_type</span><span class="p">,</span> <span class="n">ckertype</span><span class="o">=</span><span class="s1">'gaussian'</span><span class="p">,</span>
         <span class="n">okertype</span><span class="o">=</span><span class="s1">'wangryzin'</span><span class="p">,</span> <span class="n">ukertype</span><span class="o">=</span><span class="s1">'aitchisonaitken'</span><span class="p">,</span> <span class="n">tosum</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">"""</span>
<span class="sd">    Returns the non-normalized Generalized Product Kernel Estimator</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bw : 1-D ndarray</span>
<span class="sd">        The user-specified bandwidth parameters.</span>
<span class="sd">    data : 1D or 2-D ndarray</span>
<span class="sd">        The training data.</span>
<span class="sd">    data_predict : 1-D ndarray</span>
<span class="sd">        The evaluation points at which the kernel estimation is performed.</span>
<span class="sd">    var_type : str, optional</span>
<span class="sd">        The variable type (continuous, ordered, unordered).</span>
<span class="sd">    ckertype : str, optional</span>
<span class="sd">        The kernel used for the continuous variables.</span>
<span class="sd">    okertype : str, optional</span>
<span class="sd">        The kernel used for the ordered discrete variables.</span>
<span class="sd">    ukertype : str, optional</span>
<span class="sd">        The kernel used for the unordered discrete variables.</span>
<span class="sd">    tosum : bool, optional</span>
<span class="sd">        Whether or not to sum the calculated array of densities.  Default is</span>
<span class="sd">        True.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dens : array_like</span>
<span class="sd">        The generalized product kernel density estimator.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The formula for the multivariate kernel estimator for the pdf is:</span>

<span class="sd">    .. math:: f(x)=\frac{1}{nh_{1}...h_{q}}\sum_{i=1}^</span>
<span class="sd">                        {n}K\left(\frac{X_{i}-x}{h}\right)</span>

<span class="sd">    where</span>

<span class="sd">    .. math:: K\left(\frac{X_{i}-x}{h}\right) =</span>
<span class="sd">                k\left( \frac{X_{i1}-x_{1}}{h_{1}}\right)\times</span>
<span class="sd">                k\left( \frac{X_{i2}-x_{2}}{h_{2}}\right)\times...\times</span>
<span class="sd">                k\left(\frac{X_{iq}-x_{q}}{h_{q}}\right)</span>
<span class="sd">    """</span>
    <span class="n">kertypes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">ckertype</span><span class="p">,</span> <span class="n">o</span><span class="o">=</span><span class="n">okertype</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">ukertype</span><span class="p">)</span>
    <span class="c1">#Kval = []</span>
    <span class="c1">#for ii, vtype in enumerate(var_type):</span>
    <span class="c1">#    func = kernel_func[kertypes[vtype]]</span>
    <span class="c1">#    Kval.append(func(bw[ii], data[:, ii], data_predict[ii]))</span>

    <span class="c1">#Kval = np.column_stack(Kval)</span>

    <span class="n">Kval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">vtype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">var_type</span><span class="p">):</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">kernel_func</span><span class="p">[</span><span class="n">kertypes</span><span class="p">[</span><span class="n">vtype</span><span class="p">]]</span>
        <span class="n">Kval</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">bw</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">],</span> <span class="n">data_predict</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span>

    <span class="n">iscontinuous</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span> <span class="o">==</span> <span class="s1">'c'</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">var_type</span><span class="p">])</span>
    <span class="n">dens</span> <span class="o">=</span> <span class="n">Kval</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">bw</span><span class="p">[</span><span class="n">iscontinuous</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">tosum</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dens</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dens</span>
</pre></div>

          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2009-2019, Josef Perktold, Skipper Seabold, Jonathan Taylor, statsmodels-developers.
              
          </div>
            Last updated on
              Nov 02, 2022.
            <br/>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../../../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>