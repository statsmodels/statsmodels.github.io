
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>statsmodels.sandbox.regression.gmm &#8212; statsmodels 0.8.0 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.8.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../../../_static/statsmodels_hybi_favico.ico"/>
    <link rel="author" title="About these documents" href="../../../../about.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
<link rel="stylesheet" href="../../../../_static/examples.css" type="text/css" />
<link rel="stylesheet" href="../../../../_static/facebox.css" type="text/css" />
<script type="text/javascript" src="../../../../_static/scripts.js">
</script>
<script type="text/javascript" src="../../../../_static/facebox.js">
</script>

  </head>
  <body role="document">
<div class="headerwrap">
    <div class = "header">
        
        <a href = "../../../../index.html">
<img src="../../../../_static/statsmodels_hybi_banner.png" alt="Logo"
    style="padding-left: 15px"/></a>
        
    </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
<li><a href ="../../../../install.html">Install</a></li> &nbsp;|&nbsp;
<li><a href="https://groups.google.com/group/pystatsmodels?hl=en">Support</a></li> &nbsp;|&nbsp;
<li><a href="https://github.com/statsmodels/statsmodels/issues">Bugs</a></li> &nbsp;|&nbsp;
<li><a href="../../../../dev/index.html">Develop</a></li> &nbsp;|&nbsp;
<li><a href="../../../../examples/index.html">Examples</a></li> &nbsp;|&nbsp;
<li><a href="../../../../faq.html">FAQ</a></li> &nbsp;|&nbsp;

          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> |</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            




  <h1>Source code for statsmodels.sandbox.regression.gmm</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;Generalized Method of Moments, GMM, and Two-Stage Least Squares for</span>
<span class="sd">instrumental variables IV2SLS</span>



<span class="sd">Issues</span>
<span class="sd">------</span>
<span class="sd">* number of parameters, nparams, and starting values for parameters</span>
<span class="sd">  Where to put them? start was initially taken from global scope (bug)</span>
<span class="sd">* When optimal weighting matrix cannot be calculated numerically</span>
<span class="sd">  In DistQuantilesGMM, we only have one row of moment conditions, not a</span>
<span class="sd">  moment condition for each observation, calculation for cov of moments</span>
<span class="sd">  breaks down. iter=1 works (weights is identity matrix)</span>
<span class="sd">  -&gt; need method to do one iteration with an identity matrix or an</span>
<span class="sd">     analytical weighting matrix given as parameter.</span>
<span class="sd">  -&gt; add result statistics for this case, e.g. cov_params, I have it in the</span>
<span class="sd">     standalone function (and in calc_covparams which is a copy of it),</span>
<span class="sd">     but not tested yet.</span>
<span class="sd">  DONE `fitonce` in DistQuantilesGMM, params are the same as in direct call to fitgmm</span>
<span class="sd">      move it to GMM class (once it&#39;s clearer for which cases I need this.)</span>
<span class="sd">* GMM doesn&#39;t know anything about the underlying model, e.g. y = X beta + u or panel</span>
<span class="sd">  data model. It would be good if we can reuse methods from regressions, e.g.</span>
<span class="sd">  predict, fitted values, calculating the error term, and some result statistics.</span>
<span class="sd">  What&#39;s the best way to do this, multiple inheritance, outsourcing the functions,</span>
<span class="sd">  mixins or delegation (a model creates a GMM instance just for estimation).</span>


<span class="sd">Unclear</span>
<span class="sd">-------</span>
<span class="sd">* dof in Hausman</span>
<span class="sd">  - based on rank</span>
<span class="sd">  - differs between IV2SLS method and function used with GMM or (IV2SLS)</span>
<span class="sd">  - with GMM, covariance matrix difference has negative eigenvalues in iv example, ???</span>
<span class="sd">* jtest/jval</span>
<span class="sd">  - I&#39;m not sure about the normalization (multiply or divide by nobs) in jtest.</span>
<span class="sd">    need a test case. Scaling of jval is irrelevant for estimation.</span>
<span class="sd">    jval in jtest looks to large in example, but I have no idea about the size</span>
<span class="sd">* bse for fitonce look too large (no time for checking now)</span>
<span class="sd">    formula for calc_cov_params for the case without optimal weighting matrix</span>
<span class="sd">    is wrong. I don&#39;t have an estimate for omega in that case. And I&#39;m confusing</span>
<span class="sd">    between weights and omega, which are *not* the same in this case.</span>



<span class="sd">Author: josef-pktd</span>
<span class="sd">License: BSD (3-clause)</span>

<span class="sd">&#39;&#39;&#39;</span>


<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">statsmodels.compat.python</span> <span class="k">import</span> <span class="n">lrange</span>
<span class="kn">from</span> <span class="nn">statsmodels.compat.numpy</span> <span class="k">import</span> <span class="n">np_matrix_rank</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">optimize</span><span class="p">,</span> <span class="n">stats</span>

<span class="kn">from</span> <span class="nn">statsmodels.tools.numdiff</span> <span class="k">import</span> <span class="n">approx_fprime</span><span class="p">,</span> <span class="n">approx_hess</span>
<span class="kn">from</span> <span class="nn">statsmodels.base.model</span> <span class="k">import</span> <span class="p">(</span><span class="n">Model</span><span class="p">,</span>
                                    <span class="n">LikelihoodModel</span><span class="p">,</span> <span class="n">LikelihoodModelResults</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">statsmodels.regression.linear_model</span> <span class="k">import</span> <span class="p">(</span><span class="n">OLS</span><span class="p">,</span> <span class="n">RegressionResults</span><span class="p">,</span>
                                                 <span class="n">RegressionResultsWrapper</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">statsmodels.stats.sandwich_covariance</span> <span class="k">as</span> <span class="nn">smcov</span>
<span class="kn">from</span> <span class="nn">statsmodels.tools.decorators</span> <span class="k">import</span> <span class="p">(</span><span class="n">resettable_cache</span><span class="p">,</span> <span class="n">cache_readonly</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">statsmodels.tools.tools</span> <span class="k">import</span> <span class="n">_ensure_2d</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">maxabs</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;just a shortcut to np.abs(x).max()</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>


<div class="viewcode-block" id="IV2SLS"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IV2SLS.html#statsmodels.sandbox.regression.gmm.IV2SLS">[docs]</a><span class="k">class</span> <span class="nc">IV2SLS</span><span class="p">(</span><span class="n">LikelihoodModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Instrumental variables estimation using Two-Stage Least-Squares (2SLS)</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    endog: array</span>
<span class="sd">       Endogenous variable, 1-dimensional or 2-dimensional array nobs by 1</span>
<span class="sd">    exog : array</span>
<span class="sd">       Explanatory variables, 1-dimensional or 2-dimensional array nobs by k</span>
<span class="sd">    instruments : array</span>
<span class="sd">       Instruments for explanatory variables. Must contain both exog</span>
<span class="sd">       variables that are not being instrumented and instruments</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    All variables in exog are instrumented in the calculations. If variables</span>
<span class="sd">    in exog are not supposed to be instrumented, then these variables</span>
<span class="sd">    must also to be included in the instrument array.</span>

<span class="sd">    Degrees of freedom in the calculation of the standard errors uses</span>
<span class="sd">    `df_resid = (nobs - k_vars)`.</span>
<span class="sd">    (This corresponds to the `small` option in Stata&#39;s ivreg2.)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">instrument</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument_names</span> <span class="o">=</span> <span class="n">_ensure_2d</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IV2SLS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">)</span>
        <span class="c1"># where is this supposed to be handled</span>
        <span class="c1"># Note: Greene p.77/78 dof correction is not necessary (because only</span>
        <span class="c1">#       asy results), but most packages do it anyway</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#self.df_model = float(self.rank - self.k_constant)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_model</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_constant</span><span class="p">)</span>

<div class="viewcode-block" id="IV2SLS.initialize"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IV2SLS.initialize.html#statsmodels.sandbox.regression.gmm.IV2SLS.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wendog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wexog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span></div>

<div class="viewcode-block" id="IV2SLS.whiten"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IV2SLS.whiten.html#statsmodels.sandbox.regression.gmm.IV2SLS.whiten">[docs]</a>    <span class="k">def</span> <span class="nf">whiten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="IV2SLS.fit"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IV2SLS.fit.html#statsmodels.sandbox.regression.gmm.IV2SLS.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;estimate model using 2SLS IV regression</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        results : instance of RegressionResults</span>
<span class="sd">           regression result</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This returns a generic RegressioResults instance as defined for the</span>
<span class="sd">        linear models.</span>

<span class="sd">        Parameter estimates and covariance are correct, but other results</span>
<span class="sd">        haven&#39;t been tested yet, to seee whether they apply without changes.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#Greene 5th edt., p.78 section 5.4</span>
        <span class="c1">#move this maybe</span>
        <span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span>
        <span class="c1"># TODO: this uses &quot;textbook&quot; calculation, improve linalg</span>
        <span class="n">ztz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
        <span class="n">ztx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xhatparams</span> <span class="o">=</span> <span class="n">xhatparams</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">ztz</span><span class="p">,</span> <span class="n">ztx</span><span class="p">)</span>
        <span class="c1">#print &#39;x.T.shape, xhatparams.shape&#39;, x.shape, xhatparams.shape</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">xhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">xhatparams</span><span class="p">)</span>
        <span class="n">FtF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xhatprod</span> <span class="o">=</span> <span class="n">FtF</span>  <span class="c1">#store for Housman specification test</span>
        <span class="n">Ftx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">Fty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">FtF</span><span class="p">,</span> <span class="n">Fty</span><span class="p">)</span>
        <span class="n">Ftxinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Ftx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">normalized_cov_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Ftxinv</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">FtF</span><span class="p">,</span> <span class="n">Ftxinv</span><span class="p">))</span>

        <span class="n">lfit</span> <span class="o">=</span> <span class="n">IVRegressionResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
                       <span class="n">normalized_cov_params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalized_cov_params</span><span class="p">)</span>

        <span class="n">lfit</span><span class="o">.</span><span class="n">exog_hat_params</span> <span class="o">=</span> <span class="n">xhatparams</span>
        <span class="n">lfit</span><span class="o">.</span><span class="n">exog_hat</span> <span class="o">=</span> <span class="n">xhat</span> <span class="c1"># TODO: do we want to store this, might be large</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="o">=</span> <span class="n">lfit</span>  <span class="c1"># TODO : remove this</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results_ols2nd</span> <span class="o">=</span> <span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">xhat</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">RegressionResultsWrapper</span><span class="p">(</span><span class="n">lfit</span><span class="p">)</span></div>

    <span class="c1">#copied from GLS, because I subclass currently LikelihoodModel and not GLS</span>
<div class="viewcode-block" id="IV2SLS.predict"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IV2SLS.predict.html#statsmodels.sandbox.regression.gmm.IV2SLS.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return linear predicted values from a design matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exog : array-like</span>
<span class="sd">            Design / exogenous data</span>
<span class="sd">        params : array-like, optional after fit has been called</span>
<span class="sd">            Parameters of a linear model</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        An array of fitted values</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If the model as not yet been fit, params is not optional.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">exog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="c1">#JP: this doesn&#39;t look correct for GLMAR</span>
        <span class="c1">#SS: it needs its own predict method</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If the model has not been fit, then you must specify the params argument.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></div></div>



<div class="viewcode-block" id="IVRegressionResults"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IVRegressionResults.html#statsmodels.sandbox.regression.gmm.IVRegressionResults">[docs]</a><span class="k">class</span> <span class="nc">IVRegressionResults</span><span class="p">(</span><span class="n">RegressionResults</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Results class for for an OLS model.</span>

<span class="sd">    Most of the methods and attributes are inherited from RegressionResults.</span>
<span class="sd">    The special methods that are only available for OLS are:</span>

<span class="sd">    - get_influence</span>
<span class="sd">    - outlier_test</span>
<span class="sd">    - el_test</span>
<span class="sd">    - conf_int_el</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    RegressionResults</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@cache_readonly</span>
<div class="viewcode-block" id="IVRegressionResults.fvalue"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IVRegressionResults.fvalue.html#statsmodels.sandbox.regression.gmm.IVRegressionResults.fvalue">[docs]</a>    <span class="k">def</span> <span class="nf">fvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">k_vars</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">restriction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">k_vars</span><span class="p">)</span>
        <span class="n">idx_noconstant</span> <span class="o">=</span> <span class="n">lrange</span><span class="p">(</span><span class="n">k_vars</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">idx_noconstant</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">const_idx</span><span class="p">]</span>
        <span class="n">fval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_test</span><span class="p">(</span><span class="n">restriction</span><span class="p">[</span><span class="n">idx_noconstant</span><span class="p">])</span><span class="o">.</span><span class="n">fvalue</span> <span class="c1"># without constant</span>
        <span class="k">return</span> <span class="n">fval</span></div>


<div class="viewcode-block" id="IVRegressionResults.spec_hausman"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IVRegressionResults.spec_hausman.html#statsmodels.sandbox.regression.gmm.IVRegressionResults.spec_hausman">[docs]</a>    <span class="k">def</span> <span class="nf">spec_hausman</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dof</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Hausman&#39;s specification test</span>


<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        spec_hausman : generic function for Hausman&#39;s specification test</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#use normalized cov_params for OLS</span>

        <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span>
        <span class="n">resols</span> <span class="o">=</span> <span class="n">OLS</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">normalized_cov_params_ols</span> <span class="o">=</span> <span class="n">resols</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">normalized_cov_params</span>
        <span class="c1"># Stata `ivendog` doesn&#39;t use df correction for se</span>
        <span class="c1">#se2 = resols.mse_resid #* resols.df_resid * 1. / len(endog)</span>
        <span class="n">se2</span> <span class="o">=</span> <span class="n">resols</span><span class="o">.</span><span class="n">ssr</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">endog</span><span class="p">)</span>

        <span class="n">params_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">-</span> <span class="n">resols</span><span class="o">.</span><span class="n">params</span>

        <span class="n">cov_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">xhatprod</span><span class="p">)</span> <span class="o">-</span> <span class="n">normalized_cov_params_ols</span>
        <span class="c1">#TODO: the following is very inefficient, solves problem (svd) twice</span>
        <span class="c1">#use linalg.lstsq or svd directly</span>
        <span class="c1">#cov_diff will very often be in-definite (singular)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dof</span><span class="p">:</span>
            <span class="n">dof</span> <span class="o">=</span> <span class="n">np_matrix_rank</span><span class="p">(</span><span class="n">cov_diff</span><span class="p">)</span>
        <span class="n">cov_diffpinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">cov_diff</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">params_diff</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_diffpinv</span><span class="p">,</span> <span class="n">params_diff</span><span class="p">))</span><span class="o">/</span><span class="n">se2</span>
        <span class="n">pval</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">dof</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">H</span><span class="p">,</span> <span class="n">pval</span><span class="p">,</span> <span class="n">dof</span></div>


<span class="c1"># copied from regression results with small changes, no llf</span>
<div class="viewcode-block" id="IVRegressionResults.summary"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IVRegressionResults.summary.html#statsmodels.sandbox.regression.gmm.IVRegressionResults.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">05</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Summarize the Regression Results</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        yname : string, optional</span>
<span class="sd">            Default is `y`</span>
<span class="sd">        xname : list of strings, optional</span>
<span class="sd">            Default is `var_##` for ## in p the number of regressors</span>
<span class="sd">        title : string, optional</span>
<span class="sd">            Title for the top table. If not None, then this replaces the</span>
<span class="sd">            default title</span>
<span class="sd">        alpha : float</span>
<span class="sd">            significance level for the confidence intervals</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        smry : Summary instance</span>
<span class="sd">            this holds the summary tables and text, which can be printed or</span>
<span class="sd">            converted to various output formats.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        statsmodels.iolib.summary.Summary : class to hold summary</span>
<span class="sd">            results</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#TODO: import where we need it (for now), add as cached attributes</span>
        <span class="kn">from</span> <span class="nn">statsmodels.stats.stattools</span> <span class="k">import</span> <span class="p">(</span><span class="n">jarque_bera</span><span class="p">,</span>
                <span class="n">omni_normtest</span><span class="p">,</span> <span class="n">durbin_watson</span><span class="p">)</span>
        <span class="n">jb</span><span class="p">,</span> <span class="n">jbpv</span><span class="p">,</span> <span class="n">skew</span><span class="p">,</span> <span class="n">kurtosis</span> <span class="o">=</span> <span class="n">jarque_bera</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wresid</span><span class="p">)</span>
        <span class="n">omni</span><span class="p">,</span> <span class="n">omnipv</span> <span class="o">=</span> <span class="n">omni_normtest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wresid</span><span class="p">)</span>

        <span class="c1">#TODO: reuse condno from somewhere else ?</span>
        <span class="c1">#condno = np.linalg.cond(np.dot(self.wexog.T, self.wexog))</span>
        <span class="n">wexog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">wexog</span>
        <span class="n">eigvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvalsh</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">wexog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">wexog</span><span class="p">))</span>
        <span class="n">eigvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">eigvals</span><span class="p">)</span> <span class="c1">#in increasing order</span>
        <span class="n">condno</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eigvals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">eigvals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># TODO: check what is valid.</span>
        <span class="c1"># box-pierce, breusch-pagan, durbin&#39;s h are not with endogenous on rhs</span>
        <span class="c1"># use Cumby Huizinga 1992 instead</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diagn</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">jb</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span> <span class="n">jbpv</span><span class="o">=</span><span class="n">jbpv</span><span class="p">,</span> <span class="n">skew</span><span class="o">=</span><span class="n">skew</span><span class="p">,</span> <span class="n">kurtosis</span><span class="o">=</span><span class="n">kurtosis</span><span class="p">,</span>
                          <span class="n">omni</span><span class="o">=</span><span class="n">omni</span><span class="p">,</span> <span class="n">omnipv</span><span class="o">=</span><span class="n">omnipv</span><span class="p">,</span> <span class="n">condno</span><span class="o">=</span><span class="n">condno</span><span class="p">,</span>
                          <span class="n">mineigval</span><span class="o">=</span><span class="n">eigvals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1">#TODO not used yet</span>
        <span class="c1">#diagn_left_header = [&#39;Models stats&#39;]</span>
        <span class="c1">#diagn_right_header = [&#39;Residual stats&#39;]</span>

        <span class="c1">#TODO: requiring list/iterable is a bit annoying</span>
        <span class="c1">#need more control over formatting</span>
        <span class="c1">#TODO: default don&#39;t work if it&#39;s not identically spelled</span>

        <span class="n">top_left</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Dep. Variable:&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;Model:&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;Method:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Two Stage&#39;</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Least Squares&#39;</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s1">&#39;Date:&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;Time:&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;No. Observations:&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;Df Residuals:&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="c1">#[self.df_resid]), #TODO: spelling</span>
                    <span class="p">(</span><span class="s1">&#39;Df Model:&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="c1">#[self.df_model])</span>
                    <span class="p">]</span>

        <span class="n">top_right</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;R-squared:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%#8.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">rsquared</span><span class="p">]),</span>
                     <span class="p">(</span><span class="s1">&#39;Adj. R-squared:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%#8.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">rsquared_adj</span><span class="p">]),</span>
                     <span class="p">(</span><span class="s1">&#39;F-statistic:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%#8.4g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">fvalue</span><span class="p">]</span> <span class="p">),</span>
                     <span class="p">(</span><span class="s1">&#39;Prob (F-statistic):&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%#6.3g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">f_pvalue</span><span class="p">]),</span>
                     <span class="c1">#(&#39;Log-Likelihood:&#39;, None), #[&quot;%#6.4g&quot; % self.llf]),</span>
                     <span class="c1">#(&#39;AIC:&#39;, [&quot;%#8.4g&quot; % self.aic]),</span>
                     <span class="c1">#(&#39;BIC:&#39;, [&quot;%#8.4g&quot; % self.bic])</span>
                     <span class="p">]</span>

        <span class="n">diagn_left</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Omnibus:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%#6.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">omni</span><span class="p">]),</span>
                      <span class="p">(</span><span class="s1">&#39;Prob(Omnibus):&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%#6.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">omnipv</span><span class="p">]),</span>
                      <span class="p">(</span><span class="s1">&#39;Skew:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%#6.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">skew</span><span class="p">]),</span>
                      <span class="p">(</span><span class="s1">&#39;Kurtosis:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%#6.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">kurtosis</span><span class="p">])</span>
                      <span class="p">]</span>

        <span class="n">diagn_right</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Durbin-Watson:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%#8.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">durbin_watson</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wresid</span><span class="p">)]),</span>
                       <span class="p">(</span><span class="s1">&#39;Jarque-Bera (JB):&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%#8.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">jb</span><span class="p">]),</span>
                       <span class="p">(</span><span class="s1">&#39;Prob(JB):&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%#8.3g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">jbpv</span><span class="p">]),</span>
                       <span class="p">(</span><span class="s1">&#39;Cond. No.&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%#8.3g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">condno</span><span class="p">])</span>
                       <span class="p">]</span>


        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s2">&quot;Regression Results&quot;</span>

        <span class="c1">#create summary table instance</span>
        <span class="kn">from</span> <span class="nn">statsmodels.iolib.summary</span> <span class="k">import</span> <span class="n">Summary</span>
        <span class="n">smry</span> <span class="o">=</span> <span class="n">Summary</span><span class="p">()</span>
        <span class="n">smry</span><span class="o">.</span><span class="n">add_table_2cols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gleft</span><span class="o">=</span><span class="n">top_left</span><span class="p">,</span> <span class="n">gright</span><span class="o">=</span><span class="n">top_right</span><span class="p">,</span>
                          <span class="n">yname</span><span class="o">=</span><span class="n">yname</span><span class="p">,</span> <span class="n">xname</span><span class="o">=</span><span class="n">xname</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="n">smry</span><span class="o">.</span><span class="n">add_table_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yname</span><span class="o">=</span><span class="n">yname</span><span class="p">,</span> <span class="n">xname</span><span class="o">=</span><span class="n">xname</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                             <span class="n">use_t</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">smry</span><span class="o">.</span><span class="n">add_table_2cols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gleft</span><span class="o">=</span><span class="n">diagn_left</span><span class="p">,</span> <span class="n">gright</span><span class="o">=</span><span class="n">diagn_right</span><span class="p">,</span>
                          <span class="n">yname</span><span class="o">=</span><span class="n">yname</span><span class="p">,</span> <span class="n">xname</span><span class="o">=</span><span class="n">xname</span><span class="p">,</span>
                          <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>



        <span class="k">return</span> <span class="n">smry</span></div></div>




<span class="c1">############# classes for Generalized Method of Moments GMM</span>

<span class="n">_gmm_options</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span><span class="se">\</span>

<span class="s1">Options for GMM</span>
<span class="s1">---------------</span>

<span class="s1">Type of GMM</span>
<span class="s1">~~~~~~~~~~~</span>

<span class="s1"> - one-step</span>
<span class="s1"> - iterated</span>
<span class="s1"> - CUE : not tested yet</span>

<span class="s1">weight matrix</span>
<span class="s1">~~~~~~~~~~~~~</span>

<span class="s1"> - `weights_method` : string, defines method for robust</span>
<span class="s1">   Options here are similar to :mod:`statsmodels.stats.robust_covariance`</span>
<span class="s1">   default is heteroscedasticity consistent, HC0</span>

<span class="s1">   currently available methods are</span>

<span class="s1">   - `cov` : HC0, optionally with degrees of freedom correction</span>
<span class="s1">   - `hac` :</span>
<span class="s1">   - `iid` : untested, only for Z*u case, IV cases with u as error indep of Z</span>
<span class="s1">   - `ac` : not available yet</span>
<span class="s1">   - `cluster` : not connected yet</span>
<span class="s1">   - others from robust_covariance</span>

<span class="s1">other arguments:</span>

<span class="s1"> - `wargs` : tuple or dict, required arguments for weights_method</span>

<span class="s1">   - `centered` : bool,</span>
<span class="s1">     indicates whether moments are centered for the calculation of the weights</span>
<span class="s1">     and covariance matrix, applies to all weight_methods</span>
<span class="s1">   - `ddof` : int</span>
<span class="s1">     degrees of freedom correction, applies currently only to `cov`</span>
<span class="s1">   - maxlag : int</span>
<span class="s1">     number of lags to include in HAC calculation , applies only to `hac`</span>
<span class="s1">   - others not yet, e.g. groups for cluster robust</span>

<span class="s1">covariance matrix</span>
<span class="s1">~~~~~~~~~~~~~~~~~</span>

<span class="s1">The same options as for weight matrix also apply to the calculation of the</span>
<span class="s1">estimate of the covariance matrix of the parameter estimates.</span>
<span class="s1">The additional option is</span>

<span class="s1"> - `has_optimal_weights`: If true, then the calculation of the covariance</span>
<span class="s1">   matrix assumes that we have optimal GMM with :math:`W = S^{-1}`.</span>
<span class="s1">   Default is True.</span>
<span class="s1">   TODO: do we want to have a different default after `onestep`?</span>


<span class="s1">&#39;&#39;&#39;</span>

<div class="viewcode-block" id="GMM"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMM.html#statsmodels.sandbox.regression.gmm.GMM">[docs]</a><span class="k">class</span> <span class="nc">GMM</span><span class="p">(</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class for estimation by Generalized Method of Moments</span>

<span class="sd">    needs to be subclassed, where the subclass defined the moment conditions</span>
<span class="sd">    `momcond`</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    endog : array</span>
<span class="sd">        endogenous variable, see notes</span>
<span class="sd">    exog : array</span>
<span class="sd">        array of exogenous variables, see notes</span>
<span class="sd">    instrument : array</span>
<span class="sd">        array of instruments, see notes</span>
<span class="sd">    nmoms : None or int</span>
<span class="sd">        number of moment conditions, if None then it is set equal to the</span>
<span class="sd">        number of columns of instruments. Mainly needed to determin the shape</span>
<span class="sd">        or size of start parameters and starting weighting matrix.</span>
<span class="sd">    kwds : anything</span>
<span class="sd">        this is mainly if additional variables need to be stored for the</span>
<span class="sd">        calculations of the moment conditions</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    *Attributes*</span>
<span class="sd">    results : instance of GMMResults</span>
<span class="sd">        currently just a storage class for params and cov_params without it&#39;s</span>
<span class="sd">        own methods</span>
<span class="sd">    bse : property</span>
<span class="sd">        return bse</span>



<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The GMM class only uses the moment conditions and does not use any data</span>
<span class="sd">    directly. endog, exog, instrument and kwds in the creation of the class</span>
<span class="sd">    instance are only used to store them for access in the moment conditions.</span>
<span class="sd">    Which of this are required and how they are used depends on the moment</span>
<span class="sd">    conditions of the subclass.</span>

<span class="sd">    Warning:</span>

<span class="sd">    Options for various methods have not been fully implemented and</span>
<span class="sd">    are still missing in several methods.</span>


<span class="sd">    TODO:</span>
<span class="sd">    currently onestep (maxiter=0) still produces an updated estimate of bse</span>
<span class="sd">    and cov_params.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">results_class</span> <span class="o">=</span> <span class="s1">&#39;GMMResults&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="n">k_moms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">k_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">missing</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        maybe drop and use mixin instead</span>

<span class="sd">        TODO: GMM doesn&#39;t really care about the data, just the moment conditions</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_inputs</span><span class="p">(</span><span class="n">instrument</span><span class="p">,</span> <span class="n">endog</span><span class="p">)</span> <span class="c1"># attaches if needed</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GMM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="n">missing</span><span class="p">,</span>
                <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">)</span>
<span class="c1">#         self.endog = endog</span>
<span class="c1">#         self.exog = exog</span>
<span class="c1">#         self.instrument = instrument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span> <span class="o">=</span> <span class="n">endog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">k_moms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmoms</span> <span class="o">=</span> <span class="n">k_moms</span>
        <span class="k">elif</span> <span class="n">instrument</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmoms</span> <span class="o">=</span> <span class="n">instrument</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nmoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="n">k_params</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_params</span> <span class="o">=</span> <span class="n">k_params</span>
        <span class="k">elif</span> <span class="n">instrument</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_params</span> <span class="o">=</span> <span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_iter</span> <span class="o">=</span> <span class="mf">1e-6</span>

    <span class="k">def</span> <span class="nf">_check_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="n">endog</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instrument</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">instrument</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">offset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">endog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;instrument is not the same length as endog&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instrument</span>

    <span class="k">def</span> <span class="nf">_fix_param_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">param_names</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TODO: this is a temporary fix, need</span>
        <span class="n">xnames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">xnames</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">param_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">xnames</span> <span class="o">=</span> <span class="n">param_names</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;param_names has the wrong length&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">xnames</span><span class="p">):</span>
                <span class="c1"># cut in front for poisson multiplicative</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">xnames</span> <span class="o">=</span> <span class="n">xnames</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">):]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">xnames</span><span class="p">):</span>
                <span class="c1"># cut at the end</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">xnames</span> <span class="o">=</span> <span class="n">xnames</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)]</span>

<div class="viewcode-block" id="GMM.fit"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMM.fit.html#statsmodels.sandbox.regression.gmm.GMM.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">inv_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">weights_method</span><span class="o">=</span><span class="s1">&#39;cov&#39;</span><span class="p">,</span> <span class="n">wargs</span><span class="o">=</span><span class="p">(),</span>
                  <span class="n">has_optimal_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">optim_method</span><span class="o">=</span><span class="s1">&#39;bfgs&#39;</span><span class="p">,</span> <span class="n">optim_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Estimate parameters using GMM and return GMMResults</span>

<span class="sd">        TODO: weight and covariance arguments still need to be made consistent</span>
<span class="sd">        with similar options in other models,</span>
<span class="sd">        see RegressionResult.get_robustcov_results</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start_params : array (optional)</span>
<span class="sd">            starting value for parameters ub minimization. If None then</span>
<span class="sd">            fitstart method is called for the starting values.</span>
<span class="sd">        maxiter : int or &#39;cue&#39;</span>
<span class="sd">            Number of iterations in iterated GMM. The onestep estimate can be</span>
<span class="sd">            obtained with maxiter=0 or 1. If maxiter is large, then the</span>
<span class="sd">            iteration will stop either at maxiter or on convergence of the</span>
<span class="sd">            parameters (TODO: no options for convergence criteria yet.)</span>
<span class="sd">            If `maxiter == &#39;cue&#39;`, the the continuously updated GMM is</span>
<span class="sd">            calculated which updates the weight matrix during the minimization</span>
<span class="sd">            of the GMM objective function. The CUE estimation uses the onestep</span>
<span class="sd">            parameters as starting values.</span>
<span class="sd">        inv_weights : None or ndarray</span>
<span class="sd">            inverse of the starting weighting matrix. If inv_weights are not</span>
<span class="sd">            given then the method `start_weights` is used which depends on</span>
<span class="sd">            the subclass, for IV subclasses `inv_weights = z&#39;z` where `z` are</span>
<span class="sd">            the instruments, otherwise an identity matrix is used.</span>
<span class="sd">        weights_method : string, defines method for robust</span>
<span class="sd">            Options here are similar to :mod:`statsmodels.stats.robust_covariance`</span>
<span class="sd">            default is heteroscedasticity consistent, HC0</span>

<span class="sd">            currently available methods are</span>

<span class="sd">            - `cov` : HC0, optionally with degrees of freedom correction</span>
<span class="sd">            - `hac` :</span>
<span class="sd">            - `iid` : untested, only for Z*u case, IV cases with u as error indep of Z</span>
<span class="sd">            - `ac` : not available yet</span>
<span class="sd">            - `cluster` : not connected yet</span>
<span class="sd">            - others from robust_covariance</span>

<span class="sd">        wargs` : tuple or dict,</span>
<span class="sd">            required and optional arguments for weights_method</span>

<span class="sd">            - `centered` : bool,</span>
<span class="sd">              indicates whether moments are centered for the calculation of the weights</span>
<span class="sd">              and covariance matrix, applies to all weight_methods</span>
<span class="sd">            - `ddof` : int</span>
<span class="sd">              degrees of freedom correction, applies currently only to `cov`</span>
<span class="sd">            - `maxlag` : int</span>
<span class="sd">              number of lags to include in HAC calculation , applies only to `hac`</span>
<span class="sd">            - others not yet, e.g. groups for cluster robust</span>

<span class="sd">        has_optimal_weights: If true, then the calculation of the covariance</span>
<span class="sd">              matrix assumes that we have optimal GMM with :math:`W = S^{-1}`.</span>
<span class="sd">              Default is True.</span>
<span class="sd">              TODO: do we want to have a different default after `onestep`?</span>
<span class="sd">        optim_method : string, default is &#39;bfgs&#39;</span>
<span class="sd">            numerical optimization method. Currently not all optimizers that</span>
<span class="sd">            are available in LikelihoodModels are connected.</span>
<span class="sd">        optim_args : dict</span>
<span class="sd">            keyword arguments for the numerical optimizer.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        results : instance of GMMResults</span>
<span class="sd">            this is also attached as attribute results</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        Warning: One-step estimation, `maxiter` either 0 or 1, still has</span>
<span class="sd">        problems (at least compared to Stata&#39;s gmm).</span>
<span class="sd">        By default it uses a heteroscedasticity robust covariance matrix, but</span>
<span class="sd">        uses the assumption that the weight matrix is optimal.</span>
<span class="sd">        See options for cov_params in the results instance.</span>

<span class="sd">        The same options as for weight matrix also apply to the calculation of</span>
<span class="sd">        the estimate of the covariance matrix of the parameter estimates.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># TODO: add check for correct wargs keys</span>
        <span class="c1">#       currently a misspelled key is not detected,</span>
        <span class="c1">#       because I&#39;m still adding options</span>

        <span class="c1"># TODO: check repeated calls to fit with different options</span>
        <span class="c1">#       arguments are dictionaries, i.e. mutable</span>
        <span class="c1">#       unit test if anything  is stale or spilled over.</span>

        <span class="c1">#bug: where does start come from ???</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">start_params</span>  <span class="c1"># alias for renaming</span>
        <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitstart</span><span class="p">()</span> <span class="c1">#TODO: temporary hack</span>

        <span class="k">if</span> <span class="n">inv_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inv_weights</span>

        <span class="k">if</span> <span class="n">optim_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">optim_args</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;disp&#39;</span> <span class="ow">in</span> <span class="n">optim_args</span><span class="p">:</span>
            <span class="n">optim_args</span><span class="p">[</span><span class="s1">&#39;disp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">maxiter</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">maxiter</span> <span class="o">==</span> <span class="s1">&#39;cue&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inv_weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">inv_weights</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># let start_weights handle the inv=False for maxiter=0</span>
                <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_weights</span><span class="p">(</span><span class="n">inv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitgmm</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
                                 <span class="n">optim_method</span><span class="o">=</span><span class="n">optim_method</span><span class="p">,</span> <span class="n">optim_args</span><span class="o">=</span><span class="n">optim_args</span><span class="p">)</span>
            <span class="n">weights_</span> <span class="o">=</span> <span class="n">weights</span>  <span class="c1"># temporary alias used in jval</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fititer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span>
                                           <span class="n">maxiter</span><span class="o">=</span><span class="n">maxiter</span><span class="p">,</span>
                                           <span class="n">start_invweights</span><span class="o">=</span><span class="n">inv_weights</span><span class="p">,</span>
                                           <span class="n">weights_method</span><span class="o">=</span><span class="n">weights_method</span><span class="p">,</span>
                                           <span class="n">wargs</span><span class="o">=</span><span class="n">wargs</span><span class="p">,</span>
                                           <span class="n">optim_method</span><span class="o">=</span><span class="n">optim_method</span><span class="p">,</span>
                                           <span class="n">optim_args</span><span class="o">=</span><span class="n">optim_args</span><span class="p">)</span>
            <span class="c1"># TODO weights returned by fititer is inv_weights - not true anymore</span>
            <span class="c1"># weights_ currently not necessary and used anymore</span>
            <span class="n">weights_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">maxiter</span> <span class="o">==</span> <span class="s1">&#39;cue&#39;</span><span class="p">:</span>
            <span class="c1">#we have params from maxiter= 0 as starting value</span>
            <span class="c1"># TODO: need to give weights options to gmmobjective_cu</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitgmm_cu</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
                                     <span class="n">optim_method</span><span class="o">=</span><span class="n">optim_method</span><span class="p">,</span>
                                     <span class="n">optim_args</span><span class="o">=</span><span class="n">optim_args</span><span class="p">)</span>
            <span class="c1"># weights is stored as attribute</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights_cu</span>

        <span class="c1">#TODO: use Bunch instead ?</span>
        <span class="n">options_other</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;weights_method&#39;</span><span class="p">:</span><span class="n">weights_method</span><span class="p">,</span>
                         <span class="s1">&#39;has_optimal_weights&#39;</span><span class="p">:</span><span class="n">has_optimal_weights</span><span class="p">,</span>
                         <span class="s1">&#39;optim_method&#39;</span><span class="p">:</span><span class="n">optim_method</span><span class="p">}</span>

        <span class="c1"># check that we have the right number of xnames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fix_param_names</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">param_names</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">results_class_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">results_class</span><span class="p">](</span>
                                        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="p">,</span>
                                        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">,</span>
                                        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">,</span>
                                        <span class="n">wargs</span> <span class="o">=</span> <span class="n">wargs</span><span class="p">,</span>
                                        <span class="n">options_other</span> <span class="o">=</span> <span class="n">options_other</span><span class="p">,</span>
                                        <span class="n">optim_args</span> <span class="o">=</span> <span class="n">optim_args</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span> <span class="c1"># FIXME: remove, still keeping it temporarily</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="GMM.fitgmm"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMM.fitgmm.html#statsmodels.sandbox.regression.gmm.GMM.fitgmm">[docs]</a>    <span class="k">def</span> <span class="nf">fitgmm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optim_method</span><span class="o">=</span><span class="s1">&#39;bfgs&#39;</span><span class="p">,</span> <span class="n">optim_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;estimate parameters using GMM</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start : array_like</span>
<span class="sd">            starting values for minimization</span>
<span class="sd">        weights : array</span>
<span class="sd">            weighting matrix for moment conditions. If weights is None, then</span>
<span class="sd">            the identity matrix is used</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        paramest : array</span>
<span class="sd">            estimated parameters</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        todo: add fixed parameter option, not here ???</span>

<span class="sd">        uses scipy.optimize.fmin</span>

<span class="sd">        &#39;&#39;&#39;</span>
<span class="c1">##        if not fixed is None:  #fixed not defined in this version</span>
<span class="c1">##            raise NotImplementedError</span>

        <span class="c1"># TODO: should start_weights only be in `fit`</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_weights</span><span class="p">(</span><span class="n">inv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">optim_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">optim_args</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">optim_method</span> <span class="o">==</span> <span class="s1">&#39;nm&#39;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fmin</span>
        <span class="k">elif</span> <span class="n">optim_method</span> <span class="o">==</span> <span class="s1">&#39;bfgs&#39;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fmin_bfgs</span>
            <span class="c1"># TODO: add score</span>
            <span class="n">optim_args</span><span class="p">[</span><span class="s1">&#39;fprime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="c1">#lambda params: self.score(params, weights)</span>
        <span class="k">elif</span> <span class="n">optim_method</span> <span class="o">==</span> <span class="s1">&#39;ncg&#39;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fmin_ncg</span>
            <span class="n">optim_args</span><span class="p">[</span><span class="s1">&#39;fprime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span>
        <span class="k">elif</span> <span class="n">optim_method</span> <span class="o">==</span> <span class="s1">&#39;cg&#39;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fmin_cg</span>
            <span class="n">optim_args</span><span class="p">[</span><span class="s1">&#39;fprime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span>
        <span class="k">elif</span> <span class="n">optim_method</span> <span class="o">==</span> <span class="s1">&#39;fmin_l_bfgs_b&#39;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fmin_l_bfgs_b</span>
            <span class="n">optim_args</span><span class="p">[</span><span class="s1">&#39;fprime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span>
        <span class="k">elif</span> <span class="n">optim_method</span> <span class="o">==</span> <span class="s1">&#39;powell&#39;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fmin_powell</span>
        <span class="k">elif</span> <span class="n">optim_method</span> <span class="o">==</span> <span class="s1">&#39;slsqp&#39;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fmin_slsqp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;optimizer method not available&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span>

        <span class="c1">#TODO: add other optimization options and results</span>
        <span class="k">return</span> <span class="n">optimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gmmobjective</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">weights</span><span class="p">,),</span>
                         <span class="o">**</span><span class="n">optim_args</span><span class="p">)</span></div>


<div class="viewcode-block" id="GMM.fitgmm_cu"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMM.fitgmm_cu.html#statsmodels.sandbox.regression.gmm.GMM.fitgmm_cu">[docs]</a>    <span class="k">def</span> <span class="nf">fitgmm_cu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">optim_method</span><span class="o">=</span><span class="s1">&#39;bfgs&#39;</span><span class="p">,</span> <span class="n">optim_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;estimate parameters using continuously updating GMM</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start : array_like</span>
<span class="sd">            starting values for minimization</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        paramest : array</span>
<span class="sd">            estimated parameters</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        todo: add fixed parameter option, not here ???</span>

<span class="sd">        uses scipy.optimize.fmin</span>

<span class="sd">        &#39;&#39;&#39;</span>
<span class="c1">##        if not fixed is None:  #fixed not defined in this version</span>
<span class="c1">##            raise NotImplementedError</span>

        <span class="k">if</span> <span class="n">optim_args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">optim_args</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">optim_method</span> <span class="o">==</span> <span class="s1">&#39;nm&#39;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fmin</span>
        <span class="k">elif</span> <span class="n">optim_method</span> <span class="o">==</span> <span class="s1">&#39;bfgs&#39;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fmin_bfgs</span>
            <span class="n">optim_args</span><span class="p">[</span><span class="s1">&#39;fprime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_cu</span>
        <span class="k">elif</span> <span class="n">optim_method</span> <span class="o">==</span> <span class="s1">&#39;ncg&#39;</span><span class="p">:</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">fmin_ncg</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;optimizer method not available&#39;</span><span class="p">)</span>

        <span class="c1">#TODO: add other optimization options and results</span>
        <span class="k">return</span> <span class="n">optimizer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gmmobjective_cu</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="o">**</span><span class="n">optim_args</span><span class="p">)</span></div>

<div class="viewcode-block" id="GMM.start_weights"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMM.start_weights.html#statsmodels.sandbox.regression.gmm.GMM.start_weights">[docs]</a>    <span class="k">def</span> <span class="nf">start_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmoms</span><span class="p">)</span></div>

<div class="viewcode-block" id="GMM.gmmobjective"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMM.gmmobjective.html#statsmodels.sandbox.regression.gmm.GMM.gmmobjective">[docs]</a>    <span class="k">def</span> <span class="nf">gmmobjective</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        objective function for GMM minimization</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : array</span>
<span class="sd">            parameter values at which objective is evaluated</span>
<span class="sd">        weights : array</span>
<span class="sd">            weighting matrix</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        jval : float</span>
<span class="sd">            value of objective function</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">moms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">momcond_mean</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">moms</span><span class="p">,</span> <span class="n">weights</span><span class="p">),</span> <span class="n">moms</span><span class="p">)</span></div>
        <span class="c1">#moms = self.momcond(params)</span>
        <span class="c1">#return np.dot(np.dot(moms.mean(0),weights), moms.mean(0))</span>


<div class="viewcode-block" id="GMM.gmmobjective_cu"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMM.gmmobjective_cu.html#statsmodels.sandbox.regression.gmm.GMM.gmmobjective_cu">[docs]</a>    <span class="k">def</span> <span class="nf">gmmobjective_cu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">weights_method</span><span class="o">=</span><span class="s1">&#39;cov&#39;</span><span class="p">,</span>
                        <span class="n">wargs</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        objective function for continuously updating  GMM minimization</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : array</span>
<span class="sd">            parameter values at which objective is evaluated</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        jval : float</span>
<span class="sd">            value of objective function</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">moms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">momcond</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">inv_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_weightmatrix</span><span class="p">(</span><span class="n">moms</span><span class="p">,</span> <span class="n">weights_method</span><span class="o">=</span><span class="n">weights_method</span><span class="p">,</span>
                                             <span class="n">wargs</span><span class="o">=</span><span class="n">wargs</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">inv_weights</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_weights_cu</span> <span class="o">=</span> <span class="n">weights</span>  <span class="c1"># store if we need it later</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">moms</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">weights</span><span class="p">),</span> <span class="n">moms</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span></div>


<div class="viewcode-block" id="GMM.fititer"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMM.fititer.html#statsmodels.sandbox.regression.gmm.GMM.fititer">[docs]</a>    <span class="k">def</span> <span class="nf">fititer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">start_invweights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">weights_method</span><span class="o">=</span><span class="s1">&#39;cov&#39;</span><span class="p">,</span> <span class="n">wargs</span><span class="o">=</span><span class="p">(),</span> <span class="n">optim_method</span><span class="o">=</span><span class="s1">&#39;bfgs&#39;</span><span class="p">,</span>
                    <span class="n">optim_args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;iterative estimation with updating of optimal weighting matrix</span>

<span class="sd">        stopping criteria are maxiter or change in parameter estimate less</span>
<span class="sd">        than self.epsilon_iter, with default 1e-6.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start : array</span>
<span class="sd">            starting value for parameters</span>
<span class="sd">        maxiter : int</span>
<span class="sd">            maximum number of iterations</span>
<span class="sd">        start_weights : array (nmoms, nmoms)</span>
<span class="sd">            initial weighting matrix; if None, then the identity matrix</span>
<span class="sd">            is used</span>
<span class="sd">        weights_method : {&#39;cov&#39;, ...}</span>
<span class="sd">            method to use to estimate the optimal weighting matrix,</span>
<span class="sd">            see calc_weightmatrix for details</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        params : array</span>
<span class="sd">            estimated parameters</span>
<span class="sd">        weights : array</span>
<span class="sd">            optimal weighting matrix calculated with final parameter</span>
<span class="sd">            estimates</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>




<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">momcond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">momcond</span>

        <span class="k">if</span> <span class="n">start_invweights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_weights</span><span class="p">(</span><span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">start_invweights</span>

        <span class="c1">#call fitgmm function</span>
        <span class="c1">#args = (self.endog, self.exog, self.instrument)</span>
        <span class="c1">#args is not used in the method version</span>
        <span class="n">winv_new</span> <span class="o">=</span> <span class="n">w</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span>
            <span class="n">winv</span> <span class="o">=</span> <span class="n">winv_new</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">winv</span><span class="p">)</span>
            <span class="c1">#this is still calling function not method</span>
<span class="c1">##            resgmm = fitgmm(momcond, (), start, weights=winv, fixed=None,</span>
<span class="c1">##                            weightsoptimal=False)</span>
            <span class="n">resgmm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitgmm</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">optim_method</span><span class="o">=</span><span class="n">optim_method</span><span class="p">,</span>
                                 <span class="n">optim_args</span><span class="o">=</span><span class="n">optim_args</span><span class="p">)</span>

            <span class="n">moms</span> <span class="o">=</span> <span class="n">momcond</span><span class="p">(</span><span class="n">resgmm</span><span class="p">)</span>
            <span class="c1"># the following is S = cov_moments</span>
            <span class="n">winv_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_weightmatrix</span><span class="p">(</span><span class="n">moms</span><span class="p">,</span>
                                              <span class="n">weights_method</span><span class="o">=</span><span class="n">weights_method</span><span class="p">,</span>
                                              <span class="n">wargs</span><span class="o">=</span><span class="n">wargs</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">resgmm</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">it</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">maxabs</span><span class="p">(</span><span class="n">resgmm</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_iter</span><span class="p">:</span>
                <span class="c1">#check rule for early stopping</span>
                <span class="c1"># TODO: set has_optimal_weights = True</span>
                <span class="k">break</span>

            <span class="n">start</span> <span class="o">=</span> <span class="n">resgmm</span>
        <span class="k">return</span> <span class="n">resgmm</span><span class="p">,</span> <span class="n">w</span></div>


<div class="viewcode-block" id="GMM.calc_weightmatrix"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMM.calc_weightmatrix.html#statsmodels.sandbox.regression.gmm.GMM.calc_weightmatrix">[docs]</a>    <span class="k">def</span> <span class="nf">calc_weightmatrix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moms</span><span class="p">,</span> <span class="n">weights_method</span><span class="o">=</span><span class="s1">&#39;cov&#39;</span><span class="p">,</span> <span class="n">wargs</span><span class="o">=</span><span class="p">(),</span>
                          <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        calculate omega or the weighting matrix</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        moms : array, (nobs, nmoms)</span>
<span class="sd">            moment conditions for all observations evaluated at a parameter</span>
<span class="sd">            value</span>
<span class="sd">        weights_method : string &#39;cov&#39;</span>
<span class="sd">            If method=&#39;cov&#39; is cov then the matrix is calculated as simple</span>
<span class="sd">            covariance of the moment conditions.</span>
<span class="sd">            see fit method for available aoptions for the weight and covariance</span>
<span class="sd">            matrix</span>
<span class="sd">        wargs : tuple or dict</span>
<span class="sd">            parameters that are required by some kernel methods to</span>
<span class="sd">            estimate the long-run covariance. Not used yet.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        w : array (nmoms, nmoms)</span>
<span class="sd">            estimate for the weighting matrix or covariance of the moment</span>
<span class="sd">            condition</span>


<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        currently a constant cutoff window is used</span>
<span class="sd">        TODO: implement long-run cov estimators, kernel-based</span>

<span class="sd">        Newey-West</span>
<span class="sd">        Andrews</span>
<span class="sd">        Andrews-Moy????</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        Greene</span>
<span class="sd">        Hansen, Bruce</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">nobs</span><span class="p">,</span> <span class="n">k_moms</span> <span class="o">=</span> <span class="n">moms</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># TODO: wargs are tuple or dict ?</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; momcov wargs&#39;</span><span class="p">,</span> <span class="n">wargs</span><span class="p">)</span>

        <span class="n">centered</span> <span class="o">=</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;centered&#39;</span> <span class="ow">in</span> <span class="n">wargs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">wargs</span><span class="p">[</span><span class="s1">&#39;centered&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">centered</span><span class="p">:</span>
            <span class="c1"># caller doesn&#39;t want centered moment conditions</span>
            <span class="n">moms_</span> <span class="o">=</span> <span class="n">moms</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">moms_</span> <span class="o">=</span> <span class="n">moms</span> <span class="o">-</span> <span class="n">moms</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># TODO: store this outside to avoid doing this inside optimization loop</span>
        <span class="c1"># TODO: subclasses need to be able to add weights_methods, and remove</span>
        <span class="c1">#       IVGMM can have homoscedastic (OLS),</span>
        <span class="c1">#       some options won&#39;t make sense in some cases</span>
        <span class="c1">#       possible add all here and allow subclasses to define a list</span>
        <span class="c1"># TODO: should other weights_methods also have `ddof`</span>
        <span class="k">if</span> <span class="n">weights_method</span> <span class="o">==</span> <span class="s1">&#39;cov&#39;</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">moms_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">moms_</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;ddof&#39;</span> <span class="ow">in</span> <span class="n">wargs</span><span class="p">:</span>
                <span class="c1"># caller requests degrees of freedom correction</span>
                <span class="k">if</span> <span class="n">wargs</span><span class="p">[</span><span class="s1">&#39;ddof&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;k_params&#39;</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">/=</span> <span class="p">(</span><span class="n">nobs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_params</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; momcov ddof&#39;</span><span class="p">,</span> <span class="n">wargs</span><span class="p">[</span><span class="s1">&#39;ddof&#39;</span><span class="p">])</span>
                    <span class="n">w</span> <span class="o">/=</span> <span class="p">(</span><span class="n">nobs</span> <span class="o">-</span> <span class="n">wargs</span><span class="p">[</span><span class="s1">&#39;ddof&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># default: divide by nobs</span>
                <span class="n">w</span> <span class="o">/=</span> <span class="n">nobs</span>

        <span class="k">elif</span> <span class="n">weights_method</span> <span class="o">==</span> <span class="s1">&#39;flatkernel&#39;</span><span class="p">:</span>
            <span class="c1">#uniform cut-off window</span>
            <span class="c1"># This was a trial version, can use HAC with flatkernel</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;maxlag&#39;</span> <span class="ow">in</span> <span class="n">wargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;flatkernel requires maxlag&#39;</span><span class="p">)</span>

            <span class="n">maxlag</span> <span class="o">=</span> <span class="n">wargs</span><span class="p">[</span><span class="s1">&#39;maxlag&#39;</span><span class="p">]</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">maxlag</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">moms_</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">moms_</span><span class="p">)</span><span class="o">/</span><span class="n">nobs</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">maxlag</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">w</span> <span class="o">+=</span> <span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">moms_</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">moms_</span><span class="p">[:</span><span class="o">-</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">nobs</span><span class="o">-</span><span class="n">i</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">weights_method</span> <span class="o">==</span> <span class="s1">&#39;hac&#39;</span><span class="p">:</span>
            <span class="n">maxlag</span> <span class="o">=</span> <span class="n">wargs</span><span class="p">[</span><span class="s1">&#39;maxlag&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;kernel&#39;</span> <span class="ow">in</span> <span class="n">wargs</span><span class="p">:</span>
                <span class="n">weights_func</span> <span class="o">=</span> <span class="n">wargs</span><span class="p">[</span><span class="s1">&#39;kernel&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">weights_func</span> <span class="o">=</span> <span class="n">smcov</span><span class="o">.</span><span class="n">weights_bartlett</span>
                <span class="n">wargs</span><span class="p">[</span><span class="s1">&#39;kernel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weights_func</span>

            <span class="n">w</span> <span class="o">=</span> <span class="n">smcov</span><span class="o">.</span><span class="n">S_hac_simple</span><span class="p">(</span><span class="n">moms_</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="n">maxlag</span><span class="p">,</span>
                                   <span class="n">weights_func</span><span class="o">=</span><span class="n">weights_func</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">/=</span> <span class="n">nobs</span> <span class="c1">#(nobs - self.k_params)</span>

        <span class="k">elif</span> <span class="n">weights_method</span> <span class="o">==</span> <span class="s1">&#39;iid&#39;</span><span class="p">:</span>
            <span class="c1"># only when we have instruments and residual mom = Z * u</span>
            <span class="c1"># TODO: problem we don&#39;t have params in argument</span>
            <span class="c1">#       I cannot keep everything in here w/o params as argument</span>
            <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_error</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">centered</span><span class="p">:</span>
                <span class="c1"># Note: I&#39;m not centering instruments,</span>
                <span class="c1">#    shouldn&#39;t we always center u? Ok, with centered as default</span>
                <span class="n">u</span> <span class="o">-=</span> <span class="n">u</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1">#demean inplace, we don&#39;t need original u</span>

            <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">instrument</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">instrument</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">u</span><span class="p">))</span> <span class="o">/</span> <span class="n">nobs</span>
            <span class="k">if</span> <span class="s1">&#39;ddof&#39;</span> <span class="ow">in</span> <span class="n">wargs</span><span class="p">:</span>
                <span class="c1"># caller requests degrees of freedom correction</span>
                <span class="k">if</span> <span class="n">wargs</span><span class="p">[</span><span class="s1">&#39;ddof&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;k_params&#39;</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">/=</span> <span class="p">(</span><span class="n">nobs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_params</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># assume ddof is a number</span>
                    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; momcov ddof&#39;</span><span class="p">,</span> <span class="n">wargs</span><span class="p">[</span><span class="s1">&#39;ddof&#39;</span><span class="p">])</span>
                    <span class="n">w</span> <span class="o">/=</span> <span class="p">(</span><span class="n">nobs</span> <span class="o">-</span> <span class="n">wargs</span><span class="p">[</span><span class="s1">&#39;ddof&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># default: divide by nobs</span>
                <span class="n">w</span> <span class="o">/=</span> <span class="n">nobs</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;weight method not available&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">w</span></div>


<div class="viewcode-block" id="GMM.momcond_mean"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMM.momcond_mean.html#statsmodels.sandbox.regression.gmm.GMM.momcond_mean">[docs]</a>    <span class="k">def</span> <span class="nf">momcond_mean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        mean of moment conditions,</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">momcond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">momcond</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nobs_moms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_moms</span> <span class="o">=</span> <span class="n">momcond</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">return</span> <span class="n">momcond</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="GMM.gradient_momcond"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMM.gradient_momcond.html#statsmodels.sandbox.regression.gmm.GMM.gradient_momcond">[docs]</a>    <span class="k">def</span> <span class="nf">gradient_momcond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">centered</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;gradient of moment conditions</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : ndarray</span>
<span class="sd">            parameter at which the moment conditions are evaluated</span>
<span class="sd">        epsilon : float</span>
<span class="sd">            stepsize for finite difference calculation</span>
<span class="sd">        centered : bool</span>
<span class="sd">            This refers to the finite difference calculation. If `centered`</span>
<span class="sd">            is true, then the centered finite difference calculation is</span>
<span class="sd">            used. Otherwise the one-sided forward differences are used.</span>

<span class="sd">        TODO: looks like not used yet</span>
<span class="sd">              missing argument `weights`</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">momcond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">momcond_mean</span>

        <span class="c1"># TODO: approx_fprime has centered keyword</span>
        <span class="k">if</span> <span class="n">centered</span><span class="p">:</span>
            <span class="n">gradmoms</span> <span class="o">=</span> <span class="p">(</span><span class="n">approx_fprime</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">momcond</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span> <span class="o">+</span>
                    <span class="n">approx_fprime</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">momcond</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=-</span><span class="n">epsilon</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gradmoms</span> <span class="o">=</span> <span class="n">approx_fprime</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">momcond</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gradmoms</span></div>

<div class="viewcode-block" id="GMM.score"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMM.score.html#statsmodels.sandbox.regression.gmm.GMM.score">[docs]</a>    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">centered</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">deriv</span> <span class="o">=</span> <span class="n">approx_fprime</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmmobjective</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">weights</span><span class="p">,),</span>
                              <span class="n">centered</span><span class="o">=</span><span class="n">centered</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">deriv</span></div>

<div class="viewcode-block" id="GMM.score_cu"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMM.score_cu.html#statsmodels.sandbox.regression.gmm.GMM.score_cu">[docs]</a>    <span class="k">def</span> <span class="nf">score_cu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">centered</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">deriv</span> <span class="o">=</span> <span class="n">approx_fprime</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmmobjective_cu</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span>
                              <span class="n">centered</span><span class="o">=</span><span class="n">centered</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">deriv</span></div></div>


<span class="c1"># TODO: wrong superclass, I want tvalues, ... right now</span>
<div class="viewcode-block" id="GMMResults"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMMResults.html#statsmodels.sandbox.regression.gmm.GMMResults">[docs]</a><span class="k">class</span> <span class="nc">GMMResults</span><span class="p">(</span><span class="n">LikelihoodModelResults</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;just a storage class right now&#39;&#39;&#39;</span>

    <span class="n">use_t</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwds</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">nobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_resid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cov_params_default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cov_params</span><span class="p">()</span>


    <span class="nd">@cache_readonly</span>
<div class="viewcode-block" id="GMMResults.q"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMMResults.q.html#statsmodels.sandbox.regression.gmm.GMMResults.q">[docs]</a>    <span class="k">def</span> <span class="nf">q</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">gmmobjective</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span></div>


    <span class="nd">@cache_readonly</span>
<div class="viewcode-block" id="GMMResults.jval"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMMResults.jval.html#statsmodels.sandbox.regression.gmm.GMMResults.jval">[docs]</a>    <span class="k">def</span> <span class="nf">jval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># nobs_moms attached by momcond_mean</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">nobs_moms</span></div>


    <span class="k">def</span> <span class="nf">_cov_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>

        <span class="c1">#TODO add options ???)</span>
        <span class="c1"># this should use by default whatever options have been specified in</span>
        <span class="c1"># fit</span>

        <span class="c1"># TODO: don&#39;t do this when we want to change options</span>
<span class="c1">#         if hasattr(self, &#39;_cov_params&#39;):</span>
<span class="c1">#             #replace with decorator later</span>
<span class="c1">#             return self._cov_params</span>

        <span class="c1"># set defaults based on fit arguments</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;wargs&#39;</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
            <span class="c1"># Note: we don&#39;t check the keys in wargs, use either all or nothing</span>
            <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;wargs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wargs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;weights_method&#39;</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
            <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;weights_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_other</span><span class="p">[</span><span class="s1">&#39;weights_method&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;has_optimal_weights&#39;</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
            <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;has_optimal_weights&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options_other</span><span class="p">[</span><span class="s1">&#39;has_optimal_weights&#39;</span><span class="p">]</span>

        <span class="n">gradmoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">gradient_momcond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">moms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">momcond</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
        <span class="n">covparams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_cov_params</span><span class="p">(</span><span class="n">moms</span><span class="p">,</span> <span class="n">gradmoms</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">covparams</span>


<div class="viewcode-block" id="GMMResults.calc_cov_params"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMMResults.calc_cov_params.html#statsmodels.sandbox.regression.gmm.GMMResults.calc_cov_params">[docs]</a>    <span class="k">def</span> <span class="nf">calc_cov_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">moms</span><span class="p">,</span> <span class="n">gradmoms</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                              <span class="n">has_optimal_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">weights_method</span><span class="o">=</span><span class="s1">&#39;cov&#39;</span><span class="p">,</span> <span class="n">wargs</span><span class="o">=</span><span class="p">()):</span>
        <span class="sd">&#39;&#39;&#39;calculate covariance of parameter estimates</span>

<span class="sd">        not all options tried out yet</span>

<span class="sd">        If weights matrix is given, then the formula use to calculate cov_params</span>
<span class="sd">        depends on whether has_optimal_weights is true.</span>
<span class="sd">        If no weights are given, then the weight matrix is calculated with</span>
<span class="sd">        the given method, and has_optimal_weights is assumed to be true.</span>

<span class="sd">        (API Note: The latter assumption could be changed if we allow for</span>
<span class="sd">        has_optimal_weights=None.)</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">nobs</span> <span class="o">=</span> <span class="n">moms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#omegahat = self.model.calc_weightmatrix(moms, method=method, wargs=wargs)</span>
            <span class="c1">#has_optimal_weights = True</span>
            <span class="c1">#add other options, Barzen, ...  longrun var estimators</span>
            <span class="c1"># TODO: this might still be inv_weights after fititer</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
            <span class="c1">#omegahat = weights   #2 different names used,</span>
            <span class="c1">#TODO: this is wrong, I need an estimate for omega</span>

        <span class="k">if</span> <span class="n">use_weights</span><span class="p">:</span>
            <span class="n">omegahat</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">omegahat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">calc_weightmatrix</span><span class="p">(</span>
                                                <span class="n">moms</span><span class="p">,</span>
                                                <span class="n">weights_method</span><span class="o">=</span><span class="n">weights_method</span><span class="p">,</span>
                                                <span class="n">wargs</span><span class="o">=</span><span class="n">wargs</span><span class="p">,</span>
                                                <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">has_optimal_weights</span><span class="p">:</span> <span class="c1">#has_optimal_weights:</span>
            <span class="c1"># TOD0 make has_optimal_weights depend on convergence or iter &gt;2</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">gradmoms</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">omegahat</span><span class="p">),</span> <span class="n">gradmoms</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">gradmoms</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
            <span class="n">gwginv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">gw</span><span class="p">,</span> <span class="n">gradmoms</span><span class="p">))</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">gwginv</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">gw</span><span class="p">,</span> <span class="n">omegahat</span><span class="p">),</span> <span class="n">gw</span><span class="o">.</span><span class="n">T</span><span class="p">)),</span> <span class="n">gwginv</span><span class="p">)</span>
            <span class="c1">#cov /= nobs</span>

        <span class="k">return</span> <span class="n">cov</span><span class="o">/</span><span class="n">nobs</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bse_</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;standard error of the parameter estimates</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bse</span><span class="p">()</span>

<div class="viewcode-block" id="GMMResults.get_bse"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMMResults.get_bse.html#statsmodels.sandbox.regression.gmm.GMMResults.get_bse">[docs]</a>    <span class="k">def</span> <span class="nf">get_bse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;standard error of the parameter estimates with options</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwds : optional keywords</span>
<span class="sd">            options for calculating cov_params</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bse : ndarray</span>
<span class="sd">            estimated standard error of parameter estimates</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_params</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">)))</span></div>

<div class="viewcode-block" id="GMMResults.jtest"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMMResults.jtest.html#statsmodels.sandbox.regression.gmm.GMMResults.jtest">[docs]</a>    <span class="k">def</span> <span class="nf">jtest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;overidentification test</span>

<span class="sd">        I guess this is missing a division by nobs,</span>
<span class="sd">        what&#39;s the normalization in jval ?</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">jstat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jval</span>
        <span class="n">nparams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">size</span> <span class="c1">#self.nparams</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">nmoms</span> <span class="o">-</span> <span class="n">nparams</span>
        <span class="k">return</span> <span class="n">jstat</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">jstat</span><span class="p">,</span> <span class="n">df</span><span class="p">),</span> <span class="n">df</span></div>


<div class="viewcode-block" id="GMMResults.compare_j"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMMResults.compare_j.html#statsmodels.sandbox.regression.gmm.GMMResults.compare_j">[docs]</a>    <span class="k">def</span> <span class="nf">compare_j</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;overidentification test for comparing two nested gmm estimates</span>

<span class="sd">        This assumes that some moment restrictions have been dropped in one</span>
<span class="sd">        of the GMM estimates relative to the other.</span>

<span class="sd">        Not tested yet</span>

<span class="sd">        We are comparing two separately estimated models, that use different</span>
<span class="sd">        weighting matrices. It is not guaranteed that the resulting</span>
<span class="sd">        difference is positive.</span>

<span class="sd">        TODO: Check in which cases Stata programs use the same weigths</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">jstat1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jval</span>
        <span class="n">k_moms1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">nmoms</span>
        <span class="n">jstat2</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">jval</span>
        <span class="n">k_moms2</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">nmoms</span>
        <span class="n">jdiff</span> <span class="o">=</span> <span class="n">jstat1</span> <span class="o">-</span> <span class="n">jstat2</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">k_moms1</span> <span class="o">-</span> <span class="n">k_moms2</span>
        <span class="k">if</span> <span class="n">df</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># possible nested in other way, TODO allow this or not</span>
            <span class="c1"># flip sign instead of absolute</span>
            <span class="n">df</span> <span class="o">=</span> <span class="o">-</span> <span class="n">df</span>
            <span class="n">jdiff</span> <span class="o">=</span> <span class="o">-</span> <span class="n">jdiff</span>
        <span class="k">return</span> <span class="n">jdiff</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">jdiff</span><span class="p">,</span> <span class="n">df</span><span class="p">),</span> <span class="n">df</span></div>


<div class="viewcode-block" id="GMMResults.summary"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.GMMResults.summary.html#statsmodels.sandbox.regression.gmm.GMMResults.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">05</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Summarize the Regression Results</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        yname : string, optional</span>
<span class="sd">            Default is `y`</span>
<span class="sd">        xname : list of strings, optional</span>
<span class="sd">            Default is `var_##` for ## in p the number of regressors</span>
<span class="sd">        title : string, optional</span>
<span class="sd">            Title for the top table. If not None, then this replaces the</span>
<span class="sd">            default title</span>
<span class="sd">        alpha : float</span>
<span class="sd">            significance level for the confidence intervals</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        smry : Summary instance</span>
<span class="sd">            this holds the summary tables and text, which can be printed or</span>
<span class="sd">            converted to various output formats.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        statsmodels.iolib.summary.Summary : class to hold summary</span>
<span class="sd">            results</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#TODO: add a summary text for options that have been used</span>

        <span class="n">jvalue</span><span class="p">,</span> <span class="n">jpvalue</span><span class="p">,</span> <span class="n">jdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jtest</span><span class="p">()</span>

        <span class="n">top_left</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Dep. Variable:&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;Model:&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;Method:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;GMM&#39;</span><span class="p">]),</span>
                    <span class="p">(</span><span class="s1">&#39;Date:&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;Time:&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;No. Observations:&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                    <span class="c1">#(&#39;Df Residuals:&#39;, None), #[self.df_resid]), #TODO: spelling</span>
                    <span class="c1">#(&#39;Df Model:&#39;, None), #[self.df_model])</span>
                    <span class="p">]</span>

        <span class="n">top_right</span> <span class="o">=</span> <span class="p">[</span><span class="c1">#(&#39;R-squared:&#39;, [&quot;%#8.3f&quot; % self.rsquared]),</span>
                     <span class="c1">#(&#39;Adj. R-squared:&#39;, [&quot;%#8.3f&quot; % self.rsquared_adj]),</span>
                     <span class="p">(</span><span class="s1">&#39;Hansen J:&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%#8.4g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">jvalue</span><span class="p">]</span> <span class="p">),</span>
                     <span class="p">(</span><span class="s1">&#39;Prob (Hansen J):&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%#6.3g</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">jpvalue</span><span class="p">]),</span>
                     <span class="c1">#(&#39;F-statistic:&#39;, [&quot;%#8.4g&quot; % self.fvalue] ),</span>
                     <span class="c1">#(&#39;Prob (F-statistic):&#39;, [&quot;%#6.3g&quot; % self.f_pvalue]),</span>
                     <span class="c1">#(&#39;Log-Likelihood:&#39;, None), #[&quot;%#6.4g&quot; % self.llf]),</span>
                     <span class="c1">#(&#39;AIC:&#39;, [&quot;%#8.4g&quot; % self.aic]),</span>
                     <span class="c1">#(&#39;BIC:&#39;, [&quot;%#8.4g&quot; % self.bic])</span>
                     <span class="p">]</span>

        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s2">&quot;Results&quot;</span>

        <span class="c1">#create summary table instance</span>
        <span class="kn">from</span> <span class="nn">statsmodels.iolib.summary</span> <span class="k">import</span> <span class="n">Summary</span>
        <span class="n">smry</span> <span class="o">=</span> <span class="n">Summary</span><span class="p">()</span>
        <span class="n">smry</span><span class="o">.</span><span class="n">add_table_2cols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gleft</span><span class="o">=</span><span class="n">top_left</span><span class="p">,</span> <span class="n">gright</span><span class="o">=</span><span class="n">top_right</span><span class="p">,</span>
                          <span class="n">yname</span><span class="o">=</span><span class="n">yname</span><span class="p">,</span> <span class="n">xname</span><span class="o">=</span><span class="n">xname</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="n">smry</span><span class="o">.</span><span class="n">add_table_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yname</span><span class="o">=</span><span class="n">yname</span><span class="p">,</span> <span class="n">xname</span><span class="o">=</span><span class="n">xname</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
                             <span class="n">use_t</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">smry</span></div></div>



<div class="viewcode-block" id="IVGMM"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IVGMM.html#statsmodels.sandbox.regression.gmm.IVGMM">[docs]</a><span class="k">class</span> <span class="nc">IVGMM</span><span class="p">(</span><span class="n">GMM</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Basic class for instrumental variables estimation using GMM</span>

<span class="sd">    A linear function for the conditional mean is defined as default but the</span>
<span class="sd">    methods should be overwritten by subclasses, currently `LinearIVGMM` and</span>
<span class="sd">    `NonlinearIVGMM` are implemented as subclasses.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    LinearIVGMM</span>
<span class="sd">    NonlinearIVGMM</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">results_class</span> <span class="o">=</span> <span class="s1">&#39;IVGMMResults&#39;</span>

<div class="viewcode-block" id="IVGMM.fitstart"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IVGMM.fitstart.html#statsmodels.sandbox.regression.gmm.IVGMM.fitstart">[docs]</a>    <span class="k">def</span> <span class="nf">fitstart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="IVGMM.start_weights"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IVGMM.start_weights.html#statsmodels.sandbox.regression.gmm.IVGMM.start_weights">[docs]</a>    <span class="k">def</span> <span class="nf">start_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">zz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="p">)</span>
        <span class="n">nobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">inv</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">zz</span> <span class="o">/</span> <span class="n">nobs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">zz</span> <span class="o">/</span> <span class="n">nobs</span><span class="p">)</span></div>


<div class="viewcode-block" id="IVGMM.get_error"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IVGMM.get_error.html#statsmodels.sandbox.regression.gmm.IVGMM.get_error">[docs]</a>    <span class="k">def</span> <span class="nf">get_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></div>


<div class="viewcode-block" id="IVGMM.predict"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IVGMM.predict.html#statsmodels.sandbox.regression.gmm.IVGMM.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">exog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></div>

<div class="viewcode-block" id="IVGMM.momcond"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IVGMM.momcond.html#statsmodels.sandbox.regression.gmm.IVGMM.momcond">[docs]</a>    <span class="k">def</span> <span class="nf">momcond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">instrument</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span>
        <span class="k">return</span> <span class="n">instrument</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_error</span><span class="p">(</span><span class="n">params</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="LinearIVGMM"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.LinearIVGMM.html#statsmodels.sandbox.regression.gmm.LinearIVGMM">[docs]</a><span class="k">class</span> <span class="nc">LinearIVGMM</span><span class="p">(</span><span class="n">IVGMM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;class for linear instrumental variables models estimated with GMM</span>

<span class="sd">    Uses closed form expression instead of nonlinear optimizers for each step</span>
<span class="sd">    of the iterative GMM.</span>

<span class="sd">    The model is assumed to have the following moment condition</span>

<span class="sd">        E( z * (y - x beta)) = 0</span>

<span class="sd">    Where `y` is the dependent endogenous variable, `x` are the explanatory</span>
<span class="sd">    variables and `z` are the instruments. Variables in `x` that are exogenous</span>
<span class="sd">    need also be included in `z`.</span>

<span class="sd">    Notation Warning: our name `exog` stands for the explanatory variables,</span>
<span class="sd">    and includes both exogenous and explanatory variables that are endogenous,</span>
<span class="sd">    i.e. included endogenous variables</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    endog : array_like</span>
<span class="sd">        dependent endogenous variable</span>
<span class="sd">    exog : array_like</span>
<span class="sd">        explanatory, right hand side variables, including explanatory variables</span>
<span class="sd">        that are endogenous</span>
<span class="sd">    instruments : array_like</span>
<span class="sd">        Instrumental variables, variables that are exogenous to the error</span>
<span class="sd">        in the linear model containing both included and excluded exogenous</span>
<span class="sd">        variables</span>


<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="LinearIVGMM.fitgmm"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.LinearIVGMM.fitgmm.html#statsmodels.sandbox.regression.gmm.LinearIVGMM.fitgmm">[docs]</a>    <span class="k">def</span> <span class="nf">fitgmm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optim_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;estimate parameters using GMM for linear model</span>

<span class="sd">        Uses closed form expression instead of nonlinear optimizers</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start : not used</span>
<span class="sd">            starting values for minimization, not used, only for consistency</span>
<span class="sd">            of method signature</span>
<span class="sd">        weights : array</span>
<span class="sd">            weighting matrix for moment conditions. If weights is None, then</span>
<span class="sd">            the identity matrix is used</span>
<span class="sd">        optim_method : not used,</span>
<span class="sd">            optimization method, not used, only for consistency of method</span>
<span class="sd">            signature</span>
<span class="sd">        **kwds : keyword arguments</span>
<span class="sd">            not used, will be silently ignored (for compatibility with generic)</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        paramest : array</span>
<span class="sd">            estimated parameters</span>

<span class="sd">        &#39;&#39;&#39;</span>
<span class="c1">##        if not fixed is None:  #fixed not defined in this version</span>
<span class="c1">##            raise NotImplementedError</span>

        <span class="c1"># TODO: should start_weights only be in `fit`</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_weights</span><span class="p">(</span><span class="n">inv</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span>

        <span class="n">zTx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">zTy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="c1"># normal equation, solved with pinv</span>
        <span class="n">part0</span> <span class="o">=</span> <span class="n">zTx</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">part1</span> <span class="o">=</span> <span class="n">part0</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">zTx</span><span class="p">)</span>
        <span class="n">part2</span> <span class="o">=</span> <span class="n">part0</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">zTy</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">part1</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">part2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">params</span></div>


<div class="viewcode-block" id="LinearIVGMM.predict"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.LinearIVGMM.predict.html#statsmodels.sandbox.regression.gmm.LinearIVGMM.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></div>


<div class="viewcode-block" id="LinearIVGMM.gradient_momcond"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.LinearIVGMM.gradient_momcond.html#statsmodels.sandbox.regression.gmm.LinearIVGMM.gradient_momcond">[docs]</a>    <span class="k">def</span> <span class="nf">gradient_momcond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="c1"># **kwds for compatibility not used</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span>
        <span class="n">gradmoms</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span>

        <span class="k">return</span> <span class="n">gradmoms</span></div>

<div class="viewcode-block" id="LinearIVGMM.score"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.LinearIVGMM.score.html#statsmodels.sandbox.regression.gmm.LinearIVGMM.score">[docs]</a>    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="c1"># **kwds for compatibility, not used</span>
        <span class="c1"># Note: I coud use general formula with gradient_momcond instead</span>

        <span class="n">x</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span>
        <span class="n">nobs</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_errors</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">u</span><span class="p">)))</span>
        <span class="n">score</span> <span class="o">/=</span> <span class="n">nobs</span> <span class="o">*</span> <span class="n">nobs</span>

        <span class="k">return</span> <span class="n">score</span></div></div>



<div class="viewcode-block" id="NonlinearIVGMM"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.NonlinearIVGMM.html#statsmodels.sandbox.regression.gmm.NonlinearIVGMM">[docs]</a><span class="k">class</span> <span class="nc">NonlinearIVGMM</span><span class="p">(</span><span class="n">IVGMM</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for non-linear instrumental variables estimation wusing GMM</span>

<span class="sd">    The model is assumed to have the following moment condition</span>

<span class="sd">        E[ z * (y - f(X, beta)] = 0</span>

<span class="sd">    Where `y` is the dependent endogenous variable, `x` are the explanatory</span>
<span class="sd">    variables and `z` are the instruments. Variables in `x` that are exogenous</span>
<span class="sd">    need also be included in z. `f` is a nonlinear function.</span>

<span class="sd">    Notation Warning: our name `exog` stands for the explanatory variables,</span>
<span class="sd">    and includes both exogenous and explanatory variables that are endogenous,</span>
<span class="sd">    i.e. included endogenous variables</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    endog : array_like</span>
<span class="sd">        dependent endogenous variable</span>
<span class="sd">    exog : array_like</span>
<span class="sd">        explanatory, right hand side variables, including explanatory variables</span>
<span class="sd">        that are endogenous.</span>
<span class="sd">    instruments : array_like</span>
<span class="sd">        Instrumental variables, variables that are exogenous to the error</span>
<span class="sd">        in the linear model containing both included and excluded exogenous</span>
<span class="sd">        variables</span>
<span class="sd">    func : callable</span>
<span class="sd">        function for the mean or conditional expectation of the endogenous</span>
<span class="sd">        variable. The function will be called with parameters and the array of</span>
<span class="sd">        explanatory, right hand side variables, `func(params, exog)`</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This class uses numerical differences to obtain the derivative of the</span>
<span class="sd">    objective function. If the jacobian of the conditional mean function, `func`</span>
<span class="sd">    is available, then it can be used by subclassing this class and defining</span>
<span class="sd">    a method `jac_func`.</span>

<span class="sd">    TODO: check required signature of jac_error and jac_func</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># This should be reversed:</span>
    <span class="c1"># NonlinearIVGMM is IVGMM and need LinearIVGMM as special case (fit, predict)</span>


<div class="viewcode-block" id="NonlinearIVGMM.fitstart"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.NonlinearIVGMM.fitstart.html#statsmodels.sandbox.regression.gmm.NonlinearIVGMM.fitstart">[docs]</a>    <span class="k">def</span> <span class="nf">fitstart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#might not make sense for more general functions</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NonlinearIVGMM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>


<div class="viewcode-block" id="NonlinearIVGMM.predict"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.NonlinearIVGMM.predict.html#statsmodels.sandbox.regression.gmm.NonlinearIVGMM.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">exog</span><span class="p">)</span></div>

    <span class="c1">#----------  the following a semi-general versions,</span>
    <span class="c1"># TODO: move to higher class after testing</span>

<div class="viewcode-block" id="NonlinearIVGMM.jac_func"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.NonlinearIVGMM.jac_func.html#statsmodels.sandbox.regression.gmm.NonlinearIVGMM.jac_func">[docs]</a>    <span class="k">def</span> <span class="nf">jac_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">centered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># TODO: Why are ther weights in the signature - copy-paste error?</span>
        <span class="n">deriv</span> <span class="o">=</span> <span class="n">approx_fprime</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">,),</span>
                              <span class="n">centered</span><span class="o">=</span><span class="n">centered</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">deriv</span></div>


<div class="viewcode-block" id="NonlinearIVGMM.jac_error"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.NonlinearIVGMM.jac_error.html#statsmodels.sandbox.regression.gmm.NonlinearIVGMM.jac_error">[docs]</a>    <span class="k">def</span> <span class="nf">jac_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">centered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">epsilon</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="n">jac_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jac_func</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">centered</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">epsilon</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="o">-</span><span class="n">jac_func</span></div>


<div class="viewcode-block" id="NonlinearIVGMM.score"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.NonlinearIVGMM.score.html#statsmodels.sandbox.regression.gmm.NonlinearIVGMM.score">[docs]</a>    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="c1"># **kwds for compatibility not used</span>
        <span class="c1"># Note: I coud use general formula with gradient_momcond instead</span>

        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span>
        <span class="n">nobs</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">jac_u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jac_error</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">centered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">jac_u</span>  <span class="c1"># alias, plays the same role as X in linear model</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_error</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="n">score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">u</span><span class="p">))</span>
        <span class="n">score</span> <span class="o">/=</span> <span class="n">nobs</span> <span class="o">*</span> <span class="n">nobs</span>

        <span class="k">return</span> <span class="n">score</span></div></div>


<div class="viewcode-block" id="IVGMMResults"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IVGMMResults.html#statsmodels.sandbox.regression.gmm.IVGMMResults">[docs]</a><span class="k">class</span> <span class="nc">IVGMMResults</span><span class="p">(</span><span class="n">GMMResults</span><span class="p">):</span>


    <span class="c1"># this assumes that we have an additive error model `(y - f(x, params))`</span>

    <span class="nd">@cache_readonly</span>
<div class="viewcode-block" id="IVGMMResults.fittedvalues"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IVGMMResults.fittedvalues.html#statsmodels.sandbox.regression.gmm.IVGMMResults.fittedvalues">[docs]</a>    <span class="k">def</span> <span class="nf">fittedvalues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span></div>


    <span class="nd">@cache_readonly</span>
<div class="viewcode-block" id="IVGMMResults.resid"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IVGMMResults.resid.html#statsmodels.sandbox.regression.gmm.IVGMMResults.resid">[docs]</a>    <span class="k">def</span> <span class="nf">resid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fittedvalues</span></div>


    <span class="nd">@cache_readonly</span>
<div class="viewcode-block" id="IVGMMResults.ssr"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.regression.gmm.IVGMMResults.ssr.html#statsmodels.sandbox.regression.gmm.IVGMMResults.ssr">[docs]</a>    <span class="k">def</span> <span class="nf">ssr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resid</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div></div>




<span class="k">def</span> <span class="nf">spec_hausman</span><span class="p">(</span><span class="n">params_e</span><span class="p">,</span> <span class="n">params_i</span><span class="p">,</span> <span class="n">cov_params_e</span><span class="p">,</span> <span class="n">cov_params_i</span><span class="p">,</span> <span class="n">dof</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Hausmans specification test</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params_e : array</span>
<span class="sd">        efficient and consistent under Null hypothesis,</span>
<span class="sd">        inconsistent under alternative hypothesis</span>
<span class="sd">    params_i: array</span>
<span class="sd">        consistent under Null hypothesis,</span>
<span class="sd">        consistent under alternative hypothesis</span>
<span class="sd">    cov_params_e : array, 2d</span>
<span class="sd">        covariance matrix of parameter estimates for params_e</span>
<span class="sd">    cov_params_i : array, 2d</span>
<span class="sd">        covariance matrix of parameter estimates for params_i</span>

<span class="sd">    example instrumental variables OLS estimator is `e`, IV estimator is `i`</span>


<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    Todos,Issues</span>
<span class="sd">    - check dof calculations and verify for linear case</span>
<span class="sd">    - check one-sided hypothesis</span>


<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Greene section 5.5 p.82/83</span>


<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">params_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">params_i</span> <span class="o">-</span> <span class="n">params_e</span><span class="p">)</span>
    <span class="n">cov_diff</span> <span class="o">=</span> <span class="n">cov_params_i</span> <span class="o">-</span> <span class="n">cov_params_e</span>
    <span class="c1">#TODO: the following is very inefficient, solves problem (svd) twice</span>
    <span class="c1">#use linalg.lstsq or svd directly</span>
    <span class="c1">#cov_diff will very often be in-definite (singular)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dof</span><span class="p">:</span>
        <span class="n">dof</span> <span class="o">=</span> <span class="n">np_matrix_rank</span><span class="p">(</span><span class="n">cov_diff</span><span class="p">)</span>
    <span class="n">cov_diffpinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">cov_diff</span><span class="p">)</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">params_diff</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_diffpinv</span><span class="p">,</span> <span class="n">params_diff</span><span class="p">))</span>
    <span class="n">pval</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">dof</span><span class="p">)</span>

    <span class="n">evals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvalsh</span><span class="p">(</span><span class="n">cov_diff</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">H</span><span class="p">,</span> <span class="n">pval</span><span class="p">,</span> <span class="n">dof</span><span class="p">,</span> <span class="n">evals</span>




<span class="c1">###########</span>

<span class="k">class</span> <span class="nc">DistQuantilesGMM</span><span class="p">(</span><span class="n">GMM</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Estimate distribution parameters by GMM based on matching quantiles</span>

<span class="sd">    Currently mainly to try out different requirements for GMM when we cannot</span>
<span class="sd">    calculate the optimal weighting matrix.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">instrument</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="c1">#TODO: something wrong with super</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DistQuantilesGMM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">instrument</span><span class="p">)</span>
        <span class="c1">#self.func = func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_iter</span> <span class="o">=</span> <span class="mf">1e-5</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">distfn</span> <span class="o">=</span> <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;distfn&#39;</span><span class="p">]</span>
        <span class="c1">#done by super doesn&#39;t work yet</span>
        <span class="c1">#TypeError: super does not take keyword arguments</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endog</span> <span class="o">=</span> <span class="n">endog</span>

        <span class="c1">#make this optional for fit</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;pquant&#39;</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pquant</span> <span class="o">=</span> <span class="n">pquant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.9</span><span class="p">,</span><span class="mf">0.95</span><span class="p">,</span><span class="mf">0.99</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pquant</span> <span class="o">=</span> <span class="n">pquant</span> <span class="o">=</span> <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;pquant&#39;</span><span class="p">]</span>

        <span class="c1">#TODO: vectorize this: use edf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xquant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">stats</span><span class="o">.</span><span class="n">scoreatpercentile</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span>
                                <span class="ow">in</span> <span class="n">pquant</span><span class="o">*</span><span class="mi">100</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nmoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pquant</span><span class="p">)</span>

        <span class="c1">#TODOcopied from GMM, make super work</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endog</span> <span class="o">=</span> <span class="n">endog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exog</span> <span class="o">=</span> <span class="n">exog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="n">instrument</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">GMMResults</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1">#self.__dict__.update(kwds)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon_iter</span> <span class="o">=</span> <span class="mf">1e-6</span>

    <span class="k">def</span> <span class="nf">fitstart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#todo: replace with or add call to distfn._fitstart</span>
        <span class="c1">#      added but not used during testing, avoid Travis</span>
        <span class="n">distfn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distfn</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">distfn</span><span class="p">,</span> <span class="s1">&#39;_fitstart&#39;</span><span class="p">):</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">distfn</span><span class="o">.</span><span class="n">_fitstart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endog</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">distfn</span><span class="o">.</span><span class="n">numargs</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">momcond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span> <span class="c1">#drop distfn as argument</span>
        <span class="c1">#, mom2, quantile=None, shape=None</span>
        <span class="sd">&#39;&#39;&#39;moment conditions for estimating distribution parameters by matching</span>
<span class="sd">        quantiles, defines as many moment conditions as quantiles.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        difference : array</span>
<span class="sd">            difference between theoretical and empirical quantiles</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This can be used for method of moments or for generalized method of</span>
<span class="sd">        moments.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#this check looks redundant/unused know</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">params</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">shape</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#raise NotImplementedError</span>
            <span class="k">pass</span> <span class="c1">#see whether this might work, seems to work for beta with 2 shape args</span>

        <span class="c1">#mom2diff = np.array(distfn.stats(*params)) - mom2</span>
        <span class="c1">#if not quantile is None:</span>
        <span class="n">pq</span><span class="p">,</span> <span class="n">xq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pquant</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xquant</span>
        <span class="c1">#ppfdiff = distfn.ppf(pq, alpha)</span>
        <span class="n">cdfdiff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distfn</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">xq</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="n">pq</span>
        <span class="c1">#return np.concatenate([mom2diff, cdfdiff[:1]])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">cdfdiff</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fitonce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">has_optimal_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;fit without estimating an optimal weighting matrix and return results</span>

<span class="sd">        This is a convenience function that calls fitgmm and covparams with</span>
<span class="sd">        a given weight matrix or the identity weight matrix.</span>
<span class="sd">        This is useful if the optimal weight matrix is know (or is analytically</span>
<span class="sd">        given) or if an optimal weight matrix cannot be calculated.</span>

<span class="sd">        (Developer Notes: this function could go into GMM, but is needed in this</span>
<span class="sd">        class, at least at the moment.)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        results : GMMResult instance</span>
<span class="sd">            result instance with params and _cov_params attached</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        fitgmm</span>
<span class="sd">        cov_params</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nmoms</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitgmm</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>
        <span class="c1"># TODO: rewrite this old hack, should use fitgmm or fit maxiter=0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>  <span class="c1">#required before call to self.cov_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">wargs</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1">#required before call to self.cov_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">options_other</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;weights_method&#39;</span><span class="p">:</span><span class="s1">&#39;cov&#39;</span><span class="p">}</span>
        <span class="c1"># TODO: which weights_method?  There shouldn&#39;t be any needed ?</span>
        <span class="n">_cov_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">cov_params</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
                                      <span class="n">has_optimal_weights</span><span class="o">=</span><span class="n">has_optimal_weights</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">jval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gmmobjective</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">options_other</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;has_optimal_weights&#39;</span><span class="p">:</span><span class="n">has_optimal_weights</span><span class="p">})</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span>


<span class="n">results_class_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;GMMResults&#39;</span><span class="p">:</span> <span class="n">GMMResults</span><span class="p">,</span>
                      <span class="s1">&#39;IVGMMResults&#39;</span><span class="p">:</span> <span class="n">IVGMMResults</span><span class="p">,</span>
                      <span class="s1">&#39;DistQuantilesGMM&#39;</span><span class="p">:</span> <span class="n">GMMResults</span><span class="p">}</span>  <span class="c1">#TODO: should be a default</span>

</pre></div>




          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2009-2017, Josef Perktold, Skipper Seabold, Jonathan Taylor, statsmodels-developers.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.3.
    </div>
  </body>
</html>