



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="../../../_static/favicon.ico">
    
    
  
      
        <title>statsmodels.regression.mixed_linear_model - statsmodels 0.15.0 (+784)</title>
      
    
  <link rel="icon" type="image/png" sizes="32x32" href="../../../_static/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../../../_static/icons/favicon-16x16.png">
  <link rel="manifest" href="../../../_static/icons/site.webmanifest">
  <link rel="mask-icon" href="../../../_static/icons/safari-pinned-tab.svg" color="#919191">
  <meta name="msapplication-TileColor" content="#2b5797">
  <meta name="msapplication-config" content="../../../_static/icons/browserconfig.xml">
  <link rel="stylesheet" href="../../../_static/stylesheets/examples.css">
  <link rel="stylesheet" href="../../../_static/stylesheets/deprecation.css">
    
      
        
      
      


    
    
      
    
    
      
        
        
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
        <link rel="stylesheet" type="text/css" href="../../../_static/sphinx_immaterial_theme.acf80fe7f4d9ef9e2.min.css?v=9e56d0d2" />
        <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />
        <link rel="stylesheet" type="text/css" href="../../../_static/plot_directive.css" />
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../index.html" title="statsmodels 0.15.0 (+784)" class="md-header__button md-logo" aria-label="statsmodels 0.15.0 (+784)" data-md-component="logo">
      <img src="../../../_static/statsmodels-logo-v2-bw.svg" alt="logo">
    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            statsmodels 0.15.0 (+784)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              statsmodels.regression.mixed_linear_model
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/statsmodels/statsmodels/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    statsmodels
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../index.html" title="statsmodels 0.15.0 (+784)" class="md-nav__button md-logo" aria-label="statsmodels 0.15.0 (+784)" data-md-component="logo">
      <img src="../../../_static/statsmodels-logo-v2-bw.svg" alt="logo">
    </a>
    statsmodels 0.15.0 (+784)
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/statsmodels/statsmodels/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    statsmodels
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../install.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    <span title="/install.rst (reference label)"><span>Installing statsmodels</span></span>
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../gettingstarted.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    <span title="/gettingstarted.rst (reference label)"><span>Getting started</span></span>
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../user-guide.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    <span title="/user-guide.rst (reference label)"><span>User Guide</span></span>
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    <span title="/examples/index.rst (reference label)"><span>Examples</span></span>
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    <span title="/api.rst (reference label)"><span>API Reference</span></span>
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../about.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    <span title="/about.rst (reference label)"><span>About statsmodels</span></span>
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../dev/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    <span title="/dev/index.rst (reference label)"><span>Developer Page</span></span>
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../release/index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    <span title="/release/index.rst (reference label)"><span>Release Notes</span></span>
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  

<nav class="md-nav md-nav--secondary">
  
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset" role="main">
                
                
                  


<h1>Source code for statsmodels.regression.mixed_linear_model</h1><div class="highlight"><pre>
<span></span><code><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Linear mixed effects models are regression models for dependent data.</span>
<span class="sd">They can be used to estimate regression relationships involving both</span>
<span class="sd">means and variances.</span>

<span class="sd">These models are also known as multilevel linear models, and</span>
<span class="sd">hierarchical linear models.</span>

<span class="sd">The MixedLM class fits linear mixed effects models to data, and</span>
<span class="sd">provides support for some common post-estimation tasks.  This is a</span>
<span class="sd">group-based implementation that is most efficient for models in which</span>
<span class="sd">the data can be partitioned into independent groups.  Some models with</span>
<span class="sd">crossed effects can be handled by specifying a model with a single</span>
<span class="sd">group.</span>

<span class="sd">The data are partitioned into disjoint groups.  The probability model</span>
<span class="sd">for group i is:</span>

<span class="sd">Y = X*beta + Z*gamma + epsilon</span>

<span class="sd">where</span>

<span class="sd">* n_i is the number of observations in group i</span>

<span class="sd">* Y is a n_i dimensional response vector (called endog in MixedLM)</span>

<span class="sd">* X is a n_i x k_fe dimensional design matrix for the fixed effects</span>
<span class="sd">  (called exog in MixedLM)</span>

<span class="sd">* beta is a k_fe-dimensional vector of fixed effects parameters</span>
<span class="sd">  (called fe_params in MixedLM)</span>

<span class="sd">* Z is a design matrix for the random effects with n_i rows (called</span>
<span class="sd">  exog_re in MixedLM).  The number of columns in Z can vary by group</span>
<span class="sd">  as discussed below.</span>

<span class="sd">* gamma is a random vector with mean 0.  The covariance matrix for the</span>
<span class="sd">  first `k_re` elements of `gamma` (called cov_re in MixedLM) is</span>
<span class="sd">  common to all groups.  The remaining elements of `gamma` are</span>
<span class="sd">  variance components as discussed in more detail below. Each group</span>
<span class="sd">  receives its own independent realization of gamma.</span>

<span class="sd">* epsilon is a n_i dimensional vector of iid normal</span>
<span class="sd">  errors with mean 0 and variance sigma^2; the epsilon</span>
<span class="sd">  values are independent both within and between groups</span>

<span class="sd">Y, X and Z must be entirely observed.  beta, Psi, and sigma^2 are</span>
<span class="sd">estimated using ML or REML estimation, and gamma and epsilon are</span>
<span class="sd">random so define the probability model.</span>

<span class="sd">The marginal mean structure is E[Y | X, Z] = X*beta.  If only the mean</span>
<span class="sd">structure is of interest, GEE is an alternative to using linear mixed</span>
<span class="sd">models.</span>

<span class="sd">Two types of random effects are supported.  Standard random effects</span>
<span class="sd">are correlated with each other in arbitrary ways.  Every group has the</span>
<span class="sd">same number (`k_re`) of standard random effects, with the same joint</span>
<span class="sd">distribution (but with independent realizations across the groups).</span>

<span class="sd">Variance components are uncorrelated with each other, and with the</span>
<span class="sd">standard random effects.  Each variance component has mean zero, and</span>
<span class="sd">all realizations of a given variance component have the same variance</span>
<span class="sd">parameter.  The number of realized variance components per variance</span>
<span class="sd">parameter can differ across the groups.</span>

<span class="sd">The primary reference for the implementation details is:</span>

<span class="sd">MJ Lindstrom, DM Bates (1988).  &quot;Newton Raphson and EM algorithms for</span>
<span class="sd">linear mixed effects models for repeated measures data&quot;.  Journal of</span>
<span class="sd">the American Statistical Association. Volume 83, Issue 404, pages</span>
<span class="sd">1014-1022.</span>

<span class="sd">See also this more recent document:</span>

<span class="sd">http://econ.ucsb.edu/~doug/245a/Papers/Mixed%20Effects%20Implement.pdf</span>

<span class="sd">All the likelihood, gradient, and Hessian calculations closely follow</span>
<span class="sd">Lindstrom and Bates 1988, adapted to support variance components.</span>

<span class="sd">The following two documents are written more from the perspective of</span>
<span class="sd">users:</span>

<span class="sd">http://lme4.r-forge.r-project.org/lMMwR/lrgprt.pdf</span>

<span class="sd">http://lme4.r-forge.r-project.org/slides/2009-07-07-Rennes/3Longitudinal-4.pdf</span>

<span class="sd">Notation:</span>

<span class="sd">* `cov_re` is the random effects covariance matrix (referred to above</span>
<span class="sd">  as Psi) and `scale` is the (scalar) error variance.  For a single</span>
<span class="sd">  group, the marginal covariance matrix of endog given exog is scale*I</span>
<span class="sd">  + Z * cov_re * Z&#39;, where Z is the design matrix for the random</span>
<span class="sd">  effects in one group.</span>

<span class="sd">* `vcomp` is a vector of variance parameters.  The length of `vcomp`</span>
<span class="sd">  is determined by the number of keys in either the `exog_vc` argument</span>
<span class="sd">  to ``MixedLM``, or the `vc_formula` argument when using formulas to</span>
<span class="sd">  fit a model.</span>

<span class="sd">Notes:</span>

<span class="sd">1. Three different parameterizations are used in different places.</span>
<span class="sd">The regression slopes (usually called `fe_params`) are identical in</span>
<span class="sd">all three parameterizations, but the variance parameters differ.  The</span>
<span class="sd">parameterizations are:</span>

<span class="sd">* The &quot;user parameterization&quot; in which cov(endog) = scale*I + Z *</span>
<span class="sd">  cov_re * Z&#39;, as described above.  This is the main parameterization</span>
<span class="sd">  visible to the user.</span>

<span class="sd">* The &quot;profile parameterization&quot; in which cov(endog) = I +</span>
<span class="sd">  Z * cov_re1 * Z&#39;.  This is the parameterization of the profile</span>
<span class="sd">  likelihood that is maximized to produce parameter estimates.</span>
<span class="sd">  (see Lindstrom and Bates for details).  The &quot;user&quot; cov_re is</span>
<span class="sd">  equal to the &quot;profile&quot; cov_re1 times the scale.</span>

<span class="sd">* The &quot;square root parameterization&quot; in which we work with the Cholesky</span>
<span class="sd">  factor of cov_re1 instead of cov_re directly.  This is hidden from the</span>
<span class="sd">  user.</span>

<span class="sd">All three parameterizations can be packed into a vector by</span>
<span class="sd">(optionally) concatenating `fe_params` together with the lower</span>
<span class="sd">triangle or Cholesky square root of the dependence structure, followed</span>
<span class="sd">by the variance parameters for the variance components.  The are</span>
<span class="sd">stored as square roots if (and only if) the random effects covariance</span>
<span class="sd">matrix is stored as its Cholesky factor.  Note that when unpacking, it</span>
<span class="sd">is important to either square or reflect the dependence structure</span>
<span class="sd">depending on which parameterization is being used.</span>

<span class="sd">Two score methods are implemented.  One takes the score with respect</span>
<span class="sd">to the elements of the random effects covariance matrix (used for</span>
<span class="sd">inference once the MLE is reached), and the other takes the score with</span>
<span class="sd">respect to the parameters of the Cholesky square root of the random</span>
<span class="sd">effects covariance matrix (used for optimization).</span>

<span class="sd">The numerical optimization uses GLS to avoid explicitly optimizing</span>
<span class="sd">over the fixed effects parameters.  The likelihood that is optimized</span>
<span class="sd">is profiled over both the scale parameter (a scalar) and the fixed</span>
<span class="sd">effects parameters (if any).  As a result of this profiling, it is</span>
<span class="sd">difficult and unnecessary to calculate the Hessian of the profiled log</span>
<span class="sd">likelihood function, so that calculation is not implemented here.</span>
<span class="sd">Therefore, optimization methods requiring the Hessian matrix such as</span>
<span class="sd">the Newton-Raphson algorithm cannot be used for model fitting.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">sparse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats.distributions</span><span class="w"> </span><span class="kn">import</span> <span class="n">norm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.base._penalties</span><span class="w"> </span><span class="kn">import</span> <span class="n">Penalty</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.base.model</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">base</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.formula._manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">FormulaManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.formula.formulatools</span><span class="w"> </span><span class="kn">import</span> <span class="n">advance_eval_env</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.tools</span><span class="w"> </span><span class="kn">import</span> <span class="n">data</span> <span class="k">as</span> <span class="n">data_tools</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.tools.decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">cache_readonly</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.tools.sm_exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ConvergenceWarning</span><span class="p">,</span>
    <span class="n">SingularMatrixWarning</span><span class="p">,</span>
    <span class="n">ValueWarning</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">_warn_cov_sing</span> <span class="o">=</span> <span class="s2">&quot;The random effects covariance matrix is singular.&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the dot product of the arrays, works for sparse and dense.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">y</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>


<span class="c1"># From numpy, adapted to work with sparse and dense arrays.</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_multi_dot_three</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find best ordering for three arrays and do the multiplication.</span>

<span class="sd">    Doing in manually instead of using dynamic programing is</span>
<span class="sd">    approximately 15 times faster.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># cost1 = cost((AB)C)</span>
    <span class="n">cost1</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># (AB)</span>
        <span class="o">+</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>  <span class="c1"># (--)C</span>
    <span class="c1"># cost2 = cost((AB)C)</span>
    <span class="n">cost2</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># (BC)</span>
        <span class="o">+</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>  <span class="c1"># A(--)</span>

    <span class="k">if</span> <span class="n">cost1</span> <span class="o">&lt;</span> <span class="n">cost2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_dot</span><span class="p">(</span><span class="n">_dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">),</span> <span class="n">C</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">_dot</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_dotsum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns sum(x * y), where &#39;*&#39; is the pointwise product, computed</span>
<span class="sd">    efficiently for dense and sparse matrices.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># This way usually avoids allocating a temporary.</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>


<span class="k">class</span><span class="w"> </span><span class="nc">VCSpec</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Define the variance component structure of a multilevel model.</span>

<span class="sd">    An instance of the class contains three attributes:</span>

<span class="sd">    - names : names[k] is the name of variance component k.</span>

<span class="sd">    - mats : mats[k][i] is the design matrix for group index</span>
<span class="sd">      i in variance component k.</span>

<span class="sd">    - colnames : colnames[k][i] is the list of column names for</span>
<span class="sd">      mats[k][i].</span>

<span class="sd">    The groups in colnames and mats must be in sorted order.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">colnames</span><span class="p">,</span> <span class="n">mats</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colnames</span> <span class="o">=</span> <span class="n">colnames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mats</span> <span class="o">=</span> <span class="n">mats</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_exog_re_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exog_re</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Passes through if given a list of names. Otherwise, gets pandas names</span>
<span class="sd">    or creates some generic variable names as needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exog_re</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">exog_re</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exog_re</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exog_re</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">exog_re</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exog_re</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">exog_re</span>

    <span class="c1"># Default names</span>
    <span class="n">defnames</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x_re</span><span class="si">{</span><span class="n">k</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s2">1d</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">exog_re</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">defnames</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MixedLMParams</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class represents a parameter state for a mixed linear model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    k_fe : int</span>
<span class="sd">        The number of covariates with fixed effects.</span>
<span class="sd">    k_re : int</span>
<span class="sd">        The number of covariates with random coefficients (excluding</span>
<span class="sd">        variance components).</span>
<span class="sd">    k_vc : int</span>
<span class="sd">        The number of variance components parameters.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This object represents the parameter state for the model in which</span>
<span class="sd">    the scale parameter has been profiled out.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k_fe</span><span class="p">,</span> <span class="n">k_re</span><span class="p">,</span> <span class="n">k_vc</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">=</span> <span class="n">k_fe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">=</span> <span class="n">k_re</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">=</span> <span class="n">k_re</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_re</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span> <span class="o">=</span> <span class="n">k_vc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_tot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">from_packed</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">k_fe</span><span class="p">,</span> <span class="n">k_re</span><span class="p">,</span> <span class="n">use_sqrt</span><span class="p">,</span> <span class="n">has_fe</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a MixedLMParams object from packed parameter vector.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : array_like</span>
<span class="sd">            The mode parameters packed into a single vector.</span>
<span class="sd">        k_fe : int</span>
<span class="sd">            The number of covariates with fixed effects</span>
<span class="sd">        k_re : int</span>
<span class="sd">            The number of covariates with random effects (excluding</span>
<span class="sd">            variance components).</span>
<span class="sd">        use_sqrt : bool</span>
<span class="sd">            If True, the random effects covariance matrix is provided</span>
<span class="sd">            as its Cholesky factor, otherwise the lower triangle of</span>
<span class="sd">            the covariance matrix is stored.</span>
<span class="sd">        has_fe : bool</span>
<span class="sd">            If True, `params` contains fixed effects parameters.</span>
<span class="sd">            Otherwise, the fixed effects parameters are set to zero.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A MixedLMParams object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">k_re2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k_re</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_re</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># The number of covariance parameters.</span>
        <span class="k">if</span> <span class="n">has_fe</span><span class="p">:</span>
            <span class="n">k_vc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="n">k_fe</span> <span class="o">-</span> <span class="n">k_re2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k_vc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="n">k_re2</span>

        <span class="n">pa</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="p">(</span><span class="n">k_fe</span><span class="p">,</span> <span class="n">k_re</span><span class="p">,</span> <span class="n">k_vc</span><span class="p">)</span>

        <span class="n">cov_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">k_re</span><span class="p">,</span> <span class="n">k_re</span><span class="p">))</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">_ix</span>
        <span class="k">if</span> <span class="n">has_fe</span><span class="p">:</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k_fe</span><span class="p">]</span>
            <span class="n">cov_re</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">k_fe</span> <span class="p">:</span> <span class="n">k_fe</span> <span class="o">+</span> <span class="n">k_re2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">k_fe</span><span class="p">)</span>
            <span class="n">cov_re</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k_re2</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">use_sqrt</span><span class="p">:</span>
            <span class="n">cov_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_re</span><span class="p">,</span> <span class="n">cov_re</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cov_re</span> <span class="o">=</span> <span class="p">(</span><span class="n">cov_re</span> <span class="o">+</span> <span class="n">cov_re</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_re</span><span class="p">))</span>

        <span class="n">pa</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">cov_re</span>
        <span class="k">if</span> <span class="n">k_vc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_sqrt</span><span class="p">:</span>
                <span class="n">pa</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="n">k_vc</span><span class="p">:]</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pa</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="n">k_vc</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="k">return</span> <span class="n">pa</span>

    <span class="n">from_packed</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">from_packed</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">from_components</span><span class="p">(</span><span class="n">fe_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cov_re</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cov_re_sqrt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vcomp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a MixedLMParams object from each parameter component.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fe_params : array_like</span>
<span class="sd">            The fixed effects parameter (a 1-dimensional array).  If</span>
<span class="sd">            None, there are no fixed effects.</span>
<span class="sd">        cov_re : array_like</span>
<span class="sd">            The random effects covariance matrix (a square, symmetric</span>
<span class="sd">            2-dimensional array).</span>
<span class="sd">        cov_re_sqrt : array_like</span>
<span class="sd">            The Cholesky (lower triangular) square root of the random</span>
<span class="sd">            effects covariance matrix.</span>
<span class="sd">        vcomp : array_like</span>
<span class="sd">            The variance component parameters.  If None, there are no</span>
<span class="sd">            variance components.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A MixedLMParams object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">vcomp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vcomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fe_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fe_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cov_re</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cov_re_sqrt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cov_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">k_fe</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fe_params</span><span class="p">)</span>
        <span class="n">k_vc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vcomp</span><span class="p">)</span>
        <span class="n">k_re</span> <span class="o">=</span> <span class="n">cov_re</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">cov_re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cov_re_sqrt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">pa</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="p">(</span><span class="n">k_fe</span><span class="p">,</span> <span class="n">k_re</span><span class="p">,</span> <span class="n">k_vc</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="n">fe_params</span>
        <span class="k">if</span> <span class="n">cov_re_sqrt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_re_sqrt</span><span class="p">,</span> <span class="n">cov_re_sqrt</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cov_re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">cov_re</span>

        <span class="n">pa</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="n">vcomp</span>

        <span class="k">return</span> <span class="n">pa</span>

    <span class="n">from_components</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">from_components</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a copy of the object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcomp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_packed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_sqrt</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the model parameters packed into a single vector.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        use_sqrt : bool</span>
<span class="sd">            If True, the Cholesky square root of `cov_re` is</span>
<span class="sd">            included in the packed result.  Otherwise the</span>
<span class="sd">            lower triangle of `cov_re` is included.</span>
<span class="sd">        has_fe : bool</span>
<span class="sd">            If True, the fixed effects parameters are included</span>
<span class="sd">            in the packed result, otherwise they are omitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_sqrt</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
                    <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="p">)))</span>
                <span class="n">cpa</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ix</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cpa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ix</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cpa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_sqrt</span><span class="p">:</span>
            <span class="n">vcomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vcomp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vcomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcomp</span>

        <span class="k">if</span> <span class="n">has_fe</span><span class="p">:</span>
            <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">fe_params</span><span class="p">,</span> <span class="n">cpa</span><span class="p">,</span> <span class="n">vcomp</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">cpa</span><span class="p">,</span> <span class="n">vcomp</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">pa</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_smw_solver</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">AtA</span><span class="p">,</span> <span class="n">Qi</span><span class="p">,</span> <span class="n">di</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a solver for the linear system:</span>

<span class="sd">    .. math::</span>

<span class="sd">        (sI + ABA^\prime) y = x</span>

<span class="sd">    The returned function f satisfies f(x) = y as defined above.</span>

<span class="sd">    B and its inverse matrix are block diagonal.  The upper left block</span>
<span class="sd">    of :math:`B^{-1}` is Qi and its lower right block is diag(di).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : scalar</span>
<span class="sd">        See above for usage</span>
<span class="sd">    A : ndarray</span>
<span class="sd">        p x q matrix, in general q &lt;&lt; p, may be sparse.</span>
<span class="sd">    AtA : square ndarray</span>
<span class="sd">        :math:`A^\prime  A`, a q x q matrix.</span>
<span class="sd">    Qi : square symmetric ndarray</span>
<span class="sd">        The matrix `B` is q x q, where q = r + d.  `B` consists of a r</span>
<span class="sd">        x r diagonal block whose inverse is `Qi`, and a d x d diagonal</span>
<span class="sd">        block, whose inverse is diag(di).</span>
<span class="sd">    di : 1d array_like</span>
<span class="sd">        See documentation for Qi.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A function for solving a linear system, as documented above.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses Sherman-Morrison-Woodbury identity:</span>
<span class="sd">        https://en.wikipedia.org/wiki/Woodbury_matrix_identity</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Use SMW identity</span>
    <span class="n">qmat</span> <span class="o">=</span> <span class="n">AtA</span> <span class="o">/</span> <span class="n">s</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Qi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">qmat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Qi</span>

    <span class="k">if</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
        <span class="n">qmat</span><span class="p">[</span><span class="n">m</span><span class="p">:,</span> <span class="n">m</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">(</span><span class="n">di</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">solver</span><span class="p">(</span><span class="n">rhs</span><span class="p">):</span>
            <span class="n">ql</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
            <span class="c1"># Based on profiling, the next line can be the</span>
            <span class="c1"># majority of the entire run time of fitting the model.</span>
            <span class="n">ql</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">spsolve</span><span class="p">(</span><span class="n">qmat</span><span class="p">,</span> <span class="n">ql</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ql</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="n">rhs</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
                <span class="c1"># spsolve squeezes nx1 rhs</span>
                <span class="n">ql</span> <span class="o">=</span> <span class="n">ql</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">ql</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ql</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rhs</span> <span class="o">/</span> <span class="n">s</span> <span class="o">-</span> <span class="n">ql</span> <span class="o">/</span> <span class="n">s</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">qmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">qmat</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">::</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">di</span>
        <span class="n">qmati</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">qmat</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">solver</span><span class="p">(</span><span class="n">rhs</span><span class="p">):</span>
            <span class="c1"># A is tall and qmati is wide, so we want</span>
            <span class="c1"># A * (qmati * rhs) not (A * qmati) * rhs</span>
            <span class="n">ql</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">qmati</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
            <span class="n">ql</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">ql</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">rhs</span> <span class="o">/</span> <span class="n">s</span> <span class="o">-</span> <span class="n">ql</span> <span class="o">/</span> <span class="n">s</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">solver</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_smw_logdet</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">AtA</span><span class="p">,</span> <span class="n">Qi</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">B_logdet</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the log determinant of</span>

<span class="sd">    .. math::</span>

<span class="sd">        sI + ABA^\prime</span>

<span class="sd">    Uses the matrix determinant lemma to accelerate the calculation.</span>
<span class="sd">    B is assumed to be positive definite, and s &gt; 0, therefore the</span>
<span class="sd">    determinant is positive.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : positive scalar</span>
<span class="sd">        See above for usage</span>
<span class="sd">    A : ndarray</span>
<span class="sd">        p x q matrix, in general q &lt;&lt; p.</span>
<span class="sd">    AtA : square ndarray</span>
<span class="sd">        :math:`A^\prime  A`, a q x q matrix.</span>
<span class="sd">    Qi : square symmetric ndarray</span>
<span class="sd">        The matrix `B` is q x q, where q = r + d.  `B` consists of a r</span>
<span class="sd">        x r diagonal block whose inverse is `Qi`, and a d x d diagonal</span>
<span class="sd">        block, whose inverse is diag(di).</span>
<span class="sd">    di : 1d array_like</span>
<span class="sd">        See documentation for Qi.</span>
<span class="sd">    B_logdet : real</span>
<span class="sd">        The log determinant of B</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    The log determinant of s*I + A*B*A&#39;.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Uses the matrix determinant lemma:</span>
<span class="sd">        https://en.wikipedia.org/wiki/Matrix_determinant_lemma</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ld</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">qmat</span> <span class="o">=</span> <span class="n">AtA</span> <span class="o">/</span> <span class="n">s</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Qi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">qmat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Qi</span>

    <span class="k">if</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">qmat</span><span class="p">):</span>
        <span class="n">qmat</span><span class="p">[</span><span class="n">m</span><span class="p">:,</span> <span class="n">m</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">diags</span><span class="p">(</span><span class="n">di</span><span class="p">)</span>

        <span class="c1"># There are faster but much more difficult ways to do this</span>
        <span class="c1"># https://stackoverflow.com/questions/19107617</span>
        <span class="n">lu</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">splu</span><span class="p">(</span><span class="n">qmat</span><span class="p">)</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="n">lu</span><span class="o">.</span><span class="n">L</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
        <span class="n">du</span> <span class="o">=</span> <span class="n">lu</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
        <span class="n">ld1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dl</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">du</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">ld1</span> <span class="o">=</span> <span class="n">ld1</span><span class="o">.</span><span class="n">real</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">qmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">qmat</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">::</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">di</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ld1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="n">qmat</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">B_logdet</span> <span class="o">+</span> <span class="n">ld</span> <span class="o">+</span> <span class="n">ld1</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_convert_vc</span><span class="p">(</span><span class="n">exog_vc</span><span class="p">):</span>

    <span class="n">vc_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vc_colnames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vc_mats</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Get the groups in sorted order</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">exog_vc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">groups</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
    <span class="n">groups</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">exog_vc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">vc_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">colnames</span><span class="p">,</span> <span class="n">mats</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">colnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">colnames</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
            <span class="n">mats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">g</span><span class="p">])</span>
        <span class="n">vc_colnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">colnames</span><span class="p">)</span>
        <span class="n">vc_mats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mats</span><span class="p">)</span>

    <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">vc_names</span><span class="p">)</span>
    <span class="n">vc_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">vc_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ii</span><span class="p">]</span>
    <span class="n">vc_colnames</span> <span class="o">=</span> <span class="p">[</span><span class="n">vc_colnames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ii</span><span class="p">]</span>
    <span class="n">vc_mats</span> <span class="o">=</span> <span class="p">[</span><span class="n">vc_mats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ii</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">VCSpec</span><span class="p">(</span><span class="n">vc_names</span><span class="p">,</span> <span class="n">vc_colnames</span><span class="p">,</span> <span class="n">vc_mats</span><span class="p">)</span>


<div class="viewcode-block" id="MixedLM">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.html#statsmodels.regression.mixed_linear_model.MixedLM">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MixedLM</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">LikelihoodModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Linear Mixed Effects Model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    endog : 1d array_like</span>
<span class="sd">        The dependent variable</span>
<span class="sd">    exog : 2d array_like</span>
<span class="sd">        A matrix of covariates used to determine the</span>
<span class="sd">        mean structure (the &quot;fixed effects&quot; covariates).</span>
<span class="sd">    groups : 1d array_like</span>
<span class="sd">        A vector of labels determining the groups -- data from</span>
<span class="sd">        different groups are independent</span>
<span class="sd">    exog_re : 2d array_like</span>
<span class="sd">        A matrix of covariates used to determine the variance and</span>
<span class="sd">        covariance structure (the &quot;random effects&quot; covariates).  If</span>
<span class="sd">        None, defaults to a random intercept for each group.</span>
<span class="sd">    exog_vc : VCSpec instance or dict-like (deprecated)</span>
<span class="sd">        A VCSPec instance defines the structure of the variance</span>
<span class="sd">        components in the model.  Alternatively, see notes below</span>
<span class="sd">        for a dictionary-based format.  The dictionary format is</span>
<span class="sd">        deprecated and may be removed at some point in the future.</span>
<span class="sd">    use_sqrt : bool</span>
<span class="sd">        If True, optimization is carried out using the lower</span>
<span class="sd">        triangle of the square root of the random effects</span>
<span class="sd">        covariance matrix, otherwise it is carried out using the</span>
<span class="sd">        lower triangle of the random effects covariance matrix.</span>
<span class="sd">    missing : str</span>
<span class="sd">        The approach to missing data handling</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    If `exog_vc` is not a `VCSpec` instance, then it must be a</span>
<span class="sd">    dictionary of dictionaries.  Specifically, `exog_vc[a][g]` is a</span>
<span class="sd">    matrix whose columns are linearly combined using independent</span>
<span class="sd">    random coefficients.  This random term then contributes to the</span>
<span class="sd">    variance structure of the data for group `g`.  The random</span>
<span class="sd">    coefficients all have mean zero, and have the same variance.  The</span>
<span class="sd">    matrix must be `m x k`, where `m` is the number of observations in</span>
<span class="sd">    group `g`.  The number of columns may differ among the top-level</span>
<span class="sd">    groups.</span>

<span class="sd">    The covariates in `exog`, `exog_re` and `exog_vc` may (but need</span>
<span class="sd">    not) partially or wholly overlap.</span>

<span class="sd">    `use_sqrt` should almost always be set to True.  The main use case</span>
<span class="sd">    for use_sqrt=False is when complicated patterns of fixed values in</span>
<span class="sd">    the covariance structure are set (using the `free` argument to</span>
<span class="sd">    `fit`) that cannot be expressed in terms of the Cholesky factor L.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    A basic mixed model with fixed effects for the columns of</span>
<span class="sd">    ``exog`` and a random intercept for each distinct value of</span>
<span class="sd">    ``group``:</span>

<span class="sd">    &gt;&gt;&gt; model = sm.MixedLM(endog, exog, groups)</span>
<span class="sd">    &gt;&gt;&gt; result = model.fit()</span>

<span class="sd">    A mixed model with fixed effects for the columns of ``exog`` and</span>
<span class="sd">    correlated random coefficients for the columns of ``exog_re``:</span>

<span class="sd">    &gt;&gt;&gt; model = sm.MixedLM(endog, exog, groups, exog_re=exog_re)</span>
<span class="sd">    &gt;&gt;&gt; result = model.fit()</span>

<span class="sd">    A mixed model with fixed effects for the columns of ``exog`` and</span>
<span class="sd">    independent random coefficients for the columns of ``exog_re``:</span>

<span class="sd">    &gt;&gt;&gt; free = MixedLMParams.from_components(</span>
<span class="sd">                     fe_params=np.ones(exog.shape[1]),</span>
<span class="sd">                     cov_re=np.eye(exog_re.shape[1]))</span>
<span class="sd">    &gt;&gt;&gt; model = sm.MixedLM(endog, exog, groups, exog_re=exog_re)</span>
<span class="sd">    &gt;&gt;&gt; result = model.fit(free=free)</span>

<span class="sd">    A different way to specify independent random coefficients for the</span>
<span class="sd">    columns of ``exog_re``.  In this example ``groups`` must be a</span>
<span class="sd">    Pandas Series with compatible indexing with ``exog_re``, and</span>
<span class="sd">    ``exog_re`` has two columns.</span>

<span class="sd">    &gt;&gt;&gt; g = pd.groupby(groups, by=groups).groups</span>
<span class="sd">    &gt;&gt;&gt; vc = {}</span>
<span class="sd">    &gt;&gt;&gt; vc[&#39;1&#39;] = {k : exog_re.loc[g[k], 0] for k in g}</span>
<span class="sd">    &gt;&gt;&gt; vc[&#39;2&#39;] = {k : exog_re.loc[g[k], 1] for k in g}</span>
<span class="sd">    &gt;&gt;&gt; model = sm.MixedLM(endog, exog, groups, vcomp=vc)</span>
<span class="sd">    &gt;&gt;&gt; result = model.fit()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">endog</span><span class="p">,</span>
        <span class="n">exog</span><span class="p">,</span>
        <span class="n">groups</span><span class="p">,</span>
        <span class="n">exog_re</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">exog_vc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_sqrt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">missing</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="n">_allowed_kwargs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;missing_idx&quot;</span><span class="p">,</span> <span class="s2">&quot;model_spec&quot;</span><span class="p">,</span> <span class="s2">&quot;formula&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_allowed_kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;argument </span><span class="si">%s</span><span class="s2"> not permitted for MixedLM initialization&quot;</span> <span class="o">%</span> <span class="n">x</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span> <span class="o">=</span> <span class="n">use_sqrt</span>

        <span class="c1"># Some defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reml</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fe_pen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">re_pen</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exog_vc</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Using deprecated variance components format&quot;</span><span class="p">,</span>
                <span class="ne">FutureWarning</span><span class="p">,</span>
                <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Convert from old to new representation</span>
            <span class="n">exog_vc</span> <span class="o">=</span> <span class="n">_convert_vc</span><span class="p">(</span><span class="n">exog_vc</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exog_vc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">exog_vc</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exog_vc</span> <span class="o">=</span> <span class="n">exog_vc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exog_vc</span> <span class="o">=</span> <span class="n">VCSpec</span><span class="p">([],</span> <span class="p">[],</span> <span class="p">[])</span>

        <span class="c1"># If there is one covariate, it may be passed in as a column</span>
        <span class="c1"># vector, convert these to 2d arrays.</span>
        <span class="c1"># TODO: Can this be moved up in the class hierarchy?</span>
        <span class="c1">#       yes, it should be done up the hierarchy</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">exog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">data_tools</span><span class="o">.</span><span class="n">_is_using_ndarray_type</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">exog</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="n">exog</span> <span class="o">=</span> <span class="n">exog</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">exog_re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="ow">and</span> <span class="n">data_tools</span><span class="o">.</span><span class="n">_is_using_ndarray_type</span><span class="p">(</span><span class="n">exog_re</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">exog_re</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="n">exog_re</span> <span class="o">=</span> <span class="n">exog_re</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="c1"># Calling super creates self.endog, etc. as ndarrays and the</span>
        <span class="c1"># original exog, endog, etc. are self.data.endog, etc.</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span> <span class="n">exog_re</span><span class="o">=</span><span class="n">exog_re</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="n">missing</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_keys</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;use_sqrt&quot;</span><span class="p">,</span> <span class="s2">&quot;exog_vc&quot;</span><span class="p">])</span>

        <span class="c1"># Number of fixed effects parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">=</span> <span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">exog_re</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_vc</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Default random effects structure (random intercepts).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">endog</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Group Var&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">param_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_names</span> <span class="o">+</span> <span class="n">names</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re_names</span> <span class="o">=</span> <span class="n">names</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re_names_full</span> <span class="o">=</span> <span class="n">names</span>

        <span class="k">elif</span> <span class="n">exog_re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Process exog_re the same way that exog is handled</span>
            <span class="c1"># upstream</span>
            <span class="c1"># TODO: this is wrong and should be handled upstream wholly</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re</span> <span class="o">=</span> <span class="n">exog_re</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">exog_re</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="c1"># Model dimensions</span>
            <span class="c1"># Number of random effect covariates</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Number of covariance parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># All random effects are variance components</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_param_names</span><span class="p">:</span>
            <span class="c1"># HACK: could have been set in from_formula already</span>
            <span class="c1"># needs refactor</span>
            <span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">exog_re_names</span><span class="p">,</span> <span class="n">exog_re_names_full</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_param_names</span><span class="p">(</span>
                <span class="n">exog_re</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">param_names</span> <span class="o">=</span> <span class="n">param_names</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re_names</span> <span class="o">=</span> <span class="n">exog_re_names</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re_names_full</span> <span class="o">=</span> <span class="n">exog_re_names_full</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">k_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span>

        <span class="c1"># Convert the data to the internal representation, which is a</span>
        <span class="c1"># list of arrays, corresponding to the groups.</span>
        <span class="n">group_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
        <span class="n">group_labels</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">row_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">group_labels</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
            <span class="n">row_indices</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row_indices</span> <span class="o">=</span> <span class="n">row_indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span> <span class="o">=</span> <span class="n">group_labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">)</span>

        <span class="c1"># Split the data by groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endog</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exog_re_li</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span><span class="p">)</span>

        <span class="c1"># Precompute this.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exog_re2_li</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exog_re2_li</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_re_li</span><span class="p">]</span>

        <span class="c1"># The total number of observations, summed over all groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endog</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span>

        <span class="c1"># Set the fixed effects parameter names</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exog_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FE</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

        <span class="c1"># Precompute this</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_groups</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_augment_exog</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

            <span class="n">ma</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ma</span><span class="p">)</span>

        <span class="c1"># Precompute this</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reparam</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_param_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exog_re</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the full parameter names list, just the exogenous random</span>
<span class="sd">        effects variables, and the exogenous random effects variables with</span>
<span class="sd">        the interaction terms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exog_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_names</span><span class="p">)</span>
        <span class="n">exog_re_names</span> <span class="o">=</span> <span class="n">_get_exog_re_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exog_re</span><span class="p">)</span>
        <span class="n">param_names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">jj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exog_re_names</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                    <span class="n">param_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exog_re_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; Var&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">param_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">exog_re_names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; x &quot;</span> <span class="o">+</span> <span class="n">exog_re_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; Cov&quot;</span>
                    <span class="p">)</span>
                <span class="n">jj</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">vc_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="s2">&quot; Var&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_vc</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">exog_names</span> <span class="o">+</span> <span class="n">param_names</span> <span class="o">+</span> <span class="n">vc_names</span><span class="p">,</span> <span class="n">exog_re_names</span><span class="p">,</span> <span class="n">param_names</span>

<div class="viewcode-block" id="MixedLM.from_formula">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.from_formula.html#statsmodels.regression.mixed_linear_model.MixedLM.from_formula">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_formula</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">formula</span><span class="p">,</span>
        <span class="n">data</span><span class="p">,</span>
        <span class="n">re_formula</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">vc_formula</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">use_sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">missing</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a Model from a formula and dataframe.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        formula : str or generic Formula object</span>
<span class="sd">            The formula specifying the model</span>
<span class="sd">        data : array_like</span>
<span class="sd">            The data for the model. See Notes.</span>
<span class="sd">        re_formula : str</span>
<span class="sd">            A one-sided formula defining the variance structure of the</span>
<span class="sd">            model.  The default gives a random intercept for each</span>
<span class="sd">            group.</span>
<span class="sd">        vc_formula : dict-like</span>
<span class="sd">            Formulas describing variance components.  `vc_formula[vc]` is</span>
<span class="sd">            the formula for the component with variance parameter named</span>
<span class="sd">            `vc`.  The formula is processed into a matrix, and the columns</span>
<span class="sd">            of this matrix are linearly combined with independent random</span>
<span class="sd">            coefficients having mean zero and a common variance.</span>
<span class="sd">        subset : array_like</span>
<span class="sd">            An array-like object of booleans, integers, or index</span>
<span class="sd">            values that indicate the subset of df to use in the</span>
<span class="sd">            model. Assumes df is a `pandas.DataFrame`</span>
<span class="sd">        missing : str</span>
<span class="sd">            Either &#39;none&#39; or &#39;drop&#39;</span>
<span class="sd">        args : extra arguments</span>
<span class="sd">            These are passed to the model</span>
<span class="sd">        kwargs : extra keyword arguments</span>
<span class="sd">            These are passed to the model with one exception. The</span>
<span class="sd">            ``eval_env`` keyword is passed to patsy. It can be either a</span>
<span class="sd">            :class:`patsy:patsy.EvalEnvironment` object or an integer</span>
<span class="sd">            indicating the depth of the namespace to use. For example, the</span>
<span class="sd">            default ``eval_env=0`` uses the calling namespace. If you wish</span>
<span class="sd">            to use a &quot;clean&quot; environment set ``eval_env=-1``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        model : Model instance</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        `data` must define __getitem__ with the keys in the formula</span>
<span class="sd">        terms args and kwargs are passed on to the model</span>
<span class="sd">        instantiation. E.g., a numpy structured or rec array, a</span>
<span class="sd">        dictionary, or a pandas DataFrame.</span>

<span class="sd">        If the variance component is intended to produce random</span>
<span class="sd">        intercepts for disjoint subsets of a group, specified by</span>
<span class="sd">        string labels or a categorical data value, always use &#39;0 +&#39; in</span>
<span class="sd">        the formula so that no overall intercept is included.</span>

<span class="sd">        If the variance components specify random slopes and you do</span>
<span class="sd">        not also want a random group-level intercept in the model,</span>
<span class="sd">        then use &#39;0 +&#39; in the formula to exclude the intercept.</span>

<span class="sd">        The variance components formulas are processed separately for</span>
<span class="sd">        each group.  If a variable is categorical the results will not</span>
<span class="sd">        be affected by whether the group labels are distinct or</span>
<span class="sd">        re-used over the top-level groups.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Suppose we have data from an educational study with students</span>
<span class="sd">        nested in classrooms nested in schools.  The students take a</span>
<span class="sd">        test, and we want to relate the test scores to the students&#39;</span>
<span class="sd">        ages, while accounting for the effects of classrooms and</span>
<span class="sd">        schools.  The school will be the top-level group, and the</span>
<span class="sd">        classroom is a nested group that is specified as a variance</span>
<span class="sd">        component.  Note that the schools may have different number of</span>
<span class="sd">        classrooms, and the classroom labels may (but need not be)</span>
<span class="sd">        different across the schools.</span>

<span class="sd">        &gt;&gt;&gt; vc = {&#39;classroom&#39;: &#39;0 + C(classroom)&#39;}</span>
<span class="sd">        &gt;&gt;&gt; MixedLM.from_formula(&#39;test_score ~ age&#39;, vc_formula=vc, \</span>
<span class="sd">                                  re_formula=&#39;1&#39;, groups=&#39;school&#39;, data=data)</span>

<span class="sd">        Now suppose we also have a previous test score called</span>
<span class="sd">        &#39;pretest&#39;.  If we want the relationship between pretest</span>
<span class="sd">        scores and the current test to vary by classroom, we can</span>
<span class="sd">        specify a random slope for the pretest score</span>

<span class="sd">        &gt;&gt;&gt; vc = {&#39;classroom&#39;: &#39;0 + C(classroom)&#39;, &#39;pretest&#39;: &#39;0 + pretest&#39;}</span>
<span class="sd">        &gt;&gt;&gt; MixedLM.from_formula(&#39;test_score ~ age + pretest&#39;, vc_formula=vc, \</span>
<span class="sd">                                  re_formula=&#39;1&#39;, groups=&#39;school&#39;, data=data)</span>

<span class="sd">        The following model is almost equivalent to the previous one,</span>
<span class="sd">        but here the classroom random intercept and pretest slope may</span>
<span class="sd">        be correlated.</span>

<span class="sd">        &gt;&gt;&gt; vc = {&#39;classroom&#39;: &#39;0 + C(classroom)&#39;}</span>
<span class="sd">        &gt;&gt;&gt; MixedLM.from_formula(&#39;test_score ~ age + pretest&#39;, vc_formula=vc, \</span>
<span class="sd">                                  re_formula=&#39;1 + pretest&#39;, groups=&#39;school&#39;, \</span>
<span class="sd">                                  data=data)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;groups&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                <span class="s2">&quot;&#39;groups&#39; is a required keyword argument &quot;</span> <span class="o">+</span> <span class="s2">&quot;in MixedLM.from_formula&quot;</span>
            <span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span>

        <span class="c1"># If `groups` is a variable name, retrieve the data for the</span>
        <span class="c1"># groups variable.</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="s2">&quot;Group&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">groups</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">groups</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span>

        <span class="c1"># Bypass all upstream missing data handling to properly handle</span>
        <span class="c1"># variance components</span>
        <span class="k">if</span> <span class="n">missing</span> <span class="o">==</span> <span class="s2">&quot;drop&quot;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">_handle_missing</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">re_formula</span><span class="p">,</span> <span class="n">vc_formula</span>
            <span class="p">)</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>

        <span class="k">if</span> <span class="n">re_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re_formula</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
                <span class="c1"># Work around Patsy bug, fixed by 0.3.</span>
                <span class="n">exog_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">exog_re_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">group_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eval_env</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eval_env&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">eval_env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">eval_env</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">eval_env</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">mgr</span> <span class="o">=</span> <span class="n">FormulaManager</span><span class="p">()</span>
                    <span class="n">eval_env</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">.</span><span class="n">get_empty_eval_env</span><span class="p">()</span>
                <span class="n">mgr</span> <span class="o">=</span> <span class="n">FormulaManager</span><span class="p">()</span>
                <span class="n">exog_re</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">.</span><span class="n">get_matrices</span><span class="p">(</span><span class="n">re_formula</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">eval_env</span><span class="o">=</span><span class="n">eval_env</span><span class="p">)</span>
                <span class="n">exog_re_names</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">exog_re</span><span class="p">)</span>
                <span class="n">exog_re_names</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Intercept&quot;</span><span class="p">,</span> <span class="n">group_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exog_re_names</span>
                <span class="p">]</span>
                <span class="n">exog_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">exog_re</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exog_re</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">exog_re</span> <span class="o">=</span> <span class="n">exog_re</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exog_re</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">vc_formula</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">exog_re_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">group_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exog_re_names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">vc_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eval_env</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;eval_env&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">eval_env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">eval_env</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">eval_env</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">mgr</span> <span class="o">=</span> <span class="n">FormulaManager</span><span class="p">()</span>
                <span class="n">eval_env</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">.</span><span class="n">get_empty_eval_env</span><span class="p">()</span>

            <span class="n">vc_mats</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">vc_colnames</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">vc_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">gb</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
            <span class="n">kylist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">gb</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">vcf</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">vc_formula</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">mgr</span> <span class="o">=</span> <span class="n">FormulaManager</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">vc_name</span> <span class="ow">in</span> <span class="n">vcf</span><span class="p">:</span>
                <span class="n">model_spec</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">.</span><span class="n">get_spec</span><span class="p">(</span><span class="n">vc_formula</span><span class="p">[</span><span class="n">vc_name</span><span class="p">])</span>
                <span class="n">vc_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vc_name</span><span class="p">)</span>
                <span class="n">evc_mats</span><span class="p">,</span> <span class="n">evc_colnames</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kylist</span><span class="p">):</span>
                    <span class="n">ii</span> <span class="o">=</span> <span class="n">gb</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                    <span class="n">mat</span> <span class="o">=</span> <span class="n">mgr</span><span class="o">.</span><span class="n">get_matrices</span><span class="p">(</span>
                        <span class="n">model_spec</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">eval_env</span><span class="o">=</span><span class="n">eval_env</span><span class="p">,</span> <span class="n">pandas</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                    <span class="n">evc_colnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">use_sparse</span><span class="p">:</span>
                        <span class="n">evc_mats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">evc_mats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mat</span><span class="p">))</span>
                <span class="n">vc_mats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evc_mats</span><span class="p">)</span>
                <span class="n">vc_colnames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">evc_colnames</span><span class="p">)</span>
            <span class="n">exog_vc</span> <span class="o">=</span> <span class="n">VCSpec</span><span class="p">(</span><span class="n">vc_names</span><span class="p">,</span> <span class="n">vc_colnames</span><span class="p">,</span> <span class="n">vc_mats</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exog_vc</span> <span class="o">=</span> <span class="n">VCSpec</span><span class="p">([],</span> <span class="p">[],</span> <span class="p">[])</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;subset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;exog_re&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exog_re</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;exog_vc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exog_vc</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">groups</span>
        <span class="n">advance_eval_env</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># expand re names to account for pairs of RE</span>
        <span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">exog_re_names</span><span class="p">,</span> <span class="n">exog_re_names_full</span><span class="p">)</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">_make_param_names</span><span class="p">(</span>
            <span class="n">exog_re_names</span>
        <span class="p">)</span>

        <span class="n">mod</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">param_names</span> <span class="o">=</span> <span class="n">param_names</span>
        <span class="n">mod</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re_names</span> <span class="o">=</span> <span class="n">exog_re_names</span>
        <span class="n">mod</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re_names_full</span> <span class="o">=</span> <span class="n">exog_re_names_full</span>

        <span class="k">if</span> <span class="n">vc_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mod</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vcomp_names</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">exog_vc</span><span class="o">.</span><span class="n">names</span>

        <span class="k">return</span> <span class="n">mod</span></div>


<div class="viewcode-block" id="MixedLM.predict">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.predict.html#statsmodels.regression.mixed_linear_model.MixedLM.predict">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return predicted values from a design matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : array_like</span>
<span class="sd">            Parameters of a mixed linear model.  Can be either a</span>
<span class="sd">            MixedLMParams instance, or a vector containing the packed</span>
<span class="sd">            model parameters in which the fixed effects parameters are</span>
<span class="sd">            at the beginning of the vector, or a vector containing</span>
<span class="sd">            only the fixed effects parameters.</span>
<span class="sd">        exog : array_like, optional</span>
<span class="sd">            Design / exogenous data for the fixed effects. Model exog</span>
<span class="sd">            is used if None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        An array of fitted values.  Note that these predicted values</span>
<span class="sd">        only reflect the fixed effects mean structure of the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">exog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">MixedLMParams</span><span class="p">):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">fe_params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></div>


<div class="viewcode-block" id="MixedLM.group_list">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.group_list.html#statsmodels.regression.mixed_linear_model.MixedLM.group_list">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">group_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns `array` split into subarrays corresponding to the</span>
<span class="sd">        grouping structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">row_indices</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">row_indices</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="p">:])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">]</span></div>


<div class="viewcode-block" id="MixedLM.fit_regularized">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.fit_regularized.html#statsmodels.regression.mixed_linear_model.MixedLM.fit_regularized">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit_regularized</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">start_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;l1&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">ceps</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
        <span class="n">ptol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
        <span class="n">maxit</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="o">**</span><span class="n">fit_kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a model in which the fixed effects parameters are</span>
<span class="sd">        penalized.  The dependence parameters are held fixed at their</span>
<span class="sd">        estimated values in the unpenalized model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : str of Penalty object</span>
<span class="sd">            Method for regularization.  If a string, must be &#39;l1&#39;.</span>
<span class="sd">        alpha : array_like</span>
<span class="sd">            Scalar or vector of penalty weights.  If a scalar, the</span>
<span class="sd">            same weight is applied to all coefficients; if a vector,</span>
<span class="sd">            it contains a weight for each coefficient.  If method is a</span>
<span class="sd">            Penalty object, the weights are scaled by alpha.  For L1</span>
<span class="sd">            regularization, the weights are used directly.</span>
<span class="sd">        ceps : positive real scalar</span>
<span class="sd">            Fixed effects parameters smaller than this value</span>
<span class="sd">            in magnitude are treated as being zero.</span>
<span class="sd">        ptol : positive real scalar</span>
<span class="sd">            Convergence occurs when the sup norm difference</span>
<span class="sd">            between successive values of `fe_params` is less than</span>
<span class="sd">            `ptol`.</span>
<span class="sd">        maxit : int</span>
<span class="sd">            The maximum number of iterations.</span>
<span class="sd">        **fit_kwargs</span>
<span class="sd">            Additional keyword arguments passed to fit.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A MixedLMResults instance containing the results.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The covariance structure is not updated as the fixed effects</span>
<span class="sd">        parameters are varied.</span>

<span class="sd">        The algorithm used here for L1 regularization is a&quot;shooting&quot;</span>
<span class="sd">        or cyclic coordinate descent algorithm.</span>

<span class="sd">        If method is &#39;l1&#39;, then `fe_pen` and `cov_pen` are used to</span>
<span class="sd">        obtain the covariance structure, but are ignored during the</span>
<span class="sd">        L1-penalized fitting.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        Friedman, J. H., Hastie, T. and Tibshirani, R. Regularized</span>
<span class="sd">        Paths for Generalized Linear Models via Coordinate</span>
<span class="sd">        Descent. Journal of Statistical Software, 33(1) (2008)</span>
<span class="sd">        http://www.jstatsoft.org/v33/i01/paper</span>

<span class="sd">        http://statweb.stanford.edu/~tibs/stat315a/Supplements/fuse.pdf</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;l1&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid regularization method&quot;</span><span class="p">)</span>

        <span class="c1"># If method is a smooth penalty just optimize directly.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">Penalty</span><span class="p">):</span>
            <span class="c1"># Scale the penalty weights by alpha</span>
            <span class="n">method</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
            <span class="n">fit_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;fe_pen&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">})</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">**</span><span class="n">fit_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">alpha</span><span class="p">):</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="c1"># Fit the unpenalized model to get the dependence structure.</span>
        <span class="n">mdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">**</span><span class="n">fit_kwargs</span><span class="p">)</span>
        <span class="n">fe_params</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">fe_params</span>
        <span class="n">cov_re</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">cov_re</span>
        <span class="n">vcomp</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">vcomp</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">scale</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">itr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxit</span><span class="p">):</span>

            <span class="n">fe_params_s</span> <span class="o">=</span> <span class="n">fe_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">):</span>

                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fe_params</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">ceps</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># The residuals</span>
                <span class="n">fe_params</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">expval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">,</span> <span class="n">fe_params</span><span class="p">)</span>
                <span class="n">resid_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog</span> <span class="o">-</span> <span class="n">expval</span>

                <span class="c1"># The loss function has the form</span>
                <span class="c1"># a*x^2 + b*x + pwt*|x|</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>

                    <span class="n">vc_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_vcomp</span><span class="p">(</span><span class="n">vcomp</span><span class="p">,</span> <span class="n">group_ix</span><span class="p">)</span>

                    <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
                    <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r</span><span class="p">[</span><span class="n">group_ix</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r2</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>

                    <span class="n">resid</span> <span class="o">=</span> <span class="n">resid_all</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">row_indices</span><span class="p">[</span><span class="n">group</span><span class="p">]]</span>
                    <span class="n">solver</span> <span class="o">=</span> <span class="n">_smw_solver</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">)</span>

                    <span class="n">x</span> <span class="o">=</span> <span class="n">exog</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">a</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                    <span class="n">b</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">resid</span><span class="p">)</span>

                <span class="n">pwt1</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="n">pwt1</span><span class="p">:</span>
                    <span class="n">fe_params</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">pwt1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">pwt1</span><span class="p">:</span>
                    <span class="n">fe_params</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">pwt1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fe_params_s</span> <span class="o">-</span> <span class="n">fe_params</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">ptol</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Replace the fixed effects estimates with their penalized</span>
        <span class="c1"># values, leave the dependence parameters in their unpenalized</span>
        <span class="c1"># state.</span>
        <span class="n">params_prof</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">params_prof</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">]</span> <span class="o">=</span> <span class="n">fe_params</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scale</span><span class="p">(</span><span class="n">fe_params</span><span class="p">,</span> <span class="n">mdf</span><span class="o">.</span><span class="n">cov_re_unscaled</span><span class="p">,</span> <span class="n">mdf</span><span class="o">.</span><span class="n">vcomp</span><span class="p">)</span>

        <span class="c1"># Get the Hessian including only the nonzero fixed effects,</span>
        <span class="c1"># then blow back up to the full size after inverting.</span>
        <span class="n">hess</span><span class="p">,</span> <span class="n">sing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="n">params_prof</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sing</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">_warn_cov_sing</span><span class="p">,</span> <span class="n">SingularMatrixWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">pcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">hess</span><span class="p">)</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">params_prof</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ceps</span>
        <span class="n">ii</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
        <span class="n">hess1</span> <span class="o">=</span> <span class="n">hess</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">ii</span><span class="p">]</span>
        <span class="n">pcov</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="o">-</span><span class="n">hess1</span><span class="p">)</span>

        <span class="n">params_object</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="o">.</span><span class="n">from_components</span><span class="p">(</span><span class="n">fe_params</span><span class="p">,</span> <span class="n">cov_re</span><span class="o">=</span><span class="n">cov_re</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">MixedLMResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params_prof</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">params_object</span> <span class="o">=</span> <span class="n">params_object</span>
        <span class="n">results</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="n">fe_params</span>
        <span class="n">results</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">cov_re</span>
        <span class="n">results</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="n">vcomp</span>
        <span class="n">results</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="n">results</span><span class="o">.</span><span class="n">cov_re_unscaled</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">cov_re_unscaled</span>
        <span class="n">results</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">method</span>
        <span class="n">results</span><span class="o">.</span><span class="n">converged</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">results</span><span class="o">.</span><span class="n">cov_pen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_pen</span>
        <span class="n">results</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span>
        <span class="n">results</span><span class="o">.</span><span class="n">k_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span>
        <span class="n">results</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span>
        <span class="n">results</span><span class="o">.</span><span class="n">k_vc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span>

        <span class="k">return</span> <span class="n">MixedLMResultsWrapper</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>


<div class="viewcode-block" id="MixedLM.get_fe_params">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.get_fe_params.html#statsmodels.regression.mixed_linear_model.MixedLM.get_fe_params">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fe_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cov_re</span><span class="p">,</span> <span class="n">vcomp</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use GLS to update the fixed effects parameter estimates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cov_re : array_like (2d)</span>
<span class="sd">            The covariance matrix of the random effects.</span>
<span class="sd">        vcomp : array_like (1d)</span>
<span class="sd">            The variance components.</span>
<span class="sd">        tol : float</span>
<span class="sd">            A tolerance parameter to determine when covariances</span>
<span class="sd">            are singular.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        params : ndarray</span>
<span class="sd">            The GLS estimates of the fixed effects parameters.</span>
<span class="sd">        singular : bool</span>
<span class="sd">            True if the covariance is singular</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="kc">False</span>

        <span class="n">sing</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                <span class="c1"># Singular, use pseudo-inverse</span>
                <span class="n">sing</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">w</span> <span class="o">&gt;=</span> <span class="n">tol</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vi</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:,</span> <span class="n">ii</span><span class="p">]</span>
                    <span class="n">wi</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                    <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vi</span> <span class="o">/</span> <span class="n">wi</span><span class="p">,</span> <span class="n">vi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>

        <span class="c1"># Cache these quantities that do not change.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_endex_li&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_endex_li</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_endex_li</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>

        <span class="n">xtxy</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>
            <span class="n">vc_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_vcomp</span><span class="p">(</span><span class="n">vcomp</span><span class="p">,</span> <span class="n">group_ix</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vc_var</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">vc_var</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                    <span class="c1"># Pseudo-inverse</span>
                    <span class="n">sing</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">vc_var</span> <span class="o">&gt;=</span> <span class="n">tol</span><span class="p">)</span>
                    <span class="n">vc_vari</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">vc_var</span><span class="p">)</span>
                    <span class="n">vc_vari</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vc_vari</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vc_vari</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r</span><span class="p">[</span><span class="n">group_ix</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r2</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">_smw_solver</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span> <span class="n">vc_vari</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_endex_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">])</span>
            <span class="n">xtxy</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sing</span><span class="p">:</span>
            <span class="n">fe_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">xtxy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">xtxy</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fe_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">xtxy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xtxy</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">fe_params</span><span class="p">,</span> <span class="n">sing</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_reparam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns parameters of the map converting parameters from the</span>
<span class="sd">        form used in optimization to the form returned to the user.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lin : list-like</span>
<span class="sd">            Linear terms of the map</span>
<span class="sd">        quad : list-like</span>
<span class="sd">            Quadratic terms of the map</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If P are the standard form parameters and R are the</span>
<span class="sd">        transformed parameters (i.e. with the Cholesky square root</span>
<span class="sd">        covariance and square root transformed variance components),</span>
<span class="sd">        then P[i] = lin[i] * R + R&#39; * quad[i] * R</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">k_fe</span><span class="p">,</span> <span class="n">k_re</span><span class="p">,</span> <span class="n">k_re2</span><span class="p">,</span> <span class="n">k_vc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span>
        <span class="n">k_tot</span> <span class="o">=</span> <span class="n">k_fe</span> <span class="o">+</span> <span class="n">k_re2</span> <span class="o">+</span> <span class="n">k_vc</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">)</span>

        <span class="n">lin</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_fe</span><span class="p">):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">k_tot</span><span class="p">)</span>
            <span class="n">e</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">lin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_re2</span><span class="p">):</span>
            <span class="n">lin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">k_tot</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_vc</span><span class="p">):</span>
            <span class="n">lin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">k_tot</span><span class="p">))</span>

        <span class="n">quad</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Quadratic terms for fixed effects.</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_tot</span><span class="p">):</span>
            <span class="n">quad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">k_tot</span><span class="p">,</span> <span class="n">k_tot</span><span class="p">)))</span>

        <span class="c1"># Quadratic terms for random effects covariance.</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">k_re</span><span class="p">)</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ii</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ii</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_re2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_re2</span><span class="p">):</span>
                <span class="n">ix1</span> <span class="o">=</span> <span class="n">ix</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span>
                <span class="n">ix2</span> <span class="o">=</span> <span class="n">ix</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ix1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ix2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ix1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ix2</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">ii</span> <span class="o">=</span> <span class="p">(</span><span class="n">ix2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ix1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">ix</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                    <span class="n">quad</span><span class="p">[</span><span class="n">k_fe</span> <span class="o">+</span> <span class="n">k</span><span class="p">][</span><span class="n">k_fe</span> <span class="o">+</span> <span class="n">i2</span><span class="p">,</span> <span class="n">k_fe</span> <span class="o">+</span> <span class="n">i1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_tot</span><span class="p">):</span>
            <span class="n">quad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">quad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">quad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># Quadratic terms for variance components.</span>
        <span class="n">km</span> <span class="o">=</span> <span class="n">k_fe</span> <span class="o">+</span> <span class="n">k_re2</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">km</span><span class="p">,</span> <span class="n">km</span> <span class="o">+</span> <span class="n">k_vc</span><span class="p">):</span>
            <span class="n">quad</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">lin</span><span class="p">,</span> <span class="n">quad</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_expand_vcomp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vcomp</span><span class="p">,</span> <span class="n">group_ix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replicate variance parameters to match a group&#39;s design.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vcomp : array_like</span>
<span class="sd">            The variance parameters for the variance components.</span>
<span class="sd">        group_ix : int</span>
<span class="sd">            The group index</span>

<span class="sd">        Returns an expanded version of vcomp, in which each variance</span>
<span class="sd">        parameter is copied as many times as there are independent</span>
<span class="sd">        realizations of the variance component in the given group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vcomp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vc_var</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_vc</span><span class="o">.</span><span class="n">names</span><span class="p">)):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_vc</span><span class="o">.</span><span class="n">mats</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">group_ix</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">vc_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vcomp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vc_var</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">vc_var</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Cannot reach here?</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_augment_exog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_ix</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Concatenate the columns for variance components to the columns</span>
<span class="sd">        for other random effects to obtain a single random effects</span>
<span class="sd">        exog matrix for a given group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ex_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_re_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ex_r</span>

        <span class="n">ex</span> <span class="o">=</span> <span class="p">[</span><span class="n">ex_r</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">any_sparse</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_vc</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
            <span class="n">ex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_vc</span><span class="o">.</span><span class="n">mats</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">group_ix</span><span class="p">])</span>
            <span class="n">any_sparse</span> <span class="o">|=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">any_sparse</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ex</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="n">ex</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ex</span>

<div class="viewcode-block" id="MixedLM.loglike">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.loglike.html#statsmodels.regression.mixed_linear_model.MixedLM.loglike">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">loglike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">profile_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the (profile) log-likelihood of the linear mixed</span>
<span class="sd">        effects model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : MixedLMParams, or array_like.</span>
<span class="sd">            The parameter value.  If array-like, must be a packed</span>
<span class="sd">            parameter vector containing only the covariance</span>
<span class="sd">            parameters.</span>
<span class="sd">        profile_fe : bool</span>
<span class="sd">            If True, replace the provided value of `fe_params` with</span>
<span class="sd">            the GLS estimates.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        The log-likelihood value at `params`.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The scale parameter `scale` is always profiled out of the</span>
<span class="sd">        log-likelihood.  In addition, if `profile_fe` is true the</span>
<span class="sd">        fixed effects parameters are also profiled out.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">MixedLMParams</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="o">.</span><span class="n">from_packed</span><span class="p">(</span>
                <span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

        <span class="n">cov_re</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span>
        <span class="n">vcomp</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">vcomp</span>

        <span class="c1"># Move to the profile set</span>
        <span class="k">if</span> <span class="n">profile_fe</span><span class="p">:</span>
            <span class="n">fe_params</span><span class="p">,</span> <span class="n">sing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fe_params</span><span class="p">(</span><span class="n">cov_re</span><span class="p">,</span> <span class="n">vcomp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sing</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cov_sing</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fe_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">fe_params</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
                <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cov_sing</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">cov_re_logdet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">cov_re_logdet</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># The residuals</span>
        <span class="n">expval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">,</span> <span class="n">fe_params</span><span class="p">)</span>
        <span class="n">resid_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog</span> <span class="o">-</span> <span class="n">expval</span>

        <span class="n">likeval</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># Handle the covariance penalty</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_pen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_pen</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">cov_re</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">)</span>

        <span class="c1"># Handle the fixed effects penalty</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe_pen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe_pen</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">fe_params</span><span class="p">)</span>

        <span class="n">xvx</span><span class="p">,</span> <span class="n">qf</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>

            <span class="n">vc_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_vcomp</span><span class="p">(</span><span class="n">vcomp</span><span class="p">,</span> <span class="n">group_ix</span><span class="p">)</span>
            <span class="n">cov_aug_logdet</span> <span class="o">=</span> <span class="n">cov_re_logdet</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vc_var</span><span class="p">))</span>

            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r</span><span class="p">[</span><span class="n">group_ix</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r2</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">_smw_solver</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">)</span>

            <span class="n">resid</span> <span class="o">=</span> <span class="n">resid_all</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">row_indices</span><span class="p">[</span><span class="n">group</span><span class="p">]]</span>

            <span class="c1"># Part 1 of the log likelihood (for both ML and REML)</span>
            <span class="n">ld</span> <span class="o">=</span> <span class="n">_smw_logdet</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">,</span> <span class="n">cov_aug_logdet</span><span class="p">)</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="n">ld</span> <span class="o">/</span> <span class="mf">2.0</span>

            <span class="c1"># Part 2 of the log likelihood (for both ML and REML)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
            <span class="n">qf</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>

            <span class="c1"># Adjustment for REML</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">exog</span><span class="p">)</span>
                <span class="n">xvx</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">qf</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ld</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="n">xvx</span><span class="p">)</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="n">ld</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">likeval</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="p">)</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">qf</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">likeval</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="k">return</span> <span class="n">likeval</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_gen_dV_dPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">max_ix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A generator that yields the element-wise derivative of the</span>
<span class="sd">        marginal covariance matrix with respect to the random effects</span>
<span class="sd">        variance and covariance parameters.</span>

<span class="sd">        ex_r : array_like</span>
<span class="sd">            The random effects design matrix</span>
<span class="sd">        solver : function</span>
<span class="sd">            A function that given x returns V^{-1}x, where V</span>
<span class="sd">            is the group&#39;s marginal covariance matrix.</span>
<span class="sd">        group_ix : int</span>
<span class="sd">            The group index</span>
<span class="sd">        max_ix : {int, None}</span>
<span class="sd">            If not None, the generator ends when this index</span>
<span class="sd">            is reached.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">axr</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">ex_r</span><span class="p">)</span>

        <span class="c1"># Regular random effects</span>
        <span class="n">jj</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">max_ix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">jj</span> <span class="o">&gt;</span> <span class="n">max_ix</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="c1"># Need 2d</span>
                <span class="n">mat_l</span><span class="p">,</span> <span class="n">mat_r</span> <span class="o">=</span> <span class="n">ex_r</span><span class="p">[:,</span> <span class="n">j1</span> <span class="p">:</span> <span class="n">j1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ex_r</span><span class="p">[:,</span> <span class="n">j2</span> <span class="p">:</span> <span class="n">j2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">vsl</span><span class="p">,</span> <span class="n">vsr</span> <span class="o">=</span> <span class="n">axr</span><span class="p">[:,</span> <span class="n">j1</span> <span class="p">:</span> <span class="n">j1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axr</span><span class="p">[:,</span> <span class="n">j2</span> <span class="p">:</span> <span class="n">j2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">yield</span> <span class="n">jj</span><span class="p">,</span> <span class="n">mat_l</span><span class="p">,</span> <span class="n">mat_r</span><span class="p">,</span> <span class="n">vsl</span><span class="p">,</span> <span class="n">vsr</span><span class="p">,</span> <span class="n">j1</span> <span class="o">==</span> <span class="n">j2</span>
                <span class="n">jj</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Variance components</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_vc</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">max_ix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">jj</span> <span class="o">&gt;</span> <span class="n">max_ix</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_vc</span><span class="o">.</span><span class="n">mats</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">axmat</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">jj</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">axmat</span><span class="p">,</span> <span class="n">axmat</span><span class="p">,</span> <span class="kc">True</span>
            <span class="n">jj</span> <span class="o">+=</span> <span class="mi">1</span>

<div class="viewcode-block" id="MixedLM.score">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.score.html#statsmodels.regression.mixed_linear_model.MixedLM.score">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">profile_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the score vector of the profile log-likelihood.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The score vector that is returned is computed with respect to</span>
<span class="sd">        the parameterization defined by this model instance&#39;s</span>
<span class="sd">        `use_sqrt` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">MixedLMParams</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="o">.</span><span class="n">from_packed</span><span class="p">(</span>
                <span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">profile_fe</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">fe_params</span><span class="p">,</span> <span class="n">sing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fe_params</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">cov_re</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">vcomp</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sing</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Random effects covariance is singular&quot;</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">SingularMatrixWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span><span class="p">:</span>
            <span class="n">score_fe</span><span class="p">,</span> <span class="n">score_re</span><span class="p">,</span> <span class="n">score_vc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_sqrt</span><span class="p">(</span>
                <span class="n">params</span><span class="p">,</span> <span class="n">calc_fe</span><span class="o">=</span><span class="ow">not</span> <span class="n">profile_fe</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score_fe</span><span class="p">,</span> <span class="n">score_re</span><span class="p">,</span> <span class="n">score_vc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_full</span><span class="p">(</span>
                <span class="n">params</span><span class="p">,</span> <span class="n">calc_fe</span><span class="o">=</span><span class="ow">not</span> <span class="n">profile_fe</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freepat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">score_fe</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freepat</span><span class="o">.</span><span class="n">fe_params</span>
            <span class="n">score_re</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freepat</span><span class="o">.</span><span class="n">cov_re</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_freepat</span><span class="o">.</span><span class="n">_ix</span><span class="p">]</span>
            <span class="n">score_vc</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freepat</span><span class="o">.</span><span class="n">vcomp</span>

        <span class="k">if</span> <span class="n">profile_fe</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">score_re</span><span class="p">,</span> <span class="n">score_vc</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">score_fe</span><span class="p">,</span> <span class="n">score_re</span><span class="p">,</span> <span class="n">score_vc</span><span class="p">))</span></div>


<div class="viewcode-block" id="MixedLM.score_full">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.score_full.html#statsmodels.regression.mixed_linear_model.MixedLM.score_full">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">score_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">calc_fe</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the score with respect to untransformed parameters.</span>

<span class="sd">        Calculates the score vector for the profiled log-likelihood of</span>
<span class="sd">        the mixed effects model with respect to the parameterization</span>
<span class="sd">        in which the random effects covariance matrix is represented</span>
<span class="sd">        in its full form (not using the Cholesky factor).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : MixedLMParams or array_like</span>
<span class="sd">            The parameter at which the score function is evaluated.</span>
<span class="sd">            If array-like, must contain the packed random effects</span>
<span class="sd">            parameters (cov_re and vcomp) without fe_params.</span>
<span class="sd">        calc_fe : bool</span>
<span class="sd">            If True, calculate the score vector for the fixed effects</span>
<span class="sd">            parameters.  If False, this vector is not calculated, and</span>
<span class="sd">            a vector of zeros is returned in its place.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        score_fe : array_like</span>
<span class="sd">            The score vector with respect to the fixed effects</span>
<span class="sd">            parameters.</span>
<span class="sd">        score_re : array_like</span>
<span class="sd">            The score vector with respect to the random effects</span>
<span class="sd">            parameters (excluding variance components parameters).</span>
<span class="sd">        score_vc : array_like</span>
<span class="sd">            The score vector with respect to variance components</span>
<span class="sd">            parameters.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        `score_re` is taken with respect to the parameterization in</span>
<span class="sd">        which `cov_re` is represented through its lower triangle</span>
<span class="sd">        (without taking the Cholesky square root).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fe_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">fe_params</span>
        <span class="n">cov_re</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span>
        <span class="n">vcomp</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">vcomp</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cov_sing</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">score_fe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">)</span>
        <span class="n">score_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span><span class="p">)</span>
        <span class="n">score_vc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">)</span>

        <span class="c1"># Handle the covariance penalty.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_pen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">score_re</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_pen</span><span class="o">.</span><span class="n">deriv</span><span class="p">(</span><span class="n">cov_re</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">)</span>

        <span class="c1"># Handle the fixed effects penalty.</span>
        <span class="k">if</span> <span class="n">calc_fe</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fe_pen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">score_fe</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe_pen</span><span class="o">.</span><span class="n">deriv</span><span class="p">(</span><span class="n">fe_params</span><span class="p">)</span>

        <span class="c1"># resid&#39; V^{-1} resid, summed over the groups (a scalar)</span>
        <span class="n">rvir</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># exog&#39; V^{-1} resid, summed over the groups (a k_fe</span>
        <span class="c1"># dimensional vector)</span>
        <span class="n">xtvir</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># exog&#39; V^{_1} exog, summed over the groups (a k_fe x k_fe</span>
        <span class="c1"># matrix)</span>
        <span class="n">xtvix</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1"># V^{-1} exog&#39; dV/dQ_jj exog V^{-1}, where Q_jj is the jj^th</span>
        <span class="c1"># covariance parameter.</span>
        <span class="n">xtax</span> <span class="o">=</span> <span class="p">[</span>
            <span class="mf">0.0</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">)</span>

        <span class="c1"># Temporary related to the gradient of log |V|</span>
        <span class="n">dlv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">)</span>

        <span class="c1"># resid&#39; V^{-1} dV/dQ_jj V^{-1} resid (a scalar)</span>
        <span class="n">rvavr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>

            <span class="n">vc_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_vcomp</span><span class="p">(</span><span class="n">vcomp</span><span class="p">,</span> <span class="n">group_ix</span><span class="p">)</span>

            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r</span><span class="p">[</span><span class="n">group_ix</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r2</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">_smw_solver</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">)</span>

            <span class="c1"># The residuals</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">expval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">fe_params</span><span class="p">)</span>
                <span class="n">resid</span> <span class="o">=</span> <span class="n">resid</span> <span class="o">-</span> <span class="n">expval</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
                <span class="n">viexog</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">exog</span><span class="p">)</span>
                <span class="n">xtvix</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">viexog</span><span class="p">)</span>

            <span class="c1"># Contributions to the covariance parameter gradient</span>
            <span class="n">vir</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">matl</span><span class="p">,</span> <span class="n">matr</span><span class="p">,</span> <span class="n">vsl</span><span class="p">,</span> <span class="n">vsr</span><span class="p">,</span> <span class="n">sym</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_dV_dPar</span><span class="p">(</span>
                <span class="n">ex_r</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">group_ix</span>
            <span class="p">):</span>
                <span class="n">dlv</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">_dotsum</span><span class="p">(</span><span class="n">matr</span><span class="p">,</span> <span class="n">vsl</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sym</span><span class="p">:</span>
                    <span class="n">dlv</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_dotsum</span><span class="p">(</span><span class="n">matl</span><span class="p">,</span> <span class="n">vsr</span><span class="p">)</span>

                <span class="n">ul</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">vir</span><span class="p">,</span> <span class="n">matl</span><span class="p">)</span>
                <span class="n">ur</span> <span class="o">=</span> <span class="n">ul</span><span class="o">.</span><span class="n">T</span> <span class="k">if</span> <span class="n">sym</span> <span class="k">else</span> <span class="n">_dot</span><span class="p">(</span><span class="n">matr</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">vir</span><span class="p">)</span>
                <span class="n">ulr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span> <span class="n">ur</span><span class="p">)</span>
                <span class="n">rvavr</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ulr</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sym</span><span class="p">:</span>
                    <span class="n">rvavr</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ulr</span><span class="o">.</span><span class="n">T</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
                    <span class="n">ul</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">viexog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">matl</span><span class="p">)</span>
                    <span class="n">ur</span> <span class="o">=</span> <span class="n">ul</span><span class="o">.</span><span class="n">T</span> <span class="k">if</span> <span class="n">sym</span> <span class="k">else</span> <span class="n">_dot</span><span class="p">(</span><span class="n">matr</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">viexog</span><span class="p">)</span>
                    <span class="n">ulr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span> <span class="n">ur</span><span class="p">)</span>
                    <span class="n">xtax</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ulr</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sym</span><span class="p">:</span>
                        <span class="n">xtax</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ulr</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># Contribution of log|V| to the covariance parameter</span>
            <span class="c1"># gradient.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">score_re</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dlv</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">score_vc</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dlv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="p">:]</span>

            <span class="n">rvir</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">vir</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">calc_fe</span><span class="p">:</span>
                <span class="n">xtvir</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">vir</span><span class="p">)</span>

        <span class="n">fac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
            <span class="n">fac</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span>

        <span class="k">if</span> <span class="n">calc_fe</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">score_fe</span> <span class="o">+=</span> <span class="n">fac</span> <span class="o">*</span> <span class="n">xtvir</span> <span class="o">/</span> <span class="n">rvir</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">score_re</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">fac</span> <span class="o">*</span> <span class="n">rvavr</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span><span class="p">]</span> <span class="o">/</span> <span class="n">rvir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">score_vc</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">fac</span> <span class="o">*</span> <span class="n">rvavr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="p">:]</span> <span class="o">/</span> <span class="n">rvir</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
            <span class="n">xtvixi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">xtvix</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span><span class="p">):</span>
                <span class="n">score_re</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">_dotsum</span><span class="p">(</span><span class="n">xtvixi</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">xtax</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">):</span>
                <span class="n">score_vc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">_dotsum</span><span class="p">(</span><span class="n">xtvixi</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">xtax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="n">j</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">score_fe</span><span class="p">,</span> <span class="n">score_re</span><span class="p">,</span> <span class="n">score_vc</span></div>


<div class="viewcode-block" id="MixedLM.score_sqrt">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.score_sqrt.html#statsmodels.regression.mixed_linear_model.MixedLM.score_sqrt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">score_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">calc_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the score with respect to transformed parameters.</span>

<span class="sd">        Calculates the score vector with respect to the</span>
<span class="sd">        parameterization in which the random effects covariance matrix</span>
<span class="sd">        is represented through its Cholesky square root.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : MixedLMParams or array_like</span>
<span class="sd">            The model parameters.  If array-like must contain packed</span>
<span class="sd">            parameters that are compatible with this model instance.</span>
<span class="sd">        calc_fe : bool</span>
<span class="sd">            If True, calculate the score vector for the fixed effects</span>
<span class="sd">            parameters.  If False, this vector is not calculated, and</span>
<span class="sd">            a vector of zeros is returned in its place.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        score_fe : array_like</span>
<span class="sd">            The score vector with respect to the fixed effects</span>
<span class="sd">            parameters.</span>
<span class="sd">        score_re : array_like</span>
<span class="sd">            The score vector with respect to the random effects</span>
<span class="sd">            parameters (excluding variance components parameters).</span>
<span class="sd">        score_vc : array_like</span>
<span class="sd">            The score vector with respect to variance components</span>
<span class="sd">            parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">score_fe</span><span class="p">,</span> <span class="n">score_re</span><span class="p">,</span> <span class="n">score_vc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_full</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">calc_fe</span><span class="o">=</span><span class="n">calc_fe</span><span class="p">)</span>
        <span class="n">params_vec</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get_packed</span><span class="p">(</span><span class="n">use_sqrt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">score_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">score_fe</span><span class="p">,</span> <span class="n">score_re</span><span class="p">,</span> <span class="n">score_vc</span><span class="p">))</span>
        <span class="n">scr</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params_vec</span><span class="p">)):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_quad</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">params_vec</span><span class="p">)</span>
            <span class="n">scr</span> <span class="o">+=</span> <span class="n">score_full</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span>
        <span class="n">score_fe</span> <span class="o">=</span> <span class="n">scr</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">]</span>
        <span class="n">score_re</span> <span class="o">=</span> <span class="n">scr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span><span class="p">]</span>
        <span class="n">score_vc</span> <span class="o">=</span> <span class="n">scr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="p">:]</span>

        <span class="k">return</span> <span class="n">score_fe</span><span class="p">,</span> <span class="n">score_re</span><span class="p">,</span> <span class="n">score_vc</span></div>


<div class="viewcode-block" id="MixedLM.hessian">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.hessian.html#statsmodels.regression.mixed_linear_model.MixedLM.hessian">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">hessian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the model&#39;s Hessian matrix.</span>

<span class="sd">        Calculates the Hessian matrix for the linear mixed effects</span>
<span class="sd">        model with respect to the parameterization in which the</span>
<span class="sd">        covariance matrix is represented directly (without square-root</span>
<span class="sd">        transformation).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : MixedLMParams or array_like</span>
<span class="sd">            The model parameters at which the Hessian is calculated.</span>
<span class="sd">            If array-like, must contain the packed parameters in a</span>
<span class="sd">            form that is compatible with this model instance.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hess : 2d ndarray</span>
<span class="sd">            The Hessian matrix, evaluated at `params`.</span>
<span class="sd">        sing : boolean</span>
<span class="sd">            If True, the covariance matrix is singular and a</span>
<span class="sd">            pseudo-inverse is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">MixedLMParams</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="o">.</span><span class="n">from_packed</span><span class="p">(</span>
                <span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="n">use_sqrt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="n">fe_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">fe_params</span>
        <span class="n">vcomp</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">vcomp</span>
        <span class="n">cov_re</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span>
        <span class="n">sing</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
                <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
                <span class="n">sing</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Blocks for the fixed and random effects parameters.</span>
        <span class="n">hess_fe</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">hess_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">))</span>
        <span class="n">hess_fere</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">))</span>

        <span class="n">fac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
            <span class="n">fac</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">rvir</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">xtvix</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">xtax</span> <span class="o">=</span> <span class="p">[</span>
            <span class="mf">0.0</span><span class="p">,</span>
        <span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
        <span class="n">F</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>

            <span class="n">vc_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_vcomp</span><span class="p">(</span><span class="n">vcomp</span><span class="p">,</span> <span class="n">group_ix</span><span class="p">)</span>
            <span class="n">vc_vari</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">vc_var</span><span class="p">)</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">vc_var</span> <span class="o">&gt;=</span> <span class="mf">1e-10</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">vc_vari</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">vc_var</span><span class="p">):</span>
                <span class="n">sing</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r</span><span class="p">[</span><span class="n">group_ix</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r2</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">_smw_solver</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span> <span class="n">vc_vari</span><span class="p">)</span>

            <span class="c1"># The residuals</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">expval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">fe_params</span><span class="p">)</span>
                <span class="n">resid</span> <span class="o">=</span> <span class="n">resid</span> <span class="o">-</span> <span class="n">expval</span>

            <span class="n">viexog</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">exog</span><span class="p">)</span>
            <span class="n">xtvix</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">viexog</span><span class="p">)</span>
            <span class="n">vir</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
            <span class="n">rvir</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">vir</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">jj1</span><span class="p">,</span> <span class="n">matl1</span><span class="p">,</span> <span class="n">matr1</span><span class="p">,</span> <span class="n">vsl1</span><span class="p">,</span> <span class="n">vsr1</span><span class="p">,</span> <span class="n">sym1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_dV_dPar</span><span class="p">(</span>
                <span class="n">ex_r</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">group_ix</span>
            <span class="p">):</span>

                <span class="n">ul</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">viexog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">matl1</span><span class="p">)</span>
                <span class="n">ur</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">matr1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">vir</span><span class="p">)</span>
                <span class="n">hess_fere</span><span class="p">[</span><span class="n">jj1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span> <span class="n">ur</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sym1</span><span class="p">:</span>
                    <span class="n">ul</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">viexog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">matr1</span><span class="p">)</span>
                    <span class="n">ur</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">matl1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">vir</span><span class="p">)</span>
                    <span class="n">hess_fere</span><span class="p">[</span><span class="n">jj1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span> <span class="n">ur</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
                    <span class="n">ul</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">viexog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">matl1</span><span class="p">)</span>
                    <span class="n">ur</span> <span class="o">=</span> <span class="n">ul</span> <span class="k">if</span> <span class="n">sym1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">viexog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">matr1</span><span class="p">)</span>
                    <span class="n">ulr</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span> <span class="n">ur</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                    <span class="n">xtax</span><span class="p">[</span><span class="n">jj1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ulr</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sym1</span><span class="p">:</span>
                        <span class="n">xtax</span><span class="p">[</span><span class="n">jj1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ulr</span><span class="o">.</span><span class="n">T</span>

                <span class="n">ul</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">vir</span><span class="p">,</span> <span class="n">matl1</span><span class="p">)</span>
                <span class="n">ur</span> <span class="o">=</span> <span class="n">ul</span> <span class="k">if</span> <span class="n">sym1</span> <span class="k">else</span> <span class="n">_dot</span><span class="p">(</span><span class="n">vir</span><span class="p">,</span> <span class="n">matr1</span><span class="p">)</span>
                <span class="n">B</span><span class="p">[</span><span class="n">jj1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span> <span class="n">ur</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">sym1</span> <span class="k">else</span> <span class="mi">2</span><span class="p">)</span>

                <span class="c1"># V^{-1} * dV/d_theta</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[(</span><span class="n">vsl1</span><span class="p">,</span> <span class="n">matr1</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sym1</span><span class="p">:</span>
                    <span class="n">E</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">vsr1</span><span class="p">,</span> <span class="n">matl1</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">jj2</span><span class="p">,</span> <span class="n">matl2</span><span class="p">,</span> <span class="n">matr2</span><span class="p">,</span> <span class="n">vsl2</span><span class="p">,</span> <span class="n">vsr2</span><span class="p">,</span> <span class="n">sym2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gen_dV_dPar</span><span class="p">(</span>
                    <span class="n">ex_r</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">jj1</span>
                <span class="p">):</span>

                    <span class="n">re</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">_multi_dot_three</span><span class="p">(</span><span class="n">matr2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">E</span><span class="p">])</span>
                    <span class="n">vt</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">_dot</span><span class="p">(</span>
                        <span class="n">_multi_dot_three</span><span class="p">(</span><span class="n">vir</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">matl2</span><span class="p">,</span> <span class="n">re</span><span class="p">),</span> <span class="n">vir</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sym2</span><span class="p">:</span>
                        <span class="n">le</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">_multi_dot_three</span><span class="p">(</span><span class="n">matl2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">E</span><span class="p">])</span>
                        <span class="n">vt</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">_dot</span><span class="p">(</span>
                            <span class="n">_multi_dot_three</span><span class="p">(</span><span class="n">vir</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">matr2</span><span class="p">,</span> <span class="n">le</span><span class="p">),</span> <span class="n">vir</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
                        <span class="p">)</span>

                    <span class="n">D</span><span class="p">[</span><span class="n">jj1</span><span class="p">,</span> <span class="n">jj2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">vt</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">jj1</span> <span class="o">!=</span> <span class="n">jj2</span><span class="p">:</span>
                        <span class="n">D</span><span class="p">[</span><span class="n">jj2</span><span class="p">,</span> <span class="n">jj1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">vt</span><span class="p">)</span>

                    <span class="n">rt</span> <span class="o">=</span> <span class="n">_dotsum</span><span class="p">(</span><span class="n">vsl2</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sym2</span><span class="p">:</span>
                        <span class="n">rt</span> <span class="o">+=</span> <span class="n">_dotsum</span><span class="p">(</span><span class="n">vsr2</span><span class="p">,</span> <span class="n">le</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

                    <span class="n">hess_re</span><span class="p">[</span><span class="n">jj1</span><span class="p">,</span> <span class="n">jj2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rt</span>
                    <span class="k">if</span> <span class="n">jj1</span> <span class="o">!=</span> <span class="n">jj2</span><span class="p">:</span>
                        <span class="n">hess_re</span><span class="p">[</span><span class="n">jj2</span><span class="p">,</span> <span class="n">jj1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rt</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
                        <span class="n">ev</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">_dot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_dot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">viexog</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">E</span><span class="p">])</span>
                        <span class="n">u1</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">viexog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">matl2</span><span class="p">)</span>
                        <span class="n">u2</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">matr2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
                        <span class="n">um</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
                        <span class="n">F</span><span class="p">[</span><span class="n">jj1</span><span class="p">][</span><span class="n">jj2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">um</span> <span class="o">+</span> <span class="n">um</span><span class="o">.</span><span class="n">T</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">sym2</span><span class="p">:</span>
                            <span class="n">u1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">viexog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">matr2</span><span class="p">)</span>
                            <span class="n">u2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matl2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
                            <span class="n">um</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
                            <span class="n">F</span><span class="p">[</span><span class="n">jj1</span><span class="p">][</span><span class="n">jj2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">um</span> <span class="o">+</span> <span class="n">um</span><span class="o">.</span><span class="n">T</span>

        <span class="n">hess_fe</span> <span class="o">-=</span> <span class="n">fac</span> <span class="o">*</span> <span class="n">xtvix</span> <span class="o">/</span> <span class="n">rvir</span>
        <span class="n">hess_re</span> <span class="o">=</span> <span class="n">hess_re</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">fac</span> <span class="o">*</span> <span class="p">(</span><span class="n">D</span> <span class="o">/</span> <span class="n">rvir</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span> <span class="o">/</span> <span class="n">rvir</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">hess_fere</span> <span class="o">=</span> <span class="o">-</span><span class="n">fac</span> <span class="o">*</span> <span class="n">hess_fere</span> <span class="o">/</span> <span class="n">rvir</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
            <span class="n">QL</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">xtvix</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xtax</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">_dotsum</span><span class="p">(</span><span class="n">QL</span><span class="p">[</span><span class="n">j1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">QL</span><span class="p">[</span><span class="n">j2</span><span class="p">])</span>
                    <span class="n">a</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">xtvix</span><span class="p">,</span> <span class="n">F</span><span class="p">[</span><span class="n">j1</span><span class="p">][</span><span class="n">j2</span><span class="p">]))</span>
                    <span class="n">a</span> <span class="o">*=</span> <span class="mf">0.5</span>
                    <span class="n">hess_re</span><span class="p">[</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">a</span>
                    <span class="k">if</span> <span class="n">j1</span> <span class="o">&gt;</span> <span class="n">j2</span><span class="p">:</span>
                        <span class="n">hess_re</span><span class="p">[</span><span class="n">j2</span><span class="p">,</span> <span class="n">j1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">a</span>

        <span class="c1"># Put the blocks together to get the Hessian.</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span>
        <span class="n">hess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
        <span class="n">hess</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">]</span> <span class="o">=</span> <span class="n">hess_fe</span>
        <span class="n">hess</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">hess_fere</span><span class="o">.</span><span class="n">T</span>
        <span class="n">hess</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="p">:,</span> <span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">]</span> <span class="o">=</span> <span class="n">hess_fere</span>
        <span class="n">hess</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">hess_re</span>

        <span class="k">return</span> <span class="n">hess</span><span class="p">,</span> <span class="n">sing</span></div>


<div class="viewcode-block" id="MixedLM.get_scale">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.get_scale.html#statsmodels.regression.mixed_linear_model.MixedLM.get_scale">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_params</span><span class="p">,</span> <span class="n">cov_re</span><span class="p">,</span> <span class="n">vcomp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the estimated error variance based on given estimates</span>
<span class="sd">        of the slopes and random effects covariance matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fe_params : array_like</span>
<span class="sd">            The regression slope estimates</span>
<span class="sd">        cov_re : 2d array_like</span>
<span class="sd">            Estimate of the random effects covariance matrix</span>
<span class="sd">        vcomp : array_like</span>
<span class="sd">            Estimate of the variance components</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        scale : float</span>
<span class="sd">            The estimated error variance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">_warn_cov_sing</span><span class="p">,</span> <span class="n">SingularMatrixWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">qf</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>

            <span class="n">vc_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_vcomp</span><span class="p">(</span><span class="n">vcomp</span><span class="p">,</span> <span class="n">group_ix</span><span class="p">)</span>

            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r</span><span class="p">[</span><span class="n">group_ix</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r2</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>

            <span class="n">solver</span> <span class="o">=</span> <span class="n">_smw_solver</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">)</span>

            <span class="c1"># The residuals</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">expval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">fe_params</span><span class="p">)</span>
                <span class="n">resid</span> <span class="o">=</span> <span class="n">resid</span> <span class="o">-</span> <span class="n">expval</span>

            <span class="n">mat</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
            <span class="n">qf</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
            <span class="n">qf</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qf</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span>

        <span class="k">return</span> <span class="n">qf</span></div>


<div class="viewcode-block" id="MixedLM.fit">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.fit.html#statsmodels.regression.mixed_linear_model.MixedLM.fit">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">start_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">reml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">niter_sa</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">do_cg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">fe_pen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">cov_pen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">free</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">fit_kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a linear mixed model to the data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start_params : array_like or MixedLMParams</span>
<span class="sd">            Starting values for the profile log-likelihood.  If not a</span>
<span class="sd">            `MixedLMParams` instance, this should be an array</span>
<span class="sd">            containing the packed parameters for the profile</span>
<span class="sd">            log-likelihood, including the fixed effects</span>
<span class="sd">            parameters.</span>
<span class="sd">        reml : bool</span>
<span class="sd">            If true, fit according to the REML likelihood, else</span>
<span class="sd">            fit the standard likelihood using ML.</span>
<span class="sd">        niter_sa : int</span>
<span class="sd">            Currently this argument is ignored and has no effect</span>
<span class="sd">            on the results.</span>
<span class="sd">        cov_pen : CovariancePenalty object</span>
<span class="sd">            A penalty for the random effects covariance matrix</span>
<span class="sd">        do_cg : bool, defaults to True</span>
<span class="sd">            If False, the optimization is skipped and a results</span>
<span class="sd">            object at the given (or default) starting values is</span>
<span class="sd">            returned.</span>
<span class="sd">        fe_pen : Penalty object</span>
<span class="sd">            A penalty on the fixed effects</span>
<span class="sd">        free : MixedLMParams object</span>
<span class="sd">            If not `None`, this is a mask that allows parameters to be</span>
<span class="sd">            held fixed at specified values.  A 1 indicates that the</span>
<span class="sd">            corresponding parameter is estimated, a 0 indicates that</span>
<span class="sd">            it is fixed at its starting value.  Setting the `cov_re`</span>
<span class="sd">            component to the identity matrix fits a model with</span>
<span class="sd">            independent random effects.  Note that some optimization</span>
<span class="sd">            methods do not respect this constraint (bfgs and lbfgs both</span>
<span class="sd">            work).</span>
<span class="sd">        full_output : bool</span>
<span class="sd">            If true, attach iteration history to results</span>
<span class="sd">        method : str</span>
<span class="sd">            Optimization method.  Can be a scipy.optimize method name,</span>
<span class="sd">            or a list of such names to be tried in sequence.</span>
<span class="sd">        **fit_kwargs</span>
<span class="sd">            Additional keyword arguments passed to fit.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A MixedLMResults instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_allowed_kwargs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;gtol&quot;</span><span class="p">,</span>
            <span class="s2">&quot;maxiter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;eps&quot;</span><span class="p">,</span>
            <span class="s2">&quot;maxcor&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ftol&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tol&quot;</span><span class="p">,</span>
            <span class="s2">&quot;disp&quot;</span><span class="p">,</span>
            <span class="s2">&quot;maxls&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fit_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_allowed_kwargs</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Argument </span><span class="si">%s</span><span class="s2"> not used by MixedLM.fit&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">,</span>
                    <span class="ne">RuntimeWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">method</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bfgs&quot;</span><span class="p">,</span> <span class="s2">&quot;lbfgs&quot;</span><span class="p">,</span> <span class="s2">&quot;cg&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">method</span> <span class="o">=</span> <span class="p">[</span><span class="n">method</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">meth</span> <span class="ow">in</span> <span class="n">method</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">meth</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;newton&quot;</span><span class="p">,</span> <span class="s2">&quot;ncg&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;method </span><span class="si">%s</span><span class="s2"> not available for MixedLM&quot;</span> <span class="o">%</span> <span class="n">meth</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reml</span> <span class="o">=</span> <span class="n">reml</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_pen</span> <span class="o">=</span> <span class="n">cov_pen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fe_pen</span> <span class="o">=</span> <span class="n">fe_pen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cov_sing</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_freepat</span> <span class="o">=</span> <span class="n">free</span>

        <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">start_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_params</span><span class="p">,</span> <span class="n">MixedLMParams</span><span class="p">):</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">start_params</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># It&#39;s a packed array</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_params</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">:</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="o">.</span><span class="n">from_packed</span><span class="p">(</span>
                        <span class="n">start_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">True</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_params</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">:</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="o">.</span><span class="n">from_packed</span><span class="p">(</span>
                        <span class="n">start_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid start_params&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">do_cg</span><span class="p">:</span>
            <span class="n">fit_kwargs</span><span class="p">[</span><span class="s2">&quot;retall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s2">&quot;disp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fit_kwargs</span><span class="p">:</span>
                <span class="n">fit_kwargs</span><span class="p">[</span><span class="s2">&quot;disp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">packed</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get_packed</span><span class="p">(</span><span class="n">use_sqrt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">niter_sa</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;niter_sa is currently ignored&quot;</span><span class="p">,</span> <span class="n">ValueWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span>
                <span class="p">)</span>

            <span class="c1"># Try optimizing one or more times</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">method</span><span class="p">)):</span>
                <span class="n">rslt</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                    <span class="n">start_params</span><span class="o">=</span><span class="n">packed</span><span class="p">,</span>
                    <span class="n">skip_hessian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                    <span class="o">**</span><span class="n">fit_kwargs</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">rslt</span><span class="o">.</span><span class="n">mle_retvals</span><span class="p">[</span><span class="s2">&quot;converged&quot;</span><span class="p">]:</span>
                    <span class="k">break</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="n">rslt</span><span class="o">.</span><span class="n">params</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
                    <span class="n">next_method</span> <span class="o">=</span> <span class="n">method</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;Retrying MixedLM optimization with </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">next_method</span><span class="p">,</span>
                        <span class="n">ConvergenceWarning</span><span class="p">,</span>
                        <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;MixedLM optimization failed, &quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;trying a different optimizer may help.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ConvergenceWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="c1"># The optimization succeeded</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">rslt</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rslt</span><span class="o">.</span><span class="n">mle_retvals</span><span class="p">)</span>

        <span class="n">converged</span> <span class="o">=</span> <span class="n">rslt</span><span class="o">.</span><span class="n">mle_retvals</span><span class="p">[</span><span class="s2">&quot;converged&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">converged</span><span class="p">:</span>
            <span class="n">gn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">rslt</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="n">gn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gn</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Gradient optimization failed, |grad| = </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">gn</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ConvergenceWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Convert to the final parameterization (i.e. undo the square</span>
        <span class="c1"># root transform of the covariance matrix, and the profiling</span>
        <span class="c1"># over the error variance).</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="o">.</span><span class="n">from_packed</span><span class="p">(</span>
            <span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="n">use_sqrt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">cov_re_unscaled</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span>
        <span class="n">vcomp_unscaled</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">vcomp</span>
        <span class="n">fe_params</span><span class="p">,</span> <span class="n">sing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fe_params</span><span class="p">(</span><span class="n">cov_re_unscaled</span><span class="p">,</span> <span class="n">vcomp_unscaled</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="n">fe_params</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scale</span><span class="p">(</span><span class="n">fe_params</span><span class="p">,</span> <span class="n">cov_re_unscaled</span><span class="p">,</span> <span class="n">vcomp_unscaled</span><span class="p">)</span>
        <span class="n">cov_re</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">cov_re_unscaled</span>
        <span class="n">vcomp</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">vcomp_unscaled</span>

        <span class="n">f1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vcomp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f1</span> <span class="ow">or</span> <span class="n">f2</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The MLE may be on the boundary of the parameter space.&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ConvergenceWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Compute the Hessian at the MLE.  Note that this is the</span>
        <span class="c1"># Hessian with respect to the random effects covariance matrix</span>
        <span class="c1"># (not its square root).  It is used for obtaining standard</span>
        <span class="c1"># errors, not for optimization.</span>
        <span class="n">hess</span><span class="p">,</span> <span class="n">sing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sing</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">_warn_cov_sing</span><span class="p">,</span> <span class="n">SingularMatrixWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">hess_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hess</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">free</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">hess</span><span class="p">)</span>
            <span class="n">pat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freepat</span><span class="o">.</span><span class="n">get_packed</span><span class="p">(</span><span class="n">use_sqrt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
            <span class="n">hess_diag</span> <span class="o">=</span> <span class="n">hess_diag</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hess1</span> <span class="o">=</span> <span class="n">hess</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span><span class="p">)]</span>
                <span class="n">pcov</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="o">-</span><span class="n">hess1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="o">-</span><span class="n">hess</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">hess_diag</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;The Hessian matrix at the estimated parameter values &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;is not positive definite.&quot;</span>
            <span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ConvergenceWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Prepare a results class instance</span>
        <span class="n">params_packed</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get_packed</span><span class="p">(</span><span class="n">use_sqrt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">MixedLMResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params_packed</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">params_object</span> <span class="o">=</span> <span class="n">params</span>
        <span class="n">results</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="n">fe_params</span>
        <span class="n">results</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">cov_re</span>
        <span class="n">results</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="n">vcomp</span>
        <span class="n">results</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="n">results</span><span class="o">.</span><span class="n">cov_re_unscaled</span> <span class="o">=</span> <span class="n">cov_re_unscaled</span>
        <span class="n">results</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;REML&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span> <span class="k">else</span> <span class="s2">&quot;ML&quot;</span>
        <span class="n">results</span><span class="o">.</span><span class="n">converged</span> <span class="o">=</span> <span class="n">converged</span>
        <span class="n">results</span><span class="o">.</span><span class="n">hist</span> <span class="o">=</span> <span class="n">hist</span>
        <span class="n">results</span><span class="o">.</span><span class="n">reml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span>
        <span class="n">results</span><span class="o">.</span><span class="n">cov_pen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_pen</span>
        <span class="n">results</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span>
        <span class="n">results</span><span class="o">.</span><span class="n">k_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span>
        <span class="n">results</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span>
        <span class="n">results</span><span class="o">.</span><span class="n">k_vc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span>
        <span class="n">results</span><span class="o">.</span><span class="n">use_sqrt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span>
        <span class="n">results</span><span class="o">.</span><span class="n">freepat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freepat</span>

        <span class="k">return</span> <span class="n">MixedLMResultsWrapper</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>


<div class="viewcode-block" id="MixedLM.get_distribution">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.get_distribution.html#statsmodels.regression.mixed_linear_model.MixedLM.get_distribution">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">exog</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_mixedlm_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">exog</span><span class="p">)</span></div>
</div>



<span class="k">class</span><span class="w"> </span><span class="nc">_mixedlm_distribution</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A private class for simulating data from a given mixed linear model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : MixedLM instance</span>
<span class="sd">        A mixed linear model</span>
<span class="sd">    params : array_like</span>
<span class="sd">        A parameter vector defining a mixed linear model.  See</span>
<span class="sd">        notes for more information.</span>
<span class="sd">    scale : scalar</span>
<span class="sd">        The unexplained variance</span>
<span class="sd">    exog : array_like</span>
<span class="sd">        An array of fixed effect covariates.  If None, model.exog</span>
<span class="sd">        is used.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The params array is a vector containing fixed effects parameters,</span>
<span class="sd">    random effects parameters, and variance component parameters, in</span>
<span class="sd">    that order.  The lower triangle of the random effects covariance</span>
<span class="sd">    matrix is stored.  The random effects and variance components</span>
<span class="sd">    parameters are divided by the scale parameter.</span>

<span class="sd">    This class is used in Mediation, and possibly elsewhere.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">exog</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exog</span> <span class="o">=</span> <span class="n">exog</span> <span class="k">if</span> <span class="n">exog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">model</span><span class="o">.</span><span class="n">exog</span>

        <span class="n">po</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="o">.</span><span class="n">from_packed</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="n">po</span><span class="o">.</span><span class="n">fe_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">po</span><span class="o">.</span><span class="n">cov_re</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">po</span><span class="o">.</span><span class="n">vcomp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>

        <span class="n">group_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">nobs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>
            <span class="n">group_idx</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">row_indices</span><span class="p">[</span><span class="n">g</span><span class="p">]]</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_idx</span> <span class="o">=</span> <span class="n">group_idx</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rvs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a vector of simulated values from a mixed linear</span>
<span class="sd">        model.</span>

<span class="sd">        The parameter n is ignored, but required by the interface</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>

        <span class="c1"># Fixed effects</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe_params</span><span class="p">)</span>

        <span class="c1"># Random effects</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">n_groups</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">k_re</span><span class="p">))</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">group_idx</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">exog_re</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Variance components</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">exog_vc</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">exog_vc</span><span class="o">.</span><span class="n">mats</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcomp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>
                <span class="n">exg</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">row_indices</span><span class="p">[</span><span class="n">g</span><span class="p">]</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">exg</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">y</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exg</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>

        <span class="c1"># Residual variance</span>
        <span class="n">y</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">y</span>


<div class="viewcode-block" id="MixedLMResults">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLMResults.html#statsmodels.regression.mixed_linear_model.MixedLMResults">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MixedLMResults</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">LikelihoodModelResults</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">ResultMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to contain results of fitting a linear mixed effects model.</span>

<span class="sd">    MixedLMResults inherits from statsmodels.LikelihoodModelResults</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    See statsmodels.LikelihoodModelResults</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    model : class instance</span>
<span class="sd">        Pointer to MixedLM model instance that called fit.</span>
<span class="sd">    normalized_cov_params : ndarray</span>
<span class="sd">        The sampling covariance matrix of the estimates</span>
<span class="sd">    params : ndarray</span>
<span class="sd">        A packed parameter vector for the profile parameterization.</span>
<span class="sd">        The first `k_fe` elements are the estimated fixed effects</span>
<span class="sd">        coefficients.  The remaining elements are the estimated</span>
<span class="sd">        variance parameters.  The variance parameters are all divided</span>
<span class="sd">        by `scale` and are not the variance parameters shown</span>
<span class="sd">        in the summary.</span>
<span class="sd">    fe_params : ndarray</span>
<span class="sd">        The fitted fixed-effects coefficients</span>
<span class="sd">    cov_re : ndarray</span>
<span class="sd">        The fitted random-effects covariance matrix</span>
<span class="sd">    bse_fe : ndarray</span>
<span class="sd">        The standard errors of the fitted fixed effects coefficients</span>
<span class="sd">    bse_re : ndarray</span>
<span class="sd">        The standard errors of the fitted random effects covariance</span>
<span class="sd">        matrix and variance components.  The first `k_re * (k_re + 1)`</span>
<span class="sd">        parameters are the standard errors for the lower triangle of</span>
<span class="sd">        `cov_re`, the remaining elements are the standard errors for</span>
<span class="sd">        the variance components.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    statsmodels.LikelihoodModelResults</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">cov_params</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">normalized_cov_params</span><span class="o">=</span><span class="n">cov_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">nobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matrix_rank</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="p">)</span>

    <span class="nd">@cache_readonly</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fittedvalues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the fitted values for the model.</span>

<span class="sd">        The fitted values reflect the mean structure specified by the</span>
<span class="sd">        fixed effects and the predicted random effects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe_params</span><span class="p">)</span>
        <span class="n">re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_effects</span>
        <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">row_indices</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="n">mat</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_re_li</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_re_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">):</span>
                <span class="n">mat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_vc</span><span class="o">.</span><span class="n">mats</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">group_ix</span><span class="p">])</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">fit</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">re</span><span class="p">[</span><span class="n">group</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">fit</span>

    <span class="nd">@cache_readonly</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">resid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the residuals for the model.</span>

<span class="sd">        The residuals reflect the mean structure specified by the</span>
<span class="sd">        fixed effects and the predicted random effects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fittedvalues</span>

    <span class="nd">@cache_readonly</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bse_fe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the standard errors of the fixed effect regression</span>
<span class="sd">        coefficients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_params</span><span class="p">())[</span><span class="mi">0</span><span class="p">:</span><span class="n">p</span><span class="p">])</span>

    <span class="nd">@cache_readonly</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bse_re</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the standard errors of the variance parameters.</span>

<span class="sd">        The first `k_re x (k_re + 1)` elements of the returned array</span>
<span class="sd">        are the standard errors of the lower triangle of `cov_re`.</span>
<span class="sd">        The remaining elements are the standard errors of the variance</span>
<span class="sd">        components.</span>

<span class="sd">        Note that the sampling distribution of variance parameters is</span>
<span class="sd">        strongly skewed unless the sample size is large, so these</span>
<span class="sd">        standard errors may not give meaningful confidence intervals</span>
<span class="sd">        or p-values if used in the usual way.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_params</span><span class="p">())[</span><span class="n">p</span><span class="p">:])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_expand_re_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_ix</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re_names</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_vc</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
            <span class="n">vg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_vc</span><span class="o">.</span><span class="n">colnames</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">na</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s2">]&quot;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">vg</span><span class="p">]</span>
            <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">na</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">names</span>

    <span class="nd">@cache_readonly</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">random_effects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The conditional means of random effects given the data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        random_effects : dict</span>
<span class="sd">            A dictionary mapping the distinct `group` values to the</span>
<span class="sd">            conditional means of the random effects for the group</span>
<span class="sd">            given the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot predict random effects from &quot;</span> <span class="o">+</span> <span class="s2">&quot;singular covariance structure.&quot;</span>
            <span class="p">)</span>

        <span class="n">vcomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcomp</span>
        <span class="n">k_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span>

        <span class="n">ranef_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>

            <span class="n">endog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">ex_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_aex_r</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">ex2_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_aex_r2</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">vc_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_expand_vcomp</span><span class="p">(</span><span class="n">vcomp</span><span class="p">,</span> <span class="n">group_ix</span><span class="p">)</span>

            <span class="c1"># Get the residuals relative to fixed effects</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="n">endog</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">expval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe_params</span><span class="p">)</span>
                <span class="n">resid</span> <span class="o">=</span> <span class="n">resid</span> <span class="o">-</span> <span class="n">expval</span>

            <span class="n">solver</span> <span class="o">=</span> <span class="n">_smw_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">)</span>
            <span class="n">vir</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>

            <span class="n">xtvir</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">ex_r</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">vir</span><span class="p">)</span>

            <span class="n">xtvir</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k_re</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="p">,</span> <span class="n">xtvir</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k_re</span><span class="p">])</span>
            <span class="n">xtvir</span><span class="p">[</span><span class="n">k_re</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">vc_var</span>
            <span class="n">ranef_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">xtvir</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_expand_re_names</span><span class="p">(</span><span class="n">group_ix</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ranef_dict</span>

    <span class="nd">@cache_readonly</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">random_effects_cov</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the conditional covariance matrix of the random</span>
<span class="sd">        effects for each group given the data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        random_effects_cov : dict</span>
<span class="sd">            A dictionary mapping the distinct values of the `group`</span>
<span class="sd">            variable to the conditional covariance matrix of the</span>
<span class="sd">            random effects given the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">vcomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcomp</span>

        <span class="n">ranef_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">group_ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">n_groups</span><span class="p">):</span>

            <span class="n">ex_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_aex_r</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">ex2_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_aex_r2</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">group_labels</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">vc_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_expand_vcomp</span><span class="p">(</span><span class="n">vcomp</span><span class="p">,</span> <span class="n">group_ix</span><span class="p">)</span>

            <span class="n">solver</span> <span class="o">=</span> <span class="n">_smw_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">)</span>

            <span class="n">n</span> <span class="o">=</span> <span class="n">ex_r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">vc_var</span><span class="p">)))</span>
            <span class="n">mat1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ex_r</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="p">)</span>
            <span class="n">mat1</span><span class="p">[:,</span> <span class="n">m</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ex_r</span><span class="p">[:,</span> <span class="n">m</span><span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">vc_var</span><span class="p">))</span>
            <span class="n">mat2</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">mat1</span><span class="p">)</span>
            <span class="n">mat2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">mat2</span><span class="p">)</span>

            <span class="n">v</span> <span class="o">=</span> <span class="o">-</span><span class="n">mat2</span>
            <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">v</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">+=</span> <span class="n">vc_var</span>
            <span class="n">na</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_re_names</span><span class="p">(</span><span class="n">group_ix</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">na</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">na</span><span class="p">)</span>
            <span class="n">ranef_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">return</span> <span class="n">ranef_dict</span>

    <span class="c1"># Need to override since t-tests are only used for fixed effects</span>
    <span class="c1"># parameters.</span>
<div class="viewcode-block" id="MixedLMResults.t_test">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLMResults.t_test.html#statsmodels.regression.mixed_linear_model.MixedLMResults.t_test">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">t_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_matrix</span><span class="p">,</span> <span class="n">use_t</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute a t-test for a each linear hypothesis of the form Rb = q</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r_matrix : array_like</span>
<span class="sd">            If an array is given, a p x k 2d array or length k 1d</span>
<span class="sd">            array specifying the linear restrictions. It is assumed</span>
<span class="sd">            that the linear combination is equal to zero.</span>
<span class="sd">        scale : float, optional</span>
<span class="sd">            An optional `scale` to use.  Default is the scale specified</span>
<span class="sd">            by the model fit.</span>
<span class="sd">        use_t : bool, optional</span>
<span class="sd">            If use_t is None, then the default of the model is used.</span>
<span class="sd">            If use_t is True, then the p-values are based on the t</span>
<span class="sd">            distribution.</span>
<span class="sd">            If use_t is False, then the p-values are based on the normal</span>
<span class="sd">            distribution.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        res : ContrastResults instance</span>
<span class="sd">            The results for the test are attributes of this results instance.</span>
<span class="sd">            The available results have the same elements as the parameter table</span>
<span class="sd">            in `summary()`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">r_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;r_matrix for t-test should have </span><span class="si">%d</span><span class="s2"> columns&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span>
        <span class="n">z0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">))</span>
        <span class="n">r_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">r_matrix</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tst_rslt</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">t_test</span><span class="p">(</span><span class="n">r_matrix</span><span class="p">,</span> <span class="n">use_t</span><span class="o">=</span><span class="n">use_t</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tst_rslt</span></div>


<div class="viewcode-block" id="MixedLMResults.summary">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLMResults.summary.html#statsmodels.regression.mixed_linear_model.MixedLMResults.summary">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xname_fe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xname_re</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summarize the mixed model regression results.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        yname : str, optional</span>
<span class="sd">            Default is `y`</span>
<span class="sd">        xname_fe : list[str], optional</span>
<span class="sd">            Fixed effects covariate names</span>
<span class="sd">        xname_re : list[str], optional</span>
<span class="sd">            Random effects covariate names</span>
<span class="sd">        title : str, optional</span>
<span class="sd">            Title for the top table. If not None, then this replaces</span>
<span class="sd">            the default title</span>
<span class="sd">        alpha : float</span>
<span class="sd">            significance level for the confidence intervals</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        smry : Summary instance</span>
<span class="sd">            this holds the summary tables and text, which can be</span>
<span class="sd">            printed or converted to various output formats.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        statsmodels.iolib.summary2.Summary : class to hold summary results</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.iolib</span><span class="w"> </span><span class="kn">import</span> <span class="n">summary2</span>

        <span class="n">smry</span> <span class="o">=</span> <span class="n">summary2</span><span class="o">.</span><span class="n">Summary</span><span class="p">()</span>

        <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Model:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MixedLM&quot;</span>
        <span class="k">if</span> <span class="n">yname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog_names</span>

        <span class="n">param_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">param_names</span><span class="p">[:]</span>
        <span class="n">k_fe_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fe_params</span><span class="p">)</span>
        <span class="n">k_re_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fe_params</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">xname_fe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xname_fe</span><span class="p">)</span> <span class="o">!=</span> <span class="n">k_fe_params</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;xname_fe should be a list of length </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">k_fe_params</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">param_names</span><span class="p">[:</span><span class="n">k_fe_params</span><span class="p">]</span> <span class="o">=</span> <span class="n">xname_fe</span>

        <span class="k">if</span> <span class="n">xname_re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xname_re</span><span class="p">)</span> <span class="o">!=</span> <span class="n">k_re_params</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;xname_re should be a list of length </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">k_re_params</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">param_names</span><span class="p">[</span><span class="n">k_fe_params</span><span class="p">:]</span> <span class="o">=</span> <span class="n">xname_re</span>

        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;No. Observations:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">n_totobs</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;No. Groups:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">n_groups</span><span class="p">)</span>

        <span class="n">gs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog_li</span><span class="p">])</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Min. group size:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.0f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">min</span><span class="p">(</span><span class="n">gs</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Max. group size:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.0f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="n">gs</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Mean group size:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gs</span><span class="p">)</span>

        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Dependent Variable:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yname</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Method:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Scale:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Log-Likelihood:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llf</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Converged:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">converged</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span>
        <span class="n">smry</span><span class="o">.</span><span class="n">add_dict</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="n">smry</span><span class="o">.</span><span class="n">add_title</span><span class="p">(</span><span class="s2">&quot;Mixed Linear Model Regression Results&quot;</span><span class="p">)</span>

        <span class="n">float_fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span>

        <span class="n">sdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="c1"># Coefficient estimates</span>
        <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe_params</span>

        <span class="c1"># Standard errors</span>
        <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_params</span><span class="p">()[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">]))</span>

        <span class="c1"># Z-scores</span>
        <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># p-values</span>
        <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>

        <span class="c1"># Confidence intervals</span>
        <span class="n">qm</span> <span class="o">=</span> <span class="o">-</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">qm</span> <span class="o">*</span> <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">qm</span> <span class="o">*</span> <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># All random effects variances and covariances</span>
        <span class="n">jj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">sdf</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">sdf</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                <span class="n">jj</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Variance components</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">):</span>
            <span class="n">sdf</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcomp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sdf</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
            <span class="n">jj</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">sdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">param_names</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sdf</span><span class="p">)</span>
        <span class="n">sdf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Coef.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Std.Err.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;z&quot;</span><span class="p">,</span>
            <span class="s2">&quot;P&gt;|z|&quot;</span><span class="p">,</span>
            <span class="s2">&quot;[&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;]&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">sdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">sdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">float_fmt</span> <span class="o">%</span> <span class="n">x</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sdf</span><span class="p">[</span><span class="n">col</span><span class="p">]]</span>

        <span class="n">smry</span><span class="o">.</span><span class="n">add_df</span><span class="p">(</span><span class="n">sdf</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">smry</span></div>


    <span class="nd">@cache_readonly</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">llf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">loglike</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_object</span><span class="p">,</span> <span class="n">profile_fe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="nd">@cache_readonly</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">aic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Akaike information criterion&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">freepat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freepat</span><span class="o">.</span><span class="n">get_packed</span><span class="p">(</span><span class="n">use_sqrt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">llf</span> <span class="o">-</span> <span class="n">df</span><span class="p">)</span>

    <span class="nd">@cache_readonly</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Bayesian information criterion&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">freepat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freepat</span><span class="o">.</span><span class="n">get_packed</span><span class="p">(</span><span class="n">use_sqrt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">llf</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nobs</span><span class="p">)</span> <span class="o">*</span> <span class="n">df</span>

<div class="viewcode-block" id="MixedLMResults.profile_re">
<a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLMResults.profile_re.html#statsmodels.regression.mixed_linear_model.MixedLMResults.profile_re">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">profile_re</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">re_ix</span><span class="p">,</span>
        <span class="n">vtype</span><span class="p">,</span>
        <span class="n">num_low</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">dist_low</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">num_high</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">dist_high</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">fit_kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Profile-likelihood inference for variance parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        re_ix : int</span>
<span class="sd">            If vtype is `re`, this value is the index of the variance</span>
<span class="sd">            parameter for which to construct a profile likelihood.  If</span>
<span class="sd">            `vtype` is &#39;vc&#39; then `re_ix` is the name of the variance</span>
<span class="sd">            parameter to be profiled.</span>
<span class="sd">        vtype : str</span>
<span class="sd">            Either &#39;re&#39; or &#39;vc&#39;, depending on whether the profile</span>
<span class="sd">            analysis is for a random effect or a variance component.</span>
<span class="sd">        num_low : int</span>
<span class="sd">            The number of points at which to calculate the likelihood</span>
<span class="sd">            below the MLE of the parameter of interest.</span>
<span class="sd">        dist_low : float</span>
<span class="sd">            The distance below the MLE of the parameter of interest to</span>
<span class="sd">            begin calculating points on the profile likelihood.</span>
<span class="sd">        num_high : int</span>
<span class="sd">            The number of points at which to calculate the likelihood</span>
<span class="sd">            above the MLE of the parameter of interest.</span>
<span class="sd">        dist_high : float</span>
<span class="sd">            The distance above the MLE of the parameter of interest to</span>
<span class="sd">            begin calculating points on the profile likelihood.</span>
<span class="sd">        **fit_kwargs</span>
<span class="sd">            Additional keyword arguments passed to fit.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        An array with two columns.  The first column contains the</span>
<span class="sd">        values to which the parameter of interest is constrained.  The</span>
<span class="sd">        second column contains the corresponding likelihood values.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Only variance parameters can be profiled.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pmodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">k_fe</span> <span class="o">=</span> <span class="n">pmodel</span><span class="o">.</span><span class="n">k_fe</span>
        <span class="n">k_re</span> <span class="o">=</span> <span class="n">pmodel</span><span class="o">.</span><span class="n">k_re</span>
        <span class="n">k_vc</span> <span class="o">=</span> <span class="n">pmodel</span><span class="o">.</span><span class="n">k_vc</span>
        <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span> <span class="o">=</span> <span class="n">pmodel</span><span class="o">.</span><span class="n">endog</span><span class="p">,</span> <span class="n">pmodel</span><span class="o">.</span><span class="n">exog</span>

        <span class="c1"># Need to permute the columns of the random effects design</span>
        <span class="c1"># matrix so that the profiled variable is in the first column.</span>
        <span class="k">if</span> <span class="n">vtype</span> <span class="o">==</span> <span class="s2">&quot;re&quot;</span><span class="p">:</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">k_re</span><span class="p">)</span>
            <span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">re_ix</span>
            <span class="n">ix</span><span class="p">[</span><span class="n">re_ix</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">exog_re</span> <span class="o">=</span> <span class="n">pmodel</span><span class="o">.</span><span class="n">exog_re</span><span class="o">.</span><span class="n">copy</span><span class="p">()[:,</span> <span class="n">ix</span><span class="p">]</span>

            <span class="c1"># Permute the covariance structure to match the permuted</span>
            <span class="c1"># design matrix.</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_object</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cov_re_unscaled</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span>
            <span class="n">cov_re_unscaled</span> <span class="o">=</span> <span class="n">cov_re_unscaled</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span><span class="p">)]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">cov_re_unscaled</span>
            <span class="n">ru0</span> <span class="o">=</span> <span class="n">cov_re_unscaled</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Convert dist_low and dist_high to the profile</span>
            <span class="c1"># parameterization</span>
            <span class="n">cov_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">cov_re_unscaled</span>
            <span class="n">low</span> <span class="o">=</span> <span class="p">(</span><span class="n">cov_re</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dist_low</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
            <span class="n">high</span> <span class="o">=</span> <span class="p">(</span><span class="n">cov_re</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dist_high</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="k">elif</span> <span class="n">vtype</span> <span class="o">==</span> <span class="s2">&quot;vc&quot;</span><span class="p">:</span>
            <span class="n">re_ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_vc</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">re_ix</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_object</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">vcomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcomp</span>
            <span class="n">low</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcomp</span><span class="p">[</span><span class="n">re_ix</span><span class="p">]</span> <span class="o">-</span> <span class="n">dist_low</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
            <span class="n">high</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcomp</span><span class="p">[</span><span class="n">re_ix</span><span class="p">]</span> <span class="o">+</span> <span class="n">dist_high</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
            <span class="n">ru0</span> <span class="o">=</span> <span class="n">vcomp</span><span class="p">[</span><span class="n">re_ix</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="c1"># Define the sequence of values to which the parameter of</span>
        <span class="c1"># interest will be constrained.</span>
        <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;dist_low is too large and would result in a &quot;</span>
                <span class="s2">&quot;negative variance. Try a smaller value.&quot;</span>
            <span class="p">)</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">ru0</span><span class="p">,</span> <span class="n">num_low</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ru0</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">num_high</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">rvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">))</span>

        <span class="c1"># Indicators of which parameters are free and fixed.</span>
        <span class="n">free</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="p">(</span><span class="n">k_fe</span><span class="p">,</span> <span class="n">k_re</span><span class="p">,</span> <span class="n">k_vc</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">freepat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">free</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">k_fe</span><span class="p">)</span>
            <span class="n">vcomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">k_vc</span><span class="p">)</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">k_re</span><span class="p">,</span> <span class="n">k_re</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If a freepat already has been specified, we add the</span>
            <span class="c1"># constraint to it.</span>
            <span class="n">free</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freepat</span><span class="o">.</span><span class="n">fe_params</span>
            <span class="n">vcomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freepat</span><span class="o">.</span><span class="n">vcomp</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freepat</span><span class="o">.</span><span class="n">cov_re</span>
            <span class="k">if</span> <span class="n">vtype</span> <span class="o">==</span> <span class="s2">&quot;re&quot;</span><span class="p">:</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">vtype</span> <span class="o">==</span> <span class="s2">&quot;re&quot;</span><span class="p">:</span>
            <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vcomp</span><span class="p">[</span><span class="n">re_ix</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">free</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">mat</span>
        <span class="n">free</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="n">vcomp</span>

        <span class="n">klass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">init_kwargs</span> <span class="o">=</span> <span class="n">pmodel</span><span class="o">.</span><span class="n">_get_init_kwds</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vtype</span> <span class="o">==</span> <span class="s2">&quot;re&quot;</span><span class="p">:</span>
            <span class="n">init_kwargs</span><span class="p">[</span><span class="s2">&quot;exog_re&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exog_re</span>

        <span class="n">likev</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rvalues</span><span class="p">:</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">klass</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="o">**</span><span class="n">init_kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">vtype</span> <span class="o">==</span> <span class="s2">&quot;re&quot;</span><span class="p">:</span>
                <span class="n">cov_re</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">cov_re</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
                <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">cov_re</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">vcomp</span><span class="p">[</span><span class="n">re_ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>

            <span class="c1"># TODO should use fit_kwargs</span>
            <span class="n">rslt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                <span class="n">start_params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
                <span class="n">free</span><span class="o">=</span><span class="n">free</span><span class="p">,</span>
                <span class="n">reml</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">,</span>
                <span class="n">cov_pen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_pen</span><span class="p">,</span>
                <span class="o">**</span><span class="n">fit_kwargs</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">_results</span>
            <span class="n">likev</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span> <span class="o">*</span> <span class="n">rslt</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">rslt</span><span class="o">.</span><span class="n">llf</span><span class="p">])</span>

        <span class="n">likev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">likev</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">likev</span></div>
</div>



<span class="k">class</span><span class="w"> </span><span class="nc">MixedLMResultsWrapper</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">LikelihoodResultsWrapper</span><span class="p">):</span>
    <span class="n">_attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;bse_re&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;generic_columns&quot;</span><span class="p">,</span> <span class="s2">&quot;exog_re_names_full&quot;</span><span class="p">),</span>
        <span class="s2">&quot;fe_params&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;generic_columns&quot;</span><span class="p">,</span> <span class="s2">&quot;xnames&quot;</span><span class="p">),</span>
        <span class="s2">&quot;bse_fe&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;generic_columns&quot;</span><span class="p">,</span> <span class="s2">&quot;xnames&quot;</span><span class="p">),</span>
        <span class="s2">&quot;cov_re&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;generic_columns_2d&quot;</span><span class="p">,</span> <span class="s2">&quot;exog_re_names&quot;</span><span class="p">),</span>
        <span class="s2">&quot;cov_re_unscaled&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;generic_columns_2d&quot;</span><span class="p">,</span> <span class="s2">&quot;exog_re_names&quot;</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">_upstream_attrs</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">LikelihoodResultsWrapper</span><span class="o">.</span><span class="n">_wrap_attrs</span>
    <span class="n">_wrap_attrs</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">wrap</span><span class="o">.</span><span class="n">union_dicts</span><span class="p">(</span><span class="n">_attrs</span><span class="p">,</span> <span class="n">_upstream_attrs</span><span class="p">)</span>

    <span class="n">_methods</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_upstream_methods</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">LikelihoodResultsWrapper</span><span class="o">.</span><span class="n">_wrap_methods</span>
    <span class="n">_wrap_methods</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">wrap</span><span class="o">.</span><span class="n">union_dicts</span><span class="p">(</span><span class="n">_methods</span><span class="p">,</span> <span class="n">_upstream_methods</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_handle_missing</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">re_formula</span><span class="p">,</span> <span class="n">vc_formula</span><span class="p">):</span>

    <span class="n">tokens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="n">forms</span> <span class="o">=</span> <span class="p">[</span><span class="n">formula</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">re_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">forms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re_formula</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vc_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">forms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">vc_formula</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">statsmodels.compat.python</span><span class="w"> </span><span class="kn">import</span> <span class="n">asunicode</span>

    <span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">StringIO</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">tokenize</span>

    <span class="n">skiptoks</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">fml</span> <span class="ow">in</span> <span class="n">forms</span><span class="p">:</span>
        <span class="c1"># Unicode conversion is for Py2 compatability</span>
        <span class="n">rl</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">fml</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">rlu</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">asunicode</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s2">&quot;ascii&quot;</span><span class="p">)</span>

        <span class="n">g</span> <span class="o">=</span> <span class="n">tokenize</span><span class="o">.</span><span class="n">generate_tokens</span><span class="p">(</span><span class="n">rlu</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tok</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skiptoks</span><span class="p">:</span>
                <span class="n">tokens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">tokens</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">tokens</span><span class="p">]</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">ii</span> <span class="o">&amp;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">groups</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ii</span><span class="p">)]</span>
</code></pre></div>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    Sep 24, 2025
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  
  
  <div class="md-footer-meta md-typeset">
    
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-footer-copyright__highlight">
        &#169; Copyright 2009-2025, Josef Perktold, Skipper Seabold, Jonathan Taylor, statsmodels-developers.
        
    </div>
  
    Created using
    <a href="https://www.sphinx-doc.org/" target="_blank" rel="noopener">Sphinx</a>
    7.3.7.
     and
    <a href="https://github.com/jbms/sphinx-immaterial/" target="_blank" rel="noopener">Sphinx-Immaterial</a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/statsmodels/statsmodels/" target="_blank" rel="noopener" title="Source on github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/statsmodels/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://doi.org/10.5281/zenodo.593847" target="_blank" rel="noopener" title="doi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M0 216C0 149.7 53.7 96 120 96h8c17.7 0 32 14.3 32 32s-14.3 32-32 32h-8c-30.9 0-56 25.1-56 56v8h64c35.3 0 64 28.7 64 64v64c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V216m256 0c0-66.3 53.7-120 120-120h8c17.7 0 32 14.3 32 32s-14.3 32-32 32h-8c-30.9 0-56 25.1-56 56v8h64c35.3 0 64 28.7 64 64v64c0 35.3-28.7 64-64 64h-64c-35.3 0-64-28.7-64-64V216"/></svg>
    </a>
  
</div>
      
    </div>
    
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": [], "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike", "staticVersions": null, "versionPath": "../versions-v3.json"}}</script>
    
      
        <script src="../../../_static/sphinx_immaterial_theme.32136f45f91ae6956.min.js?v=a7a9472a"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
  </body>
</html>