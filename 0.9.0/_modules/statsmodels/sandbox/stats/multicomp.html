

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>statsmodels.sandbox.stats.multicomp &#8212; statsmodels 0.9.0 documentation</title>
    <link rel="stylesheet" href="../../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../../_static/statsmodels_hybi_favico.ico"/>
    <link rel="author" title="About these documents" href="../../../../about.html" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
<link rel="stylesheet" href="../../../../_static/examples.css" type="text/css" />
<link rel="stylesheet" href="../../../../_static/facebox.css" type="text/css" />
<script type="text/javascript" src="../../../../_static/scripts.js">
</script>
<script type="text/javascript" src="../../../../_static/facebox.js">
</script>
<script type="text/javascript">
$.facebox.settings.closeImage = "../../../../_static/closelabel.png"
$.facebox.settings.loadingImage = "../../../../_static/loading.gif"
</script>

  </head><body>
<div class="headerwrap">
    <div class = "header">
        
        <a href = "../../../../index.html">
<img src="../../../../_static/statsmodels_hybi_banner.png" alt="Logo"
    style="padding-left: 15px"/></a>
        
    </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
<li><a href ="../../../../install.html">Install</a></li> &nbsp;|&nbsp;
<li><a href="https://groups.google.com/forum/?hl=en#!forum/pystatsmodels">Support</a></li> &nbsp;|&nbsp;
<li><a href="https://github.com/statsmodels/statsmodels/issues">Bugs</a></li> &nbsp;|&nbsp;
<li><a href="../../../../dev/index.html">Develop</a></li> &nbsp;|&nbsp;
<li><a href="../../../../examples/index.html">Examples</a></li> &nbsp;|&nbsp;
<li><a href="../../../../faq.html">FAQ</a></li> &nbsp;|&nbsp;

          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> |</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            




  <h1>Source code for statsmodels.sandbox.stats.multicomp</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>

<span class="sd">from pystatsmodels mailinglist 20100524</span>

<span class="sd">Notes:</span>
<span class="sd"> - unfinished, unverified, but most parts seem to work in MonteCarlo</span>
<span class="sd"> - one example taken from lecture notes looks ok</span>
<span class="sd"> - needs cases with non-monotonic inequality for test to see difference between</span>
<span class="sd">   one-step, step-up and step-down procedures</span>
<span class="sd"> - FDR doesn&#39;t look really better then Bonferoni in the MC examples that I tried</span>
<span class="sd">update:</span>
<span class="sd"> - now tested against R, stats and multtest,</span>
<span class="sd">   I have all of their methods for p-value correction</span>
<span class="sd"> - getting Hommel was impossible until I found reference for pvalue correction</span>
<span class="sd"> - now, since I have p-values correction, some of the original tests (rej/norej)</span>
<span class="sd">   implementation is not really needed anymore. I think I keep it for reference.</span>
<span class="sd">   Test procedure for Hommel in development session log</span>
<span class="sd"> - I haven&#39;t updated other functions and classes in here.</span>
<span class="sd">   - multtest has some good helper function according to docs</span>
<span class="sd"> - still need to update references, the real papers</span>
<span class="sd"> - fdr with estimated true hypothesis still missing</span>
<span class="sd"> - multiple comparison procedures incomplete or missing</span>
<span class="sd"> - I will get multiple comparison for now only for independent case, which might</span>
<span class="sd">   be conservative in correlated case (?).</span>


<span class="sd">some References:</span>

<span class="sd">Gibbons, Jean Dickinson and Chakraborti Subhabrata, 2003, Nonparametric Statistical</span>
<span class="sd">Inference, Fourth Edition, Marcel Dekker</span>
<span class="sd">    p.363: 10.4 THE KRUSKAL-WALLIS ONE-WAY ANOVA TEST AND MULTIPLE COMPARISONS</span>
<span class="sd">    p.367: multiple comparison for kruskal formula used in multicomp.kruskal</span>

<span class="sd">Sheskin, David J., 2004, Handbook of Parametric and Nonparametric Statistical</span>
<span class="sd">Procedures, 3rd ed., Chapman&amp;Hall/CRC</span>
<span class="sd">    Test 21: The Single-Factor Between-Subjects Analysis of Variance</span>
<span class="sd">    Test 22: The Kruskal-Wallis One-Way Analysis of Variance by Ranks Test</span>

<span class="sd">Zwillinger, Daniel and Stephen Kokoska, 2000, CRC standard probability and</span>
<span class="sd">statistics tables and formulae, Chapman&amp;Hall/CRC</span>
<span class="sd">    14.9 WILCOXON RANKSUM (MANN WHITNEY) TEST</span>


<span class="sd">S. Paul Wright, Adjusted P-Values for Simultaneous Inference, Biometrics</span>
<span class="sd">    Vol. 48, No. 4 (Dec., 1992), pp. 1005-1013, International Biometric Society</span>
<span class="sd">    Stable URL: http://www.jstor.org/stable/2532694</span>
<span class="sd"> (p-value correction for Hommel in appendix)</span>

<span class="sd">for multicomparison</span>

<span class="sd">new book &quot;multiple comparison in R&quot;</span>
<span class="sd">Hsu is a good reference but I don&#39;t have it.</span>


<span class="sd">Author: Josef Pktd and example from H Raja and rewrite from Vincent Davis</span>


<span class="sd">TODO</span>
<span class="sd">----</span>

<span class="sd">* handle exception if empty, shows up only sometimes when running this</span>
<span class="sd">- DONE I think</span>

<span class="sd">Traceback (most recent call last):</span>
<span class="sd">  File &quot;C:\Josef\eclipsegworkspace\statsmodels-josef-experimental-gsoc\scikits\statsmodels\sandbox\stats\multicomp.py&quot;, line 711, in &lt;module&gt;</span>
<span class="sd">    print(&#39;sh&#39;, multipletests(tpval, alpha=0.05, method=&#39;sh&#39;)</span>
<span class="sd">  File &quot;C:\Josef\eclipsegworkspace\statsmodels-josef-experimental-gsoc\scikits\statsmodels\sandbox\stats\multicomp.py&quot;, line 241, in multipletests</span>
<span class="sd">    rejectmax = np.max(np.nonzero(reject))</span>
<span class="sd">  File &quot;C:\Programs\Python25\lib\site-packages\numpy\core\fromnumeric.py&quot;, line 1765, in amax</span>
<span class="sd">    return _wrapit(a, &#39;max&#39;, axis, out)</span>
<span class="sd">  File &quot;C:\Programs\Python25\lib\site-packages\numpy\core\fromnumeric.py&quot;, line 37, in _wrapit</span>
<span class="sd">    result = getattr(asarray(obj),method)(*args, **kwds)</span>
<span class="sd">ValueError: zero-size array to ufunc.reduce without identity</span>

<span class="sd">* name of function multipletests, rename to something like pvalue_correction?</span>


<span class="sd">&#39;&#39;&#39;</span>


<span class="c1">#import xlrd</span>
<span class="c1">#import xlwt</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">statsmodels.compat.python</span> <span class="k">import</span> <span class="n">lzip</span><span class="p">,</span> <span class="nb">range</span><span class="p">,</span> <span class="n">lrange</span><span class="p">,</span> <span class="nb">zip</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">statsmodels.iolib.table</span> <span class="k">import</span> <span class="n">SimpleTable</span>
<span class="kn">from</span> <span class="nn">numpy.testing</span> <span class="k">import</span> <span class="n">assert_almost_equal</span><span class="p">,</span> <span class="n">assert_equal</span>
<span class="c1">#temporary circular import</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.multitest</span> <span class="k">import</span> <span class="n">multipletests</span><span class="p">,</span> <span class="n">_ecdf</span> <span class="k">as</span> <span class="n">ecdf</span><span class="p">,</span> <span class="n">fdrcorrection</span> <span class="k">as</span> <span class="n">fdrcorrection0</span><span class="p">,</span> <span class="n">fdrcorrection_twostage</span>
<span class="kn">from</span> <span class="nn">statsmodels.graphics</span> <span class="k">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">statsmodels.tools.sm_exceptions</span> <span class="k">import</span> <span class="n">ValueWarning</span>

<span class="n">qcrit</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">  2     3     4     5     6     7     8     9     10</span>
<span class="s1">5   3.64 5.70   4.60 6.98   5.22 7.80   5.67 8.42   6.03 8.91   6.33 9.32   6.58 9.67   6.80 9.97   6.99 10.24</span>
<span class="s1">6   3.46 5.24   4.34 6.33   4.90 7.03   5.30 7.56   5.63 7.97   5.90 8.32   6.12 8.61   6.32 8.87   6.49 9.10</span>
<span class="s1">7   3.34 4.95   4.16 5.92   4.68 6.54   5.06 7.01   5.36 7.37   5.61 7.68   5.82 7.94   6.00 8.17   6.16 8.37</span>
<span class="s1">8   3.26 4.75   4.04 5.64   4.53 6.20   4.89 6.62   5.17 6.96   5.40 7.24       5.60 7.47   5.77 7.68   5.92 7.86</span>
<span class="s1">9   3.20 4.60   3.95 5.43   4.41 5.96   4.76 6.35   5.02 6.66   5.24 6.91       5.43 7.13   5.59 7.33   5.74 7.49</span>
<span class="s1">10  3.15 4.48   3.88 5.27   4.33 5.77   4.65 6.14   4.91 6.43   5.12 6.67       5.30 6.87   5.46 7.05   5.60 7.21</span>
<span class="s1">11  3.11 4.39   3.82 5.15   4.26 5.62   4.57 5.97   4.82 6.25   5.03 6.48 5.20 6.67   5.35 6.84   5.49 6.99</span>
<span class="s1">12  3.08 4.32   3.77 5.05   4.20 5.50   4.51 5.84   4.75 6.10   4.95 6.32 5.12 6.51   5.27 6.67   5.39 6.81</span>
<span class="s1">13  3.06 4.26   3.73 4.96   4.15 5.40   4.45 5.73   4.69 5.98   4.88 6.19 5.05 6.37   5.19 6.53   5.32 6.67</span>
<span class="s1">14  3.03 4.21   3.70 4.89   4.11 5.32   4.41 5.63   4.64 5.88   4.83 6.08 4.99 6.26   5.13 6.41   5.25 6.54</span>
<span class="s1">15  3.01 4.17   3.67 4.84   4.08 5.25   4.37 5.56   4.59 5.80   4.78 5.99 4.94 6.16   5.08 6.31   5.20 6.44</span>
<span class="s1">16  3.00 4.13   3.65 4.79   4.05 5.19   4.33 5.49   4.56 5.72   4.74 5.92 4.90 6.08   5.03 6.22   5.15 6.35</span>
<span class="s1">17  2.98 4.10   3.63 4.74   4.02 5.14   4.30 5.43   4.52 5.66   4.70 5.85 4.86 6.01   4.99 6.15   5.11 6.27</span>
<span class="s1">18  2.97 4.07   3.61 4.70   4.00 5.09   4.28 5.38   4.49 5.60   4.67 5.79 4.82 5.94   4.96 6.08   5.07 6.20</span>
<span class="s1">19  2.96 4.05   3.59 4.67   3.98 5.05   4.25 5.33   4.47 5.55   4.65 5.73 4.79 5.89   4.92 6.02   5.04 6.14</span>
<span class="s1">20  2.95 4.02   3.58 4.64   3.96 5.02   4.23 5.29   4.45 5.51   4.62 5.69 4.77 5.84   4.90 5.97   5.01 6.09</span>
<span class="s1">24  2.92 3.96   3.53 4.55   3.90 4.91   4.17 5.17   4.37 5.37   4.54 5.54 4.68 5.69   4.81 5.81   4.92 5.92</span>
<span class="s1">30  2.89 3.89   3.49 4.45   3.85 4.80   4.10 5.05   4.30 5.24   4.46 5.40 4.60 5.54   4.72 5.65   4.82 5.76</span>
<span class="s1">40  2.86 3.82   3.44 4.37   3.79 4.70   4.04 4.93   4.23 5.11   4.39 5.26 4.52 5.39   4.63 5.50   4.73 5.60</span>
<span class="s1">60  2.83 3.76   3.40 4.28   3.74 4.59   3.98 4.82   4.16 4.99   4.31 5.13 4.44 5.25   4.55 5.36   4.65 5.45</span>
<span class="s1">120   2.80 3.70   3.36 4.20   3.68 4.50   3.92 4.71   4.10 4.87   4.24 5.01 4.36 5.12   4.47 5.21   4.56 5.30</span>
<span class="s1">infinity  2.77 3.64   3.31 4.12   3.63 4.40   3.86 4.60   4.03 4.76   4.17 4.88   4.29 4.99   4.39 5.08   4.47 5.16</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="n">res</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">qcrit</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;infinity&#39;</span><span class="p">,</span><span class="s1">&#39;9999&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)]</span>
<span class="n">c</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
<span class="c1">#c[c==9999] = np.inf</span>
<span class="n">ccols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>
<span class="n">crows</span> <span class="o">=</span> <span class="n">c</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">cv005</span> <span class="o">=</span> <span class="n">c</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
<span class="n">cv001</span> <span class="o">=</span> <span class="n">c</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interpolate</span>
<div class="viewcode-block" id="get_tukeyQcrit"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.get_tukeyQcrit.html#statsmodels.sandbox.stats.multicomp.get_tukeyQcrit">[docs]</a><span class="k">def</span> <span class="nf">get_tukeyQcrit</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    return critical values for Tukey&#39;s HSD (Q)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    k : int in {2, ..., 10}</span>
<span class="sd">        number of tests</span>
<span class="sd">    df : int</span>
<span class="sd">        degrees of freedom of error term</span>
<span class="sd">    alpha : {0.05, 0.01}</span>
<span class="sd">        type 1 error, 1-confidence level</span>



<span class="sd">    not enough error checking for limitations</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">alpha</span> <span class="o">==</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="n">intp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">crows</span><span class="p">,</span> <span class="n">cv005</span><span class="p">[:,</span><span class="n">k</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">alpha</span> <span class="o">==</span> <span class="mf">0.01</span><span class="p">:</span>
        <span class="n">intp</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">crows</span><span class="p">,</span> <span class="n">cv001</span><span class="p">[:,</span><span class="n">k</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;only implemented for alpha equal to 0.01 and 0.05&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">intp</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">get_tukeyQcrit2</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    return critical values for Tukey&#39;s HSD (Q)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    k : int in {2, ..., 10}</span>
<span class="sd">        number of tests</span>
<span class="sd">    df : int</span>
<span class="sd">        degrees of freedom of error term</span>
<span class="sd">    alpha : {0.05, 0.01}</span>
<span class="sd">        type 1 error, 1-confidence level</span>



<span class="sd">    not enough error checking for limitations</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">statsmodels.stats.libqsturng</span> <span class="k">import</span> <span class="n">qsturng</span>
    <span class="k">return</span> <span class="n">qsturng</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">Tukeythreegene</span><span class="p">(</span><span class="n">first</span><span class="p">,</span><span class="n">second</span><span class="p">,</span><span class="n">third</span><span class="p">):</span>
    <span class="c1">#Performing the Tukey HSD post-hoc test for three genes</span>
<span class="c1">##   qwb = xlrd.open_workbook(&#39;F:/Lab/bioinformatics/qcrittable.xls&#39;)</span>
<span class="c1">##    #opening the workbook containing the q crit table</span>
<span class="c1">##   qwb.sheet_names()</span>
<span class="c1">##   qcrittable = qwb.sheet_by_name(u&#39;Sheet1&#39;)</span>

   <span class="n">firstmean</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="c1">#means of the three arrays</span>
   <span class="n">secondmean</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
   <span class="n">thirdmean</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">third</span><span class="p">)</span>

   <span class="n">firststd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="c1">#standard deviations of the threearrays</span>
   <span class="n">secondstd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
   <span class="n">thirdstd</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">third</span><span class="p">)</span>

   <span class="n">firsts2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">firststd</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#standard deviation squared of the three arrays</span>
   <span class="n">seconds2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">secondstd</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
   <span class="n">thirds2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">thirdstd</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

   <span class="n">mserrornum</span> <span class="o">=</span> <span class="n">firsts2</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="n">seconds2</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="n">thirds2</span><span class="o">*</span><span class="mi">2</span> <span class="c1">#numerator for mean square error</span>
   <span class="n">mserrorden</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">second</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">third</span><span class="p">))</span><span class="o">-</span><span class="mi">3</span> <span class="c1">#denominator for mean square error</span>
   <span class="n">mserror</span> <span class="o">=</span> <span class="n">mserrornum</span><span class="o">/</span><span class="n">mserrorden</span> <span class="c1">#mean square error</span>

   <span class="n">standarderror</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mserror</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">))</span>
   <span class="c1">#standard error, which is square root of mserror and the number of samples in a group</span>

   <span class="n">dftotal</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">first</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">second</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">third</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="c1">#various degrees of freedom</span>
   <span class="n">dfgroups</span> <span class="o">=</span> <span class="mi">2</span>
   <span class="n">dferror</span> <span class="o">=</span> <span class="n">dftotal</span><span class="o">-</span><span class="n">dfgroups</span>

   <span class="n">qcrit</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># fix arbitrary#qcrittable.cell(dftotal, 3).value</span>
   <span class="n">qcrit</span> <span class="o">=</span> <span class="n">get_tukeyQcrit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dftotal</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
   <span class="c1">#getting the q critical value, for degrees of freedom total and 3 groups</span>

   <span class="n">qtest3to1</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">thirdmean</span><span class="o">-</span><span class="n">firstmean</span><span class="p">))</span><span class="o">/</span><span class="n">standarderror</span>
    <span class="c1">#calculating q test statistic values</span>
   <span class="n">qtest3to2</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">thirdmean</span><span class="o">-</span><span class="n">secondmean</span><span class="p">))</span><span class="o">/</span><span class="n">standarderror</span>
   <span class="n">qtest2to1</span> <span class="o">=</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">secondmean</span><span class="o">-</span><span class="n">firstmean</span><span class="p">))</span><span class="o">/</span><span class="n">standarderror</span>

   <span class="n">conclusion</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">##    print(qcrit</span>
   <span class="nb">print</span><span class="p">(</span><span class="n">qtest3to1</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span><span class="n">qtest3to2</span><span class="p">)</span>
   <span class="nb">print</span><span class="p">(</span><span class="n">qtest2to1</span><span class="p">)</span>

   <span class="k">if</span><span class="p">(</span><span class="n">qtest3to1</span><span class="o">&gt;</span><span class="n">qcrit</span><span class="p">):</span> <span class="c1">#testing all q test statistic values to q critical values</span>
       <span class="n">conclusion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;3to1null&#39;</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
       <span class="n">conclusion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;3to1alt&#39;</span><span class="p">)</span>
   <span class="k">if</span><span class="p">(</span><span class="n">qtest3to2</span><span class="o">&gt;</span><span class="n">qcrit</span><span class="p">):</span>
       <span class="n">conclusion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;3to2null&#39;</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
       <span class="n">conclusion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;3to2alt&#39;</span><span class="p">)</span>
   <span class="k">if</span><span class="p">(</span><span class="n">qtest2to1</span><span class="o">&gt;</span><span class="n">qcrit</span><span class="p">):</span>
       <span class="n">conclusion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;2to1null&#39;</span><span class="p">)</span>
   <span class="k">else</span><span class="p">:</span>
       <span class="n">conclusion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;2to1alt&#39;</span><span class="p">)</span>

   <span class="k">return</span> <span class="n">conclusion</span>


<span class="c1">#rewrite by Vincent</span>
<span class="k">def</span> <span class="nf">Tukeythreegene2</span><span class="p">(</span><span class="n">genes</span><span class="p">):</span> <span class="c1">#Performing the Tukey HSD post-hoc test for three genes</span>
   <span class="sd">&quot;&quot;&quot;gend is a list, ie [first, second, third]&quot;&quot;&quot;</span>
<span class="c1">#   qwb = xlrd.open_workbook(&#39;F:/Lab/bioinformatics/qcrittable.xls&#39;)</span>
    <span class="c1">#opening the workbook containing the q crit table</span>
<span class="c1">#   qwb.sheet_names()</span>
<span class="c1">#   qcrittable = qwb.sheet_by_name(u&#39;Sheet1&#39;)</span>

   <span class="n">means</span> <span class="o">=</span> <span class="p">[]</span>
   <span class="n">stds</span> <span class="o">=</span> <span class="p">[]</span>
   <span class="k">for</span> <span class="n">gene</span> <span class="ow">in</span> <span class="n">genes</span><span class="p">:</span>
      <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gene</span><span class="p">))</span>
      <span class="n">std</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">gene</span><span class="p">))</span>

   <span class="c1">#firstmean = numpy.mean(first) #means of the three arrays</span>
   <span class="c1">#secondmean = numpy.mean(second)</span>
   <span class="c1">#thirdmean = numpy.mean(third)</span>

   <span class="c1">#firststd = numpy.std(first) #standard deviations of the three arrays</span>
   <span class="c1">#secondstd = numpy.std(second)</span>
   <span class="c1">#thirdstd = numpy.std(third)</span>

   <span class="n">stds2</span> <span class="o">=</span> <span class="p">[]</span>
   <span class="k">for</span> <span class="n">std</span> <span class="ow">in</span> <span class="n">stds</span><span class="p">:</span>
      <span class="n">stds2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">std</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>


   <span class="c1">#firsts2 = math.pow(firststd,2) #standard deviation squared of the three arrays</span>
   <span class="c1">#seconds2 = math.pow(secondstd,2)</span>
   <span class="c1">#thirds2 = math.pow(thirdstd,2)</span>

   <span class="c1">#mserrornum = firsts2*2+seconds2*2+thirds2*2 #numerator for mean square error</span>
   <span class="n">mserrornum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">stds2</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span>
   <span class="n">mserrorden</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span><span class="o">-</span><span class="mi">3</span> <span class="c1">#denominator for mean square error</span>
   <span class="n">mserror</span> <span class="o">=</span> <span class="n">mserrornum</span><span class="o">/</span><span class="n">mserrorden</span> <span class="c1">#mean square error</span>


<div class="viewcode-block" id="catstack"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.catstack.html#statsmodels.sandbox.stats.multicomp.catstack">[docs]</a><span class="k">def</span> <span class="nf">catstack</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">k</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">arr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">args</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">labels</span></div>




<div class="viewcode-block" id="maxzero"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.maxzero.html#statsmodels.sandbox.stats.multicomp.maxzero">[docs]</a><span class="k">def</span> <span class="nf">maxzero</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;find all up zero crossings and return the index of the highest</span>

<span class="sd">    Not used anymore</span>


<span class="sd">    &gt;&gt;&gt; np.random.seed(12345)</span>
<span class="sd">    &gt;&gt;&gt; x = np.random.randn(8)</span>
<span class="sd">    &gt;&gt;&gt; x</span>
<span class="sd">    array([-0.20470766,  0.47894334, -0.51943872, -0.5557303 ,  1.96578057,</span>
<span class="sd">            1.39340583,  0.09290788,  0.28174615])</span>
<span class="sd">    &gt;&gt;&gt; maxzero(x)</span>
<span class="sd">    (4, array([1, 4]))</span>


<span class="sd">    no up-zero-crossing at end</span>

<span class="sd">    &gt;&gt;&gt; np.random.seed(0)</span>
<span class="sd">    &gt;&gt;&gt; x = np.random.randn(8)</span>
<span class="sd">    &gt;&gt;&gt; x</span>
<span class="sd">    array([ 1.76405235,  0.40015721,  0.97873798,  2.2408932 ,  1.86755799,</span>
<span class="sd">           -0.97727788,  0.95008842, -0.15135721])</span>
<span class="sd">    &gt;&gt;&gt; maxzero(x)</span>
<span class="sd">    (None, array([6]))</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">cond1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="n">cond2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="c1">#allzeros = np.nonzero(np.sign(x[:-1])*np.sign(x[1:]) &lt;= 0)[0] + 1</span>
    <span class="n">allzeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">((</span><span class="n">cond1</span> <span class="o">&amp;</span> <span class="n">cond2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">==</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">maxz</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">allzeros</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maxz</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">maxz</span><span class="p">,</span> <span class="n">allzeros</span></div>

<div class="viewcode-block" id="maxzerodown"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.maxzerodown.html#statsmodels.sandbox.stats.multicomp.maxzerodown">[docs]</a><span class="k">def</span> <span class="nf">maxzerodown</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;find all up zero crossings and return the index of the highest</span>

<span class="sd">    Not used anymore</span>

<span class="sd">    &gt;&gt;&gt; np.random.seed(12345)</span>
<span class="sd">    &gt;&gt;&gt; x = np.random.randn(8)</span>
<span class="sd">    &gt;&gt;&gt; x</span>
<span class="sd">    array([-0.20470766,  0.47894334, -0.51943872, -0.5557303 ,  1.96578057,</span>
<span class="sd">            1.39340583,  0.09290788,  0.28174615])</span>
<span class="sd">    &gt;&gt;&gt; maxzero(x)</span>
<span class="sd">    (4, array([1, 4]))</span>


<span class="sd">    no up-zero-crossing at end</span>

<span class="sd">    &gt;&gt;&gt; np.random.seed(0)</span>
<span class="sd">    &gt;&gt;&gt; x = np.random.randn(8)</span>
<span class="sd">    &gt;&gt;&gt; x</span>
<span class="sd">    array([ 1.76405235,  0.40015721,  0.97873798,  2.2408932 ,  1.86755799,</span>
<span class="sd">           -0.97727788,  0.95008842, -0.15135721])</span>
<span class="sd">    &gt;&gt;&gt; maxzero(x)</span>
<span class="sd">    (None, array([6]))</span>
<span class="sd">&#39;&#39;&#39;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">cond1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">cond2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="c1">#allzeros = np.nonzero(np.sign(x[:-1])*np.sign(x[1:]) &lt;= 0)[0] + 1</span>
    <span class="n">allzeros</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">((</span><span class="n">cond1</span> <span class="o">&amp;</span> <span class="n">cond2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">==</span><span class="mi">0</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">maxz</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">allzeros</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">maxz</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">maxz</span><span class="p">,</span> <span class="n">allzeros</span></div>



<div class="viewcode-block" id="rejectionline"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.rejectionline.html#statsmodels.sandbox.stats.multicomp.rejectionline">[docs]</a><span class="k">def</span> <span class="nf">rejectionline</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;reference line for rejection in multiple tests</span>

<span class="sd">    Not used anymore</span>

<span class="sd">    from: section 3.2, page 60</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">frej</span> <span class="o">=</span> <span class="n">t</span><span class="o">/</span><span class="p">(</span> <span class="n">t</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">frej</span></div>






<span class="c1">#I don&#39;t remember what I changed or why 2 versions,</span>
<span class="c1">#this follows german diss ???  with rline</span>
<span class="c1">#this might be useful if the null hypothesis is not &quot;all effects are zero&quot;</span>
<span class="c1">#rename to _bak and working again on fdrcorrection0</span>
<span class="k">def</span> <span class="nf">fdrcorrection_bak</span><span class="p">(</span><span class="n">pvals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;indep&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Reject False discovery rate correction for pvalues</span>

<span class="sd">    Old version, to be deleted</span>


<span class="sd">    missing: methods that estimate fraction of true hypotheses</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span>


    <span class="n">pvals_sortind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span>
    <span class="n">pvals_sorted</span> <span class="o">=</span> <span class="n">pvals</span><span class="p">[</span><span class="n">pvals_sortind</span><span class="p">]</span>
    <span class="n">pecdf</span> <span class="o">=</span> <span class="n">ecdf</span><span class="p">(</span><span class="n">pvals_sorted</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="s1">&#39;indep&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;poscorr&#39;</span><span class="p">]:</span>
        <span class="n">rline</span> <span class="o">=</span> <span class="n">pvals_sorted</span> <span class="o">/</span> <span class="n">alpha</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;negcorr&#39;</span><span class="p">]:</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pvals</span><span class="p">)))</span>
        <span class="n">rline</span> <span class="o">=</span> <span class="n">pvals_sorted</span> <span class="o">/</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">cm</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;onegcorr&#39;</span><span class="p">]:</span>  <span class="c1">#what&#39;s this ? german diss</span>
        <span class="n">rline</span> <span class="o">=</span> <span class="n">pvals_sorted</span> <span class="o">/</span> <span class="p">(</span><span class="n">pvals_sorted</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;oth&#39;</span><span class="p">,</span> <span class="s1">&#39;o2negcorr&#39;</span><span class="p">]:</span> <span class="c1"># other invalid, cut-paste</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pvals</span><span class="p">)))</span>
        <span class="n">rline</span> <span class="o">=</span> <span class="n">pvals_sorted</span> <span class="o">/</span> <span class="n">alpha</span> <span class="o">/</span><span class="n">cm</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;method not available&#39;</span><span class="p">)</span>

    <span class="n">reject</span> <span class="o">=</span> <span class="n">pecdf</span> <span class="o">&gt;=</span> <span class="n">rline</span>
    <span class="k">if</span> <span class="n">reject</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">rejectmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">reject</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rejectmax</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">reject</span><span class="p">[:</span><span class="n">rejectmax</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">reject</span><span class="p">[</span><span class="n">pvals_sortind</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]</span>

<div class="viewcode-block" id="mcfdr"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.mcfdr.html#statsmodels.sandbox.stats.multicomp.mcfdr">[docs]</a><span class="k">def</span> <span class="nf">mcfdr</span><span class="p">(</span><span class="n">nrepl</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">nobs</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">ntests</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">ntrue</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;MonteCarlo to test fdrcorrection</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nfalse</span> <span class="o">=</span> <span class="n">ntests</span> <span class="o">-</span> <span class="n">ntrue</span>
    <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="n">ntrue</span> <span class="o">+</span> <span class="p">[</span><span class="n">mu</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">ntests</span> <span class="o">-</span> <span class="n">ntrue</span><span class="p">))</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrepl</span><span class="p">):</span>
        <span class="c1">#rvs = locs + stats.norm.rvs(size=(nobs, ntests))</span>
        <span class="n">rvs</span> <span class="o">=</span> <span class="n">locs</span> <span class="o">+</span> <span class="n">randmvn</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">nobs</span><span class="p">,</span> <span class="n">ntests</span><span class="p">))</span>
        <span class="n">tt</span><span class="p">,</span> <span class="n">tpval</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_1samp</span><span class="p">(</span><span class="n">rvs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">fdrcorrection_bak</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tpval</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">res0</span> <span class="o">=</span> <span class="n">fdrcorrection0</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tpval</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
        <span class="c1">#res and res0 give the same results</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[:</span><span class="n">ntrue</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">ntrue</span><span class="p">:])]</span> <span class="o">+</span>
                       <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res0</span><span class="p">[:</span><span class="n">ntrue</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">res0</span><span class="p">[</span><span class="n">ntrue</span><span class="p">:])]</span> <span class="o">+</span>
                       <span class="n">res</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tpval</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="o">+</span>
                       <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tpval</span><span class="p">[:</span><span class="n">ntrue</span><span class="p">]</span><span class="o">&lt;</span><span class="n">alpha</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tpval</span><span class="p">[</span><span class="n">ntrue</span><span class="p">:]</span><span class="o">&lt;</span><span class="n">alpha</span><span class="p">)]</span> <span class="o">+</span>
                       <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tpval</span><span class="p">[:</span><span class="n">ntrue</span><span class="p">]</span><span class="o">&lt;</span><span class="n">alpha</span><span class="o">/</span><span class="n">ntests</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tpval</span><span class="p">[</span><span class="n">ntrue</span><span class="p">:]</span><span class="o">&lt;</span><span class="n">alpha</span><span class="o">/</span><span class="n">ntests</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="randmvn"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.randmvn.html#statsmodels.sandbox.stats.multicomp.randmvn">[docs]</a><span class="k">def</span> <span class="nf">randmvn</span><span class="p">(</span><span class="n">rho</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;create random draws from equi-correlated multivariate normal distribution</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    rho : float</span>
<span class="sd">        correlation coefficient</span>
<span class="sd">    size : tuple of int</span>
<span class="sd">        size is interpreted (nobs, nvars) where each row</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rvs : ndarray</span>
<span class="sd">        nobs by nvars where each row is a independent random draw of nvars-</span>
<span class="sd">        dimensional correlated rvs</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nobs</span><span class="p">,</span> <span class="n">nvars</span> <span class="o">=</span> <span class="n">size</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">rho</span> <span class="ow">and</span> <span class="n">rho</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">rvs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">nobs</span><span class="p">,</span> <span class="n">nvars</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rvs2</span> <span class="o">=</span> <span class="n">rvs</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">))</span> <span class="o">+</span> <span class="n">rvs</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">rho</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">rvs2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">nobs</span><span class="p">,</span> <span class="n">nvars</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">rho</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">rho</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">nvars</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;rho has to be larger than -1./(nvars-1)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rho</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">nvars</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">rho</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">nvars</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="mf">1e-10</span><span class="p">)</span>  <span class="c1">#barely positive definite</span>
        <span class="c1">#use Cholesky</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">rho</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nvars</span><span class="p">,</span><span class="n">nvars</span><span class="p">))</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rho</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">nvars</span><span class="p">)</span>
        <span class="n">rvs2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">nobs</span><span class="p">,</span> <span class="n">nvars</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">standardize</span><span class="p">:</span>
        <span class="n">rvs2</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">zscore</span><span class="p">(</span><span class="n">rvs2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rvs2</span></div>

<span class="c1">#============================</span>
<span class="c1">#</span>
<span class="c1"># Part 2: Multiple comparisons and independent samples tests</span>
<span class="c1">#</span>
<span class="c1">#============================</span>

<div class="viewcode-block" id="tiecorrect"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.tiecorrect.html#statsmodels.sandbox.stats.multicomp.tiecorrect">[docs]</a><span class="k">def</span> <span class="nf">tiecorrect</span><span class="p">(</span><span class="n">xranks</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">    should be equivalent of scipy.stats.tiecorrect</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#casting to int rounds down, but not relevant for this case</span>
    <span class="n">rankbincount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">xranks</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
    <span class="n">nties</span> <span class="o">=</span> <span class="n">rankbincount</span><span class="p">[</span><span class="n">rankbincount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">ntot</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xranks</span><span class="p">));</span>
    <span class="n">tiecorrection</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">nties</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">nties</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">ntot</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">ntot</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tiecorrection</span></div>


<div class="viewcode-block" id="GroupsStats"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.GroupsStats.html#statsmodels.sandbox.stats.multicomp.GroupsStats">[docs]</a><span class="k">class</span> <span class="nc">GroupsStats</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    statistics by groups (another version)</span>

<span class="sd">    groupstats as a class with lazy evaluation (not yet - decorators are still</span>
<span class="sd">    missing)</span>

<span class="sd">    written this time as equivalent of scipy.stats.rankdata</span>
<span class="sd">    gs = GroupsStats(X, useranks=True)</span>
<span class="sd">    assert_almost_equal(gs.groupmeanfilter, stats.rankdata(X[:,0]), 15)</span>

<span class="sd">    TODO: incomplete doc strings</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">useranks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">uni</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">intlab</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;descriptive statistics by groups</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : array, 2d</span>
<span class="sd">            first column data, second column group labels</span>
<span class="sd">        useranks : boolean</span>
<span class="sd">            if true, then use ranks as data corresponding to the</span>
<span class="sd">            scipy.stats.rankdata definition (start at 1, ties get mean)</span>
<span class="sd">        uni, intlab : arrays (optional)</span>
<span class="sd">            to avoid call to unique, these can be given as inputs</span>


<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">intlab</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">uni</span><span class="p">,</span> <span class="n">intlab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">uni</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">uni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">useranks</span> <span class="o">=</span> <span class="n">useranks</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">uni</span> <span class="o">=</span> <span class="n">uni</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intlab</span> <span class="o">=</span> <span class="n">intlab</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groupnobs</span> <span class="o">=</span> <span class="n">groupnobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">intlab</span><span class="p">)</span>

        <span class="c1">#temporary until separated and made all lazy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runbasic</span><span class="p">(</span><span class="n">useranks</span><span class="o">=</span><span class="n">useranks</span><span class="p">)</span>



<div class="viewcode-block" id="GroupsStats.runbasic_old"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.GroupsStats.runbasic_old.html#statsmodels.sandbox.stats.multicomp.GroupsStats.runbasic_old">[docs]</a>    <span class="k">def</span> <span class="nf">runbasic_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">useranks</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1">#check: refactoring screwed up case useranks=True</span>

        <span class="c1">#groupxsum = np.bincount(intlab, weights=X[:,0])</span>
        <span class="c1">#groupxmean = groupxsum * 1.0 / groupnobs</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="k">if</span> <span class="n">useranks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1">#rankraw</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groupsum</span> <span class="o">=</span> <span class="n">groupranksum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intlab</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">)</span>
        <span class="c1">#print(&#39;groupranksum&#39;, groupranksum, groupranksum.shape, self.groupnobs.shape</span>
        <span class="c1"># start at 1 for stats.rankdata :</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groupmean</span> <span class="o">=</span> <span class="n">grouprankmean</span> <span class="o">=</span> <span class="n">groupranksum</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupnobs</span> <span class="c1"># + 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groupmeanfilter</span> <span class="o">=</span> <span class="n">grouprankmean</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">intlab</span><span class="p">]</span></div>
        <span class="c1">#return grouprankmean[intlab]</span>

<div class="viewcode-block" id="GroupsStats.runbasic"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.GroupsStats.runbasic.html#statsmodels.sandbox.stats.multicomp.GroupsStats.runbasic">[docs]</a>    <span class="k">def</span> <span class="nf">runbasic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">useranks</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1">#check: refactoring screwed up case useranks=True</span>

        <span class="c1">#groupxsum = np.bincount(intlab, weights=X[:,0])</span>
        <span class="c1">#groupxmean = groupxsum * 1.0 / groupnobs</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
        <span class="k">if</span> <span class="n">useranks</span><span class="p">:</span>
            <span class="n">xuni</span><span class="p">,</span> <span class="n">xintlab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ranksraw</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1">#rankraw</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xx</span> <span class="o">=</span> <span class="n">GroupsStats</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">ranksraw</span><span class="p">,</span> <span class="n">xintlab</span><span class="p">]),</span>
                                  <span class="n">useranks</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">groupmeanfilter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groupsum</span> <span class="o">=</span> <span class="n">groupranksum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intlab</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">xx</span><span class="p">)</span>
        <span class="c1">#print(&#39;groupranksum&#39;, groupranksum, groupranksum.shape, self.groupnobs.shape</span>
        <span class="c1"># start at 1 for stats.rankdata :</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groupmean</span> <span class="o">=</span> <span class="n">grouprankmean</span> <span class="o">=</span> <span class="n">groupranksum</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupnobs</span> <span class="c1"># + 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groupmeanfilter</span> <span class="o">=</span> <span class="n">grouprankmean</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">intlab</span><span class="p">]</span></div>
        <span class="c1">#return grouprankmean[intlab]</span>

<div class="viewcode-block" id="GroupsStats.groupdemean"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.GroupsStats.groupdemean.html#statsmodels.sandbox.stats.multicomp.GroupsStats.groupdemean">[docs]</a>    <span class="k">def</span> <span class="nf">groupdemean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xx</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupmeanfilter</span></div>

<div class="viewcode-block" id="GroupsStats.groupsswithin"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.GroupsStats.groupsswithin.html#statsmodels.sandbox.stats.multicomp.GroupsStats.groupsswithin">[docs]</a>    <span class="k">def</span> <span class="nf">groupsswithin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">xtmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupdemean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intlab</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">xtmp</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroupsStats.groupvarwithin"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.GroupsStats.groupvarwithin.html#statsmodels.sandbox.stats.multicomp.GroupsStats.groupvarwithin">[docs]</a>    <span class="k">def</span> <span class="nf">groupvarwithin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupsswithin</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groupnobs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#.sum()</span></div></div>

<div class="viewcode-block" id="TukeyHSDResults"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.TukeyHSDResults.html#statsmodels.sandbox.stats.multicomp.TukeyHSDResults">[docs]</a><span class="k">class</span> <span class="nc">TukeyHSDResults</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Results from Tukey HSD test, with additional plot methods</span>

<span class="sd">    Can also compute and plot additional post-hoc evaluations using this</span>
<span class="sd">    results class.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    reject : array of boolean, True if we reject Null for group pair</span>
<span class="sd">    meandiffs : pairwise mean differences</span>
<span class="sd">    confint : confidence interval for pairwise mean differences</span>
<span class="sd">    std_pairs : standard deviation of pairwise mean differences</span>
<span class="sd">    q_crit : critical value of studentized range statistic at given alpha</span>
<span class="sd">    halfwidths : half widths of simultaneous confidence interval</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    halfwidths is only available after call to `plot_simultaneous`.</span>

<span class="sd">    Other attributes contain information about the data from the</span>
<span class="sd">    MultiComparison instance: data, df_total, groups, groupsunique, variance.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mc_object</span><span class="p">,</span> <span class="n">results_table</span><span class="p">,</span> <span class="n">q_crit</span><span class="p">,</span> <span class="n">reject</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">meandiffs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">std_pairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">confint</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">df_total</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">reject2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">variance</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_multicomp</span> <span class="o">=</span> <span class="n">mc_object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_results_table</span> <span class="o">=</span> <span class="n">results_table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_crit</span> <span class="o">=</span> <span class="n">q_crit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reject</span> <span class="o">=</span> <span class="n">reject</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meandiffs</span> <span class="o">=</span> <span class="n">meandiffs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">std_pairs</span> <span class="o">=</span> <span class="n">std_pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confint</span> <span class="o">=</span> <span class="n">confint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_total</span> <span class="o">=</span> <span class="n">df_total</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reject2</span> <span class="o">=</span> <span class="n">reject2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variance</span> <span class="o">=</span> <span class="n">variance</span>
        <span class="c1"># Taken out of _multicomp for ease of access for unknowledgeable users</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multicomp</span><span class="o">.</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_multicomp</span><span class="o">.</span><span class="n">groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multicomp</span><span class="o">.</span><span class="n">groupsunique</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_results_table</span><span class="p">)</span>

<div class="viewcode-block" id="TukeyHSDResults.summary"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.TukeyHSDResults.summary.html#statsmodels.sandbox.stats.multicomp.TukeyHSDResults.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Summary table that can be printed</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_results_table</span></div>


    <span class="k">def</span> <span class="nf">_simultaneous_ci</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute simultaneous confidence intervals for comparison of means.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">halfwidths</span> <span class="o">=</span> <span class="n">simultaneous_ci</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q_crit</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_multicomp</span><span class="o">.</span><span class="n">groupstats</span><span class="o">.</span><span class="n">groupnobs</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_multicomp</span><span class="o">.</span><span class="n">pairindices</span><span class="p">)</span>

<div class="viewcode-block" id="TukeyHSDResults.plot_simultaneous"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.TukeyHSDResults.plot_simultaneous.html#statsmodels.sandbox.stats.multicomp.TukeyHSDResults.plot_simultaneous">[docs]</a>    <span class="k">def</span> <span class="nf">plot_simultaneous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comparison_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                          <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot a universal confidence interval of each group mean</span>

<span class="sd">        Visiualize significant differences in a plot with one confidence</span>
<span class="sd">        interval per group instead of all pairwise confidence intervals.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        comparison_name : string, optional</span>
<span class="sd">            if provided, plot_intervals will color code all groups that are</span>
<span class="sd">            significantly different from the comparison_name red, and will</span>
<span class="sd">            color code insignificant groups gray. Otherwise, all intervals will</span>
<span class="sd">            just be plotted in black.</span>
<span class="sd">        ax : matplotlib axis, optional</span>
<span class="sd">            An axis handle on which to attach the plot.</span>
<span class="sd">        figsize : tuple, optional</span>
<span class="sd">            tuple for the size of the figure generated</span>
<span class="sd">        xlabel : string, optional</span>
<span class="sd">            Name to be displayed on x axis</span>
<span class="sd">        ylabel : string, optional</span>
<span class="sd">            Name to be displayed on y axis</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig : Matplotlib Figure object</span>
<span class="sd">            handle to figure object containing interval plots</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Multiple comparison tests are nice, but lack a good way to be</span>
<span class="sd">        visualized. If you have, say, 6 groups, showing a graph of the means</span>
<span class="sd">        between each group will require 15 confidence intervals.</span>
<span class="sd">        Instead, we can visualize inter-group differences with a single</span>
<span class="sd">        interval for each group mean. Hochberg et al. [1] first proposed this</span>
<span class="sd">        idea and used Tukey&#39;s Q critical value to compute the interval widths.</span>
<span class="sd">        Unlike plotting the differences in the means and their respective</span>
<span class="sd">        confidence intervals, any two pairs can be compared for significance</span>
<span class="sd">        by looking for overlap.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        .. [*] Hochberg, Y., and A. C. Tamhane. Multiple Comparison Procedures.</span>
<span class="sd">               Hoboken, NJ: John Wiley &amp; Sons, 1987.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from statsmodels.examples.try_tukey_hsd import cylinders, cyl_labels</span>
<span class="sd">        &gt;&gt;&gt; from statsmodels.stats.multicomp import MultiComparison</span>
<span class="sd">        &gt;&gt;&gt; cardata = MultiComparison(cylinders, cyl_labels)</span>
<span class="sd">        &gt;&gt;&gt; results = cardata.tukeyhsd()</span>
<span class="sd">        &gt;&gt;&gt; results.plot_simultaneous()</span>
<span class="sd">        &lt;matplotlib.figure.Figure at 0x...&gt;</span>

<span class="sd">        This example shows an example plot comparing significant differences</span>
<span class="sd">        in group means. Significant differences at the alpha=0.05 level can be</span>
<span class="sd">        identified by intervals that do not overlap (i.e. USA vs Japan,</span>
<span class="sd">        USA vs Germany).</span>

<span class="sd">        &gt;&gt;&gt; results.plot_simultaneous(comparison_name=&quot;USA&quot;)</span>
<span class="sd">        &lt;matplotlib.figure.Figure at 0x...&gt;</span>

<span class="sd">        Optionally provide one of the group names to color code the plot to</span>
<span class="sd">        highlight group means different from comparison_name.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">create_mpl_ax</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">figsize</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="n">figsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;halfwidths&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_simultaneous_ci</span><span class="p">()</span>
        <span class="n">means</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multicomp</span><span class="o">.</span><span class="n">groupstats</span><span class="o">.</span><span class="n">groupmean</span>


        <span class="n">sigidx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nsigidx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">minrange</span> <span class="o">=</span> <span class="p">[</span><span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">halfwidths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">means</span><span class="p">))]</span>
        <span class="n">maxrange</span> <span class="o">=</span> <span class="p">[</span><span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">halfwidths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">means</span><span class="p">))]</span>

        <span class="k">if</span> <span class="n">comparison_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">means</span><span class="p">,</span> <span class="n">lrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">means</span><span class="p">)),</span> <span class="n">xerr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">halfwidths</span><span class="p">,</span>
                         <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">comparison_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;comparison_name not found in group names.&#39;</span><span class="p">)</span>
            <span class="n">midx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span><span class="o">==</span><span class="n">comparison_name</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">means</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">comparison_name</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">maxrange</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">maxrange</span><span class="p">[</span><span class="n">midx</span><span class="p">])</span> <span class="o">-</span>
                                         <span class="nb">max</span><span class="p">(</span><span class="n">minrange</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">minrange</span><span class="p">[</span><span class="n">midx</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">sigidx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nsigidx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="c1">#Plot the master comparison</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">means</span><span class="p">[</span><span class="n">midx</span><span class="p">],</span> <span class="n">midx</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">halfwidths</span><span class="p">[</span><span class="n">midx</span><span class="p">],</span>
                         <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">minrange</span><span class="p">[</span><span class="n">midx</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multicomp</span><span class="o">.</span><span class="n">ngroups</span><span class="p">],</span>
                     <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.7&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">maxrange</span><span class="p">[</span><span class="n">midx</span><span class="p">]]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multicomp</span><span class="o">.</span><span class="n">ngroups</span><span class="p">],</span>
                     <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.7&#39;</span><span class="p">)</span>
            <span class="c1">#Plot those that are significantly different</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sigidx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">means</span><span class="p">[</span><span class="n">sigidx</span><span class="p">],</span> <span class="n">sigidx</span><span class="p">,</span>
                             <span class="n">xerr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">halfwidths</span><span class="p">[</span><span class="n">sigidx</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                             <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="c1">#Plot those that are not significantly different</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nsigidx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">means</span><span class="p">[</span><span class="n">nsigidx</span><span class="p">],</span> <span class="n">nsigidx</span><span class="p">,</span>
                             <span class="n">xerr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">halfwidths</span><span class="p">[</span><span class="n">nsigidx</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                             <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;0.5&#39;</span><span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Multiple Comparisons Between All Pairs (Tukey)&#39;</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">maxrange</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">minrange</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multicomp</span><span class="o">.</span><span class="n">ngroups</span><span class="p">])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">minrange</span><span class="p">)</span> <span class="o">-</span> <span class="n">r</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">maxrange</span><span class="p">)</span> <span class="o">+</span> <span class="n">r</span> <span class="o">/</span> <span class="mf">10.</span><span class="p">])</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">means</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlabel</span> <span class="k">if</span> <span class="n">xlabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span> <span class="k">if</span> <span class="n">ylabel</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div></div>


<div class="viewcode-block" id="MultiComparison"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.MultiComparison.html#statsmodels.sandbox.stats.multicomp.MultiComparison">[docs]</a><span class="k">class</span> <span class="nc">MultiComparison</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Tests for multiple comparisons</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : array</span>
<span class="sd">        independent data samples</span>
<span class="sd">    groups : array</span>
<span class="sd">        group labels corresponding to each data point</span>
<span class="sd">    group_order : list of strings, optional</span>
<span class="sd">        the desired order for the group mean results to be reported in. If</span>
<span class="sd">        not specified, results are reported in increasing order.</span>
<span class="sd">        If group_order does not contain all labels that are in groups, then</span>
<span class="sd">        only those observations are kept that have a label in group_order.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">group_order</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;data has </span><span class="si">%d</span><span class="s1"> elements and groups has </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>

        <span class="c1"># Allow for user-provided sorting of groups</span>
        <span class="k">if</span> <span class="n">group_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupintlab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span>
                                                            <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#check if group_order has any names not in groups</span>
            <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">group_order</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">grp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s2">&quot;group_order value &#39;</span><span class="si">%s</span><span class="s2">&#39; not found in groups&quot;</span><span class="o">%</span><span class="n">grp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">group_order</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupintlab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groupintlab</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="o">-</span><span class="mi">999</span><span class="p">)</span>  <span class="c1"># instead of a nan</span>
            <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">==</span> <span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">groupintlab</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span> <span class="o">==</span> <span class="n">name</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c1">#raise ValueError(&#39;group_order does not contain all groups&#39;)</span>
                <span class="c1"># warn and keep only observations with label in group_order</span>
                <span class="kn">import</span> <span class="nn">warnings</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;group_order does not contain all groups:&#39;</span> <span class="o">+</span>
                              <span class="s1">&#39; dropping observations&#39;</span><span class="p">,</span> <span class="n">ValueWarning</span><span class="p">)</span>

                <span class="n">mask_keep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupintlab</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">999</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">groupintlab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupintlab</span><span class="p">[</span><span class="n">mask_keep</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">mask_keep</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">mask_keep</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;2 or more groups required for multiple comparisons&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">datali</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pairindices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1">#tuple</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ngroups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span><span class="p">)</span>


<div class="viewcode-block" id="MultiComparison.getranks"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.MultiComparison.getranks.html#statsmodels.sandbox.stats.multicomp.MultiComparison.getranks">[docs]</a>    <span class="k">def</span> <span class="nf">getranks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;convert data to rankdata and attach</span>


<span class="sd">        This creates rankdata as it is used for non-parametric tests, where</span>
<span class="sd">        in the case of ties the average rank is assigned.</span>


<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#bug: the next should use self.groupintlab instead of self.groups</span>
        <span class="c1">#update: looks fixed</span>
        <span class="c1">#self.ranks = GroupsStats(np.column_stack([self.data, self.groups]),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranks</span> <span class="o">=</span> <span class="n">GroupsStats</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupintlab</span><span class="p">]),</span>
                                 <span class="n">useranks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rankdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranks</span><span class="o">.</span><span class="n">groupmeanfilter</span></div>

<div class="viewcode-block" id="MultiComparison.kruskal"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.MultiComparison.kruskal.html#statsmodels.sandbox.stats.multicomp.MultiComparison.kruskal">[docs]</a>    <span class="k">def</span> <span class="nf">kruskal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pairs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multimethod</span><span class="o">=</span><span class="s1">&#39;T&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        pairwise comparison for kruskal-wallis test</span>

<span class="sd">        This is just a reimplementation of scipy.stats.kruskal and does</span>
<span class="sd">        not yet use a multiple comparison correction.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">getranks</span><span class="p">()</span>
        <span class="n">tot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span>
        <span class="n">meanranks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranks</span><span class="o">.</span><span class="n">groupmean</span>
        <span class="n">groupnobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranks</span><span class="o">.</span><span class="n">groupnobs</span>


        <span class="c1"># simultaneous/separate treatment of multiple tests</span>
        <span class="n">f</span><span class="o">=</span><span class="p">(</span><span class="n">tot</span> <span class="o">*</span> <span class="p">(</span><span class="n">tot</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.</span><span class="p">)</span> <span class="o">/</span> <span class="n">stats</span><span class="o">.</span><span class="n">tiecorrect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rankdata</span><span class="p">)</span> <span class="c1">#(xranks)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MultiComparison.kruskal&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pairindices</span><span class="p">):</span>
            <span class="c1">#pdiff = np.abs(mrs[i] - mrs[j])</span>
            <span class="n">pdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">meanranks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">meanranks</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">groupnobs</span><span class="p">[[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span> <span class="p">))</span> <span class="c1">#np.array([8,8]))) #Fixme groupnobs[[i,j]] ))</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">pdiff</span> <span class="o">/</span> <span class="n">se</span>

            <span class="c1"># TODO : print(statments, fix</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="n">pdiff</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">pdiff</span> <span class="o">/</span> <span class="n">se</span><span class="p">,</span> <span class="n">pdiff</span> <span class="o">/</span> <span class="n">se</span> <span class="o">&gt;</span> <span class="mf">2.6310</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span></div>


<div class="viewcode-block" id="MultiComparison.allpairtest"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.MultiComparison.allpairtest.html#statsmodels.sandbox.stats.multicomp.MultiComparison.allpairtest">[docs]</a>    <span class="k">def</span> <span class="nf">allpairtest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">testfunc</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bonf&#39;</span><span class="p">,</span> <span class="n">pvalidx</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;run a pairwise test on all pairs with multiple test correction</span>

<span class="sd">        The statistical test given in testfunc is calculated for all pairs</span>
<span class="sd">        and the p-values are adjusted by methods in multipletests. The p-value</span>
<span class="sd">        correction is generic and based only on the p-values, and does not</span>
<span class="sd">        take any special structure of the hypotheses into account.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        testfunc : function</span>
<span class="sd">            A test function for two (independent) samples. It is assumed that</span>
<span class="sd">            the return value on position pvalidx is the p-value.</span>
<span class="sd">        alpha : float</span>
<span class="sd">            familywise error rate</span>
<span class="sd">        method : string</span>
<span class="sd">            This specifies the method for the p-value correction. Any method</span>
<span class="sd">            of multipletests is possible.</span>
<span class="sd">        pvalidx : int (default: 1)</span>
<span class="sd">            position of the p-value in the return of testfunc</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sumtab : SimpleTable instance</span>
<span class="sd">            summary table for printing</span>

<span class="sd">        errors:  TODO: check if this is still wrong, I think it&#39;s fixed.</span>
<span class="sd">        results from multipletests are in different order</span>
<span class="sd">        pval_corrected can be larger than 1 ???</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pairindices</span><span class="p">):</span>
            <span class="n">res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">testfunc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datali</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">datali</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">reject</span><span class="p">,</span> <span class="n">pvals_corrected</span><span class="p">,</span> <span class="n">alphacSidak</span><span class="p">,</span> <span class="n">alphacBonf</span> <span class="o">=</span> \
                <span class="n">multipletests</span><span class="p">(</span><span class="n">res</span><span class="p">[:,</span> <span class="n">pvalidx</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
        <span class="c1">#print(np.column_stack([res[:,0],res[:,1], reject, pvals_corrected])</span>

        <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pairindices</span>
        <span class="k">if</span> <span class="n">pvals_corrected</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lzip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span><span class="p">[</span><span class="n">i1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span><span class="p">[</span><span class="n">i2</span><span class="p">],</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">res</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="mi">4</span><span class="p">),</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">res</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="mi">4</span><span class="p">),</span>
                                  <span class="n">reject</span><span class="p">),</span>
                       <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;group1&#39;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;group2&#39;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;stat&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;pval&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;reject&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool8</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lzip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span><span class="p">[</span><span class="n">i1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span><span class="p">[</span><span class="n">i2</span><span class="p">],</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">res</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="mi">4</span><span class="p">),</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">res</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="mi">4</span><span class="p">),</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pvals_corrected</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
                                  <span class="n">reject</span><span class="p">),</span>
                       <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;group1&#39;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;group2&#39;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;stat&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;pval&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;pval_corr&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;reject&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool8</span><span class="p">)])</span>
        <span class="kn">from</span> <span class="nn">statsmodels.iolib.table</span> <span class="k">import</span> <span class="n">SimpleTable</span>
        <span class="n">results_table</span> <span class="o">=</span> <span class="n">SimpleTable</span><span class="p">(</span><span class="n">resarr</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">resarr</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="n">results_table</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="p">(</span>
                          <span class="s1">&#39;Test Multiple Comparison </span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="si">%s%4.2f</span><span class="s1"> method=</span><span class="si">%s</span><span class="s1">&#39;</span>
                              <span class="o">%</span> <span class="p">(</span><span class="n">testfunc</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;FWER=&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span> <span class="o">+</span>
                          <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">alphacSidak=</span><span class="si">%4.2f</span><span class="s1">, alphacBonf=</span><span class="si">%5.3f</span><span class="s1">&#39;</span>
                              <span class="o">%</span> <span class="p">(</span><span class="n">alphacSidak</span><span class="p">,</span> <span class="n">alphacBonf</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">results_table</span><span class="p">,</span> <span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">reject</span><span class="p">,</span> <span class="n">pvals_corrected</span><span class="p">,</span>
                               <span class="n">alphacSidak</span><span class="p">,</span> <span class="n">alphacBonf</span><span class="p">),</span> <span class="n">resarr</span></div>


<div class="viewcode-block" id="MultiComparison.tukeyhsd"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.MultiComparison.tukeyhsd.html#statsmodels.sandbox.stats.multicomp.MultiComparison.tukeyhsd">[docs]</a>    <span class="k">def</span> <span class="nf">tukeyhsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tukey&#39;s range test to compare means of all pairs of groups</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alpha : float, optional</span>
<span class="sd">            Value of FWER at which to calculate HSD.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        results : TukeyHSDResults instance</span>
<span class="sd">            A results class containing relevant data and some post-hoc</span>
<span class="sd">            calculations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groupstats</span> <span class="o">=</span> <span class="n">GroupsStats</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupintlab</span><span class="p">]),</span>
                            <span class="n">useranks</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">gmeans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupstats</span><span class="o">.</span><span class="n">groupmean</span>
        <span class="n">gnobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupstats</span><span class="o">.</span><span class="n">groupnobs</span>        <span class="c1">#var_ = self.groupstats.groupvarwithin() #possibly an error in varcorrection in this case</span>
        <span class="n">var_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groupstats</span><span class="o">.</span><span class="n">groupdemean</span><span class="p">(),</span> <span class="n">ddof</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">gmeans</span><span class="p">))</span>
        <span class="c1">#res contains: 0:(idx1, idx2), 1:reject, 2:meandiffs, 3: std_pairs, 4:confint, 5:q_crit,</span>
        <span class="c1">#6:df_total, 7:reject2</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">tukeyhsd</span><span class="p">(</span><span class="n">gmeans</span><span class="p">,</span> <span class="n">gnobs</span><span class="p">,</span> <span class="n">var_</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">q_crit</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">resarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lzip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">groupsunique</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]],</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">4</span><span class="p">),</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">4</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span><span class="mi">4</span><span class="p">),</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">4</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span><span class="mi">4</span><span class="p">),</span>
                                  <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                       <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;group1&#39;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;group2&#39;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;meandiff&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;upper&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;reject&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool8</span><span class="p">)])</span>
        <span class="n">results_table</span> <span class="o">=</span> <span class="n">SimpleTable</span><span class="p">(</span><span class="n">resarr</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">resarr</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="n">results_table</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Multiple Comparison of Means - Tukey HSD,&#39;</span> <span class="o">+</span> \
                              <span class="s1">&#39;FWER=</span><span class="si">%4.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">alpha</span>

        <span class="k">return</span> <span class="n">TukeyHSDResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results_table</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                               <span class="n">res</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">var_</span><span class="p">)</span></div></div>



<div class="viewcode-block" id="rankdata"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.rankdata.html#statsmodels.sandbox.stats.multicomp.rankdata">[docs]</a><span class="k">def</span> <span class="nf">rankdata</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;rankdata, equivalent to scipy.stats.rankdata</span>

<span class="sd">    just a different implementation, I have not yet compared speed</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">uni</span><span class="p">,</span> <span class="n">intlab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">groupnobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">intlab</span><span class="p">)</span>
    <span class="n">groupxsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">intlab</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">groupxmean</span> <span class="o">=</span> <span class="n">groupxsum</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">groupnobs</span>

    <span class="n">rankraw</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">groupranksum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">intlab</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">rankraw</span><span class="p">)</span>
    <span class="c1"># start at 1 for stats.rankdata :</span>
    <span class="n">grouprankmean</span> <span class="o">=</span> <span class="n">groupranksum</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">groupnobs</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">grouprankmean</span><span class="p">[</span><span class="n">intlab</span><span class="p">]</span></div>


<span class="c1">#new</span>

<div class="viewcode-block" id="compare_ordered"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.compare_ordered.html#statsmodels.sandbox.stats.multicomp.compare_ordered">[docs]</a><span class="k">def</span> <span class="nf">compare_ordered</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;simple ordered sequential comparison of means</span>

<span class="sd">    vals : array_like</span>
<span class="sd">        means or rankmeans for independent groups</span>

<span class="sd">    incomplete, no return, not used yet</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
    <span class="n">alphaf</span> <span class="o">=</span> <span class="n">alpha</span>  <span class="c1"># Notation ?</span>
    <span class="n">sortind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
    <span class="n">pvals</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">sortind</span><span class="p">]</span>
    <span class="n">sortrevind</span> <span class="o">=</span> <span class="n">sortind</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="n">ntests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
    <span class="c1">#alphacSidak = 1 - np.power((1. - alphaf), 1./ntests)</span>
    <span class="c1">#alphacBonf = alphaf / float(ntests)</span>
    <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">ntests</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1">#v1,v2 have wrong sequence</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span></div>



<div class="viewcode-block" id="varcorrection_unbalanced"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.varcorrection_unbalanced.html#statsmodels.sandbox.stats.multicomp.varcorrection_unbalanced">[docs]</a><span class="k">def</span> <span class="nf">varcorrection_unbalanced</span><span class="p">(</span><span class="n">nobs_all</span><span class="p">,</span> <span class="n">srange</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;correction factor for variance with unequal sample sizes</span>

<span class="sd">    this is just a harmonic mean</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nobs_all : array_like</span>
<span class="sd">        The number of observations for each sample</span>
<span class="sd">    srange : bool</span>
<span class="sd">        if true, then the correction is divided by the number of samples</span>
<span class="sd">        for the variance of the studentized range statistic</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    correction : float</span>
<span class="sd">        Correction factor for variance.</span>


<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    variance correction factor is</span>

<span class="sd">    1/k * sum_i 1/n_i</span>

<span class="sd">    where k is the number of samples and summation is over i=0,...,k-1.</span>
<span class="sd">    If all n_i are the same, then the correction factor is 1.</span>

<span class="sd">    This needs to be multiplied by the joint variance estimate, means square</span>
<span class="sd">    error, MSE. To obtain the correction factor for the standard deviation,</span>
<span class="sd">    square root needs to be taken.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nobs_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">nobs_all</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">srange</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">nobs_all</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">nobs_all</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">nobs_all</span><span class="p">)</span></div>

<div class="viewcode-block" id="varcorrection_pairs_unbalanced"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.varcorrection_pairs_unbalanced.html#statsmodels.sandbox.stats.multicomp.varcorrection_pairs_unbalanced">[docs]</a><span class="k">def</span> <span class="nf">varcorrection_pairs_unbalanced</span><span class="p">(</span><span class="n">nobs_all</span><span class="p">,</span> <span class="n">srange</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;correction factor for variance with unequal sample sizes for all pairs</span>

<span class="sd">    this is just a harmonic mean</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nobs_all : array_like</span>
<span class="sd">        The number of observations for each sample</span>
<span class="sd">    srange : bool</span>
<span class="sd">        if true, then the correction is divided by 2 for the variance of</span>
<span class="sd">        the studentized range statistic</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    correction : array</span>
<span class="sd">        Correction factor for variance.</span>


<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    variance correction factor is</span>

<span class="sd">    1/k * sum_i 1/n_i</span>

<span class="sd">    where k is the number of samples and summation is over i=0,...,k-1.</span>
<span class="sd">    If all n_i are the same, then the correction factor is 1.</span>

<span class="sd">    This needs to be multiplies by the joint variance estimate, means square</span>
<span class="sd">    error, MSE. To obtain the correction factor for the standard deviation,</span>
<span class="sd">    square root needs to be taken.</span>

<span class="sd">    For the studentized range statistic, the resulting factor has to be</span>
<span class="sd">    divided by 2.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#TODO: test and replace with broadcasting</span>
    <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">nobs_all</span><span class="p">,</span> <span class="n">nobs_all</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">srange</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">n1</span> <span class="o">+</span> <span class="mf">1.</span><span class="o">/</span><span class="n">n2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">n1</span> <span class="o">+</span> <span class="mf">1.</span><span class="o">/</span><span class="n">n2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span></div>

<div class="viewcode-block" id="varcorrection_unequal"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.varcorrection_unequal.html#statsmodels.sandbox.stats.multicomp.varcorrection_unequal">[docs]</a><span class="k">def</span> <span class="nf">varcorrection_unequal</span><span class="p">(</span><span class="n">var_all</span><span class="p">,</span> <span class="n">nobs_all</span><span class="p">,</span> <span class="n">df_all</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;return joint variance from samples with unequal variances and unequal</span>
<span class="sd">    sample sizes</span>

<span class="sd">    something is wrong</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    var_all : array_like</span>
<span class="sd">        The variance for each sample</span>
<span class="sd">    nobs_all : array_like</span>
<span class="sd">        The number of observations for each sample</span>
<span class="sd">    df_all : array_like</span>
<span class="sd">        degrees of freedom for each sample</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    varjoint : float</span>
<span class="sd">        joint variance.</span>
<span class="sd">    dfjoint : float</span>
<span class="sd">        joint Satterthwait&#39;s degrees of freedom</span>


<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    (copy, paste not correct)</span>
<span class="sd">    variance is</span>

<span class="sd">    1/k * sum_i 1/n_i</span>

<span class="sd">    where k is the number of samples and summation is over i=0,...,k-1.</span>
<span class="sd">    If all n_i are the same, then the correction factor is 1/n.</span>

<span class="sd">    This needs to be multiplies by the joint variance estimate, means square</span>
<span class="sd">    error, MSE. To obtain the correction factor for the standard deviation,</span>
<span class="sd">    square root needs to be taken.</span>

<span class="sd">    This is for variance of mean difference not of studentized range.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">var_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">var_all</span><span class="p">)</span>
    <span class="n">var_over_n</span> <span class="o">=</span> <span class="n">var_all</span> <span class="o">*</span><span class="mf">1.</span><span class="o">/</span> <span class="n">nobs_all</span>  <span class="c1">#avoid integer division</span>
    <span class="n">varjoint</span> <span class="o">=</span> <span class="n">var_over_n</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">dfjoint</span> <span class="o">=</span> <span class="n">varjoint</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">var_over_n</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">df_all</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">varjoint</span><span class="p">,</span> <span class="n">dfjoint</span></div>

<div class="viewcode-block" id="varcorrection_pairs_unequal"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.varcorrection_pairs_unequal.html#statsmodels.sandbox.stats.multicomp.varcorrection_pairs_unequal">[docs]</a><span class="k">def</span> <span class="nf">varcorrection_pairs_unequal</span><span class="p">(</span><span class="n">var_all</span><span class="p">,</span> <span class="n">nobs_all</span><span class="p">,</span> <span class="n">df_all</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;return joint variance from samples with unequal variances and unequal</span>
<span class="sd">    sample sizes for all pairs</span>

<span class="sd">    something is wrong</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    var_all : array_like</span>
<span class="sd">        The variance for each sample</span>
<span class="sd">    nobs_all : array_like</span>
<span class="sd">        The number of observations for each sample</span>
<span class="sd">    df_all : array_like</span>
<span class="sd">        degrees of freedom for each sample</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    varjoint : array</span>
<span class="sd">        joint variance.</span>
<span class="sd">    dfjoint : array</span>
<span class="sd">        joint Satterthwait&#39;s degrees of freedom</span>


<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    (copy, paste not correct)</span>
<span class="sd">    variance is</span>

<span class="sd">    1/k * sum_i 1/n_i</span>

<span class="sd">    where k is the number of samples and summation is over i=0,...,k-1.</span>
<span class="sd">    If all n_i are the same, then the correction factor is 1.</span>

<span class="sd">    This needs to be multiplies by the joint variance estimate, means square</span>
<span class="sd">    error, MSE. To obtain the correction factor for the standard deviation,</span>
<span class="sd">    square root needs to be taken.</span>

<span class="sd">    TODO: something looks wrong with dfjoint, is formula from SPSS</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#TODO: test and replace with broadcasting</span>
    <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">var_all</span><span class="p">,</span> <span class="n">var_all</span><span class="p">)</span>
    <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">nobs_all</span><span class="p">,</span> <span class="n">nobs_all</span><span class="p">)</span>
    <span class="n">df1</span><span class="p">,</span> <span class="n">df2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">df_all</span><span class="p">,</span> <span class="n">df_all</span><span class="p">)</span>

    <span class="n">varjoint</span> <span class="o">=</span> <span class="n">v1</span><span class="o">/</span><span class="n">n1</span> <span class="o">+</span> <span class="n">v2</span><span class="o">/</span><span class="n">n2</span>

    <span class="n">dfjoint</span> <span class="o">=</span> <span class="n">varjoint</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="n">df1</span> <span class="o">*</span> <span class="p">(</span><span class="n">v1</span><span class="o">/</span><span class="n">n1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">df2</span> <span class="o">*</span> <span class="p">(</span><span class="n">v2</span><span class="o">/</span><span class="n">n2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">varjoint</span><span class="p">,</span> <span class="n">dfjoint</span></div>

<span class="k">def</span> <span class="nf">tukeyhsd</span><span class="p">(</span><span class="n">mean_all</span><span class="p">,</span> <span class="n">nobs_all</span><span class="p">,</span> <span class="n">var_all</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">q_crit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;simultaneous Tukey HSD</span>


<span class="sd">    check: instead of sorting, I use absolute value of pairwise differences</span>
<span class="sd">    in means. That&#39;s irrelevant for the test, but maybe reporting actual</span>
<span class="sd">    differences would be better.</span>
<span class="sd">    CHANGED: meandiffs are with sign, studentized range uses abs</span>

<span class="sd">    q_crit added for testing</span>

<span class="sd">    TODO: error in variance calculation when nobs_all is scalar, missing 1/n</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">mean_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mean_all</span><span class="p">)</span>
    <span class="c1">#check if or when other ones need to be arrays</span>

    <span class="n">n_means</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean_all</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">nobs_all</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>   <span class="c1"># assumes balanced samples with df = n - 1, n_i = n</span>
        <span class="n">df_total</span> <span class="o">=</span> <span class="n">n_means</span> <span class="o">*</span> <span class="n">df</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_means</span><span class="p">)</span> <span class="o">*</span> <span class="n">df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">nobs_all</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">var_all</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1">#balanced sample sizes and homogenous variance</span>
        <span class="n">var_pairs</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">var_all</span> <span class="o">/</span> <span class="n">nobs_all</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_means</span><span class="p">,</span> <span class="n">n_means</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">var_all</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1">#unequal sample sizes and homogenous variance</span>
        <span class="n">var_pairs</span> <span class="o">=</span> <span class="n">var_all</span> <span class="o">*</span> <span class="n">varcorrection_pairs_unbalanced</span><span class="p">(</span><span class="n">nobs_all</span><span class="p">,</span>
                                                             <span class="n">srange</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">var_all</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">var_pairs</span><span class="p">,</span> <span class="n">df_sum</span> <span class="o">=</span> <span class="n">varcorrection_pairs_unequal</span><span class="p">(</span><span class="n">nobs_all</span><span class="p">,</span> <span class="n">var_all</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
        <span class="n">var_pairs</span> <span class="o">/=</span> <span class="mf">2.</span>
        <span class="c1">#check division by two for studentized range</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not supposed to be here&#39;</span><span class="p">)</span>

    <span class="c1">#meandiffs_ = mean_all[:,None] - mean_all</span>
    <span class="n">meandiffs_</span> <span class="o">=</span> <span class="n">mean_all</span> <span class="o">-</span> <span class="n">mean_all</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>  <span class="c1">#reverse sign, check with R example</span>
    <span class="n">std_pairs_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_pairs</span><span class="p">)</span>

    <span class="c1">#select all pairs from upper triangle of matrix</span>
    <span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">n_means</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">meandiffs</span> <span class="o">=</span> <span class="n">meandiffs_</span><span class="p">[</span><span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span><span class="p">]</span>
    <span class="n">std_pairs</span> <span class="o">=</span> <span class="n">std_pairs_</span><span class="p">[</span><span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span><span class="p">]</span>

    <span class="n">st_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">meandiffs</span><span class="p">)</span> <span class="o">/</span> <span class="n">std_pairs</span> <span class="c1">#studentized range statistic</span>

    <span class="n">df_total_</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">df_total</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1">#TODO: smallest df in table</span>
    <span class="k">if</span> <span class="n">q_crit</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">q_crit</span> <span class="o">=</span> <span class="n">get_tukeyQcrit2</span><span class="p">(</span><span class="n">n_means</span><span class="p">,</span> <span class="n">df_total</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>

    <span class="n">reject</span> <span class="o">=</span> <span class="n">st_range</span> <span class="o">&gt;</span> <span class="n">q_crit</span>
    <span class="n">crit_int</span> <span class="o">=</span> <span class="n">std_pairs</span> <span class="o">*</span> <span class="n">q_crit</span>
    <span class="n">reject2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">meandiffs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">crit_int</span>

    <span class="n">confint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">meandiffs</span> <span class="o">-</span> <span class="n">crit_int</span><span class="p">,</span> <span class="n">meandiffs</span> <span class="o">+</span> <span class="n">crit_int</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span><span class="p">),</span> <span class="n">reject</span><span class="p">,</span> <span class="n">meandiffs</span><span class="p">,</span> <span class="n">std_pairs</span><span class="p">,</span> <span class="n">confint</span><span class="p">,</span> <span class="n">q_crit</span><span class="p">,</span> \
           <span class="n">df_total</span><span class="p">,</span> <span class="n">reject2</span>

<span class="k">def</span> <span class="nf">simultaneous_ci</span><span class="p">(</span><span class="n">q_crit</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">groupnobs</span><span class="p">,</span> <span class="n">pairindices</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute simultaneous confidence intervals for comparison of means.</span>

<span class="sd">    q_crit value is generated from tukey hsd test. Variance is considered</span>
<span class="sd">    across all groups. Returned halfwidths can be thought of as uncertainty</span>
<span class="sd">    intervals around each group mean. They allow for simultaneous</span>
<span class="sd">    comparison of pairwise significance among any pairs (by checking for</span>
<span class="sd">    overlap)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q_crit : float</span>
<span class="sd">        The Q critical value studentized range statistic from Tukey&#39;s HSD</span>
<span class="sd">    var : float</span>
<span class="sd">        The group variance</span>
<span class="sd">    groupnobs : array-like object</span>
<span class="sd">        Number of observations contained in each group.</span>
<span class="sd">    pairindices : tuple of lists, optional</span>
<span class="sd">        Indices corresponding to the upper triangle of matrix. Computed</span>
<span class="sd">        here if not supplied</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    halfwidths : ndarray</span>
<span class="sd">        Half the width of each confidence interval for each group given in</span>
<span class="sd">        groupnobs</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    MultiComparison : statistics class providing significance tests</span>
<span class="sd">    tukeyhsd : among other things, computes q_crit value</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [*] Hochberg, Y., and A. C. Tamhane. Multiple Comparison Procedures.</span>
<span class="sd">           Hoboken, NJ: John Wiley &amp; Sons, 1987.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Set initial variables</span>
    <span class="n">ng</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">groupnobs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pairindices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pairindices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">ng</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Compute dij for all pairwise comparisons ala hochberg p. 95</span>
    <span class="n">gvar</span> <span class="o">=</span> <span class="n">var</span> <span class="o">/</span> <span class="n">groupnobs</span>

    <span class="n">d12</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">gvar</span><span class="p">[</span><span class="n">pairindices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">gvar</span><span class="p">[</span><span class="n">pairindices</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

    <span class="c1"># Create the full d matrix given all known dij vals</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ng</span><span class="p">,</span> <span class="n">ng</span><span class="p">))</span>
    <span class="n">d</span><span class="p">[</span><span class="n">pairindices</span><span class="p">]</span> <span class="o">=</span> <span class="n">d12</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># Compute the two global sums from hochberg eq 3.32</span>
    <span class="n">sum1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">d12</span><span class="p">)</span>
    <span class="n">sum2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ng</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="p">((</span><span class="n">ng</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">sum2</span> <span class="o">-</span> <span class="n">sum1</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">ng</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ng</span> <span class="o">-</span> <span class="mf">2.</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">sum1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">q_crit</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">w</span>

<div class="viewcode-block" id="distance_st_range"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.distance_st_range.html#statsmodels.sandbox.stats.multicomp.distance_st_range">[docs]</a><span class="k">def</span> <span class="nf">distance_st_range</span><span class="p">(</span><span class="n">mean_all</span><span class="p">,</span> <span class="n">nobs_all</span><span class="p">,</span> <span class="n">var_all</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">triu</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;pairwise distance matrix, outsourced from tukeyhsd</span>



<span class="sd">    CHANGED: meandiffs are with sign, studentized range uses abs</span>

<span class="sd">    q_crit added for testing</span>

<span class="sd">    TODO: error in variance calculation when nobs_all is scalar, missing 1/n</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">mean_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mean_all</span><span class="p">)</span>
    <span class="c1">#check if or when other ones need to be arrays</span>

    <span class="n">n_means</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mean_all</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">nobs_all</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>   <span class="c1"># assumes balanced samples with df = n - 1, n_i = n</span>
        <span class="n">df_total</span> <span class="o">=</span> <span class="n">n_means</span> <span class="o">*</span> <span class="n">df</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">nobs_all</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">var_all</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
        <span class="c1">#balanced sample sizes and homogenous variance</span>
        <span class="n">var_pairs</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">*</span> <span class="n">var_all</span> <span class="o">/</span> <span class="n">nobs_all</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_means</span><span class="p">,</span> <span class="n">n_means</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">var_all</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1">#unequal sample sizes and homogenous variance</span>
        <span class="n">var_pairs</span> <span class="o">=</span> <span class="n">var_all</span> <span class="o">*</span> <span class="n">varcorrection_pairs_unbalanced</span><span class="p">(</span><span class="n">nobs_all</span><span class="p">,</span>
                                                             <span class="n">srange</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">var_all</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">var_pairs</span><span class="p">,</span> <span class="n">df_sum</span> <span class="o">=</span> <span class="n">varcorrection_pairs_unequal</span><span class="p">(</span><span class="n">nobs_all</span><span class="p">,</span> <span class="n">var_all</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
        <span class="n">var_pairs</span> <span class="o">/=</span> <span class="mf">2.</span>
        <span class="c1">#check division by two for studentized range</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not supposed to be here&#39;</span><span class="p">)</span>

    <span class="c1">#meandiffs_ = mean_all[:,None] - mean_all</span>
    <span class="n">meandiffs</span> <span class="o">=</span> <span class="n">mean_all</span> <span class="o">-</span> <span class="n">mean_all</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>  <span class="c1">#reverse sign, check with R example</span>
    <span class="n">std_pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_pairs</span><span class="p">)</span>

    <span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="n">n_means</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">triu</span><span class="p">:</span>
        <span class="c1">#select all pairs from upper triangle of matrix</span>
        <span class="n">meandiffs</span> <span class="o">=</span> <span class="n">meandiffs_</span><span class="p">[</span><span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span><span class="p">]</span>
        <span class="n">std_pairs</span> <span class="o">=</span> <span class="n">std_pairs_</span><span class="p">[</span><span class="n">idx1</span><span class="p">,</span> <span class="n">idx2</span><span class="p">]</span>

    <span class="n">st_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">meandiffs</span><span class="p">)</span> <span class="o">/</span> <span class="n">std_pairs</span> <span class="c1">#studentized range statistic</span>

    <span class="k">return</span> <span class="n">st_range</span><span class="p">,</span> <span class="n">meandiffs</span><span class="p">,</span> <span class="n">std_pairs</span><span class="p">,</span> <span class="p">(</span><span class="n">idx1</span><span class="p">,</span><span class="n">idx2</span><span class="p">)</span>  <span class="c1">#return square arrays</span></div>


<span class="k">def</span> <span class="nf">contrast_allpairs</span><span class="p">(</span><span class="n">nm</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;contrast or restriction matrix for all pairs of nm variables</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nm : int</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    contr : ndarray, 2d, (nm*(nm-1)/2, nm)</span>
<span class="sd">       contrast matrix for all pairwise comparisons</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">contr</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nm</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nm</span><span class="p">):</span>
            <span class="n">contr_row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
            <span class="n">contr_row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">contr_row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">contr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">contr_row</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">contr</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">contrast_all_one</span><span class="p">(</span><span class="n">nm</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;contrast or restriction matrix for all against first comparison</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nm : int</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    contr : ndarray, 2d, (nm-1, nm)</span>
<span class="sd">       contrast matrix for all against first comparisons</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">contr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nm</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">nm</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">contr</span>

<span class="k">def</span> <span class="nf">contrast_diff_mean</span><span class="p">(</span><span class="n">nm</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;contrast or restriction matrix for all against mean comparison</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nm : int</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    contr : ndarray, 2d, (nm-1, nm)</span>
<span class="sd">       contrast matrix for all against mean comparisons</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nm</span><span class="p">,</span><span class="n">nm</span><span class="p">))</span><span class="o">/</span><span class="n">nm</span>

<span class="k">def</span> <span class="nf">tukey_pvalues</span><span class="p">(</span><span class="n">std_range</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
    <span class="c1">#corrected but very slow with warnings about integration</span>
    <span class="kn">from</span> <span class="nn">statsmodels.sandbox.distributions.multivariate</span> <span class="k">import</span> <span class="n">mvstdtprob</span>
    <span class="c1">#nm = len(std_range)</span>
    <span class="n">contr</span> <span class="o">=</span> <span class="n">contrast_allpairs</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">contr</span><span class="p">,</span> <span class="n">contr</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span>
    <span class="n">tstat</span> <span class="o">=</span> <span class="n">std_range</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">corr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#need len of all pairs</span>
    <span class="k">return</span> <span class="n">multicontrast_pvalues</span><span class="p">(</span><span class="n">tstat</span><span class="p">,</span> <span class="n">corr</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_tukey_pvalues</span><span class="p">():</span>
    <span class="c1">#testcase with 3 is not good because all pairs has also 3*(3-1)/2=3 elements</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">tukey_pvalues</span><span class="p">(</span><span class="mf">3.649</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="c1">#3.649*np.ones(3), 16)</span>
    <span class="n">assert_almost_equal</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">assert_almost_equal</span><span class="p">(</span><span class="mf">0.05</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">multicontrast_pvalues</span><span class="p">(</span><span class="n">tstat</span><span class="p">,</span> <span class="n">tcorr</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;pvalues for simultaneous tests</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">statsmodels.sandbox.distributions.multivariate</span> <span class="k">import</span> <span class="n">mvstdtprob</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dist</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;df has to be specified for the t-distribution&#39;</span><span class="p">)</span>
    <span class="n">tstat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">tstat</span><span class="p">)</span>
    <span class="n">ntests</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tstat</span><span class="p">)</span>
    <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">tstat</span><span class="p">)</span>
    <span class="n">pval_global</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">mvstdtprob</span><span class="p">(</span><span class="o">-</span><span class="n">cc</span><span class="p">,</span><span class="n">cc</span><span class="p">,</span> <span class="n">tcorr</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
    <span class="n">pvals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">cc</span><span class="p">:</span>
        <span class="n">limits</span> <span class="o">=</span> <span class="n">ti</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ntests</span><span class="p">)</span>
        <span class="n">pvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mvstdtprob</span><span class="p">(</span><span class="o">-</span><span class="n">cc</span><span class="p">,</span><span class="n">cc</span><span class="p">,</span> <span class="n">tcorr</span><span class="p">,</span> <span class="n">df</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">pval_global</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pvals</span><span class="p">)</span>





<div class="viewcode-block" id="StepDown"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.StepDown.html#statsmodels.sandbox.stats.multicomp.StepDown">[docs]</a><span class="k">class</span> <span class="nc">StepDown</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;a class for step down methods</span>

<span class="sd">    This is currently for simple tree subset descend, similar to homogeneous_subsets,</span>
<span class="sd">    but checks all leave-one-out subsets instead of assuming an ordered set.</span>
<span class="sd">    Comment in SAS manual:</span>
<span class="sd">    SAS only uses interval subsets of the sorted list, which is sufficient for range</span>
<span class="sd">    tests (maybe also equal variance and balanced sample sizes are required).</span>
<span class="sd">    For F-test based critical distances, the restriction to intervals is not sufficient.</span>

<span class="sd">    This version uses a single critical value of the studentized range distribution</span>
<span class="sd">    for all comparisons, and is therefore a step-down version of Tukey HSD.</span>
<span class="sd">    The class is written so it can be subclassed, where the get_distance_matrix and</span>
<span class="sd">    get_crit are overwritten to obtain other step-down procedures such as REGW.</span>

<span class="sd">    iter_subsets can be overwritten, to get a recursion as in the many to one comparison</span>
<span class="sd">    with a control such as in Dunnet&#39;s test.</span>


<span class="sd">    A one-sided right tail test is not covered because the direction of the inequality</span>
<span class="sd">    is hard coded in check_set.  Also Peritz&#39;s check of partitions is not possible, but</span>
<span class="sd">    I have not seen it mentioned in any more recent references.</span>
<span class="sd">    I have only partially read the step-down procedure for closed tests by Westfall.</span>

<span class="sd">    One change to make it more flexible, is to separate out the decision on a subset,</span>
<span class="sd">    also because the F-based tests, FREGW in SPSS, take information from all elements of</span>
<span class="sd">    a set and not just pairwise comparisons. I haven&#39;t looked at the details of</span>
<span class="sd">    the F-based tests such as Sheffe yet. It looks like running an F-test on equality</span>
<span class="sd">    of means in each subset. This would also outsource how pairwise conditions are</span>
<span class="sd">    combined, any larger or max. This would also imply that the distance matrix cannot</span>
<span class="sd">    be calculated in advance for tests like the F-based ones.</span>


<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">nobs_all</span><span class="p">,</span> <span class="n">var_all</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vals</span> <span class="o">=</span> <span class="n">vals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_vals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nobs_all</span> <span class="o">=</span> <span class="n">nobs_all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_all</span> <span class="o">=</span> <span class="n">var_all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span>
        <span class="c1"># the following has been moved to run</span>
        <span class="c1">#self.cache_result = {}</span>
        <span class="c1">#self.crit = self.getcrit(0.5)   #decide where to set alpha, moved to run</span>
        <span class="c1">#self.accepted = []  #store accepted sets, not unique</span>

<div class="viewcode-block" id="StepDown.get_crit"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.StepDown.get_crit.html#statsmodels.sandbox.stats.multicomp.StepDown.get_crit">[docs]</a>    <span class="k">def</span> <span class="nf">get_crit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="c1">#currently tukey Q, add others</span>
        <span class="n">q_crit</span> <span class="o">=</span> <span class="n">get_tukeyQcrit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">q_crit</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vals</span><span class="p">)</span></div>



<div class="viewcode-block" id="StepDown.get_distance_matrix"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.StepDown.get_distance_matrix.html#statsmodels.sandbox.stats.multicomp.StepDown.get_distance_matrix">[docs]</a>    <span class="k">def</span> <span class="nf">get_distance_matrix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;studentized range statistic&#39;&#39;&#39;</span>
        <span class="c1">#make into property, decorate</span>
        <span class="n">dres</span> <span class="o">=</span> <span class="n">distance_st_range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobs_all</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_all</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">distance_matrix</span> <span class="o">=</span> <span class="n">dres</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="StepDown.iter_subsets"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.StepDown.iter_subsets.html#statsmodels.sandbox.stats.multicomp.StepDown.iter_subsets">[docs]</a>    <span class="k">def</span> <span class="nf">iter_subsets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)):</span>
            <span class="n">idxsub</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
            <span class="n">idxsub</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">idxsub</span></div>


<div class="viewcode-block" id="StepDown.check_set"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.StepDown.check_set.html#statsmodels.sandbox.stats.multicomp.StepDown.check_set">[docs]</a>    <span class="k">def</span> <span class="nf">check_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;check whether pairwise distances of indices satisfy condition</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">indtup</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">indtup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_result</span><span class="p">[</span><span class="n">indtup</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">set_distance_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">indices</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">indices</span><span class="p">]</span>
            <span class="n">n_elements</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">set_distance_matrix</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">crit</span><span class="p">[</span><span class="n">n_elements</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">res</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cache_result</span><span class="p">[</span><span class="n">indtup</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
            <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="StepDown.stepdown"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.StepDown.stepdown.html#statsmodels.sandbox.stats.multicomp.StepDown.stepdown">[docs]</a>    <span class="k">def</span> <span class="nf">stepdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_set</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span> <span class="c1"># larger than critical distance</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>  <span class="c1"># step down into subsets if more than 2 elements</span>
                <span class="k">for</span> <span class="n">subs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iter_subsets</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stepdown</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rejected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">indices</span></div>

<div class="viewcode-block" id="StepDown.run"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.StepDown.run.html#statsmodels.sandbox.stats.multicomp.StepDown.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;main function to run the test,</span>

<span class="sd">        could be done in __call__ instead</span>
<span class="sd">        this could have all the initialization code</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_crit</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>   <span class="c1">#decide where to set alpha, moved to run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accepted</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">#store accepted sets, not unique</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rejected</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_distance_matrix</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stepdown</span><span class="p">(</span><span class="n">lrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_vals</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accepted</span><span class="p">)),</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sd</span><span class="o">.</span><span class="n">rejected</span><span class="p">))</span></div></div>






<div class="viewcode-block" id="homogeneous_subsets"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.homogeneous_subsets.html#statsmodels.sandbox.stats.multicomp.homogeneous_subsets">[docs]</a><span class="k">def</span> <span class="nf">homogeneous_subsets</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">dcrit</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;recursively check all pairs of vals for minimum distance</span>

<span class="sd">    step down method as in Newman-Keuls and Ryan procedures. This is not a</span>
<span class="sd">    closed procedure since not all partitions are checked.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vals : array_like</span>
<span class="sd">        values that are pairwise compared</span>
<span class="sd">    dcrit : array_like or float</span>
<span class="sd">        critical distance for rejecting, either float, or 2-dimensional array</span>
<span class="sd">        with distances on the upper triangle.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rejs : list of pairs</span>
<span class="sd">        list of pair-indices with (strictly) larger than critical difference</span>
<span class="sd">    nrejs : list of pairs</span>
<span class="sd">        list of pair-indices with smaller than critical difference</span>
<span class="sd">    lli : list of tuples</span>
<span class="sd">        list of subsets with smaller than critical difference</span>
<span class="sd">    res : tree</span>
<span class="sd">        result of all comparisons (for checking)</span>


<span class="sd">    this follows description in SPSS notes on Post-Hoc Tests</span>

<span class="sd">    Because of the recursive structure, some comparisons are made several</span>
<span class="sd">    times, but only unique pairs or sets are returned.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; m = [0, 2, 2.5, 3, 6, 8, 9, 9.5,10 ]</span>
<span class="sd">    &gt;&gt;&gt; rej, nrej, ssli, res = homogeneous_subsets(m, 2)</span>
<span class="sd">    &gt;&gt;&gt; set_partition(ssli)</span>
<span class="sd">    ([(5, 6, 7, 8), (1, 2, 3), (4,)], [0])</span>
<span class="sd">    &gt;&gt;&gt; [np.array(m)[list(pp)] for pp in set_partition(ssli)[0]]</span>
<span class="sd">    [array([  8. ,   9. ,   9.5,  10. ]), array([ 2. ,  2.5,  3. ]), array([ 6.])]</span>


<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">nvals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span>
    <span class="n">indices_</span> <span class="o">=</span> <span class="n">lrange</span><span class="p">(</span><span class="n">nvals</span><span class="p">)</span>
    <span class="n">rejected</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">subsetsli</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">dcrit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dcrit</span> <span class="o">=</span> <span class="n">dcrit</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">nvals</span><span class="p">,</span> <span class="n">nvals</span><span class="p">))</span>  <span class="c1">#example numbers for experimenting</span>
    <span class="k">def</span> <span class="nf">subsets</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">indices_</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;recursive function for constructing homogeneous subset</span>

<span class="sd">        registers rejected and subsetli in outer scope</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="p">(</span><span class="n">indices_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">indices_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dcrit</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]:</span>
            <span class="n">rejected</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">indices_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">indices_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">subsets</span><span class="p">(</span><span class="n">vals</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">indices_</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">subsets</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">indices_</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
                    <span class="p">(</span><span class="n">indices_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">indices_</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">subsetsli</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">indices_</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">indices_</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">subsets</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">indices_</span><span class="p">)</span>

    <span class="n">all_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvals</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvals</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">rejs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">rejected</span><span class="p">)</span>
    <span class="n">not_rejected</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">all_pairs</span><span class="p">)</span> <span class="o">-</span> <span class="n">rejs</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">rejs</span><span class="p">),</span> <span class="n">not_rejected</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">subsetsli</span><span class="p">)),</span> <span class="n">res</span></div>

<div class="viewcode-block" id="set_partition"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.set_partition.html#statsmodels.sandbox.stats.multicomp.set_partition">[docs]</a><span class="k">def</span> <span class="nf">set_partition</span><span class="p">(</span><span class="n">ssli</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;extract a partition from a list of tuples</span>

<span class="sd">    this should be correctly called select largest disjoint sets.</span>
<span class="sd">    Begun and Gabriel 1981 don&#39;t seem to be bothered by sets of accepted</span>
<span class="sd">    hypothesis with joint elements,</span>
<span class="sd">    e.g. maximal_accepted_sets = { {1,2,3}, {2,3,4} }</span>

<span class="sd">    This creates a set partition from a list of sets given as tuples.</span>
<span class="sd">    It tries to find the partition with the largest sets. That is, sets are</span>
<span class="sd">    included after being sorted by length.</span>

<span class="sd">    If the list doesn&#39;t include the singletons, then it will be only a</span>
<span class="sd">    partial partition. Missing items are singletons (I think).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; li</span>
<span class="sd">    [(5, 6, 7, 8), (1, 2, 3), (4, 5), (0, 1)]</span>
<span class="sd">    &gt;&gt;&gt; set_partition(li)</span>
<span class="sd">    ([(5, 6, 7, 8), (1, 2, 3)], [0, 4])</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">part</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ssli</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="c1">#print(s,</span>
        <span class="n">s_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">s_</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">part</span><span class="p">):</span>
            <span class="c1">#print(&#39;inside:&#39;, s</span>
            <span class="n">part</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c1">#else: print(part</span>

    <span class="n">missing</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">ssli</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">)</span>
                   <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">part</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ll</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">part</span><span class="p">,</span> <span class="n">missing</span></div>


<div class="viewcode-block" id="set_remove_subs"><a class="viewcode-back" href="../../../../generated/statsmodels.sandbox.stats.multicomp.set_remove_subs.html#statsmodels.sandbox.stats.multicomp.set_remove_subs">[docs]</a><span class="k">def</span> <span class="nf">set_remove_subs</span><span class="p">(</span><span class="n">ssli</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;remove sets that are subsets of another set from a list of tuples</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ssli : list of tuples</span>
<span class="sd">        each tuple is considered as a set</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    part : list of tuples</span>
<span class="sd">        new list with subset tuples removed, it is sorted by set-length of tuples. The</span>
<span class="sd">        list contains original tuples, duplicate elements are not removed.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; set_remove_subs([(0, 1), (1, 2), (1, 2, 3), (0,)])</span>
<span class="sd">    [(1, 2, 3), (0, 1)]</span>
<span class="sd">    &gt;&gt;&gt; set_remove_subs([(0, 1), (1, 2), (1,1, 1, 2, 3), (0,)])</span>
<span class="sd">    [(1, 1, 1, 2, 3), (0, 1)]</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#TODO: maybe convert all tuples to sets immediately, but I don&#39;t need the extra efficiency</span>
    <span class="n">part</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ssli</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="c1">#print(s,</span>
        <span class="c1">#s_ = set(s).copy()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">part</span><span class="p">):</span>
            <span class="c1">#print(&#39;inside:&#39;, s</span>
            <span class="n">part</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c1">#else: print(part</span>

<span class="c1">##    missing = list(set(i for ll in ssli for i in ll)</span>
<span class="c1">##                   - set(i for ll in part for i in ll))</span>
    <span class="k">return</span> <span class="n">part</span></div>




<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">examples</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tukey&#39;</span><span class="p">,</span> <span class="s1">&#39;tukeycrit&#39;</span><span class="p">,</span> <span class="s1">&#39;fdr&#39;</span><span class="p">,</span> <span class="s1">&#39;fdrmc&#39;</span><span class="p">,</span> <span class="s1">&#39;bonf&#39;</span><span class="p">,</span> <span class="s1">&#39;randmvn&#39;</span><span class="p">,</span>
                <span class="s1">&#39;multicompdev&#39;</span><span class="p">,</span> <span class="s1">&#39;None&#39;</span><span class="p">]</span><span class="c1">#[-1]</span>

    <span class="k">if</span> <span class="s1">&#39;tukey&#39;</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
        <span class="c1">#Example Tukey</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">Tukeythreegene</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">))</span>

        <span class="c1">#Example FDR</span>
        <span class="c1">#------------</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;fdr&#39;</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;bonf&#39;</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">):</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">lzip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x1</span><span class="p">)),</span> <span class="n">x1</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">maxzero</span><span class="p">(</span><span class="n">x1</span><span class="p">))</span>
        <span class="c1">#[(0, 1), (1, 1), (2, 1), (3, 0), (4, -1), (5, -1), (6, -1), (7, 0), (8, 1), (9, 1), (10, -1), (11, 1)]</span>
        <span class="c1">#(11, array([ 3,  7, 11]))</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">maxzerodown</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x1</span><span class="p">)))</span>

        <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="mi">6</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.75</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">rvs</span> <span class="o">=</span> <span class="n">locs</span> <span class="o">+</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
        <span class="n">tt</span><span class="p">,</span> <span class="n">tpval</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_1samp</span><span class="p">(</span><span class="n">rvs</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">tpval_sortind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">tpval</span><span class="p">)</span>
        <span class="n">tpval_sorted</span> <span class="o">=</span> <span class="n">tpval</span><span class="p">[</span><span class="n">tpval_sortind</span><span class="p">]</span>

        <span class="n">reject</span> <span class="o">=</span> <span class="n">tpval_sorted</span> <span class="o">&lt;</span> <span class="n">ecdf</span><span class="p">(</span><span class="n">tpval_sorted</span><span class="p">)</span><span class="o">*</span><span class="mf">0.05</span>
        <span class="n">reject2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">reject</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">reject</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lzip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rvs</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="mi">4</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">tpval</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span>
                           <span class="n">reject</span><span class="p">[</span><span class="n">tpval_sortind</span><span class="o">.</span><span class="n">argsort</span><span class="p">()]),</span>
                       <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;pval&#39;</span><span class="p">,</span><span class="nb">float</span><span class="p">),</span>
                              <span class="p">(</span><span class="s1">&#39;reject&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">bool8</span><span class="p">)])</span>
        <span class="c1">#from statsmodels.iolib import SimpleTable</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">SimpleTable</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">fdrcorrection_bak</span><span class="p">(</span><span class="n">tpval</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">reject</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">random example&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;bonf&#39;</span><span class="p">,</span> <span class="n">multipletests</span><span class="p">(</span><span class="n">tpval</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bonf&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sidak&#39;</span><span class="p">,</span> <span class="n">multipletests</span><span class="p">(</span><span class="n">tpval</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;sidak&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hs&#39;</span><span class="p">,</span> <span class="n">multipletests</span><span class="p">(</span><span class="n">tpval</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;hs&#39;</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sh&#39;</span><span class="p">,</span> <span class="n">multipletests</span><span class="p">(</span><span class="n">tpval</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;sh&#39;</span><span class="p">))</span>
        <span class="n">pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;0.0020 0.0045 0.0060 0.0080 0.0085 0.0090 0.0175 0.0250 &#39;</span>
                 <span class="s1">&#39;0.1055 0.5350&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">example from lecturnotes&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">meth</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bonf&#39;</span><span class="p">,</span> <span class="s1">&#39;sidak&#39;</span><span class="p">,</span> <span class="s1">&#39;hs&#39;</span><span class="p">,</span> <span class="s1">&#39;sh&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">meth</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">multipletests</span><span class="p">(</span><span class="n">pvals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">meth</span><span class="p">))</span>

    <span class="k">if</span> <span class="s1">&#39;fdrmc&#39;</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
        <span class="n">mcres</span> <span class="o">=</span> <span class="n">mcfdr</span><span class="p">(</span><span class="n">nobs</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">nrepl</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">ntests</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">ntrue</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">mcmeans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mcres</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">mcmeans</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">mcmeans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">6.</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">mcmeans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">4.</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">mcmeans</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="n">mcmeans</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:])</span>


    <span class="k">if</span> <span class="s1">&#39;randmvn&#39;</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
        <span class="n">rvsmvn</span> <span class="o">=</span> <span class="n">randmvn</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="p">(</span><span class="mi">5000</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">rvsmvn</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">rvsmvn</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>


    <span class="k">if</span> <span class="s1">&#39;tukeycrit&#39;</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">get_tukeyQcrit</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">),</span> <span class="mf">5.60</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">get_tukeyQcrit</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">),</span> <span class="mf">7.47</span><span class="p">)</span>


    <span class="k">if</span> <span class="s1">&#39;multicompdev&#39;</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
        <span class="c1">#development of kruskal-wallis multiple-comparison</span>
        <span class="c1">#example from matlab file exchange</span>

        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">7.68</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.69</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.70</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.70</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.72</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">7.73</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.73</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.76</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.71</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.73</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">7.74</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.74</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.78</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.78</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.80</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">7.81</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.74</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.75</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.77</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.78</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">7.80</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.81</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.84</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.71</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.71</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">7.74</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.79</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.81</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.85</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mf">7.87</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">7.91</span><span class="p">,</span> <span class="mi">4</span><span class="p">]])</span>
        <span class="n">xli</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)]</span>
        <span class="n">xranks</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">rankdata</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">xranksli</span> <span class="o">=</span> <span class="p">[</span><span class="n">xranks</span><span class="p">[</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)]</span>
        <span class="n">xnobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xli</span><span class="p">])</span>
        <span class="n">meanranks</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">xranksli</span><span class="p">]</span>
        <span class="n">sumranks</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">xranksli</span><span class="p">]</span>
        <span class="c1"># equivalent function</span>
        <span class="c1">#from scipy import special</span>
        <span class="c1">#-np.sqrt(2.)*special.erfcinv(2-0.5) == stats.norm.isf(0.25)</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="mf">0.67448975019608171</span><span class="p">)</span>
        <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">isf</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>

        <span class="n">mrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">meanranks</span><span class="p">)</span>
        <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">triu_indices</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">sorted rank differences&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">mrs</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span> <span class="o">-</span> <span class="n">mrs</span><span class="p">[</span><span class="n">v1</span><span class="p">])</span>
        <span class="n">diffidx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">mrs</span><span class="p">[</span><span class="n">v2</span><span class="p">]</span> <span class="o">-</span> <span class="n">mrs</span><span class="p">[</span><span class="n">v1</span><span class="p">])[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">mrs</span><span class="p">[</span><span class="n">v2</span><span class="p">[</span><span class="n">diffidx</span><span class="p">]]</span> <span class="o">-</span> <span class="n">mrs</span><span class="p">[</span><span class="n">v1</span><span class="p">[</span><span class="n">diffidx</span><span class="p">]]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">kruskal for all pairs&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">v2</span><span class="p">[</span><span class="n">diffidx</span><span class="p">],</span> <span class="n">v1</span><span class="p">[</span><span class="n">diffidx</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">kruskal</span><span class="p">(</span><span class="n">xli</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xli</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
            <span class="n">mwu</span><span class="p">,</span> <span class="n">mwupval</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">xli</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xli</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">use_continuity</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">mwu</span><span class="p">,</span> <span class="n">mwupval</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">mwupval</span><span class="o">*</span><span class="mi">2</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="o">/</span><span class="mf">6.</span><span class="p">,</span> <span class="n">mwupval</span><span class="o">*</span><span class="mi">2</span><span class="o">&lt;</span><span class="mf">0.1</span><span class="o">/</span><span class="mf">6.</span><span class="p">)</span>





        <span class="n">uni</span><span class="p">,</span> <span class="n">intlab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">groupnobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">intlab</span><span class="p">)</span>
        <span class="n">groupxsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">intlab</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">groupxmean</span> <span class="o">=</span> <span class="n">groupxsum</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">groupnobs</span>

        <span class="n">rankraw</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">groupranksum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">intlab</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">rankraw</span><span class="p">)</span>
        <span class="c1"># start at 1 for stats.rankdata :</span>
        <span class="n">grouprankmean</span> <span class="o">=</span> <span class="n">groupranksum</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">groupnobs</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">grouprankmean</span><span class="p">[</span><span class="n">intlab</span><span class="p">],</span> <span class="n">stats</span><span class="o">.</span><span class="n">rankdata</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">15</span><span class="p">)</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">GroupsStats</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">useranks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">groupmeanfilter and grouprankmeans&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">gs</span><span class="o">.</span><span class="n">groupmeanfilter</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">grouprankmean</span><span class="p">[</span><span class="n">intlab</span><span class="p">])</span>
        <span class="c1">#the following has changed</span>
        <span class="c1">#assert_almost_equal(gs.groupmeanfilter, stats.rankdata(X[:,0]), 15)</span>

        <span class="n">xuni</span><span class="p">,</span> <span class="n">xintlab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">gs2</span> <span class="o">=</span> <span class="n">GroupsStats</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">xintlab</span><span class="p">]),</span> <span class="n">useranks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#assert_almost_equal(gs2.groupmeanfilter, stats.rankdata(X[:,0]), 15)</span>

        <span class="n">rankbincount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">xranks</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="n">nties</span> <span class="o">=</span> <span class="n">rankbincount</span><span class="p">[</span><span class="n">rankbincount</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">ntot</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xranks</span><span class="p">));</span>
        <span class="n">tiecorrection</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">nties</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">nties</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">ntot</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">ntot</span><span class="p">)</span>
        <span class="n">assert_almost_equal</span><span class="p">(</span><span class="n">tiecorrection</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">tiecorrect</span><span class="p">(</span><span class="n">xranks</span><span class="p">),</span><span class="mi">15</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">tiecorrection for data and ranks&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tiecorrection</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tiecorrect</span><span class="p">(</span><span class="n">xranks</span><span class="p">))</span>

        <span class="n">tot</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">t</span><span class="o">=</span><span class="mi">500</span> <span class="c1">#168</span>
        <span class="n">f</span><span class="o">=</span><span class="p">(</span><span class="n">tot</span><span class="o">*</span><span class="p">(</span><span class="n">tot</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="mf">12.</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="p">(</span><span class="mf">6.</span><span class="o">*</span><span class="p">(</span><span class="n">tot</span><span class="o">-</span><span class="mf">1.</span><span class="p">)))</span>
        <span class="n">f</span><span class="o">=</span><span class="p">(</span><span class="n">tot</span><span class="o">*</span><span class="p">(</span><span class="n">tot</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span><span class="o">/</span><span class="mf">12.</span><span class="p">)</span><span class="o">/</span><span class="n">stats</span><span class="o">.</span><span class="n">tiecorrect</span><span class="p">(</span><span class="n">xranks</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">pairs of mean rank differences&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">v2</span><span class="p">[</span><span class="n">diffidx</span><span class="p">],</span> <span class="n">v1</span><span class="p">[</span><span class="n">diffidx</span><span class="p">]):</span>
            <span class="c1">#pdiff = np.abs(mrs[i] - mrs[j])</span>
            <span class="n">pdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">meanranks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">meanranks</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">xnobs</span><span class="p">[[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span> <span class="p">))</span> <span class="c1">#np.array([8,8]))) #Fixme groupnobs[[i,j]] ))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="n">pdiff</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">pdiff</span><span class="o">/</span><span class="n">se</span><span class="p">,</span> <span class="n">pdiff</span><span class="o">/</span><span class="n">se</span><span class="o">&gt;</span><span class="mf">2.6310</span><span class="p">)</span>

        <span class="n">multicomp</span> <span class="o">=</span> <span class="n">MultiComparison</span><span class="p">(</span><span class="o">*</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">multicomp</span><span class="o">.</span><span class="n">kruskal</span><span class="p">()</span>
        <span class="n">gsr</span> <span class="o">=</span> <span class="n">GroupsStats</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">useranks</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">examples for kruskal multicomparison&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
            <span class="n">skw</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">kruskal</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
            <span class="n">mc2</span><span class="o">=</span><span class="n">MultiComparison</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x1</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x2</span><span class="p">))])</span>
            <span class="n">newskw</span> <span class="o">=</span> <span class="n">mc2</span><span class="o">.</span><span class="n">kruskal</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">skw</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">skw</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">skw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">newskw</span><span class="p">,</span> <span class="p">(</span><span class="n">newskw</span><span class="o">/</span><span class="n">skw</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>

        <span class="n">tablett</span><span class="p">,</span> <span class="n">restt</span><span class="p">,</span> <span class="n">arrtt</span> <span class="o">=</span> <span class="n">multicomp</span><span class="o">.</span><span class="n">allpairtest</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">)</span>
        <span class="n">tablemw</span><span class="p">,</span> <span class="n">resmw</span><span class="p">,</span> <span class="n">arrmw</span> <span class="o">=</span> <span class="n">multicomp</span><span class="o">.</span><span class="n">allpairtest</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tablett</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tablemw</span><span class="p">)</span>
        <span class="n">tablemwhs</span><span class="p">,</span> <span class="n">resmw</span><span class="p">,</span> <span class="n">arrmw</span> <span class="o">=</span> <span class="n">multicomp</span><span class="o">.</span><span class="n">allpairtest</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;hs&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tablemwhs</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;last&#39;</span> <span class="ow">in</span> <span class="n">examples</span><span class="p">:</span>
        <span class="n">xli</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span>
        <span class="c1">#Xrvs = np.array(catstack(xli))</span>
        <span class="n">xrvs</span><span class="p">,</span> <span class="n">xrvsgr</span> <span class="o">=</span> <span class="n">catstack</span><span class="p">(</span><span class="n">xli</span><span class="p">)</span>
        <span class="n">multicompr</span> <span class="o">=</span> <span class="n">MultiComparison</span><span class="p">(</span><span class="n">xrvs</span><span class="p">,</span> <span class="n">xrvsgr</span><span class="p">)</span>
        <span class="n">tablett</span><span class="p">,</span> <span class="n">restt</span><span class="p">,</span> <span class="n">arrtt</span> <span class="o">=</span> <span class="n">multicompr</span><span class="o">.</span><span class="n">allpairtest</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tablett</span><span class="p">)</span>


        <span class="n">xli</span><span class="o">=</span><span class="p">[[</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">9</span><span class="p">],[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">5</span><span class="p">],[</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">7</span><span class="p">]]</span>
        <span class="n">x</span><span class="p">,</span><span class="n">l</span> <span class="o">=</span> <span class="n">catstack</span><span class="p">(</span><span class="n">xli</span><span class="p">)</span>
        <span class="n">gs4</span> <span class="o">=</span> <span class="n">GroupsStats</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">l</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">gs4</span><span class="o">.</span><span class="n">groupvarwithin</span><span class="p">())</span>


    <span class="c1">#test_tukeyhsd() #moved to test_multi.py</span>

    <span class="n">gmeans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">7.71375</span><span class="p">,</span>  <span class="mf">7.76125</span><span class="p">,</span>  <span class="mf">7.78428571</span><span class="p">,</span>  <span class="mf">7.79875</span><span class="p">])</span>
    <span class="n">gnobs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">])</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">StepDown</span><span class="p">(</span><span class="n">gmeans</span><span class="p">,</span> <span class="n">gnobs</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="p">[</span><span class="mi">27</span><span class="p">])</span>

    <span class="c1">#example from BKY</span>
    <span class="n">pvals</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.0004</span><span class="p">,</span> <span class="mf">0.0019</span><span class="p">,</span> <span class="mf">0.0095</span><span class="p">,</span> <span class="mf">0.0201</span><span class="p">,</span> <span class="mf">0.0278</span><span class="p">,</span> <span class="mf">0.0298</span><span class="p">,</span> <span class="mf">0.0344</span><span class="p">,</span> <span class="mf">0.0459</span><span class="p">,</span>
             <span class="mf">0.3240</span><span class="p">,</span> <span class="mf">0.4262</span><span class="p">,</span> <span class="mf">0.5719</span><span class="p">,</span> <span class="mf">0.6528</span><span class="p">,</span> <span class="mf">0.7590</span><span class="p">,</span> <span class="mf">1.000</span> <span class="p">]</span>

    <span class="c1">#same number of rejection as in BKY paper:</span>
    <span class="c1">#single step-up:4, two-stage:8, iterated two-step:9</span>
    <span class="c1">#also alpha_star is the same as theirs for TST</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">fdrcorrection0</span><span class="p">(</span><span class="n">pvals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;indep&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">fdrcorrection_twostage</span><span class="p">(</span><span class="n">pvals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">res_tst</span> <span class="o">=</span> <span class="n">fdrcorrection_twostage</span><span class="p">(</span><span class="n">pvals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">assert_almost_equal</span><span class="p">([</span><span class="mf">0.047619</span><span class="p">,</span> <span class="mf">0.0649</span><span class="p">],</span> <span class="n">res_tst</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="mi">2</span><span class="p">],</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#alpha_star for stage 2</span>
    <span class="n">assert_equal</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">res_tst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">fdrcorrection_twostage</span><span class="p">(</span><span class="n">pvals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="nb">iter</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fdr_gbs&#39;</span><span class="p">,</span> <span class="n">multipletests</span><span class="p">(</span><span class="n">pvals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;fdr_gbs&#39;</span><span class="p">))</span>
    <span class="c1">#multicontrast_pvalues(tstat, tcorr, df)</span>
    <span class="n">test_tukey_pvalues</span><span class="p">()</span>
    <span class="n">tukey_pvalues</span><span class="p">(</span><span class="mf">3.649</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</pre></div>




          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2009-2017, Josef Perktold, Skipper Seabold, Jonathan Taylor, statsmodels-developers.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.4.
    </div>
  </body>
</html>