

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>statsmodels.regression.mixed_linear_model &#8212; statsmodels 0.9.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../_static/statsmodels_hybi_favico.ico"/>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<link rel="stylesheet" href="../../../_static/examples.css" type="text/css" />
<link rel="stylesheet" href="../../../_static/facebox.css" type="text/css" />
<script type="text/javascript" src="../../../_static/scripts.js">
</script>
<script type="text/javascript" src="../../../_static/facebox.js">
</script>
<script type="text/javascript">
$.facebox.settings.closeImage = "../../../_static/closelabel.png"
$.facebox.settings.loadingImage = "../../../_static/loading.gif"
</script>

  </head><body>
<div class="headerwrap">
    <div class = "header">
        
        <a href = "../../../index.html">
<img src="../../../_static/statsmodels_hybi_banner.png" alt="Logo"
    style="padding-left: 15px"/></a>
        
    </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
<li><a href ="../../../install.html">Install</a></li> &nbsp;|&nbsp;
<li><a href="https://groups.google.com/forum/?hl=en#!forum/pystatsmodels">Support</a></li> &nbsp;|&nbsp;
<li><a href="https://github.com/statsmodels/statsmodels/issues">Bugs</a></li> &nbsp;|&nbsp;
<li><a href="../../../dev/index.html">Develop</a></li> &nbsp;|&nbsp;
<li><a href="../../../examples/index.html">Examples</a></li> &nbsp;|&nbsp;
<li><a href="../../../faq.html">FAQ</a></li> &nbsp;|&nbsp;

          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> |</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            




  <h1>Source code for statsmodels.regression.mixed_linear_model</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Linear mixed effects models are regression models for dependent data.</span>
<span class="sd">They can be used to estimate regression relationships involving both</span>
<span class="sd">means and variances.</span>

<span class="sd">These models are also known as multilevel linear models, and</span>
<span class="sd">hierarchical linear models.</span>

<span class="sd">The MixedLM class fits linear mixed effects models to data, and</span>
<span class="sd">provides support for some common post-estimation tasks.  This is a</span>
<span class="sd">group-based implementation that is most efficient for models in which</span>
<span class="sd">the data can be partitioned into independent groups.  Some models with</span>
<span class="sd">crossed effects can be handled by specifying a model with a single</span>
<span class="sd">group.</span>

<span class="sd">The data are partitioned into disjoint groups.  The probability model</span>
<span class="sd">for group i is:</span>

<span class="sd">Y = X*beta + Z*gamma + epsilon</span>

<span class="sd">where</span>

<span class="sd">* n_i is the number of observations in group i</span>

<span class="sd">* Y is a n_i dimensional response vector (called endog in MixedLM)</span>

<span class="sd">* X is a n_i x k_fe dimensional design matrix for the fixed effects</span>
<span class="sd">  (called exog in MixedLM)</span>

<span class="sd">* beta is a k_fe-dimensional vector of fixed effects parameters</span>
<span class="sd">  (called fe_params in MixedLM)</span>

<span class="sd">* Z is a design matrix for the random effects with n_i rows (called</span>
<span class="sd">  exog_re in MixedLM).  The number of columns in Z can vary by group</span>
<span class="sd">  as discussed below.</span>

<span class="sd">* gamma is a random vector with mean 0.  The covariance matrix for the</span>
<span class="sd">  first `k_re` elements of `gamma` (called cov_re in MixedLM) is</span>
<span class="sd">  common to all groups.  The remaining elements of `gamma` are</span>
<span class="sd">  variance components as discussed in more detail below. Each group</span>
<span class="sd">  receives its own independent realization of gamma.</span>

<span class="sd">* epsilon is a n_i dimensional vector of iid normal</span>
<span class="sd">  errors with mean 0 and variance sigma^2; the epsilon</span>
<span class="sd">  values are independent both within and between groups</span>

<span class="sd">Y, X and Z must be entirely observed.  beta, Psi, and sigma^2 are</span>
<span class="sd">estimated using ML or REML estimation, and gamma and epsilon are</span>
<span class="sd">random so define the probability model.</span>

<span class="sd">The marginal mean structure is E[Y | X, Z] = X*beta.  If only the mean</span>
<span class="sd">structure is of interest, GEE is an alternative to using linear mixed</span>
<span class="sd">models.</span>

<span class="sd">Two types of random effects are supported.  Standard random effects</span>
<span class="sd">are correlated with each other in arbitrary ways.  Every group has the</span>
<span class="sd">same number (`k_re`) of standard random effects, with the same joint</span>
<span class="sd">distribution (but with independent realizations across the groups).</span>

<span class="sd">Variance components are uncorrelated with each other, and with the</span>
<span class="sd">standard random effects.  Each variance component has mean zero, and</span>
<span class="sd">all realizations of a given variance component have the same variance</span>
<span class="sd">parameter.  The number of realized variance components per variance</span>
<span class="sd">parameter can differ across the groups.</span>

<span class="sd">The primary reference for the implementation details is:</span>

<span class="sd">MJ Lindstrom, DM Bates (1988).  &quot;Newton Raphson and EM algorithms for</span>
<span class="sd">linear mixed effects models for repeated measures data&quot;.  Journal of</span>
<span class="sd">the American Statistical Association. Volume 83, Issue 404, pages</span>
<span class="sd">1014-1022.</span>

<span class="sd">See also this more recent document:</span>

<span class="sd">http://econ.ucsb.edu/~doug/245a/Papers/Mixed%20Effects%20Implement.pdf</span>

<span class="sd">All the likelihood, gradient, and Hessian calculations closely follow</span>
<span class="sd">Lindstrom and Bates 1988, adapted to support variance components.</span>

<span class="sd">The following two documents are written more from the perspective of</span>
<span class="sd">users:</span>

<span class="sd">http://lme4.r-forge.r-project.org/lMMwR/lrgprt.pdf</span>

<span class="sd">http://lme4.r-forge.r-project.org/slides/2009-07-07-Rennes/3Longitudinal-4.pdf</span>

<span class="sd">Notation:</span>

<span class="sd">* `cov_re` is the random effects covariance matrix (referred to above</span>
<span class="sd">  as Psi) and `scale` is the (scalar) error variance.  For a single</span>
<span class="sd">  group, the marginal covariance matrix of endog given exog is scale*I</span>
<span class="sd">  + Z * cov_re * Z&#39;, where Z is the design matrix for the random</span>
<span class="sd">  effects in one group.</span>

<span class="sd">* `vcomp` is a vector of variance parameters.  The length of `vcomp`</span>
<span class="sd">  is determined by the number of keys in either the `exog_vc` argument</span>
<span class="sd">  to ``MixedLM``, or the `vc_formula` argument when using formulas to</span>
<span class="sd">  fit a model.</span>

<span class="sd">Notes:</span>

<span class="sd">1. Three different parameterizations are used in different places.</span>
<span class="sd">The regression slopes (usually called `fe_params`) are identical in</span>
<span class="sd">all three parameterizations, but the variance parameters differ.  The</span>
<span class="sd">parameterizations are:</span>

<span class="sd">* The &quot;user parameterization&quot; in which cov(endog) = scale*I + Z *</span>
<span class="sd">  cov_re * Z&#39;, as described above.  This is the main parameterization</span>
<span class="sd">  visible to the user.</span>

<span class="sd">* The &quot;profile parameterization&quot; in which cov(endog) = I +</span>
<span class="sd">  Z * cov_re1 * Z&#39;.  This is the parameterization of the profile</span>
<span class="sd">  likelihood that is maximized to produce parameter estimates.</span>
<span class="sd">  (see Lindstrom and Bates for details).  The &quot;user&quot; cov_re is</span>
<span class="sd">  equal to the &quot;profile&quot; cov_re1 times the scale.</span>

<span class="sd">* The &quot;square root parameterization&quot; in which we work with the Cholesky</span>
<span class="sd">  factor of cov_re1 instead of cov_re directly.  This is hidden from the</span>
<span class="sd">  user.</span>

<span class="sd">All three parameterizations can be packed into a vector by</span>
<span class="sd">(optionally) concatenating `fe_params` together with the lower</span>
<span class="sd">triangle or Cholesky square root of the dependence structure, followed</span>
<span class="sd">by the variance parameters for the variance components.  The are</span>
<span class="sd">stored as square roots if (and only if) the random effects covariance</span>
<span class="sd">matrix is stored as its Choleky factor.  Note that when unpacking, it</span>
<span class="sd">is important to either square or reflect the dependence structure</span>
<span class="sd">depending on which parameterization is being used.</span>

<span class="sd">Two score methods are implemented.  One takes the score with respect</span>
<span class="sd">to the elements of the random effects covariance matrix (used for</span>
<span class="sd">inference once the MLE is reached), and the other takes the score with</span>
<span class="sd">respect to the parameters of the Choleky square root of the random</span>
<span class="sd">effects covariance matrix (used for optimization).</span>

<span class="sd">The numerical optimization uses GLS to avoid explicitly optimizing</span>
<span class="sd">over the fixed effects parameters.  The likelihood that is optimized</span>
<span class="sd">is profiled over both the scale parameter (a scalar) and the fixed</span>
<span class="sd">effects parameters (if any).  As a result of this profiling, it is</span>
<span class="sd">difficult and unnecessary to calculate the Hessian of the profiled log</span>
<span class="sd">likelihood function, so that calculation is not implemented here.</span>
<span class="sd">Therefore, optimization methods requiring the Hessian matrix such as</span>
<span class="sd">the Newton-Raphson algorithm cannot be used for model fitting.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">statsmodels.base.model</span> <span class="k">as</span> <span class="nn">base</span>
<span class="kn">from</span> <span class="nn">statsmodels.tools.decorators</span> <span class="k">import</span> <span class="n">cache_readonly</span>
<span class="kn">from</span> <span class="nn">statsmodels.tools</span> <span class="k">import</span> <span class="n">data</span> <span class="k">as</span> <span class="n">data_tools</span>
<span class="kn">from</span> <span class="nn">scipy.stats.distributions</span> <span class="k">import</span> <span class="n">norm</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">sparse</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">patsy</span>
<span class="kn">from</span> <span class="nn">statsmodels.compat.collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">statsmodels.compat.python</span> <span class="k">import</span> <span class="n">string_types</span>
<span class="kn">from</span> <span class="nn">statsmodels.compat</span> <span class="k">import</span> <span class="nb">range</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">statsmodels.tools.sm_exceptions</span> <span class="k">import</span> <span class="n">ConvergenceWarning</span>
<span class="kn">from</span> <span class="nn">statsmodels.base._penalties</span> <span class="k">import</span> <span class="n">Penalty</span>
<span class="kn">from</span> <span class="nn">statsmodels.compat.numpy</span> <span class="k">import</span> <span class="n">np_matrix_rank</span>


<span class="k">def</span> <span class="nf">_dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the dot product of the arrays, works for sparse and dense.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">y</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>


<span class="c1"># From numpy, adapted to work with sparse and dense arrays.</span>
<span class="k">def</span> <span class="nf">_multi_dot_three</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find best ordering for three arrays and do the multiplication.</span>

<span class="sd">    Doing in manually instead of using dynamic programing is</span>
<span class="sd">    approximately 15 times faster.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># cost1 = cost((AB)C)</span>
    <span class="n">cost1</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>  <span class="c1"># (AB)</span>
             <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>   <span class="c1"># (--)C</span>
    <span class="c1"># cost2 = cost((AB)C)</span>
    <span class="n">cost2</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span>  <span class="c1"># (BC)</span>
             <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>   <span class="c1"># A(--)</span>

    <span class="k">if</span> <span class="n">cost1</span> <span class="o">&lt;</span> <span class="n">cost2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_dot</span><span class="p">(</span><span class="n">_dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">),</span> <span class="n">C</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">_dot</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_dotsum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns sum(x * y), where &#39;*&#39; is the pointwise product, computed</span>
<span class="sd">    efficiently for dense and sparse matrices.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># This way usually avoids allocating a temporary.</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">_get_exog_re_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exog_re</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Passes through if given a list of names. Otherwise, gets pandas names</span>
<span class="sd">    or creates some generic variable names as needed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exog_re</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">exog_re</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exog_re</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span> <span class="ow">and</span> <span class="n">exog_re</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">exog_re</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exog_re</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">exog_re</span>

    <span class="c1"># Default names</span>
    <span class="n">defnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x_re</span><span class="si">{0:1d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">exog_re</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">defnames</span>


<span class="k">class</span> <span class="nc">MixedLMParams</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class represents a parameter state for a mixed linear model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    k_fe : integer</span>
<span class="sd">        The number of covariates with fixed effects.</span>
<span class="sd">    k_re : integer</span>
<span class="sd">        The number of covariates with random coefficients (excluding</span>
<span class="sd">        variance components).</span>
<span class="sd">    k_vc : integer</span>
<span class="sd">        The number of variance components parameters.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This object represents the parameter state for the model in which</span>
<span class="sd">    the scale parameter has been profiled out.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k_fe</span><span class="p">,</span> <span class="n">k_re</span><span class="p">,</span> <span class="n">k_vc</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">=</span> <span class="n">k_fe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">=</span> <span class="n">k_re</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">=</span> <span class="n">k_re</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_re</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span> <span class="o">=</span> <span class="n">k_vc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_tot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">from_packed</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">k_fe</span><span class="p">,</span> <span class="n">k_re</span><span class="p">,</span> <span class="n">use_sqrt</span><span class="p">,</span> <span class="n">has_fe</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a MixedLMParams object from packed parameter vector.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : array-like</span>
<span class="sd">            The mode parameters packed into a single vector.</span>
<span class="sd">        k_fe : integer</span>
<span class="sd">            The number of covariates with fixed effects</span>
<span class="sd">        k_re : integer</span>
<span class="sd">            The number of covariates with random effects (excluding</span>
<span class="sd">            variance components).</span>
<span class="sd">        use_sqrt : boolean</span>
<span class="sd">            If True, the random effects covariance matrix is provided</span>
<span class="sd">            as its Cholesky factor, otherwise the lower triangle of</span>
<span class="sd">            the covariance matrix is stored.</span>
<span class="sd">        has_fe : boolean</span>
<span class="sd">            If True, `params` contains fixed effects parameters.</span>
<span class="sd">            Otherwise, the fixed effects parameters are set to zero.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A MixedLMParams object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">k_re2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">k_re</span> <span class="o">*</span> <span class="p">(</span><span class="n">k_re</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># The number of covariance parameters.</span>
        <span class="k">if</span> <span class="n">has_fe</span><span class="p">:</span>
            <span class="n">k_vc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="n">k_fe</span> <span class="o">-</span> <span class="n">k_re2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k_vc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">-</span> <span class="n">k_re2</span>

        <span class="n">pa</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="p">(</span><span class="n">k_fe</span><span class="p">,</span> <span class="n">k_re</span><span class="p">,</span> <span class="n">k_vc</span><span class="p">)</span>

        <span class="n">cov_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">k_re</span><span class="p">,</span> <span class="n">k_re</span><span class="p">))</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">_ix</span>
        <span class="k">if</span> <span class="n">has_fe</span><span class="p">:</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k_fe</span><span class="p">]</span>
            <span class="n">cov_re</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">k_fe</span><span class="p">:</span><span class="n">k_fe</span><span class="o">+</span><span class="n">k_re2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">k_fe</span><span class="p">)</span>
            <span class="n">cov_re</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k_re2</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">use_sqrt</span><span class="p">:</span>
            <span class="n">cov_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_re</span><span class="p">,</span> <span class="n">cov_re</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cov_re</span> <span class="o">=</span> <span class="p">(</span><span class="n">cov_re</span> <span class="o">+</span> <span class="n">cov_re</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_re</span><span class="p">))</span>

        <span class="n">pa</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">cov_re</span>
        <span class="k">if</span> <span class="n">k_vc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_sqrt</span><span class="p">:</span>
                <span class="n">pa</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="n">k_vc</span><span class="p">:]</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pa</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="n">k_vc</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="k">return</span> <span class="n">pa</span>

    <span class="n">from_packed</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">from_packed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">from_components</span><span class="p">(</span><span class="n">fe_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cov_re</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cov_re_sqrt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">vcomp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a MixedLMParams object from each parameter component.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fe_params : array-like</span>
<span class="sd">            The fixed effects parameter (a 1-dimensional array).  If</span>
<span class="sd">            None, there are no fixed effects.</span>
<span class="sd">        cov_re : array-like</span>
<span class="sd">            The random effects covariance matrix (a square, symmetric</span>
<span class="sd">            2-dimensional array).</span>
<span class="sd">        cov_re_sqrt : array-like</span>
<span class="sd">            The Cholesky (lower triangular) square root of the random</span>
<span class="sd">            effects covariance matrix.</span>
<span class="sd">        vcomp : array-like</span>
<span class="sd">            The variance component parameters.  If None, there are no</span>
<span class="sd">            variance components.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A MixedLMParams object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">vcomp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vcomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fe_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fe_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cov_re</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cov_re_sqrt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cov_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="n">k_fe</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fe_params</span><span class="p">)</span>
        <span class="n">k_vc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vcomp</span><span class="p">)</span>
        <span class="n">k_re</span> <span class="o">=</span> <span class="n">cov_re</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">cov_re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">cov_re_sqrt</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">pa</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="p">(</span><span class="n">k_fe</span><span class="p">,</span> <span class="n">k_re</span><span class="p">,</span> <span class="n">k_vc</span><span class="p">)</span>
        <span class="n">pa</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="n">fe_params</span>
        <span class="k">if</span> <span class="n">cov_re_sqrt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov_re_sqrt</span><span class="p">,</span> <span class="n">cov_re_sqrt</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cov_re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pa</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">cov_re</span>

        <span class="n">pa</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="n">vcomp</span>

        <span class="k">return</span> <span class="n">pa</span>

    <span class="n">from_components</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">from_components</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a copy of the object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcomp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">get_packed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_sqrt</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the model parameters packed into a single vector.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        use_sqrt : bool</span>
<span class="sd">            If True, the Cholesky square root of `cov_re` is</span>
<span class="sd">            included in the packed result.  Otherwise the</span>
<span class="sd">            lower triangle of `cov_re` is included.</span>
<span class="sd">        has_fe : bool</span>
<span class="sd">            If True, the fixed effects parameters are included</span>
<span class="sd">            in the packed result, otherwise they are omitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_sqrt</span><span class="p">:</span>
                <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="p">)</span>
                <span class="n">cpa</span> <span class="o">=</span> <span class="n">L</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ix</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cpa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ix</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cpa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_sqrt</span><span class="p">:</span>
            <span class="n">vcomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vcomp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vcomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcomp</span>

        <span class="k">if</span> <span class="n">has_fe</span><span class="p">:</span>
            <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">fe_params</span><span class="p">,</span> <span class="n">cpa</span><span class="p">,</span> <span class="n">vcomp</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">cpa</span><span class="p">,</span> <span class="n">vcomp</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">pa</span>


<span class="k">def</span> <span class="nf">_smw_solver</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">AtA</span><span class="p">,</span> <span class="n">BI</span><span class="p">,</span> <span class="n">di</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Solves the system (s*I + A*B*A&#39;) * x = rhs for an arbitrary rhs.</span>

<span class="sd">    The inverse matrix of B is block diagonal.  The upper left block</span>
<span class="sd">    is BI and the lower right block is a diagonal matrix containing</span>
<span class="sd">    di.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : scalar</span>
<span class="sd">        See above for usage</span>
<span class="sd">    A : ndarray</span>
<span class="sd">        See above for usage</span>
<span class="sd">    AtA : square ndarray</span>
<span class="sd">        A.T * A</span>
<span class="sd">    BI : square symmetric ndarray</span>
<span class="sd">        The inverse of `B`.</span>
<span class="sd">    di : array-like</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    A function that takes `rhs` as an input argument and returns a</span>
<span class="sd">    solution to the linear system defined above.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Use SMW identity</span>
    <span class="n">qmat</span> <span class="o">=</span> <span class="n">AtA</span> <span class="o">/</span> <span class="n">s</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">BI</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">qmat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">]</span> <span class="o">+=</span> <span class="n">BI</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">qmat</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">+=</span> <span class="n">di</span>
    <span class="k">if</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
        <span class="n">qi</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">qmat</span><span class="p">)</span>
        <span class="n">qmati</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">qi</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">qmati</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">qmat</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">solver</span><span class="p">(</span><span class="n">rhs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
            <span class="n">ql</span> <span class="o">=</span> <span class="n">qmati</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
            <span class="n">ql</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ql</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ql</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">qmati</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span>
            <span class="n">ql</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">ql</span><span class="p">)</span>
        <span class="n">rslt</span> <span class="o">=</span> <span class="n">rhs</span> <span class="o">/</span> <span class="n">s</span> <span class="o">-</span> <span class="n">ql</span> <span class="o">/</span> <span class="n">s</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">rslt</span><span class="p">):</span>
            <span class="n">rslt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">rslt</span><span class="o">.</span><span class="n">todense</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">rslt</span>

    <span class="k">return</span> <span class="n">solver</span>


<span class="k">def</span> <span class="nf">_smw_logdet</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">AtA</span><span class="p">,</span> <span class="n">BI</span><span class="p">,</span> <span class="n">di</span><span class="p">,</span> <span class="n">B_logdet</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the log determinant of s*I + A*B*A&#39;.</span>

<span class="sd">    Uses the matrix determinant lemma to accelerate the calculation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    s : scalar</span>
<span class="sd">        See above for usage</span>
<span class="sd">    A : square symmetric ndarray</span>
<span class="sd">        See above for usage</span>
<span class="sd">    AtA : square matrix</span>
<span class="sd">        A.T * A</span>
<span class="sd">    BI : square symmetric ndarray</span>
<span class="sd">        The upper left block of B^-1.</span>
<span class="sd">    di : array-like</span>
<span class="sd">        The diagonal elements of the lower right block of B^-1.</span>
<span class="sd">    B_logdet : real</span>
<span class="sd">        The log determinant of B</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    The log determinant of s*I + A*B*A&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ld</span> <span class="o">=</span> <span class="n">p</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">qmat</span> <span class="o">=</span> <span class="n">AtA</span> <span class="o">/</span> <span class="n">s</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">BI</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">qmat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">]</span> <span class="o">+=</span> <span class="n">BI</span>
    <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">qmat</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">+=</span> <span class="n">di</span>
    <span class="k">if</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">qmat</span><span class="p">):</span>
        <span class="n">qmat</span> <span class="o">=</span> <span class="n">qmat</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ld1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="n">qmat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">B_logdet</span> <span class="o">+</span> <span class="n">ld</span> <span class="o">+</span> <span class="n">ld1</span>


<div class="viewcode-block" id="MixedLM"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.html#statsmodels.regression.mixed_linear_model.MixedLM">[docs]</a><span class="k">class</span> <span class="nc">MixedLM</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">LikelihoodModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An object specifying a linear mixed effects model.  Use the `fit`</span>
<span class="sd">    method to fit the model and obtain a results object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    endog : 1d array-like</span>
<span class="sd">        The dependent variable</span>
<span class="sd">    exog : 2d array-like</span>
<span class="sd">        A matrix of covariates used to determine the</span>
<span class="sd">        mean structure (the &quot;fixed effects&quot; covariates).</span>
<span class="sd">    groups : 1d array-like</span>
<span class="sd">        A vector of labels determining the groups -- data from</span>
<span class="sd">        different groups are independent</span>
<span class="sd">    exog_re : 2d array-like</span>
<span class="sd">        A matrix of covariates used to determine the variance and</span>
<span class="sd">        covariance structure (the &quot;random effects&quot; covariates).  If</span>
<span class="sd">        None, defaults to a random intercept for each group.</span>
<span class="sd">    exog_vc : dict-like</span>
<span class="sd">        A dictionary containing specifications of the variance</span>
<span class="sd">        component terms.  See below for details.</span>
<span class="sd">    use_sqrt : bool</span>
<span class="sd">        If True, optimization is carried out using the lower</span>
<span class="sd">        triangle of the square root of the random effects</span>
<span class="sd">        covariance matrix, otherwise it is carried out using the</span>
<span class="sd">        lower triangle of the random effects covariance matrix.</span>
<span class="sd">    missing : string</span>
<span class="sd">        The approach to missing data handling</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    `exog_vc` is a dictionary of dictionaries.  Specifically,</span>
<span class="sd">    `exog_vc[a][g]` is a matrix whose columns are linearly combined</span>
<span class="sd">    using independent random coefficients.  This random term then</span>
<span class="sd">    contributes to the variance structure of the data for group `g`.</span>
<span class="sd">    The random coefficients all have mean zero, and have the same</span>
<span class="sd">    variance.  The matrix must be `m x k`, where `m` is the number of</span>
<span class="sd">    observations in group `g`.  The number of columns may differ among</span>
<span class="sd">    the top-level groups.</span>

<span class="sd">    The covariates in `exog`, `exog_re` and `exog_vc` may (but need</span>
<span class="sd">    not) partially or wholly overlap.</span>

<span class="sd">    `use_sqrt` should almost always be set to True.  The main use case</span>
<span class="sd">    for use_sqrt=False is when complicated patterns of fixed values in</span>
<span class="sd">    the covariance structure are set (using the `free` argument to</span>
<span class="sd">    `fit`) that cannot be expressed in terms of the Cholesky factor L.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    A basic mixed model with fixed effects for the columns of</span>
<span class="sd">    ``exog`` and a random intercept for each distinct value of</span>
<span class="sd">    ``group``:</span>

<span class="sd">    &gt;&gt;&gt; model = sm.MixedLM(endog, exog, groups)</span>
<span class="sd">    &gt;&gt;&gt; result = model.fit()</span>

<span class="sd">    A mixed model with fixed effects for the columns of ``exog`` and</span>
<span class="sd">    correlated random coefficients for the columns of ``exog_re``:</span>

<span class="sd">    &gt;&gt;&gt; model = sm.MixedLM(endog, exog, groups, exog_re=exog_re)</span>
<span class="sd">    &gt;&gt;&gt; result = model.fit()</span>

<span class="sd">    A mixed model with fixed effects for the columns of ``exog`` and</span>
<span class="sd">    independent random coefficients for the columns of ``exog_re``:</span>

<span class="sd">    &gt;&gt;&gt; free = MixedLMParams.from_components(</span>
<span class="sd">                     fe_params=np.ones(exog.shape[1]),</span>
<span class="sd">                     cov_re=np.eye(exog_re.shape[1]))</span>
<span class="sd">    &gt;&gt;&gt; model = sm.MixedLM(endog, exog, groups, exog_re=exog_re)</span>
<span class="sd">    &gt;&gt;&gt; result = model.fit(free=free)</span>

<span class="sd">    A different way to specify independent random coefficients for the</span>
<span class="sd">    columns of ``exog_re``.  In this example ``groups`` must be a</span>
<span class="sd">    Pandas Series with compatible indexing with ``exog_re``, and</span>
<span class="sd">    ``exog_re`` has two columns.</span>

<span class="sd">    &gt;&gt;&gt; g = pd.groupby(groups, by=groups).groups</span>
<span class="sd">    &gt;&gt;&gt; vc = {}</span>
<span class="sd">    &gt;&gt;&gt; vc[&#39;1&#39;] = {k : exog_re.loc[g[k], 0] for k in g}</span>
<span class="sd">    &gt;&gt;&gt; vc[&#39;2&#39;] = {k : exog_re.loc[g[k], 1] for k in g}</span>
<span class="sd">    &gt;&gt;&gt; model = sm.MixedLM(endog, exog, groups, vcomp=vc)</span>
<span class="sd">    &gt;&gt;&gt; result = model.fit()</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">exog_re</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">exog_vc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_sqrt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="n">_allowed_kwargs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;missing_idx&quot;</span><span class="p">,</span> <span class="s2">&quot;design_info&quot;</span><span class="p">,</span> <span class="s2">&quot;formula&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_allowed_kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;argument </span><span class="si">%s</span><span class="s2"> not permitted for MixedLM initialization&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span> <span class="o">=</span> <span class="n">use_sqrt</span>

        <span class="c1"># Some defaults</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reml</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fe_pen</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">re_pen</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Needs to run early so that the names are sorted.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_vcomp</span><span class="p">(</span><span class="n">exog_vc</span><span class="p">)</span>

        <span class="c1"># If there is one covariate, it may be passed in as a column</span>
        <span class="c1"># vector, convert these to 2d arrays.</span>
        <span class="c1"># TODO: Can this be moved up in the class hierarchy?</span>
        <span class="c1">#       yes, it should be done up the hierarchy</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">exog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="n">data_tools</span><span class="o">.</span><span class="n">_is_using_ndarray_type</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">exog</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">exog</span> <span class="o">=</span> <span class="n">exog</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">exog_re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
                <span class="n">data_tools</span><span class="o">.</span><span class="n">_is_using_ndarray_type</span><span class="p">(</span><span class="n">exog_re</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span>
                <span class="n">exog_re</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">exog_re</span> <span class="o">=</span> <span class="n">exog_re</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="c1"># Calling super creates self.endog, etc. as ndarrays and the</span>
        <span class="c1"># original exog, endog, etc. are self.data.endog, etc.</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MixedLM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span>
                                      <span class="n">exog_re</span><span class="o">=</span><span class="n">exog_re</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="n">missing</span><span class="p">,</span>
                                      <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_init_keys</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s2">&quot;use_sqrt&quot;</span><span class="p">,</span> <span class="s2">&quot;exog_vc&quot;</span><span class="p">])</span>

        <span class="c1"># Number of fixed effects parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">=</span> <span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">exog_re</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">exog_vc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Default random effects structure (random intercepts).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">endog</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Group Var&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">param_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_names</span> <span class="o">+</span> <span class="n">names</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re_names</span> <span class="o">=</span> <span class="n">names</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re_names_full</span> <span class="o">=</span> <span class="n">names</span>

        <span class="k">elif</span> <span class="n">exog_re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Process exog_re the same way that exog is handled</span>
            <span class="c1"># upstream</span>
            <span class="c1"># TODO: this is wrong and should be handled upstream wholly</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re</span> <span class="o">=</span> <span class="n">exog_re</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">exog_re</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="c1"># Model dimensions</span>
            <span class="c1"># Number of random effect covariates</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Number of covariance parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># All random effects are variance components</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">_param_names</span><span class="p">:</span>
            <span class="c1"># HACK: could&#39;ve been set in from_formula already</span>
            <span class="c1"># needs refactor</span>
            <span class="p">(</span><span class="n">param_names</span><span class="p">,</span> <span class="n">exog_re_names</span><span class="p">,</span>
             <span class="n">exog_re_names_full</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_param_names</span><span class="p">(</span><span class="n">exog_re</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">param_names</span> <span class="o">=</span> <span class="n">param_names</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re_names</span> <span class="o">=</span> <span class="n">exog_re_names</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re_names_full</span> <span class="o">=</span> <span class="n">exog_re_names_full</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">k_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span>

        <span class="c1"># Convert the data to the internal representation, which is a</span>
        <span class="c1"># list of arrays, corresponding to the groups.</span>
        <span class="n">group_labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">groups</span><span class="p">))</span>
        <span class="n">group_labels</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">row_indices</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">s</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">group_labels</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="p">):</span>
            <span class="n">row_indices</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row_indices</span> <span class="o">=</span> <span class="n">row_indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span> <span class="o">=</span> <span class="n">group_labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_groups</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">)</span>

        <span class="c1"># Split the data by groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endog</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exog_re_li</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span><span class="p">)</span>

        <span class="c1"># Precompute this.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_re</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exog_re2_li</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exog_re2_li</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_re_li</span><span class="p">]</span>

        <span class="c1"># The total number of observations, summed over all groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endog</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span>

        <span class="c1"># Set the fixed effects parameter names</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exog_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FE</span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span>
                               <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

        <span class="c1"># Precompute this</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_groups</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_augment_exog</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_dot</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>

        <span class="c1"># Precompute this</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reparam</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_setup_vcomp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exog_vc</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exog_vc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exog_vc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exog_vc</span> <span class="o">=</span> <span class="n">exog_vc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">exog_vc</span><span class="p">)</span>
        <span class="n">vc_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">exog_vc</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">vc_names</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vc_names</span> <span class="o">=</span> <span class="n">vc_names</span>

    <span class="k">def</span> <span class="nf">_make_param_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exog_re</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the full parameter names list, just the exogenous random</span>
<span class="sd">        effects variables, and the exogenous random effects variables with</span>
<span class="sd">        the interaction terms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exog_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_names</span><span class="p">)</span>
        <span class="n">exog_re_names</span> <span class="o">=</span> <span class="n">_get_exog_re_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exog_re</span><span class="p">)</span>
        <span class="n">param_names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">jj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exog_re_names</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                    <span class="n">param_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exog_re_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; Var&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">param_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">exog_re_names</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; x &quot;</span> <span class="o">+</span>
                                       <span class="n">exog_re_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; Cov&quot;</span><span class="p">)</span>
                <span class="n">jj</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">vc_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="s2">&quot; Var&quot;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vc_names</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">exog_names</span> <span class="o">+</span> <span class="n">param_names</span> <span class="o">+</span> <span class="n">vc_names</span><span class="p">,</span> <span class="n">exog_re_names</span><span class="p">,</span> <span class="n">param_names</span>

<div class="viewcode-block" id="MixedLM.from_formula"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.from_formula.html#statsmodels.regression.mixed_linear_model.MixedLM.from_formula">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_formula</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">re_formula</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">vc_formula</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_sparse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a Model from a formula and dataframe.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        formula : str or generic Formula object</span>
<span class="sd">            The formula specifying the model</span>
<span class="sd">        data : array-like</span>
<span class="sd">            The data for the model. See Notes.</span>
<span class="sd">        re_formula : string</span>
<span class="sd">            A one-sided formula defining the variance structure of the</span>
<span class="sd">            model.  The default gives a random intercept for each</span>
<span class="sd">            group.</span>
<span class="sd">        vc_formula : dict-like</span>
<span class="sd">            Formulas describing variance components.  `vc_formula[vc]` is</span>
<span class="sd">            the formula for the component with variance parameter named</span>
<span class="sd">            `vc`.  The formula is processed into a matrix, and the columns</span>
<span class="sd">            of this matrix are linearly combined with independent random</span>
<span class="sd">            coefficients having mean zero and a common variance.</span>
<span class="sd">        subset : array-like</span>
<span class="sd">            An array-like object of booleans, integers, or index</span>
<span class="sd">            values that indicate the subset of df to use in the</span>
<span class="sd">            model. Assumes df is a `pandas.DataFrame`</span>
<span class="sd">        missing : string</span>
<span class="sd">            Either &#39;none&#39; or &#39;drop&#39;</span>
<span class="sd">        args : extra arguments</span>
<span class="sd">            These are passed to the model</span>
<span class="sd">        kwargs : extra keyword arguments</span>
<span class="sd">            These are passed to the model with one exception. The</span>
<span class="sd">            ``eval_env`` keyword is passed to patsy. It can be either a</span>
<span class="sd">            :class:`patsy:patsy.EvalEnvironment` object or an integer</span>
<span class="sd">            indicating the depth of the namespace to use. For example, the</span>
<span class="sd">            default ``eval_env=0`` uses the calling namespace. If you wish</span>
<span class="sd">            to use a &quot;clean&quot; environment set ``eval_env=-1``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        model : Model instance</span>

<span class="sd">        Notes</span>
<span class="sd">        ------</span>
<span class="sd">        `data` must define __getitem__ with the keys in the formula</span>
<span class="sd">        terms args and kwargs are passed on to the model</span>
<span class="sd">        instantiation. E.g., a numpy structured or rec array, a</span>
<span class="sd">        dictionary, or a pandas DataFrame.</span>

<span class="sd">        If the variance component is intended to produce random</span>
<span class="sd">        intercepts for disjoint subsets of a group, specified by</span>
<span class="sd">        string labels or a categorical data value, always use &#39;0 +&#39; in</span>
<span class="sd">        the formula so that no overall intercept is included.</span>

<span class="sd">        If the variance components specify random slopes and you do</span>
<span class="sd">        not also want a random group-level intercept in the model,</span>
<span class="sd">        then use &#39;0 +&#39; in the formula to exclude the intercept.</span>

<span class="sd">        The variance components formulas are processed separately for</span>
<span class="sd">        each group.  If a variable is categorical the results will not</span>
<span class="sd">        be affected by whether the group labels are distinct or</span>
<span class="sd">        re-used over the top-level groups.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Suppose we have data from an educational study with students</span>
<span class="sd">        nested in classrooms nested in schools.  The students take a</span>
<span class="sd">        test, and we want to relate the test scores to the students&#39;</span>
<span class="sd">        ages, while accounting for the effects of classrooms and</span>
<span class="sd">        schools.  The school will be the top-level group, and the</span>
<span class="sd">        classroom is a nested group that is specified as a variance</span>
<span class="sd">        component.  Note that the schools may have different number of</span>
<span class="sd">        classrooms, and the classroom labels may (but need not be)</span>
<span class="sd">        different across the schools.</span>

<span class="sd">        &gt;&gt;&gt; vc = {&#39;classroom&#39;: &#39;0 + C(classroom)&#39;}</span>
<span class="sd">        &gt;&gt;&gt; MixedLM.from_formula(&#39;test_score ~ age&#39;, vc_formula=vc, \</span>
<span class="sd">                                  re_formula=&#39;1&#39;, groups=&#39;school&#39;, data=data)</span>

<span class="sd">        Now suppose we also have a previous test score called</span>
<span class="sd">        &#39;pretest&#39;.  If we want the relationship between pretest</span>
<span class="sd">        scores and the current test to vary by classroom, we can</span>
<span class="sd">        specify a random slope for the pretest score</span>

<span class="sd">        &gt;&gt;&gt; vc = {&#39;classroom&#39;: &#39;0 + C(classroom)&#39;, &#39;pretest&#39;: &#39;0 + pretest&#39;}</span>
<span class="sd">        &gt;&gt;&gt; MixedLM.from_formula(&#39;test_score ~ age + pretest&#39;, vc_formula=vc, \</span>
<span class="sd">                                  re_formula=&#39;1&#39;, groups=&#39;school&#39;, data=data)</span>

<span class="sd">        The following model is almost equivalent to the previous one,</span>
<span class="sd">        but here the classroom random intercept and pretest slope may</span>
<span class="sd">        be correlated.</span>

<span class="sd">        &gt;&gt;&gt; vc = {&#39;classroom&#39;: &#39;0 + C(classroom)&#39;}</span>
<span class="sd">        &gt;&gt;&gt; MixedLM.from_formula(&#39;test_score ~ age + pretest&#39;, vc_formula=vc, \</span>
<span class="sd">                                  re_formula=&#39;1 + pretest&#39;, groups=&#39;school&#39;, \</span>
<span class="sd">                                  data=data)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s2">&quot;groups&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;&#39;groups&#39; is a required keyword argument &quot;</span> <span class="o">+</span>
                                 <span class="s2">&quot;in MixedLM.from_formula&quot;</span><span class="p">)</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span>

        <span class="c1"># If `groups` is a variable name, retrieve the data for the</span>
        <span class="c1"># groups variable.</span>
        <span class="n">group_name</span> <span class="o">=</span> <span class="s2">&quot;Group&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">groups</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">group_name</span> <span class="o">=</span> <span class="n">groups</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">groups</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;groups&quot;</span><span class="p">]</span>

        <span class="c1"># Bypass all upstream missing data handling to properly handle</span>
        <span class="c1"># variance components</span>
        <span class="k">if</span> <span class="n">missing</span> <span class="o">==</span> <span class="s1">&#39;drop&#39;</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">_handle_missing</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">re_formula</span><span class="p">,</span>
                                           <span class="n">vc_formula</span><span class="p">)</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>

        <span class="k">if</span> <span class="n">re_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re_formula</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
                <span class="c1"># Work around Patsy bug, fixed by 0.3.</span>
                <span class="n">exog_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">exog_re_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">group_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eval_env</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eval_env&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">eval_env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">eval_env</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">elif</span> <span class="n">eval_env</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">patsy</span> <span class="k">import</span> <span class="n">EvalEnvironment</span>
                    <span class="n">eval_env</span> <span class="o">=</span> <span class="n">EvalEnvironment</span><span class="p">({})</span>
                <span class="n">exog_re</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrix</span><span class="p">(</span><span class="n">re_formula</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">eval_env</span><span class="o">=</span><span class="n">eval_env</span><span class="p">)</span>
                <span class="n">exog_re_names</span> <span class="o">=</span> <span class="n">exog_re</span><span class="o">.</span><span class="n">design_info</span><span class="o">.</span><span class="n">column_names</span>
                <span class="n">exog_re_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Intercept&quot;</span><span class="p">,</span> <span class="n">group_name</span><span class="p">)</span>
                                 <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">exog_re_names</span><span class="p">]</span>
                <span class="n">exog_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">exog_re</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">exog_re</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">exog_re</span> <span class="o">=</span> <span class="n">exog_re</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exog_re</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">vc_formula</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">exog_re_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">group_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exog_re_names</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">vc_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eval_env</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eval_env&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">eval_env</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">eval_env</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="n">eval_env</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">patsy</span> <span class="k">import</span> <span class="n">EvalEnvironment</span>
                <span class="n">eval_env</span> <span class="o">=</span> <span class="n">EvalEnvironment</span><span class="p">({})</span>

            <span class="n">exog_vc</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">gb</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>
            <span class="n">kylist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">gb</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">kylist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">exog_vc_names</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">vc_name</span> <span class="ow">in</span> <span class="n">vc_formula</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">exog_vc</span><span class="p">[</span><span class="n">vc_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kylist</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exog_vc_names</span><span class="p">:</span>
                        <span class="n">exog_vc_names</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">ii</span> <span class="o">=</span> <span class="n">gb</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
                    <span class="n">vcg</span> <span class="o">=</span> <span class="n">vc_formula</span><span class="p">[</span><span class="n">vc_name</span><span class="p">]</span>
                    <span class="n">mat</span> <span class="o">=</span> <span class="n">patsy</span><span class="o">.</span><span class="n">dmatrix</span><span class="p">(</span>
                        <span class="n">vcg</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">eval_env</span><span class="o">=</span><span class="n">eval_env</span><span class="p">,</span>
                        <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;dataframe&#39;</span><span class="p">)</span>
                    <span class="n">exog_vc_names</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">vc_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mat</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">use_sparse</span><span class="p">:</span>
                        <span class="n">exog_vc</span><span class="p">[</span><span class="n">vc_name</span><span class="p">][</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">exog_vc</span><span class="p">[</span><span class="n">vc_name</span><span class="p">][</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
            <span class="n">exog_vc</span> <span class="o">=</span> <span class="n">exog_vc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exog_vc</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">mod</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MixedLM</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">from_formula</span><span class="p">(</span>
            <span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exog_re</span><span class="o">=</span><span class="n">exog_re</span><span class="p">,</span>
            <span class="n">exog_vc</span><span class="o">=</span><span class="n">exog_vc</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># expand re names to account for pairs of RE</span>
        <span class="p">(</span><span class="n">param_names</span><span class="p">,</span>
         <span class="n">exog_re_names</span><span class="p">,</span>
         <span class="n">exog_re_names_full</span><span class="p">)</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">_make_param_names</span><span class="p">(</span><span class="n">exog_re_names</span><span class="p">)</span>

        <span class="n">mod</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">param_names</span> <span class="o">=</span> <span class="n">param_names</span>
        <span class="n">mod</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re_names</span> <span class="o">=</span> <span class="n">exog_re_names</span>
        <span class="n">mod</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re_names_full</span> <span class="o">=</span> <span class="n">exog_re_names_full</span>

        <span class="k">if</span> <span class="n">vc_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mod</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vcomp_names</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">_vc_names</span>
            <span class="n">mod</span><span class="o">.</span><span class="n">_exog_vc_names</span> <span class="o">=</span> <span class="n">exog_vc_names</span>

        <span class="k">return</span> <span class="n">mod</span></div>

<div class="viewcode-block" id="MixedLM.predict"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.predict.html#statsmodels.regression.mixed_linear_model.MixedLM.predict">[docs]</a>    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">exog</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return predicted values from a design matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : array-like</span>
<span class="sd">            Parameters of a mixed linear model.  Can be either a</span>
<span class="sd">            MixedLMParams instance, or a vector containing the packed</span>
<span class="sd">            model parameters in which the fixed effects parameters are</span>
<span class="sd">            at the beginning of the vector, or a vector containing</span>
<span class="sd">            only the fixed effects parameters.</span>
<span class="sd">        exog : array-like, optional</span>
<span class="sd">            Design / exogenous data for the fixed effects. Model exog</span>
<span class="sd">            is used if None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        An array of fitted values.  Note that these predicted values</span>
<span class="sd">        only reflect the fixed effects mean structure of the model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">exog</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">MixedLMParams</span><span class="p">):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">fe_params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span></div>

<div class="viewcode-block" id="MixedLM.group_list"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.group_list.html#statsmodels.regression.mixed_linear_model.MixedLM.group_list">[docs]</a>    <span class="k">def</span> <span class="nf">group_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns `array` split into subarrays corresponding to the</span>
<span class="sd">        grouping structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">array</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">row_indices</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">row_indices</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="p">:])</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">]</span></div>

<div class="viewcode-block" id="MixedLM.fit_regularized"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.fit_regularized.html#statsmodels.regression.mixed_linear_model.MixedLM.fit_regularized">[docs]</a>    <span class="k">def</span> <span class="nf">fit_regularized</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">ceps</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">ptol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">maxit</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a model in which the fixed effects parameters are</span>
<span class="sd">        penalized.  The dependence parameters are held fixed at their</span>
<span class="sd">        estimated values in the unpenalized model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : string of Penalty object</span>
<span class="sd">            Method for regularization.  If a string, must be &#39;l1&#39;.</span>
<span class="sd">        alpha : array-like</span>
<span class="sd">            Scalar or vector of penalty weights.  If a scalar, the</span>
<span class="sd">            same weight is applied to all coefficients; if a vector,</span>
<span class="sd">            it contains a weight for each coefficient.  If method is a</span>
<span class="sd">            Penalty object, the weights are scaled by alpha.  For L1</span>
<span class="sd">            regularization, the weights are used directly.</span>
<span class="sd">        ceps : positive real scalar</span>
<span class="sd">            Fixed effects parameters smaller than this value</span>
<span class="sd">            in magnitude are treaded as being zero.</span>
<span class="sd">        ptol : positive real scalar</span>
<span class="sd">            Convergence occurs when the sup norm difference</span>
<span class="sd">            between successive values of `fe_params` is less than</span>
<span class="sd">            `ptol`.</span>
<span class="sd">        maxit : integer</span>
<span class="sd">            The maximum number of iterations.</span>
<span class="sd">        fit_kwargs : keywords</span>
<span class="sd">            Additional keyword arguments passed to fit.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A MixedLMResults instance containing the results.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The covariance structure is not updated as the fixed effects</span>
<span class="sd">        parameters are varied.</span>

<span class="sd">        The algorithm used here for L1 regularization is a&quot;shooting&quot;</span>
<span class="sd">        or cyclic coordinate descent algorithm.</span>

<span class="sd">        If method is &#39;l1&#39;, then `fe_pen` and `cov_pen` are used to</span>
<span class="sd">        obtain the covariance structure, but are ignored during the</span>
<span class="sd">        L1-penalized fitting.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        Friedman, J. H., Hastie, T. and Tibshirani, R. Regularized</span>
<span class="sd">        Paths for Generalized Linear Models via Coordinate</span>
<span class="sd">        Descent. Journal of Statistical Software, 33(1) (2008)</span>
<span class="sd">        http://www.jstatsoft.org/v33/i01/paper</span>

<span class="sd">        http://statweb.stanford.edu/~tibs/stat315a/Supplements/fuse.pdf</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;l1&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid regularization method&quot;</span><span class="p">)</span>

        <span class="c1"># If method is a smooth penalty just optimize directly.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">Penalty</span><span class="p">):</span>
            <span class="c1"># Scale the penalty weights by alpha</span>
            <span class="n">method</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
            <span class="n">fit_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;fe_pen&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">})</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">**</span><span class="n">fit_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">alpha</span><span class="p">):</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="c1"># Fit the unpenalized model to get the dependence structure.</span>
        <span class="n">mdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="o">**</span><span class="n">fit_kwargs</span><span class="p">)</span>
        <span class="n">fe_params</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">fe_params</span>
        <span class="n">cov_re</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">cov_re</span>
        <span class="n">vcomp</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">vcomp</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">scale</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">itr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxit</span><span class="p">):</span>

            <span class="n">fe_params_s</span> <span class="o">=</span> <span class="n">fe_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">):</span>

                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fe_params</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">ceps</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># The residuals</span>
                <span class="n">fe_params</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">expval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">,</span> <span class="n">fe_params</span><span class="p">)</span>
                <span class="n">resid_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog</span> <span class="o">-</span> <span class="n">expval</span>

                <span class="c1"># The loss function has the form</span>
                <span class="c1"># a*x^2 + b*x + pwt*|x|</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span>
                <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>

                    <span class="n">vc_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_vcomp</span><span class="p">(</span><span class="n">vcomp</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

                    <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
                    <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r</span><span class="p">[</span><span class="n">group_ix</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r2</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>

                    <span class="n">resid</span> <span class="o">=</span> <span class="n">resid_all</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">row_indices</span><span class="p">[</span><span class="n">group</span><span class="p">]]</span>
                    <span class="n">solver</span> <span class="o">=</span> <span class="n">_smw_solver</span><span class="p">(</span><span class="n">scale</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span>
                                         <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">)</span>

                    <span class="n">x</span> <span class="o">=</span> <span class="n">exog</span><span class="p">[:,</span> <span class="n">j</span><span class="p">]</span>
                    <span class="n">u</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">a</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
                    <span class="n">b</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">resid</span><span class="p">)</span>

                <span class="n">pwt1</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="n">pwt1</span><span class="p">:</span>
                    <span class="n">fe_params</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">pwt1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">pwt1</span><span class="p">:</span>
                    <span class="n">fe_params</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">b</span> <span class="o">+</span> <span class="n">pwt1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fe_params_s</span> <span class="o">-</span> <span class="n">fe_params</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">ptol</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># Replace the fixed effects estimates with their penalized</span>
        <span class="c1"># values, leave the dependence parameters in their unpenalized</span>
        <span class="c1"># state.</span>
        <span class="n">params_prof</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">params_prof</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">]</span> <span class="o">=</span> <span class="n">fe_params</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scale</span><span class="p">(</span><span class="n">fe_params</span><span class="p">,</span> <span class="n">mdf</span><span class="o">.</span><span class="n">cov_re_unscaled</span><span class="p">,</span> <span class="n">mdf</span><span class="o">.</span><span class="n">vcomp</span><span class="p">)</span>

        <span class="c1"># Get the Hessian including only the nonzero fixed effects,</span>
        <span class="c1"># then blow back up to the full size after inverting.</span>
        <span class="n">hess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="n">params_prof</span><span class="p">)</span>
        <span class="n">pcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">hess</span><span class="p">)</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">params_prof</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ceps</span>
        <span class="n">ii</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
        <span class="n">hess1</span> <span class="o">=</span> <span class="n">hess</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">ii</span><span class="p">]</span>
        <span class="n">pcov</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="o">-</span><span class="n">hess1</span><span class="p">)</span>

        <span class="n">params_object</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="o">.</span><span class="n">from_components</span><span class="p">(</span><span class="n">fe_params</span><span class="p">,</span> <span class="n">cov_re</span><span class="o">=</span><span class="n">cov_re</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">MixedLMResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params_prof</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">params_object</span> <span class="o">=</span> <span class="n">params_object</span>
        <span class="n">results</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="n">fe_params</span>
        <span class="n">results</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">cov_re</span>
        <span class="n">results</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="n">results</span><span class="o">.</span><span class="n">cov_re_unscaled</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">cov_re_unscaled</span>
        <span class="n">results</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">mdf</span><span class="o">.</span><span class="n">method</span>
        <span class="n">results</span><span class="o">.</span><span class="n">converged</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">results</span><span class="o">.</span><span class="n">cov_pen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_pen</span>
        <span class="n">results</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span>
        <span class="n">results</span><span class="o">.</span><span class="n">k_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span>
        <span class="n">results</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span>
        <span class="n">results</span><span class="o">.</span><span class="n">k_vc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span>

        <span class="k">return</span> <span class="n">MixedLMResultsWrapper</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div>

<div class="viewcode-block" id="MixedLM.get_fe_params"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.get_fe_params.html#statsmodels.regression.mixed_linear_model.MixedLM.get_fe_params">[docs]</a>    <span class="k">def</span> <span class="nf">get_fe_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cov_re</span><span class="p">,</span> <span class="n">vcomp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Use GLS to update the fixed effects parameter estimates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cov_re : array-like</span>
<span class="sd">            The covariance matrix of the random effects.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        The GLS estimates of the fixed effects parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>

        <span class="c1"># Cache these quantities that don&#39;t change.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_endex_li&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_endex_li</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_endex_li</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>

        <span class="n">xtxy</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>
            <span class="n">vc_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_vcomp</span><span class="p">(</span><span class="n">vcomp</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r</span><span class="p">[</span><span class="n">group_ix</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r2</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">_smw_solver</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_endex_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">])</span>
            <span class="n">xtxy</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>

        <span class="n">fe_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">xtxy</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xtxy</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">fe_params</span></div>

    <span class="k">def</span> <span class="nf">_reparam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns parameters of the map converting parameters from the</span>
<span class="sd">        form used in optimization to the form returned to the user.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lin : list-like</span>
<span class="sd">            Linear terms of the map</span>
<span class="sd">        quad : list-like</span>
<span class="sd">            Quadratic terms of the map</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If P are the standard form parameters and R are the</span>
<span class="sd">        transformed parameters (i.e. with the Cholesky square root</span>
<span class="sd">        covariance and square root transformed variance components),</span>
<span class="sd">        then P[i] = lin[i] * R + R&#39; * quad[i] * R</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">k_fe</span><span class="p">,</span> <span class="n">k_re</span><span class="p">,</span> <span class="n">k_re2</span><span class="p">,</span> <span class="n">k_vc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span>
        <span class="n">k_tot</span> <span class="o">=</span> <span class="n">k_fe</span> <span class="o">+</span> <span class="n">k_re2</span> <span class="o">+</span> <span class="n">k_vc</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">)</span>

        <span class="n">lin</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_fe</span><span class="p">):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">k_tot</span><span class="p">)</span>
            <span class="n">e</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">lin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_re2</span><span class="p">):</span>
            <span class="n">lin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">k_tot</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_vc</span><span class="p">):</span>
            <span class="n">lin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">k_tot</span><span class="p">))</span>

        <span class="n">quad</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Quadratic terms for fixed effects.</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_tot</span><span class="p">):</span>
            <span class="n">quad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">k_tot</span><span class="p">,</span> <span class="n">k_tot</span><span class="p">)))</span>

        <span class="c1"># Quadratic terms for random effects covariance.</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">k_re</span><span class="p">)</span>
        <span class="n">ix</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ii</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ii</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">i1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_re2</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_re2</span><span class="p">):</span>
                <span class="n">ix1</span> <span class="o">=</span> <span class="n">ix</span><span class="p">[</span><span class="n">i1</span><span class="p">]</span>
                <span class="n">ix2</span> <span class="o">=</span> <span class="n">ix</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ix1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ix2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ix1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ix2</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">ii</span> <span class="o">=</span> <span class="p">(</span><span class="n">ix2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ix1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="n">ix</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                    <span class="n">quad</span><span class="p">[</span><span class="n">k_fe</span><span class="o">+</span><span class="n">k</span><span class="p">][</span><span class="n">k_fe</span><span class="o">+</span><span class="n">i2</span><span class="p">,</span> <span class="n">k_fe</span><span class="o">+</span><span class="n">i1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k_tot</span><span class="p">):</span>
            <span class="n">quad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">quad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">quad</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="c1"># Quadratic terms for variance components.</span>
        <span class="n">km</span> <span class="o">=</span> <span class="n">k_fe</span> <span class="o">+</span> <span class="n">k_re2</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">km</span><span class="p">,</span> <span class="n">km</span><span class="o">+</span><span class="n">k_vc</span><span class="p">):</span>
            <span class="n">quad</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">lin</span><span class="p">,</span> <span class="n">quad</span>

    <span class="k">def</span> <span class="nf">_expand_vcomp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vcomp</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replicate variance parameters to match a group&#39;s design.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vcomp : array-like</span>
<span class="sd">            The variance parameters for the variance components.</span>
<span class="sd">        group : string</span>
<span class="sd">            The group label</span>

<span class="sd">        Returns an expanded version of vcomp, in which each variance</span>
<span class="sd">        parameter is copied as many times as there are independent</span>
<span class="sd">        realizations of the variance component in the given group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vcomp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">vc_var</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vc_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_vc</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="n">vc_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">vcomp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_vc</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vc_var</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">vc_var</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_augment_exog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_ix</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Concatenate the columns for variance components to the columns</span>
<span class="sd">        for other random effects to obtain a single random effects</span>
<span class="sd">        exog matrix for a given group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ex_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_re_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ex_r</span>

        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="p">[</span><span class="n">ex_r</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">any_sparse</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_vc_names</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_vc</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">ex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog_vc</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">group</span><span class="p">])</span>
            <span class="n">any_sparse</span> <span class="o">|=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">ex</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">any_sparse</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ex</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                    <span class="n">ex</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ex</span>

<div class="viewcode-block" id="MixedLM.loglike"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.loglike.html#statsmodels.regression.mixed_linear_model.MixedLM.loglike">[docs]</a>    <span class="k">def</span> <span class="nf">loglike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">profile_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate the (profile) log-likelihood of the linear mixed</span>
<span class="sd">        effects model.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : MixedLMParams, or array-like.</span>
<span class="sd">            The parameter value.  If array-like, must be a packed</span>
<span class="sd">            parameter vector containing only the covariance</span>
<span class="sd">            parameters.</span>
<span class="sd">        profile_fe : boolean</span>
<span class="sd">            If True, replace the provided value of `fe_params` with</span>
<span class="sd">            the GLS estimates.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        The log-likelihood value at `params`.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The scale parameter `scale` is always profiled out of the</span>
<span class="sd">        log-likelihood.  In addition, if `profile_fe` is true the</span>
<span class="sd">        fixed effects parameters are also profiled out.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">MixedLMParams</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="o">.</span><span class="n">from_packed</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span><span class="p">,</span>
                                               <span class="n">has_fe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">cov_re</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span>
        <span class="n">vcomp</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">vcomp</span>

        <span class="c1"># Move to the profile set</span>
        <span class="k">if</span> <span class="n">profile_fe</span><span class="p">:</span>
            <span class="n">fe_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fe_params</span><span class="p">(</span><span class="n">cov_re</span><span class="p">,</span> <span class="n">vcomp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fe_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">fe_params</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
                <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">cov_re_logdet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">cov_re_logdet</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># The residuals</span>
        <span class="n">expval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="p">,</span> <span class="n">fe_params</span><span class="p">)</span>
        <span class="n">resid_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog</span> <span class="o">-</span> <span class="n">expval</span>

        <span class="n">likeval</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1"># Handle the covariance penalty</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_pen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_pen</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">cov_re</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">)</span>

        <span class="c1"># Handle the fixed effects penalty</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fe_pen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe_pen</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">fe_params</span><span class="p">)</span>

        <span class="n">xvx</span><span class="p">,</span> <span class="n">qf</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>

            <span class="n">vc_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_vcomp</span><span class="p">(</span><span class="n">vcomp</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
            <span class="n">cov_aug_logdet</span> <span class="o">=</span> <span class="n">cov_re_logdet</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">vc_var</span><span class="p">))</span>

            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">_smw_solver</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">)</span>

            <span class="n">resid</span> <span class="o">=</span> <span class="n">resid_all</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">row_indices</span><span class="p">[</span><span class="n">group</span><span class="p">]]</span>

            <span class="c1"># Part 1 of the log likelihood (for both ML and REML)</span>
            <span class="n">ld</span> <span class="o">=</span> <span class="n">_smw_logdet</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">,</span>
                             <span class="n">cov_aug_logdet</span><span class="p">)</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="n">ld</span> <span class="o">/</span> <span class="mf">2.</span>

            <span class="c1"># Part 2 of the log likelihood (for both ML and REML)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
            <span class="n">qf</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>

            <span class="c1"># Adjustment for REML</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">exog</span><span class="p">)</span>
                <span class="n">xvx</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">qf</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ld</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">slogdet</span><span class="p">(</span><span class="n">xvx</span><span class="p">)</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="n">ld</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">likeval</span> <span class="o">+=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">)</span> <span class="o">*</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">qf</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">likeval</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span>
            <span class="n">likeval</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">/</span> <span class="mf">2.</span>

        <span class="k">return</span> <span class="n">likeval</span></div>

    <span class="k">def</span> <span class="nf">_gen_dV_dPar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">max_ix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A generator that yields the element-wise derivative of the</span>
<span class="sd">        marginal covariance matrix with respect to the random effects</span>
<span class="sd">        variance and covariance parameters.</span>

<span class="sd">        ex_r : array-like</span>
<span class="sd">            The random effects design matrix</span>
<span class="sd">        solver : function</span>
<span class="sd">            A function that given x returns V^{-1}x, where V</span>
<span class="sd">            is the group&#39;s marginal covariance matrix.</span>
<span class="sd">        group : scalar</span>
<span class="sd">            The group label</span>
<span class="sd">        max_ix : integer or None</span>
<span class="sd">            If not None, the generator ends when this index</span>
<span class="sd">            is reached.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">axr</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">ex_r</span><span class="p">)</span>

        <span class="c1"># Regular random effects</span>
        <span class="n">jj</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">max_ix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">jj</span> <span class="o">&gt;</span> <span class="n">max_ix</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="c1"># Need 2d</span>
                <span class="n">mat_l</span><span class="p">,</span> <span class="n">mat_r</span> <span class="o">=</span> <span class="n">ex_r</span><span class="p">[:,</span> <span class="n">j1</span><span class="p">:</span><span class="n">j1</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">ex_r</span><span class="p">[:,</span> <span class="n">j2</span><span class="p">:</span><span class="n">j2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">vsl</span><span class="p">,</span> <span class="n">vsr</span> <span class="o">=</span> <span class="n">axr</span><span class="p">[:,</span> <span class="n">j1</span><span class="p">:</span><span class="n">j1</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">axr</span><span class="p">[:,</span> <span class="n">j2</span><span class="p">:</span><span class="n">j2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">yield</span> <span class="n">jj</span><span class="p">,</span> <span class="n">mat_l</span><span class="p">,</span> <span class="n">mat_r</span><span class="p">,</span> <span class="n">vsl</span><span class="p">,</span> <span class="n">vsr</span><span class="p">,</span> <span class="n">j1</span> <span class="o">==</span> <span class="n">j2</span>
                <span class="n">jj</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Variance components</span>
        <span class="k">for</span> <span class="n">ky</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vc_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_vc</span><span class="p">[</span><span class="n">ky</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">max_ix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">jj</span> <span class="o">&gt;</span> <span class="n">max_ix</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_vc</span><span class="p">[</span><span class="n">ky</span><span class="p">][</span><span class="n">group</span><span class="p">]</span>
                <span class="n">axmat</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">mat</span><span class="p">)</span>
                <span class="k">yield</span> <span class="n">jj</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">axmat</span><span class="p">,</span> <span class="n">axmat</span><span class="p">,</span> <span class="kc">True</span>
                <span class="n">jj</span> <span class="o">+=</span> <span class="mi">1</span>

<div class="viewcode-block" id="MixedLM.score"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.score.html#statsmodels.regression.mixed_linear_model.MixedLM.score">[docs]</a>    <span class="k">def</span> <span class="nf">score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">profile_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the score vector of the profile log-likelihood.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The score vector that is returned is computed with respect to</span>
<span class="sd">        the parameterization defined by this model instance&#39;s</span>
<span class="sd">        `use_sqrt` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">MixedLMParams</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="o">.</span><span class="n">from_packed</span><span class="p">(</span>
                <span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span><span class="p">,</span>
                <span class="n">has_fe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">profile_fe</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fe_params</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">cov_re</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">vcomp</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span><span class="p">:</span>
            <span class="n">score_fe</span><span class="p">,</span> <span class="n">score_re</span><span class="p">,</span> <span class="n">score_vc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_sqrt</span><span class="p">(</span>
                <span class="n">params</span><span class="p">,</span> <span class="n">calc_fe</span><span class="o">=</span><span class="ow">not</span> <span class="n">profile_fe</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">score_fe</span><span class="p">,</span> <span class="n">score_re</span><span class="p">,</span> <span class="n">score_vc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_full</span><span class="p">(</span>
                <span class="n">params</span><span class="p">,</span> <span class="n">calc_fe</span><span class="o">=</span><span class="ow">not</span> <span class="n">profile_fe</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freepat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">score_fe</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freepat</span><span class="o">.</span><span class="n">fe_params</span>
            <span class="n">score_re</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freepat</span><span class="o">.</span><span class="n">cov_re</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_freepat</span><span class="o">.</span><span class="n">_ix</span><span class="p">]</span>
            <span class="n">score_vc</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freepat</span><span class="o">.</span><span class="n">vcomp</span>

        <span class="k">if</span> <span class="n">profile_fe</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">score_re</span><span class="p">,</span> <span class="n">score_vc</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">score_fe</span><span class="p">,</span> <span class="n">score_re</span><span class="p">,</span> <span class="n">score_vc</span><span class="p">))</span></div>

<div class="viewcode-block" id="MixedLM.score_full"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.score_full.html#statsmodels.regression.mixed_linear_model.MixedLM.score_full">[docs]</a>    <span class="k">def</span> <span class="nf">score_full</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">calc_fe</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the score with respect to untransformed parameters.</span>

<span class="sd">        Calculates the score vector for the profiled log-likelihood of</span>
<span class="sd">        the mixed effects model with respect to the parameterization</span>
<span class="sd">        in which the random effects covariance matrix is represented</span>
<span class="sd">        in its full form (not using the Cholesky factor).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : MixedLMParams or array-like</span>
<span class="sd">            The parameter at which the score function is evaluated.</span>
<span class="sd">            If array-like, must contain the packed random effects</span>
<span class="sd">            parameters (cov_re and vcomp) without fe_params.</span>
<span class="sd">        calc_fe : boolean</span>
<span class="sd">            If True, calculate the score vector for the fixed effects</span>
<span class="sd">            parameters.  If False, this vector is not calculated, and</span>
<span class="sd">            a vector of zeros is returned in its place.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        score_fe : array-like</span>
<span class="sd">            The score vector with respect to the fixed effects</span>
<span class="sd">            parameters.</span>
<span class="sd">        score_re : array-like</span>
<span class="sd">            The score vector with respect to the random effects</span>
<span class="sd">            parameters (excluding variance components parameters).</span>
<span class="sd">        score_vc : array-like</span>
<span class="sd">            The score vector with respect to variance components</span>
<span class="sd">            parameters.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        `score_re` is taken with respect to the parameterization in</span>
<span class="sd">        which `cov_re` is represented through its lower triangle</span>
<span class="sd">        (without taking the Cholesky square root).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fe_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">fe_params</span>
        <span class="n">cov_re</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span>
        <span class="n">vcomp</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">vcomp</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">score_fe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">)</span>
        <span class="n">score_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span><span class="p">)</span>
        <span class="n">score_vc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">)</span>

        <span class="c1"># Handle the covariance penalty.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_pen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">score_re</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_pen</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">cov_re</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">)</span>

        <span class="c1"># Handle the fixed effects penalty.</span>
        <span class="k">if</span> <span class="n">calc_fe</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fe_pen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">score_fe</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe_pen</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span><span class="n">fe_params</span><span class="p">)</span>

        <span class="c1"># resid&#39; V^{-1} resid, summed over the groups (a scalar)</span>
        <span class="n">rvir</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1"># exog&#39; V^{-1} resid, summed over the groups (a k_fe</span>
        <span class="c1"># dimensional vector)</span>
        <span class="n">xtvir</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1"># exog&#39; V^{_1} exog, summed over the groups (a k_fe x k_fe</span>
        <span class="c1"># matrix)</span>
        <span class="n">xtvix</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1"># V^{-1} exog&#39; dV/dQ_jj exog V^{-1}, where Q_jj is the jj^th</span>
        <span class="c1"># covariance parameter.</span>
        <span class="n">xtax</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">)</span>

        <span class="c1"># Temporary related to the gradient of log |V|</span>
        <span class="n">dlv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">)</span>

        <span class="c1"># resid&#39; V^{-1} dV/dQ_jj V^{-1} resid (a scalar)</span>
        <span class="n">rvavr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>

            <span class="n">vc_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_vcomp</span><span class="p">(</span><span class="n">vcomp</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r</span><span class="p">[</span><span class="n">group_ix</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r2</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">_smw_solver</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">)</span>

            <span class="c1"># The residuals</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">expval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">fe_params</span><span class="p">)</span>
                <span class="n">resid</span> <span class="o">=</span> <span class="n">resid</span> <span class="o">-</span> <span class="n">expval</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
                <span class="n">viexog</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">exog</span><span class="p">)</span>
                <span class="n">xtvix</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">viexog</span><span class="p">)</span>

            <span class="c1"># Contributions to the covariance parameter gradient</span>
            <span class="n">vir</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="n">matl</span><span class="p">,</span> <span class="n">matr</span><span class="p">,</span> <span class="n">vsl</span><span class="p">,</span> <span class="n">vsr</span><span class="p">,</span> <span class="n">sym</span><span class="p">)</span> <span class="ow">in</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">_gen_dV_dPar</span><span class="p">(</span><span class="n">ex_r</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
                <span class="n">dlv</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">_dotsum</span><span class="p">(</span><span class="n">matr</span><span class="p">,</span> <span class="n">vsl</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sym</span><span class="p">:</span>
                    <span class="n">dlv</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_dotsum</span><span class="p">(</span><span class="n">matl</span><span class="p">,</span> <span class="n">vsr</span><span class="p">)</span>

                <span class="n">ul</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">vir</span><span class="p">,</span> <span class="n">matl</span><span class="p">)</span>
                <span class="n">ur</span> <span class="o">=</span> <span class="n">ul</span><span class="o">.</span><span class="n">T</span> <span class="k">if</span> <span class="n">sym</span> <span class="k">else</span> <span class="n">_dot</span><span class="p">(</span><span class="n">matr</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">vir</span><span class="p">)</span>
                <span class="n">ulr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span> <span class="n">ur</span><span class="p">)</span>
                <span class="n">rvavr</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ulr</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sym</span><span class="p">:</span>
                    <span class="n">rvavr</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ulr</span><span class="o">.</span><span class="n">T</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
                    <span class="n">ul</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">viexog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">matl</span><span class="p">)</span>
                    <span class="n">ur</span> <span class="o">=</span> <span class="n">ul</span><span class="o">.</span><span class="n">T</span> <span class="k">if</span> <span class="n">sym</span> <span class="k">else</span> <span class="n">_dot</span><span class="p">(</span><span class="n">matr</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">viexog</span><span class="p">)</span>
                    <span class="n">ulr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span> <span class="n">ur</span><span class="p">)</span>
                    <span class="n">xtax</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ulr</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sym</span><span class="p">:</span>
                        <span class="n">xtax</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ulr</span><span class="o">.</span><span class="n">T</span>

            <span class="c1"># Contribution of log|V| to the covariance parameter</span>
            <span class="c1"># gradient.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">score_re</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dlv</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">score_vc</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">dlv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span><span class="p">:]</span>

            <span class="n">rvir</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">vir</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">calc_fe</span><span class="p">:</span>
                <span class="n">xtvir</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">vir</span><span class="p">)</span>

        <span class="n">fac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
            <span class="n">fac</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span>

        <span class="k">if</span> <span class="n">calc_fe</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">score_fe</span> <span class="o">+=</span> <span class="n">fac</span> <span class="o">*</span> <span class="n">xtvir</span> <span class="o">/</span> <span class="n">rvir</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">score_re</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">fac</span> <span class="o">*</span> <span class="n">rvavr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span><span class="p">]</span> <span class="o">/</span> <span class="n">rvir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">score_vc</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">fac</span> <span class="o">*</span> <span class="n">rvavr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span><span class="p">:]</span> <span class="o">/</span> <span class="n">rvir</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
            <span class="n">xtvixi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">xtvix</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span><span class="p">):</span>
                <span class="n">score_re</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">_dotsum</span><span class="p">(</span><span class="n">xtvixi</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">xtax</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">):</span>
                <span class="n">score_vc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">_dotsum</span><span class="p">(</span><span class="n">xtvixi</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">xtax</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="n">j</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">score_fe</span><span class="p">,</span> <span class="n">score_re</span><span class="p">,</span> <span class="n">score_vc</span></div>

<div class="viewcode-block" id="MixedLM.score_sqrt"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.score_sqrt.html#statsmodels.regression.mixed_linear_model.MixedLM.score_sqrt">[docs]</a>    <span class="k">def</span> <span class="nf">score_sqrt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">calc_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the score with respect to transformed parameters.</span>

<span class="sd">        Calculates the score vector with respect to the</span>
<span class="sd">        parameterization in which the random effects covariance matrix</span>
<span class="sd">        is represented through its Cholesky square root.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : MixedLMParams or array-like</span>
<span class="sd">            The model parameters.  If array-like must contain packed</span>
<span class="sd">            parameters that are compatible with this model instance.</span>
<span class="sd">        calc_fe : boolean</span>
<span class="sd">            If True, calculate the score vector for the fixed effects</span>
<span class="sd">            parameters.  If False, this vector is not calculated, and</span>
<span class="sd">            a vector of zeros is returned in its place.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        score_fe : array-like</span>
<span class="sd">            The score vector with respect to the fixed effects</span>
<span class="sd">            parameters.</span>
<span class="sd">        score_re : array-like</span>
<span class="sd">            The score vector with respect to the random effects</span>
<span class="sd">            parameters (excluding variance components parameters).</span>
<span class="sd">        score_vc : array-like</span>
<span class="sd">            The score vector with respect to variance components</span>
<span class="sd">            parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">score_fe</span><span class="p">,</span> <span class="n">score_re</span><span class="p">,</span> <span class="n">score_vc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">score_full</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">calc_fe</span><span class="o">=</span><span class="n">calc_fe</span><span class="p">)</span>
        <span class="n">params_vec</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get_packed</span><span class="p">(</span><span class="n">use_sqrt</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">score_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">score_fe</span><span class="p">,</span> <span class="n">score_re</span><span class="p">,</span> <span class="n">score_vc</span><span class="p">))</span>
        <span class="n">scr</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params_vec</span><span class="p">)):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_quad</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">params_vec</span><span class="p">)</span>
            <span class="n">scr</span> <span class="o">+=</span> <span class="n">score_full</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span>
        <span class="n">score_fe</span> <span class="o">=</span> <span class="n">scr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">]</span>
        <span class="n">score_re</span> <span class="o">=</span> <span class="n">scr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span><span class="p">]</span>
        <span class="n">score_vc</span> <span class="o">=</span> <span class="n">scr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span><span class="p">:]</span>

        <span class="k">return</span> <span class="n">score_fe</span><span class="p">,</span> <span class="n">score_re</span><span class="p">,</span> <span class="n">score_vc</span></div>

<div class="viewcode-block" id="MixedLM.hessian"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.hessian.html#statsmodels.regression.mixed_linear_model.MixedLM.hessian">[docs]</a>    <span class="k">def</span> <span class="nf">hessian</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the model&#39;s Hessian matrix.</span>

<span class="sd">        Calculates the Hessian matrix for the linear mixed effects</span>
<span class="sd">        model with respect to the parameterization in which the</span>
<span class="sd">        covariance matrix is represented directly (without square-root</span>
<span class="sd">        transformation).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : MixedLMParams or array-like</span>
<span class="sd">            The model parameters at which the Hessian is calculated.</span>
<span class="sd">            If array-like, must contain the packed parameters in a</span>
<span class="sd">            form that is compatible with this model instance.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hess : 2d ndarray</span>
<span class="sd">            The Hessian matrix, evaluated at `params`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">MixedLMParams</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="o">.</span><span class="n">from_packed</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span>
                                               <span class="n">use_sqrt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span><span class="p">,</span>
                                               <span class="n">has_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">fe_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">fe_params</span>
        <span class="n">vcomp</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">vcomp</span>
        <span class="n">cov_re</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Blocks for the fixed and random effects parameters.</span>
        <span class="n">hess_fe</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">hess_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">))</span>
        <span class="n">hess_fere</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">))</span>

        <span class="n">fac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
            <span class="n">fac</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">rvir</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">xtvix</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">xtax</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
        <span class="n">F</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.</span><span class="p">]</span> <span class="o">*</span> <span class="n">m</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>

            <span class="n">vc_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_vcomp</span><span class="p">(</span><span class="n">vcomp</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r2</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">_smw_solver</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">)</span>

            <span class="c1"># The residuals</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">expval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">fe_params</span><span class="p">)</span>
                <span class="n">resid</span> <span class="o">=</span> <span class="n">resid</span> <span class="o">-</span> <span class="n">expval</span>

            <span class="n">viexog</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">exog</span><span class="p">)</span>
            <span class="n">xtvix</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">viexog</span><span class="p">)</span>
            <span class="n">vir</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
            <span class="n">rvir</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">vir</span><span class="p">)</span>

            <span class="k">for</span> <span class="p">(</span><span class="n">jj1</span><span class="p">,</span> <span class="n">matl1</span><span class="p">,</span> <span class="n">matr1</span><span class="p">,</span> <span class="n">vsl1</span><span class="p">,</span> <span class="n">vsr1</span><span class="p">,</span> <span class="n">sym1</span><span class="p">)</span> <span class="ow">in</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">_gen_dV_dPar</span><span class="p">(</span><span class="n">ex_r</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>

                <span class="n">ul</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">viexog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">matl1</span><span class="p">)</span>
                <span class="n">ur</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">matr1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">vir</span><span class="p">)</span>
                <span class="n">hess_fere</span><span class="p">[</span><span class="n">jj1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span> <span class="n">ur</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sym1</span><span class="p">:</span>
                    <span class="n">ul</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">viexog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">matr1</span><span class="p">)</span>
                    <span class="n">ur</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">matl1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">vir</span><span class="p">)</span>
                    <span class="n">hess_fere</span><span class="p">[</span><span class="n">jj1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span> <span class="n">ur</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
                    <span class="n">ul</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">viexog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">matl1</span><span class="p">)</span>
                    <span class="n">ur</span> <span class="o">=</span> <span class="n">ul</span> <span class="k">if</span> <span class="n">sym1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">viexog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">matr1</span><span class="p">)</span>
                    <span class="n">ulr</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span> <span class="n">ur</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                    <span class="n">xtax</span><span class="p">[</span><span class="n">jj1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ulr</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sym1</span><span class="p">:</span>
                        <span class="n">xtax</span><span class="p">[</span><span class="n">jj1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ulr</span><span class="o">.</span><span class="n">T</span>

                <span class="n">ul</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">vir</span><span class="p">,</span> <span class="n">matl1</span><span class="p">)</span>
                <span class="n">ur</span> <span class="o">=</span> <span class="n">ul</span> <span class="k">if</span> <span class="n">sym1</span> <span class="k">else</span> <span class="n">_dot</span><span class="p">(</span><span class="n">vir</span><span class="p">,</span> <span class="n">matr1</span><span class="p">)</span>
                <span class="n">B</span><span class="p">[</span><span class="n">jj1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ul</span><span class="p">,</span> <span class="n">ur</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">sym1</span> <span class="k">else</span> <span class="mi">2</span><span class="p">)</span>

                <span class="c1"># V^{-1} * dV/d_theta</span>
                <span class="n">E</span> <span class="o">=</span> <span class="p">[(</span><span class="n">vsl1</span><span class="p">,</span> <span class="n">matr1</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sym1</span><span class="p">:</span>
                    <span class="n">E</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">vsr1</span><span class="p">,</span> <span class="n">matl1</span><span class="p">))</span>

                <span class="k">for</span> <span class="p">(</span><span class="n">jj2</span><span class="p">,</span> <span class="n">matl2</span><span class="p">,</span> <span class="n">matr2</span><span class="p">,</span> <span class="n">vsl2</span><span class="p">,</span> <span class="n">vsr2</span><span class="p">,</span> <span class="n">sym2</span><span class="p">)</span> <span class="ow">in</span>\
                        <span class="bp">self</span><span class="o">.</span><span class="n">_gen_dV_dPar</span><span class="p">(</span><span class="n">ex_r</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">jj1</span><span class="p">):</span>

                    <span class="n">re</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">_multi_dot_three</span><span class="p">(</span><span class="n">matr2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                              <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">E</span><span class="p">])</span>
                    <span class="n">vt</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">_dot</span><span class="p">(</span><span class="n">_multi_dot_three</span><span class="p">(</span><span class="n">vir</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">matl2</span><span class="p">,</span> <span class="n">re</span><span class="p">),</span>
                                  <span class="n">vir</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sym2</span><span class="p">:</span>
                        <span class="n">le</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">_multi_dot_three</span><span class="p">(</span><span class="n">matl2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                                  <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">E</span><span class="p">])</span>
                        <span class="n">vt</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">_dot</span><span class="p">(</span><span class="n">_multi_dot_three</span><span class="p">(</span>
                            <span class="n">vir</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">matr2</span><span class="p">,</span> <span class="n">le</span><span class="p">),</span> <span class="n">vir</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">])</span>

                    <span class="n">D</span><span class="p">[</span><span class="n">jj1</span><span class="p">,</span> <span class="n">jj2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">vt</span>
                    <span class="k">if</span> <span class="n">jj1</span> <span class="o">!=</span> <span class="n">jj2</span><span class="p">:</span>
                        <span class="n">D</span><span class="p">[</span><span class="n">jj2</span><span class="p">,</span> <span class="n">jj1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">vt</span>

                    <span class="n">rt</span> <span class="o">=</span> <span class="n">_dotsum</span><span class="p">(</span><span class="n">vsl2</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">sym2</span><span class="p">:</span>
                        <span class="n">rt</span> <span class="o">+=</span> <span class="n">_dotsum</span><span class="p">(</span><span class="n">vsr2</span><span class="p">,</span> <span class="n">le</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

                    <span class="n">hess_re</span><span class="p">[</span><span class="n">jj1</span><span class="p">,</span> <span class="n">jj2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rt</span>
                    <span class="k">if</span> <span class="n">jj1</span> <span class="o">!=</span> <span class="n">jj2</span><span class="p">:</span>
                        <span class="n">hess_re</span><span class="p">[</span><span class="n">jj2</span><span class="p">,</span> <span class="n">jj1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rt</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
                        <span class="n">ev</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">_dot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">_dot</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">viexog</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">E</span><span class="p">])</span>
                        <span class="n">u1</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">viexog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">matl2</span><span class="p">)</span>
                        <span class="n">u2</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">matr2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
                        <span class="n">um</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
                        <span class="n">F</span><span class="p">[</span><span class="n">jj1</span><span class="p">][</span><span class="n">jj2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">um</span> <span class="o">+</span> <span class="n">um</span><span class="o">.</span><span class="n">T</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">sym2</span><span class="p">:</span>
                            <span class="n">u1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">viexog</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">matr2</span><span class="p">)</span>
                            <span class="n">u2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matl2</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ev</span><span class="p">)</span>
                            <span class="n">um</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
                            <span class="n">F</span><span class="p">[</span><span class="n">jj1</span><span class="p">][</span><span class="n">jj2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">um</span> <span class="o">+</span> <span class="n">um</span><span class="o">.</span><span class="n">T</span>

        <span class="n">hess_fe</span> <span class="o">-=</span> <span class="n">fac</span> <span class="o">*</span> <span class="n">xtvix</span> <span class="o">/</span> <span class="n">rvir</span>
        <span class="n">hess_re</span> <span class="o">=</span> <span class="n">hess_re</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">fac</span> <span class="o">*</span> <span class="p">(</span><span class="n">D</span><span class="o">/</span><span class="n">rvir</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span> <span class="o">/</span> <span class="n">rvir</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">hess_fere</span> <span class="o">=</span> <span class="o">-</span><span class="n">fac</span> <span class="o">*</span> <span class="n">hess_fere</span> <span class="o">/</span> <span class="n">rvir</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
            <span class="n">QL</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">xtvix</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xtax</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">_dotsum</span><span class="p">(</span><span class="n">QL</span><span class="p">[</span><span class="n">j1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">QL</span><span class="p">[</span><span class="n">j2</span><span class="p">])</span>
                    <span class="n">a</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">xtvix</span><span class="p">,</span> <span class="n">F</span><span class="p">[</span><span class="n">j1</span><span class="p">][</span><span class="n">j2</span><span class="p">]))</span>
                    <span class="n">a</span> <span class="o">*=</span> <span class="mf">0.5</span>
                    <span class="n">hess_re</span><span class="p">[</span><span class="n">j1</span><span class="p">,</span> <span class="n">j2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">a</span>
                    <span class="k">if</span> <span class="n">j1</span> <span class="o">&gt;</span> <span class="n">j2</span><span class="p">:</span>
                        <span class="n">hess_re</span><span class="p">[</span><span class="n">j2</span><span class="p">,</span> <span class="n">j1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">a</span>

        <span class="c1"># Put the blocks together to get the Hessian.</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span>
        <span class="n">hess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
        <span class="n">hess</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">]</span> <span class="o">=</span> <span class="n">hess_fe</span>
        <span class="n">hess</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">:]</span> <span class="o">=</span> <span class="n">hess_fere</span><span class="o">.</span><span class="n">T</span>
        <span class="n">hess</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">]</span> <span class="o">=</span> <span class="n">hess_fere</span>
        <span class="n">hess</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">:]</span> <span class="o">=</span> <span class="n">hess_re</span>

        <span class="k">return</span> <span class="n">hess</span></div>

<div class="viewcode-block" id="MixedLM.get_scale"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.get_scale.html#statsmodels.regression.mixed_linear_model.MixedLM.get_scale">[docs]</a>    <span class="k">def</span> <span class="nf">get_scale</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fe_params</span><span class="p">,</span> <span class="n">cov_re</span><span class="p">,</span> <span class="n">vcomp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the estimated error variance based on given estimates</span>
<span class="sd">        of the slopes and random effects covariance matrix.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fe_params : array-like</span>
<span class="sd">            The regression slope estimates</span>
<span class="sd">        cov_re : 2d array-like</span>
<span class="sd">            Estimate of the random effects covariance matrix</span>
<span class="sd">        vcomp : array-like</span>
<span class="sd">            Estimate of the variance components</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        scale : float</span>
<span class="sd">            The estimated error variance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">qf</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>

            <span class="n">vc_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_vcomp</span><span class="p">(</span><span class="n">vcomp</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r</span><span class="p">[</span><span class="n">group_ix</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aex_r2</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>

            <span class="n">solver</span> <span class="o">=</span> <span class="n">_smw_solver</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">)</span>

            <span class="c1"># The residuals</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">expval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="n">fe_params</span><span class="p">)</span>
                <span class="n">resid</span> <span class="o">=</span> <span class="n">resid</span> <span class="o">-</span> <span class="n">expval</span>

            <span class="n">mat</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
            <span class="n">qf</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">mat</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
            <span class="n">qf</span> <span class="o">/=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qf</span> <span class="o">/=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_totobs</span>

        <span class="k">return</span> <span class="n">qf</span></div>

<div class="viewcode-block" id="MixedLM.fit"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLM.fit.html#statsmodels.regression.mixed_linear_model.MixedLM.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reml</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">niter_sa</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">do_cg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fe_pen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cov_pen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">full_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;bfgs&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit a linear mixed model to the data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start_params: array-like or MixedLMParams</span>
<span class="sd">            Starting values for the profile log-likelihood.  If not a</span>
<span class="sd">            `MixedLMParams` instance, this should be an array</span>
<span class="sd">            containing the packed parameters for the profile</span>
<span class="sd">            log-likelihood, including the fixed effects</span>
<span class="sd">            parameters.</span>
<span class="sd">        reml : bool</span>
<span class="sd">            If true, fit according to the REML likelihood, else</span>
<span class="sd">            fit the standard likelihood using ML.</span>
<span class="sd">        niter_sa :</span>
<span class="sd">            Currently this argument is ignored and has no effect</span>
<span class="sd">            on the results.</span>
<span class="sd">        cov_pen : CovariancePenalty object</span>
<span class="sd">            A penalty for the random effects covariance matrix</span>
<span class="sd">        do_cg : boolean, defaults to True</span>
<span class="sd">            If False, the optimization is skipped and a results</span>
<span class="sd">            object at the given (or default) starting values is</span>
<span class="sd">            returned.</span>
<span class="sd">        fe_pen : Penalty object</span>
<span class="sd">            A penalty on the fixed effects</span>
<span class="sd">        free : MixedLMParams object</span>
<span class="sd">            If not `None`, this is a mask that allows parameters to be</span>
<span class="sd">            held fixed at specified values.  A 1 indicates that the</span>
<span class="sd">            correspondinig parameter is estimated, a 0 indicates that</span>
<span class="sd">            it is fixed at its starting value.  Setting the `cov_re`</span>
<span class="sd">            component to the identity matrix fits a model with</span>
<span class="sd">            independent random effects.  Note that some optimization</span>
<span class="sd">            methods do not respect this constraint (bfgs and lbfgs both</span>
<span class="sd">            work).</span>
<span class="sd">        full_output : bool</span>
<span class="sd">            If true, attach iteration history to results</span>
<span class="sd">        method : string</span>
<span class="sd">            Optimization method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A MixedLMResults instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_allowed_kwargs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gtol&#39;</span><span class="p">,</span> <span class="s1">&#39;maxiter&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_allowed_kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Argument </span><span class="si">%s</span><span class="s2"> not allowed for MixedLM.fit&quot;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;newton&quot;</span><span class="p">,</span> <span class="s2">&quot;ncg&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;method </span><span class="si">%s</span><span class="s2"> not available for MixedLM&quot;</span> <span class="o">%</span> <span class="n">method</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reml</span> <span class="o">=</span> <span class="n">reml</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cov_pen</span> <span class="o">=</span> <span class="n">cov_pen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fe_pen</span> <span class="o">=</span> <span class="n">fe_pen</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_freepat</span> <span class="o">=</span> <span class="n">free</span>

        <span class="k">if</span> <span class="n">full_output</span><span class="p">:</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hist</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">start_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_params</span><span class="p">,</span> <span class="n">MixedLMParams</span><span class="p">):</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">start_params</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># It&#39;s a packed array</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_params</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">:</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="o">.</span><span class="n">from_packed</span><span class="p">(</span>
                        <span class="n">start_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span><span class="p">,</span>
                        <span class="n">has_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">start_params</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">:</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="o">.</span><span class="n">from_packed</span><span class="p">(</span>
                        <span class="n">start_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span><span class="p">,</span>
                        <span class="n">has_fe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;invalid start_params&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">do_cg</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;retall&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s2">&quot;disp&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;disp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">packed</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get_packed</span><span class="p">(</span><span class="n">use_sqrt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">niter_sa</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;niter_sa is currently ignored&quot;</span><span class="p">)</span>

            <span class="c1"># It seems that the optimizers sometimes stop too soon, so</span>
            <span class="c1"># we run a few times.</span>
            <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">rslt</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MixedLM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">start_params</span><span class="o">=</span><span class="n">packed</span><span class="p">,</span>
                                                <span class="n">skip_hessian</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rslt</span><span class="o">.</span><span class="n">mle_retvals</span><span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">]:</span>
                    <span class="k">break</span>
                <span class="n">packed</span> <span class="o">=</span> <span class="n">rslt</span><span class="o">.</span><span class="n">params</span>

            <span class="c1"># The optimization succeeded</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">rslt</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rslt</span><span class="o">.</span><span class="n">mle_retvals</span><span class="p">)</span>

        <span class="n">converged</span> <span class="o">=</span> <span class="n">rslt</span><span class="o">.</span><span class="n">mle_retvals</span><span class="p">[</span><span class="s1">&#39;converged&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">converged</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Gradient optimization failed.&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ConvergenceWarning</span><span class="p">)</span>

        <span class="c1"># Convert to the final parameterization (i.e. undo the square</span>
        <span class="c1"># root transform of the covariance matrix, and the profiling</span>
        <span class="c1"># over the error variance).</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="o">.</span><span class="n">from_packed</span><span class="p">(</span>
            <span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">,</span> <span class="n">use_sqrt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">cov_re_unscaled</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span>
        <span class="n">vcomp_unscaled</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">vcomp</span>
        <span class="n">fe_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fe_params</span><span class="p">(</span><span class="n">cov_re_unscaled</span><span class="p">,</span> <span class="n">vcomp_unscaled</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="n">fe_params</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_scale</span><span class="p">(</span><span class="n">fe_params</span><span class="p">,</span> <span class="n">cov_re_unscaled</span><span class="p">,</span> <span class="n">vcomp_unscaled</span><span class="p">)</span>
        <span class="n">cov_re</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">cov_re_unscaled</span>
        <span class="n">vcomp</span> <span class="o">=</span> <span class="n">scale</span> <span class="o">*</span> <span class="n">vcomp_unscaled</span>

        <span class="n">f1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_re</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vcomp</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f1</span> <span class="ow">or</span> <span class="n">f2</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;The MLE may be on the boundary of the parameter space.&quot;</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ConvergenceWarning</span><span class="p">)</span>

        <span class="c1"># Compute the Hessian at the MLE.  Note that this is the</span>
        <span class="c1"># Hessian with respect to the random effects covariance matrix</span>
        <span class="c1"># (not its square root).  It is used for obtaining standard</span>
        <span class="c1"># errors, not for optimization.</span>
        <span class="n">hess</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hessian</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">hess_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hess</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">free</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">hess</span><span class="p">)</span>
            <span class="n">pat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freepat</span><span class="o">.</span><span class="n">get_packed</span><span class="p">(</span><span class="n">use_sqrt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">pat</span><span class="p">)</span>
            <span class="n">hess_diag</span> <span class="o">=</span> <span class="n">hess_diag</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hess1</span> <span class="o">=</span> <span class="n">hess</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span><span class="p">)]</span>
                <span class="n">pcov</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">ii</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="o">-</span><span class="n">hess1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="o">-</span><span class="n">hess</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">hess_diag</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The Hessian matrix at the estimated parameter values &quot;</span> <span class="o">+</span>
                   <span class="s2">&quot;is not positive definite.&quot;</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ConvergenceWarning</span><span class="p">)</span>

        <span class="c1"># Prepare a results class instance</span>
        <span class="n">params_packed</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get_packed</span><span class="p">(</span><span class="n">use_sqrt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">MixedLMResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params_packed</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">params_object</span> <span class="o">=</span> <span class="n">params</span>
        <span class="n">results</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="n">fe_params</span>
        <span class="n">results</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">cov_re</span>
        <span class="n">results</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="n">vcomp</span>
        <span class="n">results</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="n">results</span><span class="o">.</span><span class="n">cov_re_unscaled</span> <span class="o">=</span> <span class="n">cov_re_unscaled</span>
        <span class="n">results</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;REML&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span> <span class="k">else</span> <span class="s2">&quot;ML&quot;</span>
        <span class="n">results</span><span class="o">.</span><span class="n">converged</span> <span class="o">=</span> <span class="n">converged</span>
        <span class="n">results</span><span class="o">.</span><span class="n">hist</span> <span class="o">=</span> <span class="n">hist</span>
        <span class="n">results</span><span class="o">.</span><span class="n">reml</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span>
        <span class="n">results</span><span class="o">.</span><span class="n">cov_pen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_pen</span>
        <span class="n">results</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span>
        <span class="n">results</span><span class="o">.</span><span class="n">k_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span>
        <span class="n">results</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span>
        <span class="n">results</span><span class="o">.</span><span class="n">k_vc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span>
        <span class="n">results</span><span class="o">.</span><span class="n">use_sqrt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_sqrt</span>
        <span class="n">results</span><span class="o">.</span><span class="n">freepat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_freepat</span>

        <span class="k">return</span> <span class="n">MixedLMResultsWrapper</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MixedLMResults"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLMResults.html#statsmodels.regression.mixed_linear_model.MixedLMResults">[docs]</a><span class="k">class</span> <span class="nc">MixedLMResults</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">LikelihoodModelResults</span><span class="p">,</span> <span class="n">base</span><span class="o">.</span><span class="n">ResultMixin</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class to contain results of fitting a linear mixed effects model.</span>

<span class="sd">    MixedLMResults inherits from statsmodels.LikelihoodModelResults</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    See statsmodels.LikelihoodModelResults</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    **Attributes**</span>

<span class="sd">    model : class instance</span>
<span class="sd">        Pointer to MixedLM model instance that called fit.</span>
<span class="sd">    normalized_cov_params : array</span>
<span class="sd">        The sampling covariance matrix of the estimates</span>
<span class="sd">    fe_params : array</span>
<span class="sd">        The fitted fixed-effects coefficients</span>
<span class="sd">    cov_re : array</span>
<span class="sd">        The fitted random-effects covariance matrix</span>
<span class="sd">    bse_fe : array</span>
<span class="sd">        The standard errors of the fitted fixed effects coefficients</span>
<span class="sd">    bse_re : array</span>
<span class="sd">        The standard errors of the fitted random effects covariance</span>
<span class="sd">        matrix and variance components.  The first `k_re * (k_re + 1)`</span>
<span class="sd">        parameters are the standard errors for the lower triangle of</span>
<span class="sd">        `cov_re`, the remaining elements are the standard errors for</span>
<span class="sd">        the variance components.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    statsmodels.LikelihoodModelResults</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">cov_params</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">MixedLMResults</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
                                             <span class="n">normalized_cov_params</span><span class="o">=</span><span class="n">cov_params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">nobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nobs</span> <span class="o">-</span> <span class="n">np_matrix_rank</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="p">)</span>

<div class="viewcode-block" id="MixedLMResults.fittedvalues"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLMResults.fittedvalues.html#statsmodels.regression.mixed_linear_model.MixedLMResults.fittedvalues">[docs]</a>    <span class="nd">@cache_readonly</span>
    <span class="k">def</span> <span class="nf">fittedvalues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the fitted values for the model.</span>

<span class="sd">        The fitted values reflect the mean structure specified by the</span>
<span class="sd">        fixed effects and the predicted random effects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe_params</span><span class="p">)</span>
        <span class="n">re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_effects</span>
        <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">row_indices</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>

            <span class="n">mat</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_re_li</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_re_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_vc_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_vc</span><span class="p">[</span><span class="n">c</span><span class="p">]:</span>
                    <span class="n">mat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_vc</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">group</span><span class="p">])</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">fit</span><span class="p">[</span><span class="n">ix</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat</span><span class="p">,</span> <span class="n">re</span><span class="p">[</span><span class="n">group</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">fit</span></div>

<div class="viewcode-block" id="MixedLMResults.resid"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLMResults.resid.html#statsmodels.regression.mixed_linear_model.MixedLMResults.resid">[docs]</a>    <span class="nd">@cache_readonly</span>
    <span class="k">def</span> <span class="nf">resid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the residuals for the model.</span>

<span class="sd">        The residuals reflect the mean structure specified by the</span>
<span class="sd">        fixed effects and the predicted random effects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">fittedvalues</span></div>

<div class="viewcode-block" id="MixedLMResults.bse_fe"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLMResults.bse_fe.html#statsmodels.regression.mixed_linear_model.MixedLMResults.bse_fe">[docs]</a>    <span class="nd">@cache_readonly</span>
    <span class="k">def</span> <span class="nf">bse_fe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the standard errors of the fixed effect regression</span>
<span class="sd">        coefficients.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_params</span><span class="p">())[</span><span class="mi">0</span><span class="p">:</span><span class="n">p</span><span class="p">])</span></div>

<div class="viewcode-block" id="MixedLMResults.bse_re"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLMResults.bse_re.html#statsmodels.regression.mixed_linear_model.MixedLMResults.bse_re">[docs]</a>    <span class="nd">@cache_readonly</span>
    <span class="k">def</span> <span class="nf">bse_re</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the standard errors of the variance parameters.</span>

<span class="sd">        The first `k_re x (k_re + 1)` elements of the returned array</span>
<span class="sd">        are the standard errors of the lower triangle of `cov_re`.</span>
<span class="sd">        The remaining elements are the standard errors of the variance</span>
<span class="sd">        components.</span>

<span class="sd">        Note that the sampling distribution of variance parameters is</span>
<span class="sd">        strongly skewed unless the sample size is large, so these</span>
<span class="sd">        standard errors may not give meaningful confidence intervals</span>
<span class="sd">        or p-values if used in the usual way.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_params</span><span class="p">())[</span><span class="n">p</span><span class="p">:])</span></div>

    <span class="k">def</span> <span class="nf">_expand_re_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exog_re_names</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_vc_names</span><span class="p">:</span>
            <span class="n">vg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_exog_vc_names</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="n">v</span><span class="p">]</span>
            <span class="n">na</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">vg</span><span class="p">]</span>
            <span class="n">names</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">na</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">names</span>

<div class="viewcode-block" id="MixedLMResults.random_effects"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLMResults.random_effects.html#statsmodels.regression.mixed_linear_model.MixedLMResults.random_effects">[docs]</a>    <span class="nd">@cache_readonly</span>
    <span class="k">def</span> <span class="nf">random_effects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The conditional means of random effects given the data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        random_effects : dict</span>
<span class="sd">            A dictionary mapping the distinct `group` values to the</span>
<span class="sd">            conditional means of the random effects for the group</span>
<span class="sd">            given the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot predict random effects from &quot;</span> <span class="o">+</span>
                             <span class="s2">&quot;singular covariance structure.&quot;</span><span class="p">)</span>

        <span class="n">vcomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcomp</span>
        <span class="n">k_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re</span>

        <span class="n">ranef_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">group_ix</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">group_labels</span><span class="p">):</span>

            <span class="n">endog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">exog_li</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">ex_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_aex_r</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">ex2_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_aex_r2</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">vc_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_expand_vcomp</span><span class="p">(</span><span class="n">vcomp</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>

            <span class="c1"># Get the residuals relative to fixed effects</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="n">endog</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">expval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">exog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe_params</span><span class="p">)</span>
                <span class="n">resid</span> <span class="o">=</span> <span class="n">resid</span> <span class="o">-</span> <span class="n">expval</span>

            <span class="n">solver</span> <span class="o">=</span> <span class="n">_smw_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span>
                                 <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">)</span>
            <span class="n">vir</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>

            <span class="n">xtvir</span> <span class="o">=</span> <span class="n">_dot</span><span class="p">(</span><span class="n">ex_r</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">vir</span><span class="p">)</span>

            <span class="n">xtvir</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k_re</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="p">,</span> <span class="n">xtvir</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">k_re</span><span class="p">])</span>
            <span class="n">xtvir</span><span class="p">[</span><span class="n">k_re</span><span class="p">:]</span> <span class="o">*=</span> <span class="n">vc_var</span>
            <span class="n">ranef_dict</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                <span class="n">xtvir</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_expand_re_names</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ranef_dict</span></div>

<div class="viewcode-block" id="MixedLMResults.random_effects_cov"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLMResults.random_effects_cov.html#statsmodels.regression.mixed_linear_model.MixedLMResults.random_effects_cov">[docs]</a>    <span class="nd">@cache_readonly</span>
    <span class="k">def</span> <span class="nf">random_effects_cov</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the conditional covariance matrix of the random</span>
<span class="sd">        effects for each group given the data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        random_effects_cov : dict</span>
<span class="sd">            A dictionary mapping the distinct values of the `group`</span>
<span class="sd">            variable to the conditional covariance matrix of the</span>
<span class="sd">            random effects given the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
            <span class="n">cov_re_inv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">vcomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcomp</span>

        <span class="n">ranef_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">group_ix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">n_groups</span><span class="p">):</span>

            <span class="n">ex_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_aex_r</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">ex2_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_aex_r2</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">group_labels</span><span class="p">[</span><span class="n">group_ix</span><span class="p">]</span>
            <span class="n">vc_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_expand_vcomp</span><span class="p">(</span><span class="n">vcomp</span><span class="p">,</span> <span class="n">group_ix</span><span class="p">)</span>

            <span class="n">solver</span> <span class="o">=</span> <span class="n">_smw_solver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">ex_r</span><span class="p">,</span> <span class="n">ex2_r</span><span class="p">,</span> <span class="n">cov_re_inv</span><span class="p">,</span>
                                 <span class="mi">1</span> <span class="o">/</span> <span class="n">vc_var</span><span class="p">)</span>

            <span class="n">n</span> <span class="o">=</span> <span class="n">ex_r</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">vc_var</span><span class="p">)))</span>
            <span class="n">mat1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ex_r</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="p">)</span>
            <span class="n">mat1</span><span class="p">[:,</span> <span class="n">m</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">ex_r</span><span class="p">[:,</span> <span class="n">m</span><span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">vc_var</span><span class="p">))</span>
            <span class="n">mat2</span> <span class="o">=</span> <span class="n">solver</span><span class="p">(</span><span class="n">mat1</span><span class="p">)</span>
            <span class="n">mat2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mat1</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">mat2</span><span class="p">)</span>

            <span class="n">v</span> <span class="o">=</span> <span class="o">-</span><span class="n">mat2</span>
            <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="n">m</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">v</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span><span class="p">]</span> <span class="o">+=</span> <span class="n">vc_var</span>
            <span class="n">na</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_re_names</span><span class="p">(</span><span class="n">group_ix</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">na</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">na</span><span class="p">)</span>
            <span class="n">ranef_dict</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">return</span> <span class="n">ranef_dict</span></div>

    <span class="c1"># Need to override since t-tests are only used for fixed effects</span>
    <span class="c1"># parameters.</span>
<div class="viewcode-block" id="MixedLMResults.t_test"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLMResults.t_test.html#statsmodels.regression.mixed_linear_model.MixedLMResults.t_test">[docs]</a>    <span class="k">def</span> <span class="nf">t_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r_matrix</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_t</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute a t-test for a each linear hypothesis of the form Rb = q</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        r_matrix : array-like</span>
<span class="sd">            If an array is given, a p x k 2d array or length k 1d</span>
<span class="sd">            array specifying the linear restrictions. It is assumed</span>
<span class="sd">            that the linear combination is equal to zero.</span>
<span class="sd">        scale : float, optional</span>
<span class="sd">            An optional `scale` to use.  Default is the scale specified</span>
<span class="sd">            by the model fit.</span>
<span class="sd">        use_t : bool, optional</span>
<span class="sd">            If use_t is None, then the default of the model is used.</span>
<span class="sd">            If use_t is True, then the p-values are based on the t</span>
<span class="sd">            distribution.</span>
<span class="sd">            If use_t is False, then the p-values are based on the normal</span>
<span class="sd">            distribution.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        res : ContrastResults instance</span>
<span class="sd">            The results for the test are attributes of this results instance.</span>
<span class="sd">            The available results have the same elements as the parameter table</span>
<span class="sd">            in `summary()`.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">r_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;r_matrix for t-test should have </span><span class="si">%d</span><span class="s2"> columns&quot;</span>
                             <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span>
        <span class="n">z0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">r_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">))</span>
        <span class="n">r_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">r_matrix</span><span class="p">,</span> <span class="n">z0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tst_rslt</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MixedLMResults</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">t_test</span><span class="p">(</span>
            <span class="n">r_matrix</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">use_t</span><span class="o">=</span><span class="n">use_t</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tst_rslt</span></div>

<div class="viewcode-block" id="MixedLMResults.summary"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLMResults.summary.html#statsmodels.regression.mixed_linear_model.MixedLMResults.summary">[docs]</a>    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">yname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xname_fe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xname_re</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">05</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Summarize the mixed model regression results.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        yname : string, optional</span>
<span class="sd">            Default is `y`</span>
<span class="sd">        xname_fe : list of strings, optional</span>
<span class="sd">            Fixed effects covariate names</span>
<span class="sd">        xname_re : list of strings, optional</span>
<span class="sd">            Random effects covariate names</span>
<span class="sd">        title : string, optional</span>
<span class="sd">            Title for the top table. If not None, then this replaces</span>
<span class="sd">            the default title</span>
<span class="sd">        alpha : float</span>
<span class="sd">            significance level for the confidence intervals</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        smry : Summary instance</span>
<span class="sd">            this holds the summary tables and text, which can be</span>
<span class="sd">            printed or converted to various output formats.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        statsmodels.iolib.summary.Summary : class to hold summary</span>
<span class="sd">            results</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">from</span> <span class="nn">statsmodels.iolib</span> <span class="k">import</span> <span class="n">summary2</span>
        <span class="n">smry</span> <span class="o">=</span> <span class="n">summary2</span><span class="o">.</span><span class="n">Summary</span><span class="p">()</span>

        <span class="n">info</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Model:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;MixedLM&quot;</span>
        <span class="k">if</span> <span class="n">yname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">yname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog_names</span>
        <span class="n">param_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">param_names</span><span class="p">[:]</span>
        <span class="n">k_fe_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fe_params</span><span class="p">)</span>
        <span class="n">k_re_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fe_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xname_fe</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xname_fe</span><span class="p">)</span> <span class="o">!=</span> <span class="n">k_fe_params</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;xname_fe should be a list of length </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">k_fe_params</span><span class="p">)</span>
            <span class="n">param_names</span><span class="p">[:</span><span class="n">k_fe_params</span><span class="p">]</span> <span class="o">=</span> <span class="n">xname_fe</span>
        <span class="k">if</span> <span class="n">xname_re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xname_re</span><span class="p">)</span> <span class="o">!=</span> <span class="n">k_re_params</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;xname_re should be a list of length </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">k_re_params</span><span class="p">)</span>
            <span class="n">param_names</span><span class="p">[</span><span class="n">k_fe_params</span><span class="p">:]</span> <span class="o">=</span> <span class="n">xname_re</span>

        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;No. Observations:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">n_totobs</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;No. Groups:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">n_groups</span><span class="p">)</span>

        <span class="n">gs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">endog_li</span><span class="p">])</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Min. group size:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.0f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">min</span><span class="p">(</span><span class="n">gs</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Max. group size:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.0f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">max</span><span class="p">(</span><span class="n">gs</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Mean group size:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">gs</span><span class="p">)</span>

        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Dependent Variable:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yname</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Method:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Scale:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Likelihood:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llf</span>
        <span class="n">info</span><span class="p">[</span><span class="s2">&quot;Converged:&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">converged</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span>
        <span class="n">smry</span><span class="o">.</span><span class="n">add_dict</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="n">smry</span><span class="o">.</span><span class="n">add_title</span><span class="p">(</span><span class="s2">&quot;Mixed Linear Model Regression Results&quot;</span><span class="p">)</span>

        <span class="n">float_fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span>

        <span class="n">sdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_re2</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="c1"># Coefficient estimates</span>
        <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fe_params</span>

        <span class="c1"># Standard errors</span>
        <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_params</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">]))</span>

        <span class="c1"># Z-scores</span>
        <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># p-values</span>
        <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">2</span><span class="p">]))</span>

        <span class="c1"># Confidence intervals</span>
        <span class="n">qm</span> <span class="o">=</span> <span class="o">-</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">qm</span> <span class="o">*</span> <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">qm</span> <span class="o">*</span> <span class="n">sdf</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># All random effects variances and covariances</span>
        <span class="n">jj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_fe</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_re</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">sdf</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cov_re</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">sdf</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                <span class="n">jj</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Variance components</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_vc</span><span class="p">):</span>
            <span class="n">sdf</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcomp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sdf</span><span class="p">[</span><span class="n">jj</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
            <span class="n">jj</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">sdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">param_names</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">sdf</span><span class="p">)</span>
        <span class="n">sdf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Coef.&#39;</span><span class="p">,</span> <span class="s1">&#39;Std.Err.&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;P&gt;|z|&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">alpha</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">sdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">sdf</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">float_fmt</span> <span class="o">%</span> <span class="n">x</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sdf</span><span class="p">[</span><span class="n">col</span><span class="p">]]</span>

        <span class="n">smry</span><span class="o">.</span><span class="n">add_df</span><span class="p">(</span><span class="n">sdf</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">smry</span></div>

<div class="viewcode-block" id="MixedLMResults.llf"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLMResults.llf.html#statsmodels.regression.mixed_linear_model.MixedLMResults.llf">[docs]</a>    <span class="nd">@cache_readonly</span>
    <span class="k">def</span> <span class="nf">llf</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">loglike</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_object</span><span class="p">,</span> <span class="n">profile_fe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="MixedLMResults.aic"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLMResults.aic.html#statsmodels.regression.mixed_linear_model.MixedLMResults.aic">[docs]</a>    <span class="nd">@cache_readonly</span>
    <span class="k">def</span> <span class="nf">aic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">freepat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freepat</span><span class="o">.</span><span class="n">get_packed</span><span class="p">(</span><span class="n">use_sqrt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">llf</span> <span class="o">-</span> <span class="n">df</span><span class="p">)</span></div>

<div class="viewcode-block" id="MixedLMResults.bic"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLMResults.bic.html#statsmodels.regression.mixed_linear_model.MixedLMResults.bic">[docs]</a>    <span class="nd">@cache_readonly</span>
    <span class="k">def</span> <span class="nf">bic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">freepat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freepat</span><span class="o">.</span><span class="n">get_packed</span><span class="p">(</span><span class="n">use_sqrt</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">has_fe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">llf</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nobs</span><span class="p">)</span> <span class="o">*</span> <span class="n">df</span></div>

<div class="viewcode-block" id="MixedLMResults.profile_re"><a class="viewcode-back" href="../../../generated/statsmodels.regression.mixed_linear_model.MixedLMResults.profile_re.html#statsmodels.regression.mixed_linear_model.MixedLMResults.profile_re">[docs]</a>    <span class="k">def</span> <span class="nf">profile_re</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">re_ix</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">num_low</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">dist_low</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">num_high</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                   <span class="n">dist_high</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Profile-likelihood inference for variance parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        re_ix : integer</span>
<span class="sd">            If vtype is `re`, this value is the index of the variance</span>
<span class="sd">            parameter for which to construct a profile likelihood.  If</span>
<span class="sd">            `vtype` is &#39;vc&#39; then `re_ix` is the name of the variance</span>
<span class="sd">            parameter to be profiled.</span>
<span class="sd">        vtype : string</span>
<span class="sd">            Either &#39;re&#39; or &#39;vc&#39;, depending on whether the profile</span>
<span class="sd">            analysis is for a random effect or a variance component.</span>
<span class="sd">        num_low : integer</span>
<span class="sd">            The number of points at which to calculate the likelihood</span>
<span class="sd">            below the MLE of the parameter of interest.</span>
<span class="sd">        dist_low : float</span>
<span class="sd">            The distance below the MLE of the parameter of interest to</span>
<span class="sd">            begin calculating points on the profile likelihood.</span>
<span class="sd">        num_high : integer</span>
<span class="sd">            The number of points at which to calculate the likelihood</span>
<span class="sd">            abov the MLE of the parameter of interest.</span>
<span class="sd">        dist_high : float</span>
<span class="sd">            The distance above the MLE of the parameter of interest to</span>
<span class="sd">            begin calculating points on the profile likelihood.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        An array with two columns.  The first column contains the</span>
<span class="sd">        values to which the parameter of interest is constrained.  The</span>
<span class="sd">        second column contains the corresponding likelihood values.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Only variance parameters can be profiled.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pmodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">k_fe</span> <span class="o">=</span> <span class="n">pmodel</span><span class="o">.</span><span class="n">k_fe</span>
        <span class="n">k_re</span> <span class="o">=</span> <span class="n">pmodel</span><span class="o">.</span><span class="n">k_re</span>
        <span class="n">k_vc</span> <span class="o">=</span> <span class="n">pmodel</span><span class="o">.</span><span class="n">k_vc</span>
        <span class="n">endog</span><span class="p">,</span> <span class="n">exog</span> <span class="o">=</span> <span class="n">pmodel</span><span class="o">.</span><span class="n">endog</span><span class="p">,</span> <span class="n">pmodel</span><span class="o">.</span><span class="n">exog</span>

        <span class="c1"># Need to permute the columns of the random effects design</span>
        <span class="c1"># matrix so that the profiled variable is in the first column.</span>
        <span class="k">if</span> <span class="n">vtype</span> <span class="o">==</span> <span class="s1">&#39;re&#39;</span><span class="p">:</span>
            <span class="n">ix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">k_re</span><span class="p">)</span>
            <span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">re_ix</span>
            <span class="n">ix</span><span class="p">[</span><span class="n">re_ix</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">exog_re</span> <span class="o">=</span> <span class="n">pmodel</span><span class="o">.</span><span class="n">exog_re</span><span class="o">.</span><span class="n">copy</span><span class="p">()[:,</span> <span class="n">ix</span><span class="p">]</span>

            <span class="c1"># Permute the covariance structure to match the permuted</span>
            <span class="c1"># design matrix.</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_object</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cov_re_unscaled</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span>
            <span class="n">cov_re_unscaled</span> <span class="o">=</span> <span class="n">cov_re_unscaled</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span><span class="p">)]</span>
            <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">cov_re_unscaled</span>
            <span class="n">ru0</span> <span class="o">=</span> <span class="n">cov_re_unscaled</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Convert dist_low and dist_high to the profile</span>
            <span class="c1"># parameterization</span>
            <span class="n">cov_re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">*</span> <span class="n">cov_re_unscaled</span>
            <span class="n">low</span> <span class="o">=</span> <span class="p">(</span><span class="n">cov_re</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">dist_low</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
            <span class="n">high</span> <span class="o">=</span> <span class="p">(</span><span class="n">cov_re</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dist_high</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="k">elif</span> <span class="n">vtype</span> <span class="o">==</span> <span class="s1">&#39;vc&#39;</span><span class="p">:</span>
            <span class="n">re_ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_vc_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">re_ix</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_object</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">vcomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vcomp</span>
            <span class="n">low</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcomp</span><span class="p">[</span><span class="n">re_ix</span><span class="p">]</span> <span class="o">-</span> <span class="n">dist_low</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
            <span class="n">high</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcomp</span><span class="p">[</span><span class="n">re_ix</span><span class="p">]</span> <span class="o">+</span> <span class="n">dist_high</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>
            <span class="n">ru0</span> <span class="o">=</span> <span class="n">vcomp</span><span class="p">[</span><span class="n">re_ix</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span>

        <span class="c1"># Define the sequence of values to which the parameter of</span>
        <span class="c1"># interest will be constrained.</span>
        <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dist_low is too large and would result in a &quot;</span>
                             <span class="s2">&quot;negative variance. Try a smaller value.&quot;</span><span class="p">)</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">ru0</span><span class="p">,</span> <span class="n">num_low</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ru0</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">num_high</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">rvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">))</span>

        <span class="c1"># Indicators of which parameters are free and fixed.</span>
        <span class="n">free</span> <span class="o">=</span> <span class="n">MixedLMParams</span><span class="p">(</span><span class="n">k_fe</span><span class="p">,</span> <span class="n">k_re</span><span class="p">,</span> <span class="n">k_vc</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">freepat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">free</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">k_fe</span><span class="p">)</span>
            <span class="n">vcomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">k_vc</span><span class="p">)</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">k_re</span><span class="p">,</span> <span class="n">k_re</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If a freepat already has been specified, we add the</span>
            <span class="c1"># constraint to it.</span>
            <span class="n">free</span><span class="o">.</span><span class="n">fe_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freepat</span><span class="o">.</span><span class="n">fe_params</span>
            <span class="n">vcomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freepat</span><span class="o">.</span><span class="n">vcomp</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freepat</span><span class="o">.</span><span class="n">cov_re</span>
            <span class="k">if</span> <span class="n">vtype</span> <span class="o">==</span> <span class="s1">&#39;re&#39;</span><span class="p">:</span>
                <span class="n">mat</span> <span class="o">=</span> <span class="n">mat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">ix</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">vtype</span> <span class="o">==</span> <span class="s1">&#39;re&#39;</span><span class="p">:</span>
            <span class="n">mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vcomp</span><span class="p">[</span><span class="n">re_ix</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">free</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">mat</span>
        <span class="n">free</span><span class="o">.</span><span class="n">vcomp</span> <span class="o">=</span> <span class="n">vcomp</span>

        <span class="n">klass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">init_kwargs</span> <span class="o">=</span> <span class="n">pmodel</span><span class="o">.</span><span class="n">_get_init_kwds</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">vtype</span> <span class="o">==</span> <span class="s1">&#39;re&#39;</span><span class="p">:</span>
            <span class="n">init_kwargs</span><span class="p">[</span><span class="s1">&#39;exog_re&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exog_re</span>

        <span class="n">likev</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rvalues</span><span class="p">:</span>

            <span class="n">model</span> <span class="o">=</span> <span class="n">klass</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">exog</span><span class="p">,</span> <span class="o">**</span><span class="n">init_kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">vtype</span> <span class="o">==</span> <span class="s1">&#39;re&#39;</span><span class="p">:</span>
                <span class="n">cov_re</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">cov_re</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
                <span class="n">params</span><span class="o">.</span><span class="n">cov_re</span> <span class="o">=</span> <span class="n">cov_re</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">vcomp</span><span class="p">[</span><span class="n">re_ix</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>

            <span class="c1"># TODO should use fit_kwargs</span>
            <span class="n">rslt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">start_params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">free</span><span class="o">=</span><span class="n">free</span><span class="p">,</span>
                             <span class="n">reml</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reml</span><span class="p">,</span> <span class="n">cov_pen</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cov_pen</span><span class="p">)</span><span class="o">.</span><span class="n">_results</span>
            <span class="n">likev</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span> <span class="o">*</span> <span class="n">rslt</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span> <span class="n">rslt</span><span class="o">.</span><span class="n">llf</span><span class="p">])</span>

        <span class="n">likev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">likev</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">likev</span></div></div>


<span class="k">class</span> <span class="nc">MixedLMResultsWrapper</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">LikelihoodResultsWrapper</span><span class="p">):</span>
    <span class="n">_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;bse_re&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;generic_columns&#39;</span><span class="p">,</span> <span class="s1">&#39;exog_re_names_full&#39;</span><span class="p">),</span>
              <span class="s1">&#39;fe_params&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;generic_columns&#39;</span><span class="p">,</span> <span class="s1">&#39;xnames&#39;</span><span class="p">),</span>
              <span class="s1">&#39;bse_fe&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;generic_columns&#39;</span><span class="p">,</span> <span class="s1">&#39;xnames&#39;</span><span class="p">),</span>
              <span class="s1">&#39;cov_re&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;generic_columns_2d&#39;</span><span class="p">,</span> <span class="s1">&#39;exog_re_names&#39;</span><span class="p">),</span>
              <span class="s1">&#39;cov_re_unscaled&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;generic_columns_2d&#39;</span><span class="p">,</span> <span class="s1">&#39;exog_re_names&#39;</span><span class="p">),</span>
              <span class="p">}</span>
    <span class="n">_upstream_attrs</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">LikelihoodResultsWrapper</span><span class="o">.</span><span class="n">_wrap_attrs</span>
    <span class="n">_wrap_attrs</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">wrap</span><span class="o">.</span><span class="n">union_dicts</span><span class="p">(</span><span class="n">_attrs</span><span class="p">,</span> <span class="n">_upstream_attrs</span><span class="p">)</span>

    <span class="n">_methods</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_upstream_methods</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">LikelihoodResultsWrapper</span><span class="o">.</span><span class="n">_wrap_methods</span>
    <span class="n">_wrap_methods</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">wrap</span><span class="o">.</span><span class="n">union_dicts</span><span class="p">(</span><span class="n">_methods</span><span class="p">,</span> <span class="n">_upstream_methods</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_handle_missing</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">formula</span><span class="p">,</span> <span class="n">re_formula</span><span class="p">,</span> <span class="n">vc_formula</span><span class="p">):</span>

    <span class="n">tokens</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>

    <span class="n">forms</span> <span class="o">=</span> <span class="p">[</span><span class="n">formula</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">re_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">forms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re_formula</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">vc_formula</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">forms</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">vc_formula</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="kn">import</span> <span class="nn">tokenize</span>
    <span class="kn">from</span> <span class="nn">statsmodels.compat</span> <span class="k">import</span> <span class="n">PY3</span>
    <span class="kn">from</span> <span class="nn">statsmodels.compat.python</span> <span class="k">import</span> <span class="n">StringIO</span><span class="p">,</span> <span class="n">asunicode</span>
    <span class="n">skiptoks</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">fml</span> <span class="ow">in</span> <span class="n">forms</span><span class="p">:</span>
        <span class="c1"># Unicode conversion is for Py2 compatability</span>
        <span class="n">rl</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">fml</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">rlu</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">rl</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">asunicode</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">tokenize</span><span class="o">.</span><span class="n">generate_tokens</span><span class="p">(</span><span class="n">rlu</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">g</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tok</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skiptoks</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
                    <span class="n">tokens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tok</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tokens</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">tok</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tokens</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
    <span class="n">tokens</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">tokens</span><span class="p">]</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;str&quot;</span><span class="p">:</span>
        <span class="n">ii</span> <span class="o">&amp;=</span> <span class="n">pd</span><span class="o">.</span><span class="n">notnull</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="p">:],</span> <span class="n">groups</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ii</span><span class="p">)]</span>
</pre></div>




          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2009-2017, Josef Perktold, Skipper Seabold, Jonathan Taylor, statsmodels-developers.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.4.
    </div>
  </body>
</html>